<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AKSARA - BK16</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* Loading Spinner */
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loader { border-top-color: #3498db; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Autocomplete Dropdown Styles */
        .autocomplete-items {
            position: absolute; border: 1px solid #d4d4d4; border-bottom: none; border-top: none; z-index: 99;
            top: 100%; left: 0; right: 0; max-height: 200px; overflow-y: auto; background-color: white; border-radius: 0 0 8px 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .autocomplete-items div { padding: 10px; cursor: pointer; background-color: #fff; border-bottom: 1px solid #d4d4d4; font-size: 0.875rem; }
        .autocomplete-items div:hover { background-color: #e9e9e9; }
        .autocomplete-active { background-color: DodgerBlue !important; color: #ffffff; }

        @media print {
            /* Kita atur margin langsung di kertas cetak, bukan di div-nya */
            @page { size: 215mm 330mm; margin: 15mm 20mm; } 
            
            /* Hancurkan semua kuncian tinggi layar agar kertas bisa panjang ke bawah */
            html, body, #root, .min-h-screen { 
                background-color: #ffffff !important; 
                height: auto !important; 
                min-height: auto !important; 
                overflow: visible !important; 
                position: relative !important;
            }
            
            /* Sembunyikan elemen UI aplikasi (Sidebar, Navbar, dll) */
            aside, main, .no-print { 
                display: none !important; 
            }
            
            /* Bebaskan area surat agar mengalir alami mengikuti isi teks */
            .print-area { 
                display: block !important; 
                position: relative !important; /* Ini kunci utamanya! Harus relative */
                width: 100% !important; 
                height: auto !important;
                padding: 0 !important; 
                margin: 0 !important;
                box-shadow: none !important; 
                overflow: visible !important;
            }
            
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
    </style>
	
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ==========================================
        // CONFIGURATION
        // ==========================================
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx1QKFeaD1uyRRkg4qhfBOuRfxT-D7Im6E8SVdCEpQeixpGWIKl9Ehzj0fp0EKApIekdQ/exec"; 
        // ==========================================

        const { useState, useEffect, useRef } = React;

        // --- ICONS ---
        const IconBase = ({ children, size = 24, className = "" }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>);
        const Plus = (props) => <IconBase {...props}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></IconBase>;
        const Trash2 = (props) => <IconBase {...props}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></IconBase>;
        const Edit = (props) => <IconBase {...props}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></IconBase>;
        const Eye = (props) => <IconBase {...props}><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></IconBase>;
        const EyeOff = (props) => <IconBase {...props}><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></IconBase>;
        const Printer = (props) => <IconBase {...props}><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></IconBase>;
        const Search = (props) => <IconBase {...props}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></IconBase>;
        const LayoutDashboard = (props) => <IconBase {...props}><rect x="3" y="3" width="7" height="9"/><rect x="14" y="3" width="7" height="5"/><rect x="14" y="12" width="7" height="9"/><rect x="3" y="16" width="7" height="5"/></IconBase>;
        const FileWarning = (props) => <IconBase {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><path d="M12 9v4"/><path d="M12 17h.01"/></IconBase>;
        const FileSignature = (props) => <IconBase {...props}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M16 13H8"/><path d="M16 17H8"/><path d="M10 9H8"/></IconBase>;
        const Mail = (props) => <IconBase {...props}><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></IconBase>;
        const FileCheck = (props) => <IconBase {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="m9 15 2 2 4-4"/></IconBase>;
        const X = (props) => <IconBase {...props}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></IconBase>;
        const Save = (props) => <IconBase {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>;
        const ArrowLeft = (props) => <IconBase {...props}><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></IconBase>;
        const Building2 = (props) => <IconBase {...props}><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"/><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"/><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"/><path d="M10 6h4"/><path d="M10 10h4"/><path d="M10 14h4"/><path d="M10 18h4"/></IconBase>;
        const Menu = (props) => <IconBase {...props}><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></IconBase>;
        const RotateCcw = (props) => <IconBase {...props}><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></IconBase>;
        const ChevronLeft = (props) => <IconBase {...props}><polyline points="15 18 9 12 15 6"/></IconBase>;
        const ChevronRight = (props) => <IconBase {...props}><polyline points="9 18 15 12 9 6"/></IconBase>;
		const ChevronDown = (props) => <IconBase {...props}><polyline points="6 9 12 15 18 9"/></IconBase>;
        const SidebarOpen = (props) => <IconBase {...props}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="9" y1="3" x2="9" y2="21"/></IconBase>;
        const Cloud = (props) => <IconBase {...props}><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></IconBase>;
        const MessageCircle = (props) => <IconBase {...props}><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></IconBase>;
        const History = (props) => <IconBase {...props}><path d="M3 3v5h5"/><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"/><path d="M12 7v5l4 2"/></IconBase>;
        const BarChart2 = (props) => <IconBase {...props}><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></IconBase>;
        const Download = (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></IconBase>;
        const LogOut = (props) => <IconBase {...props}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></IconBase>;
        const User = (props) => <IconBase {...props}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconBase>;
        const Lock = (props) => <IconBase {...props}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></IconBase>;
        const Briefcase = (props) => <IconBase {...props}><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></IconBase>;
        const ClipboardList = (props) => <IconBase {...props}><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></IconBase>;
        const Share = (props) => <IconBase {...props}><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></IconBase>;
        const ShieldCheck = (props) => <IconBase {...props}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="m9 12 2 2 4-4"/></IconBase>;
		const Users = (props) => <IconBase {...props}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></IconBase>;
        const UserMinus = (props) => <IconBase {...props}><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="23" y1="11" x2="17" y2="11"></line></IconBase>;
		const Info = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></IconBase>;
		const AlertTriangle = (props) => <IconBase {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></IconBase>;
		const BookOpen = (props) => <IconBase {...props}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></IconBase>;
		const Calendar = (props) => <IconBase {...props}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></IconBase>;
		const Filter = (props) => <IconBase {...props}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></IconBase>;
		const PieChart = (props) => <IconBase {...props}><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></IconBase>;
		const Sparkles = (props) => <IconBase {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></IconBase>;
		const Monitor = (props) => <IconBase {...props}><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></IconBase>;

        // --- LOADING OVERLAY ---
        function LoadingOverlay({ message }) {
            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[60] flex flex-col items-center justify-center text-white">
                    <div className="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
                    <p className="font-semibold text-lg animate-pulse">{message}</p>
                </div>
            );
        }
		
		// --- LOGIN VIEW (SPLIT SCREEN MODERN) ---
        function LoginView({ onLogin }) {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [showPass, setShowPass] = useState(false);
            const [error, setError] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault();
                setError('');
                setIsLoading(true);

                try {
                    // MENGIRIM PERMINTAAN LOGIN KE SERVER (GOOGLE APPS SCRIPT)
                    const response = await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: 'login',
                            payload: { username, password }
                        })
                    });
                    const result = await response.json();

                    if (result.status === 'success') {
                        Swal.fire({
                            icon: 'success',
                            title: 'Berhasil Masuk!',
                            text: `Selamat datang, ${result.user.username}`,
                            timer: 1500,
                            showConfirmButton: false
                        }).then(() => {
                            onLogin(result.user);
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Login Gagal',
                            text: result.message || 'Username atau Password Salah!'
                        });
                        setError(result.message || 'Username atau Password Salah!');
                    }
                } catch (err) {
                    setError('Gagal terhubung ke server. Pastikan internet lancar.');
                } finally {
                    setIsLoading(false);
                }
            };

            // Fungsi Info Pop-Up (Hanya untuk tampilan HP)
            const showInfoModal = () => {
                Swal.fire({
                    title: 'Informasi Aplikasi',
                    html: `
                        <div class="text-left text-sm space-y-3">
                            <p><strong>AKSARA-BK16</strong> dirancang khusus untuk mempermudah Guru Bimbingan dan Konseling dalam mengelola persuratan dan administrasi.</p>
                            <p class="font-bold border-b pb-1 mt-4">Cara Penggunaan:</p>
                            <ul class="list-decimal pl-5 space-y-1">
                                <li>Masukkan <strong>Username</strong> dan <strong>Password</strong>.</li>
                                <li>Pilih jenis layanan di menu sebelah kiri (Skorsing, Mediasi, dll).</li>
                                <li>Isi form yang disediakan. Nama siswa dapat dicari otomatis.</li>
                                <li>Klik <strong>Simpan</strong>, lalu gunakan tombol <strong>Cetak PDF</strong>.</li>
                            </ul>
                        </div>
                    `,
                    icon: 'info',
                    confirmButtonText: 'Tutup',
                    confirmButtonColor: '#3b82f6'
                });
            };

            return (
                <div className="min-h-screen w-full flex bg-slate-50 font-sans">
                    {isLoading && <LoadingOverlay message="Tunggu Yah..." />}
                    
                    {/* BAGIAN KIRI: INFO & BRANDING (Hanya Tampil di Layar Besar/Laptop) */}
                    <div className="hidden lg:flex lg:w-[55%] xl:w-[60%] bg-gradient-to-br from-blue-900 via-indigo-900 to-slate-900 relative flex-col justify-between p-12 overflow-hidden text-white shadow-[inset_-20px_0_40px_rgba(0,0,0,0.1)]">
                        {/* Efek Cahaya Dekoratif */}
                        <div className="absolute top-[-20%] left-[-10%] w-[70%] h-[70%] bg-blue-500/20 rounded-full blur-[120px] pointer-events-none"></div>
                        <div className="absolute bottom-[-10%] right-[-10%] w-[50%] h-[50%] bg-purple-500/20 rounded-full blur-[100px] pointer-events-none"></div>
                        
                        {/* Tekstur Pattern (Opsional) */}
                        <div className="absolute inset-0 bg-[url('https://source.unsplash.com/random/1920x1080/?abstract,geometric')] bg-cover opacity-5 mix-blend-overlay pointer-events-none"></div>

                        {/* Konten Kiri Atas - Logo & Tagline */}
						<div className="relative z-10 animate-fade-in-up">
							<div className="flex items-center gap-3 mb-8">
								
								{/* --- UBAH BAGIAN INI UNTUK LOGO DESKTOP --- */}
								<div className="w-24 h-30 bg-white/10 backdrop-blur-md rounded-2xl flex items-center justify-center border border-white/20 shadow-lg overflow-hidden">
									<img 
										src="https://lh3.googleusercontent.com/u/0/d/1Wr_uC9C32tjzN19PZXLsk3tyBNrzO1wy" 
										alt="Logo Aksara" 
										className="w-full h-full object-contain p-1" 
									/>
								</div>
								{/* ----------------------------------------- */}

								<div>
									<h1 className="text-3xl font-black tracking-tight text-white leading-none">AKSARA<span className="text-blue-400">-16</span></h1>
									<p className="text-[11px] text-blue-200 mt-1 font-bold tracking-[0.2em] uppercase">Aplikasi Persuratan Bimbingan dan Konseling</p>
								</div>
							</div>
                            <h2 className="text-4xl xl:text-5xl font-extrabold leading-tight mb-6 tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-white to-blue-200">
                                Mudahkan Langkah,<br/>Rapikan Administrasi Persuratan.
                            </h2>
                            <p className="text-blue-100/80 text-lg max-w-lg mb-12 leading-relaxed">
                                Asisten digital untuk kelancaran tata usaha Bimbingan dan Konseling. Buat, lacak, dan cetak berbagai dokumen persuratan siswa tanpa repot, di mana saja dan kapan saja.
                            </p>

                            {/* Fitur Utama / Cara Penggunaan (Grid) */}
                            <div className="grid grid-cols-2 gap-6 max-w-2xl">
                                <div className="bg-white/5 backdrop-blur-sm border border-white/10 p-5 rounded-2xl">
                                    <div className="bg-blue-500/20 w-10 h-10 rounded-xl flex items-center justify-center mb-4 border border-blue-400/30">
                                        <ShieldCheck size={20} className="text-blue-300"/>
                                    </div>
                                    <h3 className="font-bold text-white text-sm mb-1">Aman & Terpusat</h3>
                                    <p className="text-xs text-blue-100/60 leading-relaxed">Semua data tersimpan otomatis di Cloud. Tidak ada lagi dokumen kertas yang hilang.</p>
                                </div>
                                <div className="bg-white/5 backdrop-blur-sm border border-white/10 p-5 rounded-2xl">
                                    <div className="bg-purple-500/20 w-10 h-10 rounded-xl flex items-center justify-center mb-4 border border-purple-400/30">
                                        <Sparkles size={20} className="text-purple-300"/>
                                    </div>
                                    <h3 className="font-bold text-white text-sm mb-1">AI-Powered</h3>
                                    <p className="text-xs text-blue-100/60 leading-relaxed">Dilengkapi fitur Sulap AI untuk merangkai kalimat baku dan Radar Prediksi Risiko siswa.</p>
                                </div>
                                <div className="bg-white/5 backdrop-blur-sm border border-white/10 p-5 rounded-2xl">
                                    <div className="bg-emerald-500/20 w-10 h-10 rounded-xl flex items-center justify-center mb-4 border border-emerald-400/30">
                                        <Printer size={20} className="text-emerald-300"/>
                                    </div>
                                    <h3 className="font-bold text-white text-sm mb-1">Cetak Instan</h3>
                                    <p className="text-xs text-blue-100/60 leading-relaxed">Generate Berita Acara, Undangan, dan Surat Skorsing ke dalam format cetak PDF.</p>
                                </div>
                                <div className="bg-white/5 backdrop-blur-sm border border-white/10 p-5 rounded-2xl">
                                    <div className="bg-amber-500/20 w-10 h-10 rounded-xl flex items-center justify-center mb-4 border border-amber-400/30">
                                        <MessageCircle size={20} className="text-amber-300"/>
                                    </div>
                                    <h3 className="font-bold text-white text-sm mb-1">Integrasi WA</h3>
                                    <p className="text-xs text-blue-100/60 leading-relaxed">Kirim pemberitahuan dan surat panggilan langsung ke nomor WhatsApp Orang Tua.</p>
                                </div>
                            </div>
                        </div>

                        {/* Konten Kiri Bawah - Footer */}
                        <div className="relative z-10 text-xs text-blue-200/50 font-medium">
                            &copy; {new Date().getFullYear()} Mappaguru Online. Dikembangkan untuk Guru BK.
                        </div>
                    </div>

                    {/* BAGIAN KANAN: AREA LOGIN (Tampil Full di HP, Tampil Kanan di Laptop) */}
                    <div className="w-full lg:w-[45%] xl:w-[40%] flex items-center justify-center p-6 sm:p-12 relative bg-white lg:bg-slate-50">
                        
                        {/* Tombol Info (Hanya Muncul di HP, Karena di Laptop Infonya Ada di Kiri) */}
                        <button type="button" onClick={showInfoModal} className="lg:hidden absolute top-6 right-6 text-slate-400 hover:text-blue-600 bg-slate-100 hover:bg-blue-50 p-2.5 rounded-full transition-colors shadow-sm" title="Informasi Aplikasi">
                            <Info size={22} />
                        </button>

                       <div className="w-full max-w-[400px] animate-fade-in-up">
							{/* Header Form Kanan */}
							<div className="text-center mb-8 lg:text-left">
								
								{/* --- UBAH BAGIAN INI UNTUK LOGO MOBILE --- */}
								<div className="lg:hidden w-24 h-25 mx-auto mb-4 bg-white rounded-2xl flex items-center justify-center shadow-lg shadow-blue-500/30 overflow-hidden border border-slate-100">
									<img 
										src="https://lh3.googleusercontent.com/u/0/d/1Wr_uC9C32tjzN19PZXLsk3tyBNrzO1wy" 
										alt="Logo Aksara" 
										className="w-full h-full object-contain p-2" 
									/>
								</div>
								{/* ---------------------------------------- */}

								<h2 className="text-3xl font-black text-slate-800 mb-2">Selamat Datang ðŸ‘‹</h2>
								<p className="text-sm text-slate-500 font-medium">Silakan masuk ke akun konselor Anda untuk mengelola data hari ini.</p>
							</div>

                            {error && <div className="bg-red-50 border-l-4 border-red-500 text-red-700 p-4 rounded-r-lg text-sm mb-6 flex items-center gap-3"><AlertTriangle size={18} className="shrink-0"/> {error}</div>}
                            
                            <form onSubmit={handleLogin} className="space-y-5">
                                <div>
                                    <label className="block text-sm font-bold text-slate-700 mb-1.5 ml-1">Username / ID Konselor</label>
                                    <div className="relative group">
                                        <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                            <User className="h-5 w-5 text-slate-400 group-focus-within:text-blue-600 transition-colors" />
                                        </div>
                                        <input type="text" value={username} onChange={e => setUsername(e.target.value)} className="w-full pl-11 pr-4 py-3.5 bg-slate-100/50 border border-slate-200 rounded-2xl focus:bg-white focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 outline-none transition-all text-slate-700 font-semibold" placeholder="Contoh: Pak Hasratul" required />
                                    </div>
                                </div>
                                
                                <div>
                                    <label className="block text-sm font-bold text-slate-700 mb-1.5 ml-1">Password</label>
                                    <div className="relative group">
                                        <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                            <Lock className="h-5 w-5 text-slate-400 group-focus-within:text-blue-600 transition-colors" />
                                        </div>
                                        <input type={showPass ? "text" : "password"} value={password} onChange={e => setPassword(e.target.value)} className="w-full pl-11 pr-12 py-3.5 bg-slate-100/50 border border-slate-200 rounded-2xl focus:bg-white focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 outline-none transition-all text-slate-700 font-semibold" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required />
                                        <button type="button" onClick={() => setShowPass(!showPass)} className="absolute inset-y-0 right-0 pr-4 flex items-center text-slate-400 hover:text-slate-600 focus:outline-none">
                                            {showPass ? <EyeOff size={20}/> : <Eye size={20}/>}
                                        </button>
                                    </div>
                                </div>

                                <div className="pt-4">
                                    <button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-white font-black text-lg py-4 rounded-2xl shadow-lg shadow-blue-500/30 transform hover:-translate-y-1 transition-all duration-300 flex items-center justify-center gap-2">
                                        Masuk Aplikasi <ArrowLeft size={20} className="rotate-180" />
                                    </button>
                                </div>
                            </form>
                            
                            {/* Footer Mobile (Hidden in Desktop because Desktop has left side footer) */}
                            <div className="mt-8 text-center text-xs text-slate-400 font-medium lg:hidden">
                                &copy; {new Date().getFullYear()} UPT SPF SMPN 16 Makassar
                            </div>
                        </div>
                    </div>
                </div>
            )
        }
		
		// --- KIOSK MODE VIP (RESEPSIONIS DIGITAL PREMIUM) ---
        function KioskMode({ students, schoolData, onExit, letters, setLetters, currentUser }) {
            const [view, setView] = useState('welcome');
            const [tapCount, setTapCount] = useState(0);
            const [formData, setFormData] = useState({ name: '', studentName: '', studentClass: '', instansi: '' });
            const [searchQuery, setSearchQuery] = useState('');
            const [filteredStudents, setFilteredStudents] = useState([]);
            const [customPurpose, setCustomPurpose] = useState('');

            // Fitur Sandi Rahasia Keluar (Menggunakan Pop-Up SweetAlert Premium)
            const handleSecretTap = () => {
                if (tapCount >= 4) {
                    setTapCount(0);
                    Swal.fire({
                        title: 'ðŸ”’ Mode Administrator',
                        text: 'Masukkan PIN Rahasia Guru BK',
                        input: 'password',
                        inputPlaceholder: 'Ketik PIN...',
                        showCancelButton: true,
                        confirmButtonColor: '#3b82f6',
                        cancelButtonColor: '#ef4444',
                        confirmButtonText: 'Buka Sistem',
                        cancelButtonText: 'Batal'
                    }).then((result) => {
                        if (result.value === "552211") { // Ganti 1234 dengan PIN yang sahabat inginkan
                            onExit();
                        } else if (result.value) {
                            Swal.fire({ icon: 'error', title: 'Akses Ditolak!', text: 'PIN yang Anda masukkan salah.', showConfirmButton: false, timer: 2000 });
                        }
                    });
                } else {
                    setTapCount(prev => prev + 1);
                    setTimeout(() => setTapCount(0), 2000);
                }
            };

            const handleSearch = (e) => {
                const val = e.target.value;
                setSearchQuery(val);
                if (val.length > 2) {
                    setFilteredStudents(students.filter(s => s['Nama Lengkap'].toLowerCase().includes(val.toLowerCase())));
                } else {
                    setFilteredStudents([]);
                }
            };

            const handleSelectStudent = (s) => {
                setFormData({ ...formData, studentName: s['Nama Lengkap'], studentClass: s['Kelas'] });
                setSearchQuery(s['Nama Lengkap']);
                setFilteredStudents([]);
            };

            const handleSubmit = (purpose) => {
                let pName = '', pClass = '';
                if (view === 'form_siswa') {
                    pName = formData.studentName; pClass = formData.studentClass;
                } else if (view === 'form_ortu') {
                    pName = `Ortu: ${formData.name}`; pClass = `Wali dr ${formData.studentName} (${formData.studentClass})`;
                } else {
                    pName = `Tamu: ${formData.name}`; pClass = formData.instansi;
                }

                // Kirim Gaib ke Spreadsheet dengan Tanda Tangan Guru Piket
                const payload = {
                    id: Date.now(), type: 'BUKU_TAMU',
                    tanggal: new Date().toISOString().split('T')[0],
                    waktuAcara: new Date().toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'}),
                    namaSiswa: pName, kelas: pClass, keperluan: purpose, createdBy: 'Resepsionis Kiosk',
                    penandaTangan: currentUser.username, 
                    jabatan: 'Guru BK / Konselor Piket',
                    nipPenandaTangan: '-'
                };

                fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'saveLetter', payload }) });
                if (setLetters && letters) { setLetters([payload, ...letters]); }

                setView('success');
                setTimeout(() => { setView('welcome'); setFormData({ name: '', studentName: '', studentClass: '', instansi: '' }); setSearchQuery(''); setCustomPurpose(''); }, 3000);
            };

            return (
                <div className="fixed inset-0 z-[100] bg-[#020817] flex flex-col items-center justify-center p-4 md:p-8 text-white no-print select-none overflow-hidden font-sans">
                    {/* EFEK CAHAYA AMBIENT (GLOWING ORBS) */}
                    <div className="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none">
                        <div className="absolute top-[-15%] left-[-10%] w-[50%] h-[50%] bg-blue-600/20 rounded-full blur-[120px] animate-[pulse_8s_ease-in-out_infinite]"></div>
                        <div className="absolute bottom-[-10%] right-[-5%] w-[40%] h-[40%] bg-purple-600/20 rounded-full blur-[100px] animate-[pulse_10s_ease-in-out_infinite_reverse]"></div>
                    </div>
                    
                    {/* BACKGROUND TEXTURE */}
                    <div className="absolute inset-0 bg-[url('https://source.unsplash.com/random/1920x1080/?modern,architecture,interior')] bg-cover opacity-5 mix-blend-overlay pointer-events-none"></div>
                    
                    {/* HEADER KIOSK */}
                    <div className="absolute top-8 left-0 right-0 flex justify-center z-20">
                        <div onClick={handleSecretTap} className="cursor-pointer flex items-center gap-4 bg-white/5 backdrop-blur-xl px-8 py-3 rounded-full border border-white/10 shadow-[0_8px_30px_rgb(0,0,0,0.12)] hover:bg-white/10 transition-all duration-300 group">
                            {/* Logo Sekolah Pintar */}
                            <div className="w-12 h-12 rounded-full flex items-center justify-center overflow-hidden bg-white/20 group-hover:scale-110 transition-transform shadow-lg shadow-blue-500/30 border border-white/20">
                                {schoolData?.logoKanan ? (
                                    <img src={schoolData.logoKanan} alt="Logo" className="w-full h-full object-contain p-1 drop-shadow-md" />
                                ) : (
                                    <Building2 size={24} className="text-white" />
                                )}
                            </div>
                            <div className="text-left">
                                <h1 className="text-sm md:text-lg font-black tracking-widest text-transparent bg-clip-text bg-gradient-to-r from-white to-slate-400 uppercase">{schoolData.namaSekolah}</h1>
                                <p className="text-[10px] md:text-xs text-blue-400 font-semibold tracking-[0.2em] uppercase">Buku Tamu Digital Ruang BK</p>
                            </div>
                        </div>
                    </div>

                    {/* MAIN CONTAINER KACA MEWAH */}
                    <div className="w-full max-w-4xl bg-slate-900/60 backdrop-blur-2xl border border-slate-700/50 p-8 md:p-14 rounded-[2.5rem] shadow-[0_0_50px_rgba(0,0,0,0.5)] relative z-10 animate-fade-in-up">
                        
                        {/* VIEW 1: WELCOME */}
                        {view === 'welcome' && (
                            <div className="py-12 text-center">
                                <h2 className="text-5xl md:text-6xl font-black mb-6 tracking-tight text-transparent bg-clip-text bg-gradient-to-br from-white via-slate-200 to-slate-500 drop-shadow-sm">Selamat Datang ðŸ‘‹</h2>
                                <p className="text-xl md:text-2xl text-slate-400 mb-14 font-medium max-w-2xl mx-auto leading-relaxed">Pusat Layanan Terpadu Bimbingan dan Konseling. Silakan isi daftar hadir mandiri Anda.</p>
                                <button onClick={() => setView('role')} className="bg-white text-slate-900 hover:bg-blue-50 text-xl md:text-2xl font-black py-5 px-16 rounded-full shadow-[0_0_40px_rgba(255,255,255,0.2)] transform hover:scale-105 hover:-translate-y-1 transition-all duration-300 w-full md:w-auto flex items-center justify-center gap-3 mx-auto">
                                    <span className="animate-bounce">ðŸ‘†</span> SENTUH UNTUK MULAI
                                </button>
                            </div>
                        )}

                        {/* VIEW 2: PILIH PERAN */}
                        {view === 'role' && (
                            <div className="animate-fade-in-up text-center">
                                <h2 className="text-3xl font-bold mb-10 text-white tracking-wide">Pilih Identitas Anda</h2>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <button onClick={() => setView('form_siswa')} className="group relative bg-slate-800/50 hover:bg-blue-600/20 border border-slate-700 hover:border-blue-500/50 p-8 rounded-3xl cursor-pointer transition-all duration-300 hover:-translate-y-2 hover:shadow-[0_20px_40px_rgba(0,0,0,0.4)] overflow-hidden flex flex-col items-center gap-5">
                                        <div className="w-20 h-20 rounded-2xl bg-slate-800 border border-slate-600 group-hover:bg-blue-500 group-hover:border-blue-400 flex items-center justify-center transition-colors shadow-inner"><User size={40} className="text-blue-400 group-hover:text-white transition-colors"/></div>
                                        <span className="font-bold text-xl text-slate-300 group-hover:text-white transition-colors tracking-wide">SAYA SISWA</span>
                                    </button>
                                    
                                    <button onClick={() => setView('form_ortu')} className="group relative bg-slate-800/50 hover:bg-emerald-600/20 border border-slate-700 hover:border-emerald-500/50 p-8 rounded-3xl cursor-pointer transition-all duration-300 hover:-translate-y-2 hover:shadow-[0_20px_40px_rgba(0,0,0,0.4)] overflow-hidden flex flex-col items-center gap-5">
                                        <div className="w-20 h-20 rounded-2xl bg-slate-800 border border-slate-600 group-hover:bg-emerald-500 group-hover:border-emerald-400 flex items-center justify-center transition-colors shadow-inner"><Users size={40} className="text-emerald-400 group-hover:text-white transition-colors"/></div>
                                        <span className="font-bold text-xl text-slate-300 group-hover:text-white transition-colors tracking-wide">ORANG TUA / WALI</span>
                                    </button>
                                    
                                    <button onClick={() => setView('form_tamu')} className="group relative bg-slate-800/50 hover:bg-amber-600/20 border border-slate-700 hover:border-amber-500/50 p-8 rounded-3xl cursor-pointer transition-all duration-300 hover:-translate-y-2 hover:shadow-[0_20px_40px_rgba(0,0,0,0.4)] overflow-hidden flex flex-col items-center gap-5">
                                        <div className="w-20 h-20 rounded-2xl bg-slate-800 border border-slate-600 group-hover:bg-amber-500 group-hover:border-amber-400 flex items-center justify-center transition-colors shadow-inner"><Briefcase size={40} className="text-amber-400 group-hover:text-white transition-colors"/></div>
                                        <span className="font-bold text-xl text-slate-300 group-hover:text-white transition-colors tracking-wide">TAMU / INSTANSI</span>
                                    </button>
                                </div>
                                <button onClick={() => setView('welcome')} className="mt-12 text-slate-500 font-bold hover:text-white text-lg transition-colors flex items-center justify-center gap-2 mx-auto"><ArrowLeft size={20}/> Kembali</button>
                            </div>
                        )}

                        {/* VIEW 3: FORM SISWA */}
                        {view === 'form_siswa' && (
                            <div className="animate-fade-in-up">
                                <h2 className="text-3xl font-bold mb-8 text-center text-blue-100">Halo Siswa! Siapa namamu?</h2>
                                <div className="mb-8 relative max-w-2xl mx-auto">
                                    <Search className="absolute left-6 top-5 text-slate-400" size={28}/>
                                    <input type="text" value={searchQuery} onChange={handleSearch} placeholder="Ketik nama kamu di sini..." className="w-full pl-20 pr-6 py-5 text-xl bg-slate-950/50 border border-slate-600 text-white placeholder-slate-500 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all font-semibold shadow-inner" autoFocus />
                                    {filteredStudents.length > 0 && (
                                        <div className="absolute left-0 right-0 mt-3 bg-slate-800 border border-slate-700 rounded-2xl shadow-2xl overflow-hidden max-h-60 overflow-y-auto z-50 custom-scrollbar">
                                            {filteredStudents.map((s, i) => (
                                                <div key={i} onClick={() => handleSelectStudent(s)} className="p-5 hover:bg-blue-600 cursor-pointer border-b border-slate-700 text-white font-bold text-lg transition-colors">{s['Nama Lengkap']} <span className="text-slate-400 font-normal">({s['Kelas']})</span></div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                                {formData.studentName && (
                                    <div className="animate-fade-in-up mt-10">
                                        <p className="text-center text-blue-300 mb-6 font-bold text-lg tracking-wide uppercase">Pilih Keperluan Kehadiranmu:</p>
                                        <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                            {['Curhat / Konseling', 'Minta Tanda Tangan', 'Istirahat Sakit (UKS)', 'Izin Pulang / Keluar', 'Konsultasi Karir'].map(p => (
                                                <button key={p} onClick={() => handleSubmit(p)} className="bg-slate-800 hover:bg-blue-600 border border-slate-700 hover:border-blue-400 py-5 px-4 rounded-2xl font-bold text-white shadow-lg transition-all duration-300 hover:-translate-y-1">{p}</button>
                                            ))}
                                        </div>
                                        <div className="mt-4 flex gap-3">
                                            <input type="text" value={customPurpose} onChange={(e) => setCustomPurpose(e.target.value)} placeholder="Atau ketik keperluan lainnya..." className="flex-1 bg-slate-950/50 border border-slate-600 p-4 rounded-2xl outline-none text-white focus:ring-2 ring-blue-500 font-semibold text-lg" />
                                            <button onClick={() => { if(customPurpose.trim()) handleSubmit(customPurpose); }} className="bg-blue-600 hover:bg-blue-500 text-white px-8 rounded-2xl font-black text-lg shadow-lg shadow-blue-600/30 transition-all hover:scale-105">KIRIM</button>
                                        </div>
                                    </div>
                                )}
                                <div className="text-center mt-10"><button onClick={() => {setView('role'); setSearchQuery(''); setFormData({});}} className="text-slate-500 font-bold hover:text-white text-lg flex items-center justify-center gap-2 mx-auto"><ArrowLeft size={20}/> Batal</button></div>
                            </div>
                        )}

                        {/* VIEW 4: FORM ORTU */}
                        {view === 'form_ortu' && (
                            <div className="animate-fade-in-up">
                                <h2 className="text-3xl font-bold mb-8 text-center text-emerald-100">Buku Tamu Orang Tua / Wali</h2>
                                <div className="space-y-5 mb-8 max-w-2xl mx-auto">
                                    <input type="text" placeholder="Nama Lengkap Bapak/Ibu" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} className="w-full py-5 px-6 text-xl bg-slate-950/50 border border-slate-600 text-white placeholder-slate-500 rounded-2xl outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-all font-semibold" />
                                    <div className="relative">
                                        <Search className="absolute left-6 top-5 text-slate-400" size={28}/>
                                        <input type="text" value={searchQuery} onChange={handleSearch} placeholder="Cari Nama Siswa (Anak Bapak/Ibu)..." className="w-full pl-20 pr-6 py-5 text-xl bg-slate-950/50 border border-slate-600 text-white placeholder-slate-500 rounded-2xl outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-all font-semibold" />
                                        {filteredStudents.length > 0 && (
                                            <div className="absolute z-50 left-0 right-0 mt-3 bg-slate-800 border border-slate-700 rounded-2xl shadow-2xl overflow-hidden max-h-60 overflow-y-auto custom-scrollbar">
                                                {filteredStudents.map((s, i) => (
                                                    <div key={i} onClick={() => handleSelectStudent(s)} className="p-5 hover:bg-emerald-600 cursor-pointer border-b border-slate-700 text-white font-bold text-lg transition-colors">{s['Nama Lengkap']} <span className="text-slate-400 font-normal">({s['Kelas']})</span></div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </div>
                                {formData.name && formData.studentName && (
                                    <div className="animate-fade-in-up mt-10 max-w-3xl mx-auto">
                                        <p className="text-center text-emerald-300 mb-6 font-bold text-lg tracking-wide uppercase">Tujuan Kunjungan:</p>
                                        <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                            {['Memenuhi Undangan', 'Konsultasi Mandiri', 'Menjemput Anak Sakit'].map(p => (
                                                <button key={p} onClick={() => handleSubmit(p)} className="bg-slate-800 hover:bg-emerald-600 border border-slate-700 hover:border-emerald-400 py-5 px-4 rounded-2xl font-bold text-white shadow-lg transition-all duration-300 hover:-translate-y-1">{p}</button>
                                            ))}
                                        </div>
                                        <div className="mt-4 flex gap-3">
                                            <input type="text" value={customPurpose} onChange={(e) => setCustomPurpose(e.target.value)} placeholder="Atau ketik keperluan lainnya..." className="flex-1 bg-slate-950/50 border border-slate-600 p-4 rounded-2xl outline-none text-white focus:ring-2 ring-emerald-500 font-semibold text-lg" />
                                            <button onClick={() => { if(customPurpose.trim()) handleSubmit(customPurpose); }} className="bg-emerald-600 hover:bg-emerald-500 text-white px-8 rounded-2xl font-black text-lg shadow-lg shadow-emerald-600/30 transition-all hover:scale-105">KIRIM</button>
                                        </div>
                                    </div>
                                )}
                                <div className="text-center mt-10"><button onClick={() => {setView('role'); setSearchQuery(''); setFormData({});}} className="text-slate-500 font-bold hover:text-white text-lg flex items-center justify-center gap-2 mx-auto"><ArrowLeft size={20}/> Batal</button></div>
                            </div>
                        )}

                        {/* VIEW 5: FORM TAMU */}
                        {view === 'form_tamu' && (
                            <div className="animate-fade-in-up">
                                <h2 className="text-3xl font-bold mb-8 text-center text-amber-100">Buku Tamu Umum / Instansi</h2>
                                <div className="space-y-5 mb-8 max-w-2xl mx-auto">
                                    <input type="text" placeholder="Nama Lengkap" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} className="w-full py-5 px-6 text-xl bg-slate-950/50 border border-slate-600 text-white placeholder-slate-500 rounded-2xl outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-all font-semibold" />
                                    <input type="text" placeholder="Asal Instansi / Jabatan (Cth: Polsek / Guru IPA)" value={formData.instansi} onChange={e => setFormData({...formData, instansi: e.target.value})} className="w-full py-5 px-6 text-xl bg-slate-950/50 border border-slate-600 text-white placeholder-slate-500 rounded-2xl outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-all font-semibold" />
                                </div>
                                {formData.name && formData.instansi && (
                                    <div className="animate-fade-in-up mt-10 max-w-3xl mx-auto">
                                        <p className="text-center text-amber-300 mb-6 font-bold text-lg tracking-wide uppercase">Tujuan Kunjungan:</p>
                                        <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                            {['Koordinasi / Rapat', 'Kunjungan Dinas', 'Konsultasi Teman Sejawat'].map(p => (
                                                <button key={p} onClick={() => handleSubmit(p)} className="bg-slate-800 hover:bg-amber-600 border border-slate-700 hover:border-amber-400 py-5 px-4 rounded-2xl font-bold text-white shadow-lg transition-all duration-300 hover:-translate-y-1">{p}</button>
                                            ))}
                                        </div>
                                        <div className="mt-4 flex gap-3">
                                            <input type="text" value={customPurpose} onChange={(e) => setCustomPurpose(e.target.value)} placeholder="Atau ketik keperluan lainnya..." className="flex-1 bg-slate-950/50 border border-slate-600 p-4 rounded-2xl outline-none text-white focus:ring-2 ring-amber-500 font-semibold text-lg" />
                                            <button onClick={() => { if(customPurpose.trim()) handleSubmit(customPurpose); }} className="bg-amber-600 hover:bg-amber-500 text-white px-8 rounded-2xl font-black text-lg shadow-lg shadow-amber-600/30 transition-all hover:scale-105">KIRIM</button>
                                        </div>
                                    </div>
                                )}
                                <div className="text-center mt-10"><button onClick={() => {setView('role'); setSearchQuery(''); setFormData({});}} className="text-slate-500 font-bold hover:text-white text-lg flex items-center justify-center gap-2 mx-auto"><ArrowLeft size={20}/> Batal</button></div>
                            </div>
                        )}

                        {/* VIEW 6: SUCCESS */}
                        {view === 'success' && (
                            <div className="py-20 animate-fade-in-up text-center">
                                <div className="w-32 h-32 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-8 shadow-[0_0_50px_rgba(34,197,94,0.6)] animate-bounce"><ShieldCheck size={64} className="text-white"/></div>
                                <h2 className="text-5xl font-black mb-4 text-white">Berhasil!</h2>
                                <p className="text-xl text-green-200 font-medium">Data kunjungan Anda telah tersimpan aman di sistem.<br/>Silakan masuk atau menunggu giliran.</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // --- APP LOGIC ---
        function App() {
            const [currentUser, setCurrentUser] = useState(null);
            
            const [activeTab, setActiveTab] = useState('dashboard');
            const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
            const [isSidebarOpen, setIsSidebarOpen] = useState(true);
            const [itemsPerPage, setItemsPerPage] = useState(5);
            const [currentPage, setCurrentPage] = useState(1);
            
            const [schoolData, setSchoolData] = useState({
                pemerintah: 'PEMERINTAH PROVINSI',
                instansi: 'DINAS PENDIDIKAN',
                namaSekolah: 'NAMA SEKOLAH ANDA',
                alamat: 'Alamat Sekolah Lengkap...',
                logoKiri: '', 
                logoKanan: '',
                users: []
            });

            const [letters, setLetters] = useState([]);
            // DATA BARU DARI BACKEND
            const [students, setStudents] = useState([]);
            const [classes, setClasses] = useState([]);
            const [officials, setOfficials] = useState([]);

            const [loadingState, setLoadingState] = useState({ isLoading: false, message: '' });
			
			// --- FITUR BARU: COMMAND PALETTE ---
            const [isCmdOpen, setIsCmdOpen] = useState(false);
            const [cmdQuery, setCmdQuery] = useState('');

            useEffect(() => {
                const handleKeyDown = (e) => {
                    // Jika tekan Ctrl + K atau Cmd + K
                    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                        e.preventDefault();
                        setIsCmdOpen(prev => !prev);
                        setCmdQuery('');
                    }
                    // Jika tekan tombol Esc (Escape)
                    if (e.key === 'Escape') setIsCmdOpen(false);
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, []);

            useEffect(() => {
                if (APPS_SCRIPT_URL !== "PASTE_URL_APPS_SCRIPT_DISINI") {
                    fetchData();
                }
            }, []);

            const fetchData = async () => {
                setLoadingState({ isLoading: true, message: 'Sinkronisasi Data...' });
                try {
                    const response = await fetch(APPS_SCRIPT_URL);
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        // Data Surat & Sekolah
                        setLetters(result.data.letters || []);
                        if (result.data.school) {
                            setSchoolData(result.data.school);
                        }
                        // DATA BARU: Simpan ke state
                        if (result.data.students) setStudents(result.data.students);
                        if (result.data.classes) setClasses(result.data.classes);
                        if (result.data.officials) setOfficials(result.data.officials);

                    } else {
                        alert('Gagal mengambil data: ' + result.message);
                    }
                } catch (error) {
                    console.error("Error fetching:", error);
                } finally {
                    setLoadingState({ isLoading: false, message: '' });
                }
            };

            const [viewState, setViewState] = useState('list');
            const [selectedLetter, setSelectedLetter] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
			// --- STATE FILTER LANJUTAN ---
            const [filterType, setFilterType] = useState('Semua');
            const [filterCreator, setFilterCreator] = useState('Semua');
            const [filterStartDate, setFilterStartDate] = useState('');
            const [filterEndDate, setFilterEndDate] = useState('');

            // --- PILIHAN DROPDOWN DINAMIS ---
            const uniqueCreators = ['Semua', ...new Set(letters.map(l => l.createdBy).filter(Boolean))];
            const letterTypesList = ['Semua', 'SKORSING', 'PERNYATAAN', 'KONTRAK', 'UNDANGAN', 'TUGAS_HOMEVISIT', 'LAPORAN_HOMEVISIT', 'ALIH_KASUS', 'MEDIASI', 'KONFERENSI_KASUS', 'ADVOKASI', 'BIMBINGAN_KELOMPOK', 'KONSELING_KELOMPOK', 'SKBB', 'BERHENTI', 'BUKU_TAMU', 'REKOMENDASI_STUDI'];
            const [historyStudent, setHistoryStudent] = useState(null);

            useEffect(() => { setCurrentPage(1); }, [activeTab, searchTerm, itemsPerPage, filterType, filterCreator, filterStartDate, filterEndDate]);

            // ACTIONS
            const handleDelete = (id) => {
                Swal.fire({
                    title: 'Yakin ingin menghapus?',
                    text: "Data surat ini akan dihapus permanen dari Database!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Ya, Hapus!',
                    cancelButtonText: 'Batal'
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        setLoadingState({ isLoading: true, message: 'Menghapus data...' });
                        try {
                            await fetch(APPS_SCRIPT_URL, {
                                method: 'POST',
                                body: JSON.stringify({ action: 'deleteLetter', payload: { id } })
                            });
                            setLetters(letters.filter(l => l.id !== id));
                            if (selectedLetter && selectedLetter.id === id) { setViewState('list'); setSelectedLetter(null); }
                            
                            // Notifikasi sukses
                            Swal.fire('Terhapus!', 'Data surat berhasil dihapus.', 'success');
                        } catch (error) { 
                            Swal.fire('Gagal!', 'Gagal menghapus data. Periksa koneksi internet.', 'error');
                        } finally { 
                            setLoadingState({ isLoading: false, message: '' }); 
                        }
                    }
                });
            };

            const handleSaveLetter = async (formData) => {
                setLoadingState({ isLoading: true, message: 'Menyimpan Surat ...' });
                const newData = { 
                    ...formData, 
                    id: formData.id || Date.now(),
                    createdBy: formData.id ? formData.createdBy : currentUser.username,
                    lastEditedBy: currentUser.username
                };

                try {
                    await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'saveLetter', payload: newData })
                    });
                    
                    if (viewState === 'create') { setLetters([ newData, ...letters ]); } 
                    else if (viewState === 'edit') { setLetters(letters.map(l => l.id === newData.id ? newData : l)); }
                    
                    setViewState('list');
                    setSelectedLetter(null);
                    Swal.fire({
                        icon: 'success',
                        title: 'Tersimpan!',
                        text: 'Data surat berhasil disimpan ke database.',
                        timer: 1500,
                        showConfirmButton: false
                    });
                } catch (error) { 
                    Swal.fire('Gagal!', 'Terjadi kesalahan saat menyimpan data.', 'error');
                } finally {
                    // BARIS INI YANG SEBELUMNYA HILANG
                    setLoadingState({ isLoading: false, message: '' }); 
                }
            };

            const handleSaveSchoolData = async (data) => {
                setLoadingState({ isLoading: true, message: 'Menyimpan Pengaturan...' });
                try {
                    await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'saveSchoolData', payload: data })
                    });
                    setSchoolData(data);
                    setViewState('list');
                    Swal.fire({
                        icon: 'success',
                        title: 'Pengaturan Disimpan!',
                        showConfirmButton: false,
                        timer: 1500
                    });
                } catch (error) { 
                    Swal.fire('Gagal!', 'Gagal menyimpan pengaturan sekolah.', 'error');
                } finally {
                    // PASTIKAN BARIS INI JUGA ADA DI SINI
                    setLoadingState({ isLoading: false, message: '' }); 
                }
            };

            /// --- FUNGSI BARU: DYNAMIC WA TEMPLATES (LENGKAP & TANPA EMOJI) ---
            const handleSendWA = (letter) => {
                if (!letter.noHpOrangTua) {
                    Swal.fire('Oops!', 'Nomor HP Orang Tua belum diisi pada surat ini.', 'warning');
                    return;
                }
                
                // Format nomor HP (ubah awalan 0 jadi 62)
                let phone = letter.noHpOrangTua.replace(/\D/g, '');
                if (phone.startsWith('0')) phone = '62' + phone.slice(1);
                
                // Siapkan template dasar (Header & Footer)
                let textMsg = "";
                const salam = `Yth. Bapak/Ibu Wali dari ananda *${letter.namaSiswa}* (Kelas ${letter.kelas}).\n\n`;
                const penutup = `\n\nTerima kasih atas perhatian dan kerjasamanya.\nSalam,\n*Tim BK ${schoolData.namaSekolah}*`;

                // Logika pencabangan pesan berdasarkan jenis layanan
                switch (letter.type) {
                    case 'SKORSING':
                        textMsg = salam + `Kami sampaikan bahwa ananda diberikan sanksi pembinaan berupa *SKORSING* selama ${letter.lamaSkorsing} (dari tanggal ${formatDate(letter.tanggalMulai)} s.d. ${formatDate(letter.tanggalSelesai)}).\n\n*Alasan:* ${letter.alasan}\n\nSelama masa skorsing, mohon Bapak/Ibu dapat mengawasi dan membimbing ananda di rumah.` + penutup;
                        break;
                    case 'UNDANGAN':
                        textMsg = salam + `Kami mengundang Bapak/Ibu untuk hadir ke sekolah pada:\n\n1. Hari/Tgl : *${letter.hariTanggalAcara}*\n2. Waktu    : *${letter.waktuAcara}*\n3. Tempat   : *${letter.tempatAcara}*\n4. Keperluan: *${letter.keperluan}*\n\nMengingat pentingnya agenda ini, kami sangat mengharapkan kehadiran Bapak/Ibu tepat waktu.` + penutup;
                        break;
                    case 'TUGAS_HOMEVISIT':
                    case 'LAPORAN_HOMEVISIT':
                        textMsg = salam + `Kami dari Tim BK bermaksud melakukan Kunjungan Rumah (Home Visit) pada:\n\n1. Hari/Tgl : *${letter.hariTanggalAcara || '-'}*\n2. Waktu    : *${letter.waktuAcara || '-'}*\n3. Tujuan   : *${letter.keperluan || 'Silaturahmi dan koordinasi perkembangan siswa'}*\n\nMohon kesediaan Bapak/Ibu untuk menerima kunjungan kami.` + penutup;
                        break;
                    case 'PERNYATAAN':
                    case 'KONTRAK':
                        textMsg = salam + `Kami informasikan bahwa ananda telah membuat *${letter.type === 'PERNYATAAN' ? 'Surat Pernyataan' : 'Kontrak Perilaku'}* di sekolah terkait kedisiplinan.\n\nMohon Bapak/Ibu dapat memantau perkembangan dan perubahan perilaku ananda di rumah.` + penutup;
                        break;
                    case 'MEDIASI':
                    case 'KONFERENSI_KASUS':
                        textMsg = salam + `Sehubungan dengan dinamika perkembangan ananda di sekolah, kami mengundang Bapak/Ibu untuk hadir dalam agenda *${letter.type.replace('_', ' ')}* pada:\n\n1. Hari/Tgl : *${letter.hariTanggalAcara || formatDate(letter.tanggal)}*\n2. Waktu    : *${letter.waktuAcara || 'Menyesuaikan'}*\n3. Tempat   : *${letter.tempatAcara || 'Ruang BK'}*\n\nKehadiran dan dukungan Bapak/Ibu sangat berarti bagi penyelesaian masalah ananda.` + penutup;
                        break;
                    case 'ALIH_KASUS':
                        textMsg = salam + `Sehubungan dengan proses pembinaan ananda, kami informasikan bahwa sekolah melakukan *Alih Tangan Kasus (Referral)* kepada pihak yang lebih berwenang, yaitu: *${letter.pihakTujuan}*.\n\nHal ini kami lakukan untuk memastikan ananda mendapatkan pendampingan yang maksimal.` + penutup;
                        break;
                    case 'ADVOKASI':
                        textMsg = salam + `Kami informasikan bahwa Tim BK telah melakukan upaya *Advokasi* (pendampingan hak siswa) terkait permasalahan ananda bersama *${letter.pihakTerkait}*.\n\n1. Tujuan : *${letter.tujuanAdvokasi}*\n2. Hasil  : *${letter.hasilAdvokasi}*\n\nSemoga langkah ini dapat membantu kelancaran pendidikan ananda.` + penutup;
                        break;
                    case 'BERHENTI':
                        textMsg = salam + `Kami mengonfirmasi bahwa proses administrasi *Pengunduran Diri / Berhenti* ananda dari sekolah telah kami terima dan catat pada tanggal *${formatDate(letter.tanggal)}*.\n\nTerima kasih atas kepercayaan Bapak/Ibu selama ini.` + penutup;
                        break;
                    default:
                        textMsg = salam + `Berikut kami sampaikan informasi persuratan sekolah terkait layanan *${letter.type.replace('_', ' ')}* dengan nomor registrasi: ${letter.nomorSurat || '-'}.\n\nMohon untuk diperhatikan.` + penutup;
                        break;
                }

                // encodeURIComponent memastikan format teks terbaca aman di link WA
                const encodedMessage = encodeURIComponent(textMsg);
                window.open(`https://wa.me/${phone}?text=${encodedMessage}`, '_blank');
            };
            // -----------------------------------------------------------------

            const handleExportExcel = () => {
                // 1. Fungsi kecil pelindung (escape) agar tanda kutip (") atau koma (,) di inputan guru tidak merusak kolom Excel
                const escapeCSV = (str) => {
                    if (str === null || str === undefined) return '""';
                    const text = String(str);
                    return `"${text.replace(/"/g, '""')}"`; // Ubah " jadi "" sesuai standar CSV
                };

                // 2. Header kolom Excel
                const header = ["ID", "Jenis Surat", "Nomor Surat", "Tanggal", "Nama Siswa", "Kelas", "Keterangan/Perihal", "Pembuat"];
                
                // 3. Menggunakan 'filteredLetters' (Bukan 'letters') agar yang diekspor HANYA yang tampil di tabel saat ini
                const rows = filteredLetters.map(l => [
                    l.id, 
                    escapeCSV(l.type.replace('_', ' ')), 
                    escapeCSV(l.nomorSurat || '-'), 
                    escapeCSV(formatDate(l.tanggal)), 
                    escapeCSV(l.namaSiswa), 
                    escapeCSV(l.kelas), 
                    escapeCSV(l.alasan || l.permasalahan || l.perihal || l.keperluan || l.gambaranMasalah || l.alasanBerhenti || '-'), 
                    escapeCSV(l.createdBy || '-')
                ]);
                
                const csvContent = header.join(",") + "\n" + rows.map(e => e.join(",")).join("\n");
                
                // 4. Menggunakan Blob & BOM (\ufeff) agar Excel membaca karakter khusus dengan sempurna (UTF-8 format)
                const blob = new Blob(["\ufeff", csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", `Laporan_Surat_BK_${new Date().toISOString().slice(0,10)}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link); // Bersihkan sisa link setelah download
                
                // Alert kecil sebagai pemanis
                Swal.fire({
                    icon: 'success',
                    title: 'Berhasil Diunduh!',
                    text: `Laporan sebanyak ${filteredLetters.length} surat telah diekspor.`,
                    timer: 2000,
                    showConfirmButton: false
                });
            };

            // Filtering
            // Filtering Lanjutan
            const filteredLetters = letters
                .filter(l => {
                    if (viewState === 'history' && historyStudent) {
                        return l.namaSiswa.toLowerCase() === historyStudent.toLowerCase();
                    }
                    
                    // 1. Filter Menu Samping (Active Tab)
                    if (activeTab !== 'dashboard' && l.type !== activeTab) return false;

                    // 2. Filter Pencarian Teks
                    const search = searchTerm.toLowerCase();
                    const matchesSearch = (l.namaSiswa && l.namaSiswa.toLowerCase().includes(search)) || 
                                          (l.nomorSurat && l.nomorSurat.toLowerCase().includes(search));
                    if (!matchesSearch) return false;

                    // 3. Filter Jenis Surat
                    if (filterType !== 'Semua' && l.type !== filterType) return false;

                    // 4. Filter Nama Guru (Pembuat)
                    if (filterCreator !== 'Semua' && l.createdBy !== filterCreator) return false;

                    // 5. Filter Rentang Tanggal
                    const letterDate = new Date(l.tanggal);
                    if (filterStartDate && letterDate < new Date(filterStartDate)) return false;
                    if (filterEndDate && letterDate > new Date(filterEndDate)) return false;

                    return true; // Jika lolos semua filter, tampilkan!
                })
                .sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));

            const indexOfLastItem = currentPage * itemsPerPage;
            const indexOfFirstItem = indexOfLastItem - itemsPerPage;
            const currentLetters = itemsPerPage === 'semua' ? filteredLetters : filteredLetters.slice(indexOfFirstItem, indexOfLastItem);
            const totalPages = itemsPerPage === 'semua' ? 1 : Math.ceil(filteredLetters.length / itemsPerPage);
            const headerDate = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            // Dashboard Stats Logic
            const getDashboardStats = () => {
                const types = [
                    { key: 'SKORSING', label: 'Skorsing', icon: <FileWarning/>, color: 'text-red-600', bg: 'bg-red-50', border: 'border-red-200' },
                    { key: 'PERNYATAAN', label: 'Pernyataan', icon: <FileSignature/>, color: 'text-orange-600', bg: 'bg-orange-50', border: 'border-orange-200' },
                    { key: 'UNDANGAN', label: 'Undangan', icon: <Mail/>, color: 'text-blue-600', bg: 'bg-blue-50', border: 'border-blue-200' },
                    { key: 'KONTRAK', label: 'Kontrak Perilaku', icon: <FileCheck/>, color: 'text-emerald-600', bg: 'bg-emerald-50', border: 'border-emerald-200' },
                    { key: 'TUGAS_HOMEVISIT', label: 'Tugas H.Visit', icon: <Briefcase/>, color: 'text-indigo-600', bg: 'bg-indigo-50', border: 'border-indigo-200' },
                    { key: 'LAPORAN_HOMEVISIT', label: 'Laporan H.Visit', icon: <ClipboardList/>, color: 'text-cyan-600', bg: 'bg-cyan-50', border: 'border-cyan-200' },
					{ key: 'MEDIASI', label: 'Mediasi', icon: <Users/>, color: 'text-pink-600', bg: 'bg-pink-50', border: 'border-pink-200' },
					{ key: 'ADVOKASI', label: 'Advokasi', icon: <MessageCircle/>, color: 'text-rose-600', bg: 'bg-rose-50', border: 'border-rose-200' },
					{ key: 'BIMBINGAN_KELOMPOK', label: 'Bim. Kelompok', icon: <Users/>, color: 'text-emerald-600', bg: 'bg-emerald-50', border: 'border-emerald-200' },
					{ key: 'KONSELING_KELOMPOK', label: 'Kon. Kelompok', icon: <MessageCircle/>, color: 'text-violet-600', bg: 'bg-violet-50', border: 'border-violet-200' },
                    { key: 'ALIH_KASUS', label: 'Alih Kasus', icon: <Share/>, color: 'text-purple-600', bg: 'bg-purple-50', border: 'border-purple-200' },
					{ key: 'KONFERENSI_KASUS', label: 'Konf. Kasus', icon: <Users/>, color: 'text-indigo-600', bg: 'bg-indigo-50', border: 'border-indigo-200' },
                    { key: 'SKBB', label: 'Ket. Baik', icon: <ShieldCheck/>, color: 'text-teal-600', bg: 'bg-teal-50', border: 'border-teal-200' },
					{ key: 'BERHENTI', label: 'Berhenti/Keluar', icon: <UserMinus/>, color: 'text-gray-600', bg: 'bg-gray-50', border: 'border-gray-200' },
					{ key: 'REKOMENDASI_STUDI', label: 'Rekomendasi', icon: <FileCheck/>, color: 'text-blue-600', bg: 'bg-blue-50', border: 'border-blue-200' },
					{ key: 'BUKU_TAMU', label: 'Buku Tamu', icon: <BookOpen/>, color: 'text-sky-600', bg: 'bg-sky-50', border: 'border-sky-200' },
                ];
                return types.map(t => ({
                    ...t,
                    count: letters.filter(l => l.type === t.key).length
                }));
            };
			
			// --- LOGIKA SMART DASHBOARD ---
            const getRedZoneStudents = () => {
                const problemTypes = ['SKORSING', 'PERNYATAAN', 'KONTRAK', 'KONFERENSI_KASUS', 'MEDIASI'];
                const counts = {};
                letters.forEach(l => {
                    if(problemTypes.includes(l.type) && l.namaSiswa) { counts[l.namaSiswa] = (counts[l.namaSiswa] || 0) + 1; }
                });
                return Object.entries(counts).map(([nama, count]) => ({ nama, count })).filter(item => item.count >= 2).sort((a,b) => b.count - a.count).slice(0, 5);
            };
			
			// --- AI PREDICTIVE ANALYTICS (MESIN PERAMAL) ---
            const getAIPredictions = () => {
                const problemTypes = ['SKORSING', 'PERNYATAAN', 'KONTRAK', 'MEDIASI', 'KONFERENSI_KASUS'];
                const studentStats = {};
                const now = new Date();

                // Membaca pola dari database
                letters.forEach(l => {
                    if (problemTypes.includes(l.type) && l.namaSiswa) {
                        if (!studentStats[l.namaSiswa]) {
                            studentStats[l.namaSiswa] = { counts: 0, lastDate: new Date(l.tanggal), types: [], kelas: l.kelas };
                        }
                        studentStats[l.namaSiswa].counts += 1;
                        studentStats[l.namaSiswa].types.push(l.type);
                        const lDate = new Date(l.tanggal);
                        if (lDate > studentStats[l.namaSiswa].lastDate) {
                            studentStats[l.namaSiswa].lastDate = lDate;
                        }
                    }
                });

                const predictions = [];
                Object.keys(studentStats).forEach(nama => {
                    const stat = studentStats[nama];
                    const daysSinceLast = Math.floor((now - stat.lastDate) / (1000 * 60 * 60 * 24));
                    
                    // Algoritma Penilaian Risiko Dasar (Nilai awal 5 poin, jumlah kasus x 5)
                    let score = 5 + (stat.counts * 5); 
                    
                    // Jika ada kejadian berulang/baru dalam kurun waktu 7 hari, tambah 10 poin
                    if (daysSinceLast <= 7) score += 10; 
                    
                    // Punya riwayat skorsing tetap tambah 15 poin
                    if (stat.types.includes('SKORSING')) score += 15; 
                    
                    if (score > 98) score = 98; // Maksimal 98%

                    // Hanya tampilkan jika skor mencapai 25% ke atas
                    if (score >= 25) {
                        let insight = "";
                        if (daysSinceLast <= 7) insight = `Jeda pelanggaran sangat pendek (${daysSinceLast} hari lalu). Rawan terjadi eskalasi minggu ini.`;
                        else if (stat.counts >= 3) insight = `Pola historis berulang terdeteksi (${stat.counts} kasus). Diperlukan intervensi & pendekatan preventif segera.`;
                        else if (stat.types.includes('SKORSING')) insight = `Riwayat sanksi berat sebelumnya. Probabilitas mengulangi pelanggaran cukup tinggi.`;
                        else insight = `Terdapat indikasi penurunan kedisiplinan beruntun. Jadwalkan pemanggilan konseling.`;

                        predictions.push({ nama, kelas: stat.kelas, score, insight, daysSinceLast });
                    }
                });

                // Urutkan dari yang paling berbahaya, ambil 4 teratas agar pas 1 baris
                return predictions.sort((a, b) => b.score - a.score);
            };

            const getChartData = () => {
Â  Â  Â  Â  Â  Â  Â  Â  const stats = getDashboardStats().filter(s => s.count > 0).sort((a,b) => b.count - a.count);
Â  Â  Â  Â  Â  Â  Â  Â  const max = Math.max(...stats.map(s => s.count), 1);
Â  Â  Â  Â  Â  Â  Â  Â  return stats.map(s => ({ ...s, percentage: (s.count / max) * 100 }));
Â  Â  Â  Â  Â  Â  };

            const getClassChartData = () => {
                const counts = {};
                letters.forEach(l => {
                    if(l.kelas) { counts[l.kelas] = (counts[l.kelas] || 0) + 1; }
                });
                // Sortir diubah menjadi berdasarkan Abjad/Angka kelas (A-Z)
                const stats = Object.entries(counts).map(([label, count]) => ({ label, count })).sort((a, b) => a.label.localeCompare(b.label, 'id', { numeric: true }));
                const max = Math.max(...stats.map(s => s.count), 1);
                return stats.map(s => ({ ...s, percentage: (s.count / max) * 100 }));
            };
			
			// --- FUNGSI BARU: SMART SCANNER TREN MASALAH (VERSI PRO) ---
            const getProblemTrends = () => {
                const counts = {};
                letters.forEach(l => {
                    // Gabungkan semua field teks yang mungkin berisi deskripsi masalah (ditambah gambaranMasalah untuk home visit)
                    let text = (l.alasan || l.permasalahan || l.fokusMasalah || l.gambaranMasalah || '').toLowerCase();
                    if (!text) return; // Lewati jika kosong
                    
                    let category = 'Lain-lain';
                    
                    // ==========================================
                    // DATABASE KATA KUNCI (KEYWORD SCANNER)
                    // ==========================================
                    // 1. Kehadiran & Keterlambatan
                    if (text.includes('terlambat') || text.includes('telat') || text.includes('kesiangan')) category = 'Sering Terlambat';
                    else if (text.includes('alpa') || text.includes('bolos') || text.includes('tidak masuk') || text.includes('ponteng') || text.includes('cabut')) category = 'Bolos / Alpa / Kabur';
                    else if (text.includes('pagar') || text.includes('lompat')) category = 'Melompat Pagar';
                    
                    // 2. Fisik & Atribut
                    else if (text.includes('atribut') || text.includes('seragam') || text.includes('sepatu') || text.includes('rambut') || text.includes('kuku') || text.includes('topi') || text.includes('dasi') || text.includes('tato') || text.includes('tindik') || text.includes('make up') || text.includes('lipstik') || text.includes('celana ketat')) category = 'Pelanggaran Atribut & Kerapian';
                    
                    // 3. Kekerasan & Bullying
                    else if (text.includes('bully') || text.includes('perundungan') || text.includes('ejek') || text.includes('palak') || text.includes('ancam') || text.includes('memeras') || text.includes('olok')) category = 'Bullying / Pemalakan / Ancaman';
                    else if (text.includes('kelahi') || text.includes('pukul') || text.includes('ribut') || text.includes('tawuran') || text.includes('bertengkar')) category = 'Berkelahi / Tawuran';
                    else if (text.includes('sajam') || text.includes('senjata') || text.includes('badik') || text.includes('busur')) category = 'Membawa Senjata Tajam';
                    
                    // 4. Zat Adiktif
                    else if (text.includes('rokok') || text.includes('merokok') || text.includes('vape') || text.includes('pod')) category = 'Merokok / Vape';
                    else if (text.includes('miras') || text.includes('alkohol') || text.includes('minum') || text.includes('obat') || text.includes('narkoba')) category = 'Miras / Narkoba / Zat Terlarang';
                    
                    // 5. Etika, Sikap & Susila
                    else if (text.includes('melawan') || text.includes('membantah') || text.includes('kasar') || text.includes('kotor') || text.includes('sopan')) category = 'Sikap Kurang Sopan / Melawan Guru';
                    else if (text.includes('pacaran') || text.includes('asusila') || text.includes('mesum') || text.includes('porno') || text.includes('pelecehan') || text.includes('video')) category = 'Pelanggaran Susila / Asmara / Pornografi';
                    
                    // 6. Akademik & Barang Bawaan
                    else if (text.includes('hp') || text.includes('handphone') || text.includes('ponsel') || text.includes('game') || text.includes('gawai') || text.includes('mabar')) category = 'Penyalahgunaan HP / Bermain Game';
                    else if (text.includes('tugas') || text.includes('pr ') || text.includes('contek') || text.includes('ujian') || text.includes('malas') || text.includes('tugas tidak')) category = 'Masalah Akademik / Abaikan Tugas';
                    
                    // 7. Lingkungan
                    else if (text.includes('rusak') || text.includes('coret') || text.includes('vandalisme') || text.includes('sampah') || text.includes('fasilitas')) category = 'Merusak Fasilitas / Kebersihan';
                    
                    // 8. Fallback (Jika teksnya diketik sangat singkat/spesifik)
                    else if (text.length < 35) category = l.alasan || l.permasalahan || l.fokusMasalah || l.gambaranMasalah;

                    counts[category] = (counts[category] || 0) + 1;
                });
                
                // Urutkan dari yang paling banyak terjadi, AMBIL 9 TERATAS agar layar lebih penuh
                const stats = Object.entries(counts).map(([label, count]) => ({ label, count })).sort((a,b) => b.count - a.count).slice(0, 9);
                const max = Math.max(...stats.map(s => s.count), 1);
                return stats.map(s => ({ ...s, percentage: (s.count / max) * 100 }));
            };
			
			// --- FITUR BARU: SMART AGENDA MENDATANG (DENGAN FILTER TANGGAL LEWAT) ---
            const getUpcomingAgenda = () => {
                // Mesin AI Pembaca Format Tanggal (Otomatis deteksi YYYY-MM-DD atau Teks Manual)
                const parseDateStr = (dateStr) => {
                    if (!dateStr) return new Date(0); 
                    
                    // Coba format 1: Tanggal baku dari sistem (YYYY-MM-DD)
                    if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return new Date(dateStr);

                    const str = String(dateStr).toLowerCase();
                    const months = {'januari':0, 'februari':1, 'maret':2, 'april':3, 'mei':4, 'juni':5, 'juli':6, 'agustus':7, 'september':8, 'oktober':9, 'november':10, 'desember':11, 'jan':0, 'feb':1, 'mar':2, 'apr':3, 'jun':5, 'jul':6, 'agu':7, 'sep':8, 'okt':9, 'nov':10, 'des':11};
                    
                    // Coba format 2: Teks Manual (Contoh: "Senin, 10 Januari 2026")
                    const matchText = str.match(/(\d{1,2})\s+([a-z]+)\s+(\d{4})/);
                    if (matchText && months[matchText[2]] !== undefined) {
                        return new Date(matchText[3], months[matchText[2]], matchText[1]);
                    }
                    
                    // Coba format 3: Angka Manual (Contoh: "10/01/2026")
                    const matchNum = str.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/);
                    if (matchNum) return new Date(matchNum[3], matchNum[2] - 1, matchNum[1]);
                    
                    return new Date(); 
                };

                const today = new Date();
                today.setHours(0, 0, 0, 0); 

                let agendaList = [];

                letters.forEach(l => {
                    let sortDate = new Date(0);
                    let displayDate = '';
                    let displayTime = '';

                    if (l.type === 'SKORSING') {
                        // Skorsing: Tampil selama tanggalSelesai belum lewat
                        sortDate = parseDateStr(l.tanggalSelesai || l.tanggalMulai);
                        if (sortDate < today) return; 
                        displayDate = `${formatDate(l.tanggalMulai)} s.d ${formatDate(l.tanggalSelesai)}`;
                        displayTime = `Masa Skorsing (${l.lamaSkorsing})`;
                        agendaList.push({ ...l, sortDate, displayDate, displayTime });
                    } 
                    else if (l.type === 'KONTRAK') {
                        // Kontrak: Fokus ke tanggal Tinjauan
                        sortDate = parseDateStr(l.tanggalTinjauan || l.tanggalKontrak);
                        if (sortDate < today) return;
                        displayDate = `Tinjauan: ${formatDate(l.tanggalTinjauan)}`;
                        displayTime = `Mulai: ${formatDate(l.tanggalKontrak)}`;
                        agendaList.push({ ...l, sortDate, displayDate, displayTime });
                    }
                    else if (l.type === 'UNDANGAN' || l.type === 'TUGAS_HOMEVISIT') {
                        // Undangan & Homevisit: Fokus ke hari acara
                        if (!l.hariTanggalAcara) return;
                        sortDate = parseDateStr(l.hariTanggalAcara);
                        if (sortDate < today) return;
                        displayDate = l.hariTanggalAcara;
                        displayTime = `Pukul ${l.waktuAcara}`;
                        agendaList.push({ ...l, sortDate, displayDate, displayTime });
                    }
                });

                // Urutkan dari jadwal yang paling dekat harinya
                return agendaList.sort((a, b) => a.sortDate - b.sortDate);
            };
			
            // -----------------------------------------------------------
			
			// --- FUNGSI BARU: RENDER ISI HISTORY BIKIN WOW ---
            const renderHistoryContent = (letter) => {
                switch (letter.type) {
                    case 'SKORSING':
                        return (
                            <div className="space-y-2">
                                <p><span className="block text-[10px] font-extrabold text-red-500 uppercase tracking-widest">Pelanggaran</span> {letter.alasan}</p>
                                <p><span className="block text-[10px] font-extrabold text-red-500 uppercase tracking-widest">Masa Skorsing</span> {letter.lamaSkorsing} ({formatDate(letter.tanggalMulai)} - {formatDate(letter.tanggalSelesai)})</p>
                            </div>
                        );
                    case 'PERNYATAAN':
                        return (
                            <div className="space-y-2">
                                {letter.permasalahan && <p><span className="block text-[10px] font-extrabold text-orange-500 uppercase tracking-widest">Duduk Perkara</span> {letter.permasalahan}</p>}
                                <p><span className="block text-[10px] font-extrabold text-orange-500 uppercase tracking-widest">Isi Pernyataan</span> <span className="italic">"{letter.isiPernyataan}"</span></p>
                            </div>
                        );
                    case 'KONTRAK':
                        return (
                            <div className="space-y-2">
                                <div className="grid grid-cols-2 gap-2">
                                    <p><span className="block text-[10px] font-extrabold text-emerald-500 uppercase tracking-widest">Target Perubahan</span> {letter.tujuanPerubahan}</p>
                                    <p><span className="block text-[10px] font-extrabold text-emerald-500 uppercase tracking-widest">Status Kontrak</span> <span className="bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded shadow-sm text-xs">{letter.statusKontrak}</span></p>
                                </div>
                                <p><span className="block text-[10px] font-extrabold text-emerald-500 uppercase tracking-widest">Konsekuensi</span> {letter.konsekuensi}</p>
                            </div>
                        );
                    case 'UNDANGAN':
                        return (
                            <div className="space-y-2">
                                <p><span className="block text-[10px] font-extrabold text-blue-500 uppercase tracking-widest">Perihal & Keperluan</span> {letter.perihal} - {letter.keperluan}</p>
                                <p><span className="block text-[10px] font-extrabold text-blue-500 uppercase tracking-widest">Jadwal Kehadiran</span> {letter.hariTanggalAcara} | Pukul {letter.waktuAcara} di {letter.tempatAcara}</p>
                            </div>
                        );
                    case 'TUGAS_HOMEVISIT':
                        return (
                            <div className="space-y-2">
                                <p><span className="block text-[10px] font-extrabold text-indigo-500 uppercase tracking-widest">Ditugaskan Kepada</span> {letter.namaPetugas}</p>
                                <p><span className="block text-[10px] font-extrabold text-indigo-500 uppercase tracking-widest">Tujuan / Keperluan Kunjungan</span> {letter.keperluan}</p>
                            </div>
                        );
                    case 'LAPORAN_HOMEVISIT':
                        return (
                            <div className="space-y-2">
                                <p><span className="block text-[10px] font-extrabold text-cyan-500 uppercase tracking-widest">Pihak Yang Ditemui</span> {letter.pihakDitemui} ({letter.statusPihakDitemui})</p>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mt-1">
                                    <p><span className="block text-[10px] font-extrabold text-cyan-500 uppercase tracking-widest">Hasil Pembicaraan</span> {letter.hasilPembicaraan}</p>
                                    <p><span className="block text-[10px] font-extrabold text-cyan-500 uppercase tracking-widest">Tindak Lanjut</span> {letter.tindakLanjut}</p>
                                </div>
                            </div>
                        );
                    case 'ALIH_KASUS':
                        return (
                            <div className="space-y-2 border-l-2 border-fuchsia-300 pl-3">
                                <p><span className="block text-[10px] font-extrabold text-fuchsia-500 uppercase tracking-widest">Pihak Tujuan (Referral)</span> {letter.pihakTujuan}</p>
                                <p><span className="block text-[10px] font-extrabold text-fuchsia-500 uppercase tracking-widest">Rincian Masalah</span> {letter.rincianMasalah}</p>
                            </div>
                        );
                    case 'MEDIASI':
                        return (
                            <div className="space-y-2">
                                <p><span className="block text-[10px] font-extrabold text-pink-500 uppercase tracking-widest">Pihak Ke-2 (Lawan Mediasi)</span> Siswa a.n. {letter.namaSiswa2} ({letter.kelas2})</p>
                                <p><span className="block text-[10px] font-extrabold text-pink-500 uppercase tracking-widest">Permasalahan</span> {letter.permasalahan}</p>
                                <p><span className="block text-[10px] font-extrabold text-pink-600 uppercase tracking-widest">Hasil Kesepakatan Damai</span> {letter.hasilMediasi}</p>
                            </div>
                        );
                    case 'KONFERENSI_KASUS':
                        return (
                            <div className="space-y-2">
                                <p><span className="block text-[10px] font-extrabold text-indigo-500 uppercase tracking-widest">Topik / Permasalahan Bahasan</span> {letter.permasalahan}</p>
                                <p><span className="block text-[10px] font-extrabold text-indigo-600 uppercase tracking-widest">Keputusan Bersama</span> {letter.hasilKonferensi}</p>
                            </div>
                        );
                    case 'ADVOKASI':
                        return (
                            <div className="space-y-2">
                                <p><span className="block text-[10px] font-extrabold text-rose-500 uppercase tracking-widest">Advokasi Bersama</span> {letter.pihakTerkait} ({letter.statusPihakTerkait})</p>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mt-1">
                                    <p><span className="block text-[10px] font-extrabold text-rose-500 uppercase tracking-widest">Tujuan</span> {letter.tujuanAdvokasi}</p>
                                    <p><span className="block text-[10px] font-extrabold text-rose-600 uppercase tracking-widest">Hasil</span> {letter.hasilAdvokasi}</p>
                                </div>
                            </div>
                        );
                    case 'BIMBINGAN_KELOMPOK':
                        return (
                            <div className="space-y-2">
                                <p><span className="block text-[10px] font-extrabold text-emerald-500 uppercase tracking-widest">Topik Materi Bahasan</span> {letter.topikBimbingan}</p>
                                <div className="grid grid-cols-2 gap-3 mt-1">
                                    <p><span className="block text-[10px] font-extrabold text-emerald-500 uppercase tracking-widest">Jumlah Anggota</span> {(letter.pesertaBimbingan || []).length} Siswa</p>
                                    <p><span className="block text-[10px] font-extrabold text-emerald-500 uppercase tracking-widest">Hasil/Tujuan</span> {letter.hasilBimbingan || letter.tujuanBimbingan}</p>
                                </div>
                            </div>
                        );
                    case 'KONSELING_KELOMPOK':
                        return (
                            <div className="space-y-2">
                                <p><span className="block text-[10px] font-extrabold text-violet-500 uppercase tracking-widest">Fokus Masalah Kelompok</span> {letter.fokusMasalah}</p>
                                <p><span className="block text-[10px] font-extrabold text-violet-500 uppercase tracking-widest">Dinamika & Evaluasi</span> {letter.evaluasiKonseling}</p>
                            </div>
                        );
                    case 'SKBB':
                        return (
                            <div className="space-y-2">
                                <p><span className="block text-[10px] font-extrabold text-teal-500 uppercase tracking-widest">Keperluan Pembuatan Surat</span> {letter.keperluan}</p>
                            </div>
                        );
                    case 'BERHENTI':
                        return (
                            <div className="space-y-2 border-l-2 border-gray-400 pl-3 bg-gray-100 p-2 rounded">
                                <p><span className="block text-[10px] font-extrabold text-gray-600 uppercase tracking-widest">Alasan Keluar / Pindah</span> {letter.alasanBerhenti}</p>
                            </div>
                        );
                    case 'BUKU_TAMU':
                        return (
                            <div className="space-y-2 border-l-4 border-sky-400 pl-3">
                                <p><span className="block text-[10px] font-extrabold text-sky-600 uppercase tracking-widest">Keperluan Layanan / Curhat</span> {letter.keperluan}</p>
                            </div>
                        );
						
					case 'REKOMENDASI_STUDI':
                        return (
                            <div className="space-y-2 border-l-4 border-blue-500 pl-3">
                                <p><span className="block text-[10px] font-extrabold text-blue-600 uppercase tracking-widest">Target Lanjutan Studi</span> {letter.targetStudi}</p>
                                <p><span className="block text-[10px] font-extrabold text-blue-600 uppercase tracking-widest">Kesimpulan Rekomendasi</span> "{letter.uraianRekomendasi}"</p>
                            </div>
                        );
                    default:
                        return (
                            <p className="italic text-slate-500 text-sm">
                                {letter.alasan || letter.permasalahan || letter.perihal || letter.keperluan || letter.gambaranMasalah || letter.fokusMasalah || letter.alasanBerhenti || letter.topikBimbingan || letter.latarBelakang || "Tidak ada deskripsi rinci untuk layanan ini."}
                            </p>
                        );
                }
            };
            // ----------------------------------------------------

            if (!currentUser) {
                return <LoginView onLogin={setCurrentUser} />;
            }
			
			// Memicu Mode Kiosk Layar Penuh
			if (viewState === 'kiosk') {
				return <KioskMode students={students} schoolData={schoolData} onExit={() => setViewState('list')} letters={letters} setLetters={setLetters} currentUser={currentUser} />;
			}

            return (
                <div className="min-h-screen bg-gray-50 flex font-sans text-gray-800">
                    {loadingState.isLoading && <LoadingOverlay message={loadingState.message} />}
                    
                    <aside className={`bg-slate-50 border-r border-slate-200 flex-col no-print sticky top-0 h-screen transition-all duration-300 hidden md:flex ${isSidebarOpen ? 'w-[280px]' : 'w-0 overflow-hidden'}`}>
                        <SidebarContent activeTab={activeTab} setActiveTab={setActiveTab} setViewState={setViewState} currentUser={currentUser} onLogout={() => setCurrentUser(null)} />
                    </aside>

                    {isMobileMenuOpen && (
                        <div className="fixed inset-0 bg-black/50 z-40 md:hidden no-print" onClick={() => setIsMobileMenuOpen(false)}>
                            <div className="bg-slate-900 text-white w-64 h-full p-4" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-6"><h1 className="font-bold text-lg">Menu</h1><button onClick={() => setIsMobileMenuOpen(false)}><X size={24}/></button></div>
                                <SidebarContent activeTab={activeTab} setActiveTab={(tab) => { setActiveTab(tab); setIsMobileMenuOpen(false); }} setViewState={(view) => { setViewState(view); setIsMobileMenuOpen(false); }} currentUser={currentUser} onLogout={() => setCurrentUser(null)} />
                            </div>
                        </div>
                    )}

                    <main className="flex-1 overflow-hidden flex flex-col h-screen bg-slate-50">
                        {/* HEADER DINAMIS BENTO STYLE */}
                        {(() => {
                            // Kamus Pintar untuk mencocokkan kode dengan Nama dan Ikon
                            const headerMap = {
                                'dashboard': { cat: 'Aplikasi', title: 'Dashboard Utama', icon: <LayoutDashboard size={20} className="text-blue-600"/> },
                                'PERNYATAAN': { cat: 'Pembinaan & Disiplin', title: 'Surat Pernyataan', icon: <FileSignature size={20} className="text-orange-600"/> },
                                'KONTRAK': { cat: 'Pembinaan & Disiplin', title: 'Kontrak Perilaku', icon: <FileCheck size={20} className="text-emerald-600"/> },
                                'SKORSING': { cat: 'Pembinaan & Disiplin', title: 'Surat Skorsing', icon: <FileWarning size={20} className="text-red-600"/> },
                                'BUKU_TAMU': { cat: 'Layanan & Konseling', title: 'Buku Tamu Harian', icon: <BookOpen size={20} className="text-sky-600"/> },
                                'KONSELING_KELOMPOK': { cat: 'Layanan & Konseling', title: 'Konseling Kelompok', icon: <MessageCircle size={20} className="text-violet-600"/> },
                                'BIMBINGAN_KELOMPOK': { cat: 'Layanan & Konseling', title: 'Bimbingan Kelompok', icon: <Users size={20} className="text-emerald-600"/> },
                                'MEDIASI': { cat: 'Layanan & Konseling', title: 'Berita Acara Mediasi', icon: <Users size={20} className="text-pink-600"/> },
                                'KONFERENSI_KASUS': { cat: 'Layanan & Konseling', title: 'Konferensi Kasus', icon: <Users size={20} className="text-indigo-600"/> },
                                'ALIH_KASUS': { cat: 'Layanan & Konseling', title: 'Alih Tangan Kasus', icon: <Share size={20} className="text-fuchsia-600"/> },
                                'ADVOKASI': { cat: 'Layanan & Konseling', title: 'Berita Acara Advokasi', icon: <MessageCircle size={20} className="text-rose-600"/> },
                                'UNDANGAN': { cat: 'Kemitraan & Kunjungan', title: 'Undangan Orang Tua', icon: <Mail size={20} className="text-blue-600"/> },
                                'TUGAS_HOMEVISIT': { cat: 'Kemitraan & Kunjungan', title: 'Tugas Home Visit', icon: <Briefcase size={20} className="text-indigo-600"/> },
                                'LAPORAN_HOMEVISIT': { cat: 'Kemitraan & Kunjungan', title: 'Laporan Home Visit', icon: <ClipboardList size={20} className="text-cyan-600"/> },
                                'SKBB': { cat: 'Keterangan & Keluar', title: 'Ket. Berkelakuan Baik', icon: <ShieldCheck size={20} className="text-teal-600"/> },
                                'REKOMENDASI_STUDI': { cat: 'Keterangan & Keluar', title: 'Rekomendasi Studi', icon: <FileCheck size={20} className="text-blue-600"/> },
                                'BERHENTI': { cat: 'Keterangan & Keluar', title: 'Berhenti / Keluar', icon: <UserMinus size={20} className="text-slate-600"/> },
                                'SCHOOL_DATA': { cat: 'Pengaturan Sistem', title: 'Identitas Sekolah', icon: <Building2 size={20} className="text-slate-600"/> },
                            };
                            
                            // Ambil data sesuai menu yang aktif
                            const current = headerMap[activeTab] || headerMap['dashboard'];

                            return (
                                <header className="bg-white/90 backdrop-blur-xl shadow-sm px-4 py-3 md:px-6 md:py-4 flex justify-between items-center no-print flex-shrink-0 z-30 border-b border-slate-200/80 sticky top-0 transition-all duration-300">
                                    <div className="flex items-center gap-3 md:gap-4">
                                        
                                        {/* Tombol Toggle Sidebar Mobile & Desktop */}
                                        <button className="md:hidden text-slate-500 hover:text-blue-600 bg-slate-100 hover:bg-blue-50 p-2 rounded-xl transition-colors" onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)}>
                                            <Menu size={20} />
                                        </button>
                                        <button className="hidden md:flex text-slate-400 hover:text-blue-600 bg-slate-50 hover:bg-blue-50 border border-slate-200 p-2 rounded-xl transition-colors shadow-sm" onClick={() => setIsSidebarOpen(!isSidebarOpen)} title="Buka/Tutup Sidebar">
                                            <SidebarOpen size={20} />
                                        </button>
                                        
                                        {/* Breadcrumbs & Dynamic Title Area */}
                                        <div className="flex items-center gap-3">
                                            {/* Ikon Besar (Hanya muncul di laptop/tablet) */}
                                            <div className="hidden md:flex items-center justify-center w-10 h-10 rounded-xl bg-slate-50 border border-slate-100 shadow-inner">
                                                {current.icon}
                                            </div>
                                            <div className="flex flex-col">
                                                {/* Desktop Breadcrumb (Silsilah) */}
                                                <div className="hidden md:flex items-center gap-1.5 text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-0.5">
                                                    <span>{current.cat}</span>
                                                    <ChevronRight size={10} className="text-slate-300"/>
                                                    <span className="text-blue-500">{current.title}</span>
                                                </div>
                                                {/* Judul Utama (Muncul di HP & Laptop) */}
                                                <div className="font-black text-slate-800 text-lg md:text-xl flex items-center gap-2 tracking-tight">
                                                    {current.title}
                                                    {APPS_SCRIPT_URL === "PASTE_URL_APPS_SCRIPT_DISINI" && <span className="text-[10px] bg-rose-100 text-rose-600 px-2 py-0.5 rounded-full border border-rose-200 font-bold tracking-wide shadow-sm">âš ï¸ URL DB Kosong</span>}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* Right Side: Date & Profile Chip */}
                                    <div className="flex items-center gap-4 text-right">
                                        <div className="hidden lg:block text-right mr-2">
                                            <p className="text-[13px] font-bold text-slate-700 tracking-wide">{headerDate}</p>
                                            <p className="text-[9px] font-black text-emerald-500 flex justify-end items-center gap-1 mt-0.5 tracking-[0.1em] uppercase"><Cloud size={10} strokeWidth={3}/> Mappaguru Online</p>
                                        </div>
                                        
                                        {/* Chip User Profil - Bentuk Kapsul Keren */}
                                        <div className="flex items-center gap-2.5 bg-white border border-slate-200 shadow-sm pl-1.5 pr-4 py-1.5 rounded-full cursor-default hover:border-blue-300 hover:shadow-md transition-all">
                                            <div className="w-7 h-7 rounded-full bg-gradient-to-tr from-blue-600 to-indigo-500 text-white flex items-center justify-center font-black text-xs shadow-inner">
                                                <User size={14} strokeWidth={2.5} />
											</div>
											<span className="text-sm font-bold text-slate-700 hidden sm:block tracking-wide">{currentUser.username}</span>
										</div>
                                    </div>
                                </header>
                            );
                        })()}

                        {/* MAIN CONTENT AREA - SCROLLABLE INTERNAL */}
                        <div className="flex-1 overflow-y-auto p-4 md:p-6 no-print scroll-smooth">
                            {viewState === 'list' && (
                                <div className="space-y-6 pb-10 max-w-7xl mx-auto">
                                    {activeTab === 'dashboard' && (
                                        <div className="space-y-8 mb-8 animate-fade-in-up">
                                            {/* 1. HERO BANNER MODERN */}
                                            <div className="bg-gradient-to-br from-blue-700 via-blue-600 to-indigo-800 rounded-3xl p-6 md:p-8 shadow-xl shadow-blue-900/20 text-white flex flex-col md:flex-row justify-between items-center gap-6 relative overflow-hidden border border-blue-400/20">
                                                {/* Efek Cahaya / Ornamen Latar */}
                                                <div className="absolute -right-10 -top-10 w-48 h-48 bg-white opacity-10 rounded-full blur-3xl pointer-events-none"></div>
                                                <div className="absolute right-1/4 -bottom-10 w-32 h-32 bg-blue-300 opacity-20 rounded-full blur-2xl pointer-events-none"></div>
                                                
                                                <div className="relative z-10 w-full md:w-auto text-center md:text-left">
                                                    <h2 className="text-2xl md:text-3xl font-extrabold mb-2 tracking-tight drop-shadow-sm">Selamat Datang, {currentUser.username}! ðŸ‘‹</h2>
                                                    <p className="text-blue-100 mb-6 text-sm md:text-base max-w-xl font-medium leading-relaxed">Kelola administrasi dan rekam jejak Bimbingan & Konseling <strong className="text-white">{schoolData.namaSekolah}</strong> dengan lebih cepat, rapi, dan terpantau.</p>
                                                    <div className="flex flex-wrap gap-3 justify-center md:justify-start">
                                                        <button onClick={() => {setSelectedLetter(null); setViewState('create');}} className="bg-white text-blue-700 hover:bg-blue-50 px-5 py-2.5 rounded-xl text-sm font-bold shadow-lg shadow-black/10 transition-all flex items-center gap-2 transform hover:-translate-y-0.5"><Plus size={18} strokeWidth={3}/> Buat Surat Baru</button>
                                                        <button onClick={handleExportExcel} className="bg-white/10 hover:bg-white/20 backdrop-blur-md border border-white/20 text-white px-5 py-2.5 rounded-xl text-sm font-semibold shadow-lg transition-all flex items-center gap-2"><Download size={18}/> Export Laporan</button>
                                                    </div>
                                                </div>
                                                <div className="relative z-10 bg-white/10 backdrop-blur-md border border-white/20 p-6 rounded-2xl text-center min-w-[160px] shadow-inner transform hover:scale-105 transition-transform duration-300">
                                                    <p className="text-blue-100 text-xs font-bold uppercase tracking-widest mb-1">Total Arsip</p>
                                                    <h3 className="text-5xl font-black drop-shadow-md tracking-tighter">{letters.length}</h3>
                                                    <p className="text-[10px] text-blue-200 mt-2 font-medium uppercase tracking-wide">Dokumen Tersimpan</p>
                                                </div>
                                            </div>
											
											{/* FITUR ALIEN: AI EARLY WARNING SYSTEM (FULL WIDTH) */}
                                            <div className="mb-8 animate-fade-in-up w-full">
                                                <div className="bg-[#0f172a] p-6 md:p-8 rounded-3xl shadow-2xl border border-rose-500/20 relative overflow-hidden">
                                                    {/* Efek Cahaya Merah Ambient */}
                                                    <div className="absolute top-0 right-0 w-64 h-64 bg-rose-600/10 rounded-full blur-[80px] pointer-events-none animate-pulse"></div>
                                                    <div className="absolute bottom-0 left-0 w-40 h-40 bg-orange-600/10 rounded-full blur-[60px] pointer-events-none"></div>
                                                    
                                                    {/* Header Radar */}
                                                    <div className="flex items-center gap-4 mb-6 relative z-10">
                                                        <div className="p-3 bg-rose-500/20 rounded-xl shadow-[0_0_15px_rgba(244,63,94,0.3)] animate-[pulse_2s_ease-in-out_infinite]">
                                                            <AlertTriangle className="text-rose-400" size={26} strokeWidth={2.5}/>
                                                        </div>
                                                        <div>
                                                            <h3 className="text-lg md:text-xl font-black text-white tracking-wide uppercase drop-shadow-md">Radar Prediksi Risiko (AI-Scanner)</h3>
                                                            <p className="text-[11px] md:text-xs text-slate-400 font-medium mt-1">Memindai anomali dan probabilitas pelanggaran siswa dalam 7-14 hari ke depan berdasarkan pola database.</p>
                                                        </div>
                                                    </div>

                                                    {/* Daftar Hasil Prediksi (Grid 4 Kolom) */}
                                                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 relative z-10 max-h-[320px] overflow-y-auto custom-scrollbar pr-2 pb-2">
                                                        {getAIPredictions().map((pred, i) => (
                                                            <div key={i} className="bg-slate-800/80 backdrop-blur-sm border border-slate-700/80 hover:border-rose-500/50 p-5 rounded-2xl transition-all duration-300 group hover:-translate-y-1 hover:shadow-lg hover:shadow-rose-900/20 flex flex-col justify-between">
                                                                <div>
                                                                    <div className="flex justify-between items-start mb-3">
                                                                        <div>
                                                                            <h4 className="font-bold text-slate-200 text-sm truncate w-[130px]" title={pred.nama}>{pred.nama}</h4>
                                                                            <span className="text-[10px] text-slate-500 font-medium bg-slate-900 px-2 py-0.5 rounded">{pred.kelas}</span>
                                                                        </div>
                                                                        <span className="bg-rose-500/20 text-rose-400 text-[11px] font-black px-2 py-1 rounded shadow-sm border border-rose-500/30">{pred.score}%</span>
                                                                    </div>
                                                                    
                                                                    <div className="w-full bg-slate-900 rounded-full h-1.5 mb-4 overflow-hidden border border-slate-700">
                                                                        <div className="bg-gradient-to-r from-orange-500 to-rose-500 h-full rounded-full relative" style={{ width: `${pred.score}%` }}>
                                                                            <div className="absolute inset-0 bg-white/20 w-full h-full animate-[pulse_1s_ease-in-out_infinite]"></div>
                                                                        </div>
                                                                    </div>
                                                                    
                                                                    <p className="text-[11px] text-slate-400 italic leading-relaxed mb-4">"{pred.insight}"</p>
                                                                </div>
                                                                
                                                                <button onClick={() => {setHistoryStudent(pred.nama); setViewState('history');}} className="w-full bg-slate-700/50 hover:bg-rose-600 text-slate-300 hover:text-white text-xs font-bold py-2.5 rounded-xl transition-colors flex items-center justify-center gap-2 border border-slate-600 hover:border-rose-500">
                                                                    <Search size={14} strokeWidth={2.5}/> Investigasi Siswa
                                                                </button>
                                                            </div>
                                                        ))}
                                                        
                                                        {getAIPredictions().length === 0 && (
                                                            <div className="col-span-full py-10 text-center border-2 border-dashed border-slate-700/50 rounded-2xl bg-slate-800/30">
                                                                <div className="w-16 h-16 bg-emerald-500/10 rounded-full flex items-center justify-center mx-auto mb-3"><ShieldCheck size={32} className="text-emerald-400 opacity-80"/></div>
                                                                <p className="text-emerald-400 font-bold text-sm tracking-wide uppercase">Zona Hijau / Aman Terkendali</p>
                                                                <p className="text-xs text-slate-500 mt-1 max-w-md mx-auto">Sistem AI tidak mendeteksi adanya anomali atau risiko pelanggaran tinggi pada siswa berdasarkan histori data saat ini.</p>
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
											
											{/* FITUR BARU: AGENDA MENDATANG (LIST MENYATU & SCROLL) */}
                                            <div className="bg-white rounded-[2rem] shadow-[0_8px_30px_rgb(0,0,0,0.04)] border border-slate-200/60 p-5 md:p-6 mb-8 animate-fade-in-up w-full relative overflow-hidden">
                                                {/* Ambient Glow Latar Agenda */}
                                                <div className="absolute -top-10 -right-10 w-40 h-40 bg-emerald-400/10 rounded-full blur-[60px] pointer-events-none"></div>

                                                <div className="flex items-center justify-between mb-5 pb-4 border-b border-slate-100 relative z-10">
                                                    <h3 className="text-lg font-black text-slate-800 flex items-center gap-2.5 tracking-tight">
                                                        <div className="p-2 bg-blue-50 text-blue-600 rounded-xl shadow-sm"><Calendar size={20}/></div> 
                                                        Agenda & Jadwal Terdekat
                                                    </h3>
                                                    <span className="bg-emerald-50 border border-emerald-200 text-emerald-600 text-[10px] font-black px-3 py-1.5 rounded-full uppercase tracking-widest shadow-sm flex items-center gap-1.5">
                                                        <span className="w-2 h-2 bg-emerald-500 rounded-full animate-pulse shadow-[0_0_8px_rgba(16,185,129,0.8)]"></span> Live Update
                                                    </span>
                                                </div>
                                                
                                                {/* Pembungkus List dengan Scrollbar Maksimal Tinggi */}
                                                <div className="max-h-[260px] overflow-y-auto custom-scrollbar pr-3 space-y-3 relative z-10">
                                                    {getUpcomingAgenda().length > 0 ? (
                                                        getUpcomingAgenda().map((agenda, i) => (
                                                            <div key={i} onClick={() => {setSelectedLetter(agenda); setViewState('detail');}} className="flex flex-col sm:flex-row sm:items-center justify-between p-4 bg-white hover:bg-slate-50 border border-slate-200 hover:border-blue-300 rounded-2xl cursor-pointer transition-all duration-300 group gap-4 shadow-sm hover:shadow-md">
                                                                <div className="flex items-center gap-4">
                                                                    <div className="w-14 h-14 bg-gradient-to-br from-slate-50 to-slate-100 rounded-[1rem] flex items-center justify-center border border-slate-200 shadow-inner group-hover:from-blue-50 group-hover:to-indigo-50 group-hover:border-blue-200 group-hover:text-blue-600 transition-all shrink-0">
                                                                        <Calendar size={24} className="text-slate-400 group-hover:text-blue-600 transition-colors" strokeWidth={2}/>
                                                                    </div>
                                                                    <div>
                                                                        <div className="flex flex-wrap items-center gap-2 mb-1.5">
                                                                            <h4 className="font-bold text-slate-800 group-hover:text-blue-700 transition-colors text-sm md:text-base">{agenda.namaSiswa}</h4>
                                                                            <span className="bg-slate-800 text-white text-[9px] px-2 py-0.5 rounded uppercase font-bold tracking-widest shadow-sm">Kelas {agenda.kelas}</span>
                                                                            <span className={`text-[9px] px-2 py-0.5 rounded font-black uppercase tracking-widest shadow-sm border ${getBadgeStyle(agenda.type)}`}>{agenda.type.replace('_', ' ')}</span>
                                                                        </div>
                                                                        <div className="flex flex-wrap items-center gap-3 text-[11px] font-bold text-slate-500 mt-1">
                                                                            <span className="flex items-center gap-1.5 bg-slate-100 px-2 py-1 rounded-md border border-slate-200"><Calendar size={12} className="text-slate-400"/> {agenda.displayDate}</span>
                                                                            <span className="flex items-center gap-1.5 bg-slate-100 px-2 py-1 rounded-md border border-slate-200"><Monitor size={12} className="text-slate-400"/> {agenda.displayTime}</span>
                                                                            
                                                                            {/* INFO PEMBUAT (PIC) AGENDA */}
                                                                            <span className="flex items-center gap-1.5 bg-indigo-50 text-indigo-700 px-2 py-1 rounded-md border border-indigo-200 shadow-sm ml-auto sm:ml-0">
                                                                                <User size={12} strokeWidth={2.5}/> Guru: {agenda.namaPetugas || agenda.createdBy || '-'}
                                                                            </span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div className="hidden sm:flex items-center gap-2 text-xs font-black text-slate-400 group-hover:text-blue-600 transition-colors whitespace-nowrap uppercase tracking-widest bg-slate-50 group-hover:bg-blue-100 px-3 py-2 rounded-xl">
                                                                    Cek Detail <ChevronRight size={14} strokeWidth={3}/>
                                                                </div>
                                                            </div>
                                                        ))
                                                    ) : (
                                                        <div className="text-center py-10 bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200">
                                                            <div className="w-14 h-14 bg-white rounded-full flex items-center justify-center mx-auto mb-4 border border-slate-100 text-slate-300 shadow-sm">
                                                                <ShieldCheck size={28} strokeWidth={2}/>
                                                            </div>
                                                            <p className="text-slate-700 font-black text-sm tracking-wide">Clear! Tidak ada agenda mendatang.</p>
                                                            <p className="text-xs text-slate-400 mt-1.5 max-w-sm mx-auto font-medium">Jadwal Skorsing, Kontrak, Home Visit, & Undangan otomatis tampil di sini.</p>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>

                                            {/* 2. STATISTIK KARTU INTERAKTIF */}
                                            <div>
                                                <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2"><LayoutDashboard size={22} className="text-blue-600"/> Ringkasan Layanan</h3>
                                                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-5">
                                                    {getDashboardStats().map((stat) => (
                                                        <div key={stat.key} onClick={() => {setActiveTab(stat.key); setViewState('list');}} className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 hover:border-blue-300 hover:shadow-lg hover:shadow-blue-500/10 transition-all duration-300 group cursor-pointer relative overflow-hidden">
                                                            <div className="absolute top-0 right-0 w-16 h-16 bg-gradient-to-bl from-slate-50 to-transparent rounded-bl-full -z-0"></div>
                                                            <div className="relative z-10">
                                                                <div className="flex justify-between items-start mb-4">
                                                                    <div className={`p-3 rounded-xl ${stat.bg} ${stat.color} group-hover:scale-110 transition-transform duration-300 shadow-sm border ${stat.border}`}>
                                                                        {React.cloneElement(stat.icon, { size: 24, strokeWidth: 2.5 })}
                                                                    </div>
                                                                    <span className="text-3xl font-black text-slate-700 tracking-tight">{stat.count}</span>
                                                                </div>
                                                                <div>
                                                                    <p className="text-sm font-bold text-slate-700 group-hover:text-blue-700 transition-colors">{stat.label}</p>
                                                                    <p className="text-[10px] text-slate-400 mt-1 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-all transform -translate-x-2 group-hover:translate-x-0 duration-300 font-semibold">Lihat arsip <ChevronRight size={12} strokeWidth={3}/></p>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                      
											{/* 3. NEW FEATURE: GRAFIK & EARLY WARNING SYSTEM */}
											  <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-8">
												   {/* KIRI: GRAFIK DISTRIBUSI LAYANAN */}
												   <div className="bg-white p-6 md:p-8 rounded-3xl shadow-sm border border-slate-200 relative overflow-hidden">
													   <h3 className="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2"><BarChart2 className="text-blue-600"/> Grafik Layanan Terbanyak</h3>
													   <div className="space-y-5 relative z-10 max-h-[260px] overflow-y-auto custom-scrollbar pr-3">
															{getChartData().map((data, i) => (
															   <div key={i} className="group">
																   <div className="flex justify-between text-xs font-bold text-slate-600 mb-1.5">
																	   <span className="uppercase tracking-wider group-hover:text-blue-600 transition-colors">{data.label}</span>
																	   <span className="bg-slate-100 px-2 py-0.5 rounded text-[10px]">{data.count} Berkas</span>
																   </div>
																   <div className="w-full bg-slate-100 rounded-full h-3 overflow-hidden shadow-inner">
																	   {/* Progress Bar Pintar */}
																	   <div className={`h-3 rounded-full bg-gradient-to-r from-blue-400 to-indigo-500 shadow-sm relative`} style={{ width: `${data.percentage}%`, transition: 'width 1.5s ease-in-out' }}>
																		   <div className="absolute inset-0 bg-white/20 w-full h-full animate-[pulse_2s_ease-in-out_infinite]"></div>
																	   </div>
																   </div>
															   </div>
														   ))}
														   {getChartData().length === 0 && <p className="text-sm text-slate-400 italic text-center py-4 border-2 border-dashed rounded-xl">Belum ada data grafik.</p>}
													   </div>
												   </div>
												   
												   {/* TENGAH: GRAFIK TOP KELAS */}
													<div className="bg-white p-6 md:p-8 rounded-3xl shadow-sm border border-slate-200 relative overflow-hidden">
														<h3 className="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2"><PieChart className="text-emerald-600"/> Top Kelas Teraktif</h3>
														<div className="space-y-5 relative z-10 max-h-[260px] overflow-y-auto custom-scrollbar pr-3">
															{getClassChartData().map((data, i) => (
																<div key={i} className="group">
																	<div className="flex justify-between text-xs font-bold text-slate-600 mb-1.5">
																		<span className="uppercase tracking-wider group-hover:text-emerald-600 transition-colors">Kelas {data.label}</span>
																		<span className="bg-slate-100 px-2 py-0.5 rounded text-[10px]">{data.count} Kasus/Layanan</span>
																	</div>
																	<div className="w-full bg-slate-100 rounded-full h-3 overflow-hidden shadow-inner">
																		{/* Progress Bar Pintar - Warna Hijau */}
																		<div className={`h-3 rounded-full bg-gradient-to-r from-emerald-400 to-teal-500 shadow-sm relative`} style={{ width: `${data.percentage}%`, transition: 'width 1.5s ease-in-out' }}>
																			<div className="absolute inset-0 bg-white/20 w-full h-full animate-[pulse_2s_ease-in-out_infinite]"></div>
																		</div>
																	</div>
																</div>
															))}
															{getClassChartData().length === 0 && <p className="text-sm text-slate-400 italic text-center py-4 border-2 border-dashed rounded-xl">Belum ada data kelas.</p>}
														</div>
													</div>

												   {/* KANAN: EARLY WARNING SYSTEM (RED ZONE) */}
													<div className="bg-white p-6 md:p-8 rounded-3xl shadow-sm border border-slate-200 relative overflow-hidden">
														<div className="absolute top-0 right-0 w-32 h-32 bg-red-50 rounded-bl-full -z-0"></div>
														<h3 className="text-lg font-bold text-slate-800 mb-1 flex items-center gap-2 relative z-10"><AlertTriangle className="text-red-500 animate-bounce"/> Siswa Pantauan Khusus (Red Zone)</h3>
														<p className="text-xs text-slate-500 mb-6 relative z-10">Terdeteksi berulang kali menerima surat pelanggaran / masalah (â‰¥ 2 kali).</p>
														<div className="space-y-3 relative z-10">
															{getRedZoneStudents().map((student, i) => (
																<div key={i} onClick={() => {setHistoryStudent(student.nama); setViewState('history');}} className="flex items-center justify-between p-3 bg-white rounded-xl border border-slate-200 hover:border-red-300 hover:bg-red-50 hover:shadow-md transition-all cursor-pointer transform hover:-translate-y-0.5">
																	<div className="flex items-center gap-3">
																		<div className="w-8 h-8 rounded-full bg-red-100 text-red-600 flex items-center justify-center font-bold text-sm shadow-sm">{i+1}</div>
																		<span className="font-bold text-slate-700 text-sm">{student.nama}</span>
																	</div>
																	<span className="bg-red-600 shadow-md text-white text-[10px] font-bold px-3 py-1.5 rounded-full flex items-center gap-1">{student.count} Kasus <ChevronRight size={12}/></span>
																</div>
															))}
															{getRedZoneStudents().length === 0 && (
																<div className="p-8 text-center border-2 border-dashed border-emerald-200 rounded-2xl bg-emerald-50 text-emerald-600 flex flex-col items-center justify-center h-[200px]">
																	<ShieldCheck size={40} className="mb-3 opacity-80"/>
																	<p className="font-bold text-sm">Aman Terkendali</p>
																	<p className="text-xs mt-1">Belum ada siswa yang masuk zona pantauan.</p>
																</div>
															)}
														</div>
													</div>
												</div>

												{/* 5. TREN TOPIK MASALAH (FULL WIDTH) */}
												<div className="mt-6 mb-8 animate-fade-in-up w-full">
													<div className="bg-white p-6 md:p-8 rounded-[2rem] shadow-sm border border-slate-200/80 relative overflow-hidden">
														{/* Dekorasi Background */}
														<div className="absolute top-0 right-0 w-64 h-64 bg-rose-50 rounded-bl-full -z-0 pointer-events-none"></div>
														<div className="absolute bottom-0 left-0 w-40 h-40 bg-orange-50 rounded-tr-full -z-0 pointer-events-none"></div>
														
														<div className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8 relative z-10">
															<h3 className="text-lg font-black text-slate-800 flex items-center gap-2.5 tracking-tight">
																<div className="p-2 bg-rose-50 text-rose-600 rounded-xl shadow-sm border border-rose-100"><FileWarning size={20}/></div> 
																Tren Topik Masalah & Pelanggaran
															</h3>
															<span className="bg-slate-50 text-slate-500 text-[10px] font-bold px-3 py-1.5 rounded-lg border border-slate-200 shadow-sm uppercase tracking-widest">
																Tingkat Kerawanan Tertinggi
															</span>
														</div>
														
														<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 relative z-10">
															{getProblemTrends().map((data, i) => (
																<div key={i} className="group flex flex-col justify-between bg-white border border-slate-200/60 p-4 sm:p-5 rounded-2xl shadow-[0_2px_10px_rgba(0,0,0,0.02)] hover:shadow-[0_10px_25px_rgba(225,29,72,0.1)] hover:border-rose-300 transition-all duration-300 transform hover:-translate-y-1">
																	<div className="flex items-start gap-3.5 mb-5">
																		{/* Indikator Kerawanan (1: Merah/Bahaya, 2: Oranye/Peringatan, 3: Kuning/Waspada) */}
																		<div className={`w-9 h-9 rounded-xl flex items-center justify-center font-black text-sm shrink-0 shadow-sm border ${
																			i === 0 ? 'bg-gradient-to-br from-rose-500 to-red-700 text-white border-red-600 shadow-rose-500/30' : 
																			i === 1 ? 'bg-gradient-to-br from-orange-500 to-orange-700 text-white border-orange-600 shadow-orange-500/30' : 
																			i === 2 ? 'bg-gradient-to-br from-amber-400 to-amber-600 text-white border-amber-500 shadow-amber-500/30' : 
																			'bg-slate-100 text-slate-500 border-slate-200 group-hover:bg-rose-50 group-hover:text-rose-600 group-hover:border-rose-200'
																		} transition-colors`}>
																			#{i+1}
																		</div>
																		
																		{/* Judul Masalah */}
																		<h4 className="text-sm font-bold text-slate-700 leading-snug group-hover:text-rose-600 transition-colors pt-1" style={{ wordBreak: 'break-word' }}>
																			{data.label}
																		</h4>
																	</div>
																	
																	<div className="mt-auto">
																		<div className="flex justify-between items-end mb-2">
																			<span className="text-[10px] font-extrabold text-slate-400 uppercase tracking-widest flex items-center gap-1"><AlertTriangle size={10} className="text-rose-500"/> Intensitas</span>
																			<div className="flex items-center gap-2">
																				<span className="text-slate-800 font-black text-sm group-hover:text-rose-600 transition-colors">{data.count} <span className="text-[10px] font-bold text-slate-500">Kasus</span></span>
																				<span className="bg-rose-50 text-rose-600 px-2 py-0.5 rounded text-[10px] font-black border border-rose-100">{Math.round(data.percentage)}%</span>
																			</div>
																		</div>
																		<div className="w-full bg-slate-100 rounded-full h-2 overflow-hidden border border-slate-200/50 shadow-inner">
																			{/* Bar Animasi Mengikuti Level Kerawanan */}
																			<div className={`h-full rounded-full ${
																				i === 0 ? 'bg-gradient-to-r from-rose-500 to-red-600' : 
																				i === 1 ? 'bg-gradient-to-r from-orange-400 to-orange-600' : 
																				i === 2 ? 'bg-gradient-to-r from-amber-400 to-amber-500' : 
																				'bg-gradient-to-r from-slate-400 to-slate-500'
																			} relative`} style={{ width: `${data.percentage}%`, transition: 'width 1.5s ease-in-out' }}>
																				<div className="absolute inset-0 bg-white/20 w-full h-full animate-[pulse_2s_ease-in-out_infinite]"></div>
																			</div>
																		</div>
																	</div>
																</div>
															))}
															
															{getProblemTrends().length === 0 && (
																<div className="col-span-full">
																	<div className="py-12 flex flex-col items-center justify-center text-center border-2 border-dashed border-slate-200 rounded-2xl bg-slate-50/50">
																		<ShieldCheck size={36} className="text-slate-300 mb-3"/>
																		<p className="text-sm font-bold text-slate-600">Sistem Bersih</p>
																		<p className="text-xs text-slate-400 mt-1">Belum ada data permasalahan atau pelanggaran yang tercatat.</p>
																	</div>
																</div>
															)}
														</div>
													</div>
												</div>
											</div>
                                    )}

                                    {/* PANEL FILTER GLASSMORPHISM */}
                                    <div className="bg-white/80 backdrop-blur-xl border border-slate-200/60 shadow-lg shadow-slate-200/40 rounded-2xl p-4 mb-6 sticky top-2 z-20 animate-fade-in-up">
                                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                                            <div className="relative w-full md:w-80 group">
                                                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                    <Search className="h-5 w-5 text-gray-400 group-hover:text-blue-500 transition-colors" />
                                                </div>
                                                <input type="text" placeholder="Cari nama siswa atau nomor surat..." className="w-full pl-10 pr-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-4 focus:ring-blue-500/20 focus:border-blue-500 focus:bg-white transition-all text-sm font-medium" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
                                            </div>
                                            <div className="flex gap-2 w-full md:w-auto">
                                                <button onClick={fetchData} className="bg-white border border-slate-200 hover:border-slate-300 hover:bg-slate-50 text-slate-600 p-2.5 rounded-xl flex items-center justify-center gap-2 shadow-sm transition-all transform hover:-translate-y-0.5" title="Refresh Data"><RotateCcw size={18} /></button>
                                                <button onClick={() => {setSelectedLetter(null); setViewState('create');}} className="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-xl flex items-center justify-center gap-2 shadow-md shadow-blue-500/30 transition-all transform hover:-translate-y-0.5 flex-1 md:flex-none font-bold text-sm"><Plus size={18} strokeWidth={3} /> Buat Surat Baru</button>
                                            </div>
                                        </div>

                                        <div className="flex flex-wrap gap-3 items-end border-t border-slate-100 pt-3">
                                            <div className="flex items-center gap-2 mr-2 text-slate-400"><Filter size={16}/> <span className="text-xs font-bold uppercase tracking-wider">Filter:</span></div>
                                            <div className="flex-1 min-w-[140px]">
                                                <select value={filterType} onChange={(e) => setFilterType(e.target.value)} className="w-full p-2 text-xs font-semibold text-slate-600 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer hover:bg-white transition-colors">
                                                    {letterTypesList.map(t => <option key={t} value={t}>{t === 'Semua' ? 'Semua Layanan / Surat' : t.replace('_', ' ')}</option>)}
                                                </select>
                                            </div>
                                            <div className="flex-1 min-w-[130px]">
                                                <select value={filterCreator} onChange={(e) => setFilterCreator(e.target.value)} className="w-full p-2 text-xs font-semibold text-slate-600 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer hover:bg-white transition-colors">
                                                    {uniqueCreators.map(c => <option key={c} value={c}>{c === 'Semua' ? 'Semua Guru BK' : c}</option>)}
                                                </select>
                                            </div>
                                            <div className="flex flex-wrap gap-2 flex-[2] min-w-[200px]">
                                                <input type="date" value={filterStartDate} onChange={(e) => setFilterStartDate(e.target.value)} className="flex-1 p-2 text-xs text-slate-600 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" title="Dari Tanggal" />
                                                <span className="text-slate-400 self-center">-</span>
                                                <input type="date" value={filterEndDate} onChange={(e) => setFilterEndDate(e.target.value)} className="flex-1 p-2 text-xs text-slate-600 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" title="Sampai Tanggal" />
                                            </div>
                                            <div>
                                                <button onClick={() => { setFilterType('Semua'); setFilterCreator('Semua'); setFilterStartDate(''); setFilterEndDate(''); setSearchTerm(''); }} className="px-4 py-2 bg-slate-100 hover:bg-rose-100 hover:text-rose-600 text-slate-600 rounded-lg text-xs font-bold transition-colors shadow-sm" title="Reset Semua Filter">
                                                    Reset
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    {/* SCROLLABLE TABLE CONTAINER (ULTRA-MODERN EXCLUSIVE + ZEBRA & COLORED HEADER) */}
                                    <div className="relative bg-gradient-to-br from-white/80 to-white/40 backdrop-blur-3xl rounded-[2.5rem] shadow-[0_8px_40px_-12px_rgba(0,0,0,0.08)] border border-white flex flex-col max-h-[calc(100vh-220px)] overflow-hidden animate-fade-in-up p-2 md:p-4">
                                        
                                        {/* Ambient Glow di belakang tabel */}
                                        <div className="absolute top-0 left-0 w-64 h-64 bg-blue-400/10 rounded-full blur-[80px] pointer-events-none"></div>
                                        <div className="absolute bottom-0 right-0 w-64 h-64 bg-purple-400/10 rounded-full blur-[80px] pointer-events-none"></div>

                                        {/* Table Toolbar Atas - Floating Pills */}
                                        <div className="px-4 py-2 flex flex-col sm:flex-row sm:items-center justify-between gap-4 relative z-10 shrink-0 mb-2">
                                            <div className="flex items-center gap-3 bg-white/60 backdrop-blur-md px-4 py-2 rounded-full border border-slate-200/50 shadow-sm">
                                                <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Tampilkan</span>
                                                <select value={itemsPerPage} onChange={(e) => setItemsPerPage(e.target.value === 'semua' ? 'semua' : Number(e.target.value))} className="bg-transparent text-slate-800 text-xs font-bold focus:outline-none cursor-pointer">
                                                    <option value={5}>5 Entri</option>
                                                    <option value={10}>10 Entri</option>
                                                    <option value={20}>20 Entri</option>
                                                    <option value={50}>50 Entri</option>
                                                    <option value="semua">Semua Entri</option>
                                                </select>
                                            </div>
                                            <div className="bg-slate-900/5 backdrop-blur-md border border-slate-900/10 px-5 py-2 rounded-full flex items-center gap-3 shadow-inner">
                                                <span className="relative flex h-2.5 w-2.5">
                                                  <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span>
                                                  <span className="relative inline-flex rounded-full h-2.5 w-2.5 bg-blue-500"></span>
                                                </span>
                                                <span className="text-[11px] font-bold text-slate-600 uppercase tracking-widest"><span className="text-slate-900 font-black text-sm">{filteredLetters.length}</span> Dokumen Tersimpan</span>
                                            </div>
                                        </div>

                                        {/* Area Tabel Utama */}
                                        <div className="overflow-auto flex-1 custom-scrollbar relative z-10 px-2">
                                            <table className="w-full text-left min-w-[900px] border-separate border-spacing-y-2">
                                                <thead className="sticky top-0 z-20">
                                                    {/* HEADER BERWARNA MEWAH */}
                                                    <tr className="bg-gradient-to-r from-blue-600 via-indigo-600 to-purple-600 shadow-md">
                                                        <th className="px-6 py-4 text-[10px] font-extrabold text-white uppercase tracking-[0.2em] w-48 rounded-l-2xl">Kategori Dokumen</th>
                                                        <th className="px-6 py-4 text-[10px] font-extrabold text-blue-50 uppercase tracking-[0.2em]">Identitas & Pembuat</th>
                                                        <th className="px-6 py-4 text-[10px] font-extrabold text-blue-50 uppercase tracking-[0.2em]">Siswa Tertuju</th>
                                                        <th className="px-6 py-4 text-[10px] font-extrabold text-blue-50 uppercase tracking-[0.2em] w-40">Jadwal Acara</th>
                                                        <th className="px-6 py-4 text-[10px] font-extrabold text-white uppercase tracking-[0.2em] text-center w-[220px] rounded-r-2xl">Aksi Cepat</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-100 bg-white">
                                                    {currentLetters.length > 0 ? (
                                                        currentLetters.map((letter) => (
                                                            /* ZEBRA STRIPING: Ganjil Putih, Genap Biru Muda Lembut */
                                                            <tr key={letter.id} className="group odd:bg-white even:bg-sky-50/40 hover:!bg-blue-50/80 shadow-[0_4px_15px_rgba(0,0,0,0.02)] hover:shadow-[0_8px_25px_rgba(59,130,246,0.15)] transition-all duration-300 transform hover:-translate-y-0.5">
                                                                <td className="px-6 py-3 align-middle rounded-l-2xl border border-transparent group-hover:border-blue-100">
                                                                    <div className="flex items-center gap-2">
                                                                        <div className="w-1.5 h-1.5 rounded-full bg-blue-500 opacity-0 group-hover:opacity-100 transition-opacity duration-300 shadow-[0_0_8px_rgba(59,130,246,0.8)]"></div>
                                                                        <span className={`px-2 py-1 rounded-lg text-[9px] font-black whitespace-nowrap uppercase tracking-widest ${getBadgeStyle(letter.type)} bg-opacity-20`}>
                                                                            {letter.type.replace('_', ' ')}
                                                                        </span>
                                                                    </div>
                                                                </td>
                                                                <td className="px-6 py-3 align-middle border-t border-b border-transparent group-hover:border-blue-100">
                                                                    <div className="text-[11px] text-slate-800 font-bold group-hover:text-blue-700 transition-colors flex items-center gap-2">
                                                                        {letter.nomorSurat || 'TANPA NOMOR'}
                                                                    </div>
                                                                    <div className="text-[9px] text-slate-400 flex items-center gap-1 mt-1 font-bold uppercase tracking-widest">
                                                                        Oleh: <span className="text-indigo-700 bg-indigo-100 px-2 py-0.5 rounded flex items-center gap-1 border border-indigo-200 shadow-sm"><User size={9} strokeWidth={3}/> {letter.createdBy || 'SYSTEM'}</span>
                                                                    </div>
                                                                </td>
                                                                <td className="px-6 py-3 align-middle border-t border-b border-transparent group-hover:border-blue-100">
                                                                    <div className="flex items-center gap-3">
                                                                        {/* AVATAR IKON SISWA */}
                                                                        <div className="w-8 h-8 rounded-full bg-gradient-to-br from-blue-50 to-indigo-50 text-blue-600 flex items-center justify-center shrink-0 border border-blue-100 shadow-sm group-hover:scale-110 group-hover:from-blue-500 group-hover:to-indigo-600 group-hover:text-white transition-all duration-300">
                                                                            <User size={14} strokeWidth={2.5} />
                                                                        </div>
                                                                        <div>
                                                                            <div className="font-bold text-[11px] text-slate-800 group-hover:text-blue-700 transition-colors tracking-wide">{letter.namaSiswa || 'Siswa Tidak Diketahui'}</div>
                                                                            <div className="text-slate-500 text-[9px] mt-0.5 font-black tracking-widest uppercase">
                                                                                KELAS {letter.kelas || '-'}
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </td>
                                                                <td className="px-6 py-3 align-middle border-t border-b border-transparent group-hover:border-blue-100">
                                                                    <div className="flex items-center gap-2 text-slate-600 text-[10px] font-bold group-hover:text-slate-800 transition-colors">
                                                                        <div className="p-1 bg-white shadow-sm border border-slate-100 rounded-md group-hover:bg-blue-50 group-hover:text-blue-600 transition-colors"><Calendar size={12}/></div>
                                                                        {formatDate(letter.tanggal)}
                                                                    </div>
                                                                </td>
                                                                <td className="px-6 py-3 align-middle rounded-r-2xl border border-transparent group-hover:border-blue-100">
                                                                    {/* Action Bar - COLORFUL & BIGGER ICONS */}
                                                                    <div className="flex items-center justify-center bg-white p-1.5 rounded-full border border-slate-200/80 w-fit mx-auto opacity-90 group-hover:opacity-100 transition-all duration-300 shadow-sm group-hover:shadow-md gap-1">
                                                                        <button onClick={() => {setSelectedLetter(letter); setViewState('detail');}} className="p-2 text-blue-600 bg-blue-50 hover:bg-blue-600 hover:text-white rounded-full transition-all transform hover:scale-110 hover:shadow-md" title="Lihat & Cetak"><Eye size={16} strokeWidth={2.5}/></button>
                                                                        <button onClick={() => {setSelectedLetter(letter); setViewState('edit');}} className="p-2 text-amber-600 bg-amber-50 hover:bg-amber-500 hover:text-white rounded-full transition-all transform hover:scale-110 hover:shadow-md" title="Edit Data"><Edit size={16} strokeWidth={2.5}/></button>
                                                                        <button onClick={() => handleSendWA(letter)} className="p-2 text-emerald-600 bg-emerald-50 hover:bg-emerald-500 hover:text-white rounded-full transition-all transform hover:scale-110 hover:shadow-md" title="Kirim WA"><MessageCircle size={16} strokeWidth={2.5}/></button>
                                                                        <button onClick={() => {setHistoryStudent(letter.namaSiswa); setViewState('history');}} className="p-2 text-purple-600 bg-purple-50 hover:bg-purple-600 hover:text-white rounded-full transition-all transform hover:scale-110 hover:shadow-md" title="Buka Riwayat"><History size={16} strokeWidth={2.5}/></button>
                                                                        <div className="w-[2px] h-6 bg-slate-200 mx-0.5 rounded-full"></div>
                                                                        <button onClick={() => handleDelete(letter.id)} className="p-2 text-rose-600 bg-rose-50 hover:bg-rose-600 hover:text-white rounded-full transition-all transform hover:scale-110 hover:shadow-md" title="Hapus"><Trash2 size={16} strokeWidth={2.5}/></button>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        ))
                                                    ) : (
                                                        <tr>
                                                            <td colSpan="5" className="py-20 text-center rounded-2xl bg-white/50">
                                                                <div className="flex flex-col items-center justify-center gap-4">
                                                                    <div className="w-16 h-16 bg-white rounded-2xl flex items-center justify-center border-2 border-dashed border-slate-200 shadow-sm transform -rotate-6"><Search size={28} className="text-slate-300"/></div>
                                                                    <div>
                                                                        <p className="font-black text-slate-700 text-base tracking-tight">Tidak ada data ditemukan</p>
                                                                        <p className="text-[11px] font-medium text-slate-400 mt-1 max-w-sm mx-auto leading-relaxed">Belum ada dokumen untuk kategori ini atau kata kunci yang dicari tidak cocok.</p>
                                                                    </div>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    )}
                                                </tbody>
                                            </table>
                                        </div>

                                        {/* Pagination Footer - Glass Pill */}
                                        {itemsPerPage !== 'semua' && totalPages > 1 && (
                                            <div className="px-4 py-3 flex items-center justify-center md:justify-between relative z-10 shrink-0 mt-2">
                                                <div className="hidden md:block text-[10px] font-black text-slate-400 uppercase tracking-widest bg-white/60 px-4 py-2 rounded-full shadow-sm border border-slate-100">
                                                    Hal <span className="text-blue-600 mx-1">{currentPage}</span> / {totalPages}
                                                </div>
                                                <div className="flex gap-2 bg-white/60 backdrop-blur-md p-1.5 rounded-full border border-slate-200/60 shadow-sm">
                                                    <button onClick={() => setCurrentPage(p => Math.max(p - 1, 1))} disabled={currentPage === 1} className="px-5 py-2 rounded-full bg-white text-slate-600 hover:text-blue-600 hover:shadow-md disabled:opacity-50 disabled:hover:shadow-none disabled:hover:text-slate-600 transition-all font-bold text-xs flex items-center gap-1.5">
                                                        <ChevronLeft size={14} strokeWidth={3} /> Kembali
                                                    </button>
                                                    <button onClick={() => setCurrentPage(p => Math.min(p + 1, totalPages))} disabled={currentPage === totalPages} className="px-5 py-2 rounded-full bg-white text-slate-600 hover:text-blue-600 hover:shadow-md disabled:opacity-50 disabled:hover:shadow-none disabled:hover:text-slate-600 transition-all font-bold text-xs flex items-center gap-1.5">
                                                        Selanjutnya <ChevronRight size={14} strokeWidth={3} />
                                                    </button>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                            
                            {/* TRACK RECORD VIEW - TIMELINE INTERAKTIF */}
                            {viewState === 'history' && (
                                <div className="space-y-6 max-w-4xl mx-auto animate-fade-in-up pb-10">
                                    <div className="bg-gradient-to-r from-purple-700 via-purple-600 to-indigo-700 p-6 md:p-8 rounded-3xl shadow-xl shadow-purple-900/20 flex flex-col md:flex-row justify-between items-start md:items-center gap-4 text-white sticky top-2 z-20 overflow-hidden border border-purple-400/30">
                                        {/* Ornamen Abstrak */}
                                        <div className="absolute right-0 top-0 w-32 h-32 bg-white opacity-10 rounded-bl-full pointer-events-none"></div>
                                        <div className="relative z-10">
                                            <h2 className="text-sm font-bold text-purple-200 uppercase tracking-widest mb-1 flex items-center gap-2"><History size={16}/> Laporan Riwayat Layanan / Masalah</h2>
                                            <p className="text-3xl font-black drop-shadow-md">{historyStudent}</p>
                                        </div>
                                        <div className="relative z-10">
                                            <button onClick={() => {setHistoryStudent(null); setViewState('list');}} className="px-5 py-2.5 bg-white/20 hover:bg-white/30 backdrop-blur-md rounded-xl text-sm font-bold transition-all shadow-lg flex items-center gap-2 border border-white/30 transform hover:-translate-y-0.5"><ArrowLeft size={18}/> Kembali ke Daftar</button>
                                        </div>
                                    </div>
                                    
                                    <div className="bg-white rounded-3xl shadow-sm border border-slate-200 p-6 md:p-10">
                                        <div className="relative border-l-4 border-slate-100 ml-4 md:ml-8 space-y-10 py-4">
                                            {filteredLetters.length > 0 ? filteredLetters.map((letter, index) => (
                                                <div key={letter.id} className="relative pl-6 md:pl-10 group">
                                                    {/* Titik / Node Timeline */}
                                                    <div className="absolute -left-[14px] top-1.5 w-6 h-6 rounded-full bg-slate-200 border-4 border-white shadow-sm group-hover:scale-125 group-hover:bg-purple-500 group-hover:border-purple-100 transition-all duration-300 z-10"></div>
                                                    
                                                    {/* Kartu Konten */}
                                                    <div className="bg-white hover:bg-purple-50/50 p-6 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition-all duration-300 relative overflow-hidden group-hover:border-purple-200">
                                                        <div className="flex flex-wrap justify-between items-start gap-3 mb-4">
                                                            <span className={`px-3 py-1.5 rounded-full text-xs font-extrabold uppercase tracking-wide border shadow-sm ${getBadgeStyle(letter.type)}`}>
                                                                {letter.type.replace('_', ' ')}
                                                            </span>
                                                            <div className="text-xs font-bold text-slate-600 bg-slate-100 px-3 py-1.5 rounded-lg border border-slate-200 flex items-center gap-1.5 shadow-inner">
                                                                <Calendar size={14} className="text-slate-400"/> {formatDate(letter.tanggal)}
                                                            </div>
                                                        </div>
                                                        <p className="font-mono text-[11px] text-slate-400 mb-3 bg-slate-50 inline-block px-2 py-1 rounded border border-slate-100">Ref: {letter.nomorSurat || '-'}</p>
                                                        <div className="text-sm text-slate-700 bg-slate-50/50 p-4 rounded-xl border border-slate-100 whitespace-pre-line leading-relaxed font-medium">
                                                            {/* Otomatis mengambil isi uraian dari berbagai jenis surat */}
                                                            {renderHistoryContent(letter)}
                                                        </div>
                                                        <div className="mt-4 pt-4 border-t border-slate-100 text-[11px] text-slate-500 font-semibold flex items-center gap-1.5">
                                                            <div className="w-5 h-5 rounded-full bg-slate-200 flex items-center justify-center text-slate-600"><User size={10}/></div>
                                                            Guru BK / Pembuat: <span className="text-purple-600">{letter.createdBy || '-'}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            )) : (
                                                <div className="pl-10 pb-4">
                                                    <div className="bg-slate-50 border border-slate-200 border-dashed rounded-2xl p-8 text-center text-slate-400 flex flex-col items-center gap-3">
                                                        <ShieldCheck size={40} className="text-emerald-300"/>
                                                        <div>
                                                            <p className="font-bold text-slate-600">Catatan Bersih</p>
                                                            <p className="text-xs mt-1">Belum ada riwayat layanan atau pelanggaran yang tercatat untuk siswa ini.</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            {viewState === 'school_settings' && (
                                <SettingsView 
                                    schoolData={schoolData} 
                                    onSaveSchoolData={handleSaveSchoolData} 
                                    onCancel={() => setViewState('list')} 
                                />
                            )}
                            {(viewState === 'create' || viewState === 'edit') && (
                                <LetterForm 
                                    initialData={selectedLetter} 
                                    onSave={handleSaveLetter} 
                                    onCancel={() => {setViewState('list'); setSelectedLetter(null);}} 
                                    currentUser={currentUser}
                                    students={students}
                                    classes={classes}
                                    officials={officials}
                                />
                            )}
                            
                            {viewState === 'detail' && selectedLetter && (
                                <div className="flex flex-col h-full bg-gray-100">
                                    <div className="mb-4 flex justify-between items-center bg-white p-4 shadow-sm border-b border-gray-200 sticky top-0 z-20">
                                        <button onClick={() => {setViewState('list'); setSelectedLetter(null);}} className="flex items-center gap-2 text-gray-600 hover:text-gray-900 bg-gray-50 hover:bg-gray-100 px-4 py-2 rounded-lg transition-colors"><ArrowLeft size={20} /> Kembali</button>
                                        <div className="flex gap-2">
                                            <div className="hidden md:flex items-center gap-2 text-xs text-gray-500 bg-gray-50 px-3 py-2 rounded-lg border border-gray-200">
                                                <span>Dibuat: <strong>{selectedLetter.createdBy || '?'}</strong></span>
                                                {selectedLetter.lastEditedBy && <span>| Edit: <strong>{selectedLetter.lastEditedBy}</strong></span>}
                                            </div>
                                            <button onClick={() => window.print()} className="bg-slate-800 hover:bg-slate-900 text-white px-4 py-2 rounded-lg flex items-center gap-2 shadow-sm transition-colors"><Printer size={20} /> Cetak PDF</button>
                                        </div>
                                    </div>
                                    <div className="flex-1 overflow-auto p-4 flex justify-center bg-gray-100">
                                        <LetterContent data={selectedLetter} schoolData={schoolData} isPreview={true} />
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>
					
					{/* FITUR COMMAND PALETTE (PENCARIAN KILAT) - MUNCUL DENGAN CTRL+K */}
                    {isCmdOpen && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] flex items-start justify-center pt-[10vh] px-4" onClick={() => setIsCmdOpen(false)}>
                            <div className="bg-white w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden animate-fade-in-up" onClick={e => e.stopPropagation()}>
                                <div className="flex items-center px-4 py-3 border-b border-slate-100 bg-slate-50/50">
                                    <Search className="text-blue-500 mr-3 animate-pulse" size={24} />
                                    <input autoFocus type="text" placeholder="Ketik nama siswa atau NISN..." value={cmdQuery} onChange={(e) => setCmdQuery(e.target.value)} className="flex-1 bg-transparent border-none outline-none text-lg font-bold text-slate-800 placeholder-slate-400" />
                                    <div className="flex items-center gap-2">
                                        <span className="text-[10px] text-slate-400 font-medium tracking-widest hidden sm:block">PINTASAN CEPAT</span>
                                        <button onClick={() => setIsCmdOpen(false)} className="bg-slate-200 text-slate-600 text-[10px] px-2 py-1 rounded font-bold hover:bg-red-500 hover:text-white transition-colors">ESC</button>
                                    </div>
                                </div>
                                
                                <div className="max-h-[60vh] overflow-y-auto p-2 custom-scrollbar">
                                    {cmdQuery.length < 2 && (
                                        <div className="text-center py-10">
                                            <div className="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-3 text-slate-400"><Search size={24}/></div>
                                            <p className="text-sm text-slate-500 font-medium">Ketik minimal 2 huruf untuk memunculkan tombol jalan pintas...</p>
                                        </div>
                                    )}
                                    {cmdQuery.length >= 2 && students.filter(s => s['Nama Lengkap'].toLowerCase().includes(cmdQuery.toLowerCase()) || String(s['NISN']).includes(cmdQuery)).slice(0, 6).map((s, idx) => (
                                        <div key={idx} className="p-4 hover:bg-blue-50/80 rounded-xl group transition-colors border border-transparent hover:border-blue-100 mb-1 flex flex-col sm:flex-row sm:items-center justify-between gap-3">
                                            <div>
                                                <h4 className="font-bold text-slate-800 text-sm">{s['Nama Lengkap']}</h4>
                                                <p className="text-xs text-slate-500 font-medium mt-0.5">Kelas {s['Kelas']} â€¢ NISN: {s['NISN']}</p>
                                            </div>
                                            <div className="flex gap-2 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity overflow-x-auto pb-1 sm:pb-0 hide-scrollbar">
                                                <button onClick={() => { setHistoryStudent(s['Nama Lengkap']); setViewState('history'); setIsCmdOpen(false); }} className="px-3 py-1.5 bg-purple-100 text-purple-700 hover:bg-purple-600 hover:text-white rounded-lg text-[11px] font-bold transition-colors flex items-center gap-1.5 whitespace-nowrap shadow-sm"><History size={14}/> Riwayat</button>
                                                <button onClick={() => { setSelectedLetter(null); setActiveTab('SKORSING'); setFormData(prev => ({...prev, namaSiswa: s['Nama Lengkap'], kelas: s['Kelas']})); setViewState('create'); setIsCmdOpen(false); }} className="px-3 py-1.5 bg-red-100 text-red-700 hover:bg-red-600 hover:text-white rounded-lg text-[11px] font-bold transition-colors flex items-center gap-1.5 whitespace-nowrap shadow-sm"><FileWarning size={14}/> Skorsing</button>
                                                <button onClick={() => { setSelectedLetter(null); setActiveTab('UNDANGAN'); setFormData(prev => ({...prev, namaSiswa: s['Nama Lengkap'], kelas: s['Kelas']})); setViewState('create'); setIsCmdOpen(false); }} className="px-3 py-1.5 bg-blue-100 text-blue-700 hover:bg-blue-600 hover:text-white rounded-lg text-[11px] font-bold transition-colors flex items-center gap-1.5 whitespace-nowrap shadow-sm"><Mail size={14}/> Panggil Ortu</button>
                                            </div>
                                        </div>
                                    ))}
                                    {cmdQuery.length >= 2 && students.filter(s => s['Nama Lengkap'].toLowerCase().includes(cmdQuery.toLowerCase()) || String(s['NISN']).includes(cmdQuery)).length === 0 && (
                                        <p className="text-center text-sm text-rose-500 font-medium py-8 bg-rose-50 rounded-xl mt-2">Data siswa "{cmdQuery}" tidak ditemukan di database.</p>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* HIDDEN PRINT AREA */}
                    {viewState === 'detail' && selectedLetter && (<div className="print-area hidden"><LetterContent data={selectedLetter} schoolData={schoolData} isPreview={false} /></div>)}
                </div>
            );
        }

        // --- COMPONENTS ---
        // 1. Komponen Bento Box: Group Menu (Kartu Kategori)
        function SidebarGroup({ title, icon, children, defaultOpen = false }) {
            const [isOpen, setIsOpen] = useState(defaultOpen);
            return (
                <div className="bg-white rounded-2xl shadow-sm border border-slate-200/60 p-2 mb-3 mx-3 transition-all duration-300 hover:border-slate-300 hover:shadow-md">
                    <button onClick={() => setIsOpen(!isOpen)} className="w-full flex items-center justify-between px-3 py-2 text-[12px] font-bold text-slate-700 hover:text-blue-600 transition-colors group">
                        <div className="flex items-center gap-2.5">
                            <span className="text-slate-400 group-hover:text-blue-500 transition-colors">{icon}</span>
                            <span className="tracking-wide">{title}</span>
                        </div>
                        <span className={`transform transition-transform duration-300 text-slate-400 group-hover:text-blue-500 ${isOpen ? 'rotate-180' : ''}`}><ChevronDown size={14}/></span>
                    </button>
                    <div className={`overflow-hidden transition-all duration-300 ease-in-out ${isOpen ? 'max-h-[1000px] opacity-100 mt-1' : 'max-h-0 opacity-0'}`}>
                        <div className="flex flex-col gap-1 pt-2 border-t border-slate-100/80">
                            {children}
                        </div>
                    </div>
                </div>
            );
        }

        // 2. Komponen Bento Box: Sidebar Item Super Clean
        function SidebarItem({ icon, label, active, onClick }) {
            return (
                <button onClick={onClick} className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-xl transition-all duration-200 group ${active ? 'bg-blue-50 text-blue-700 font-bold' : 'text-slate-600 hover:bg-slate-50 hover:text-slate-900 font-medium'}`}>
                    <div className={`flex items-center justify-center shrink-0 transition-transform duration-300 ${active ? 'text-blue-600 scale-110' : 'text-slate-400 group-hover:text-slate-600'}`}>
                        {React.cloneElement(icon, { size: 18, strokeWidth: active ? 2.5 : 2 })}
                    </div>
                    <span className="text-[13px] tracking-wide text-left flex-1">{label}</span>
                    
                    {/* Titik Pemanis untuk Menu Aktif */}
                    {active && <div className="w-1.5 h-1.5 rounded-full bg-blue-600 shadow-[0_0_5px_rgba(37,99,235,0.5)] mr-1"></div>}
                </button>
            );
        }

        // 3. Konten Sidebar Utama (Bento Layout)
        function SidebarContent({ activeTab, setActiveTab, setViewState, currentUser, onLogout }) {
            return (
                <div className="flex flex-col h-full text-slate-800 bg-slate-50/50"> 
                    
                    {/* Bento Card 1: Logo & Branding */}
                    <div className="m-4 bg-white rounded-2xl shadow-sm border border-slate-200/60 p-4 flex items-center gap-3 shrink-0">
                        {/* Ini yang diubah: Kotak Ikon Awan diganti jadi Image Logo */}
						<div className="w-10 h-15 rounded-xl bg-white flex items-center justify-center shadow-md shadow-blue-600/20 shrink-0 border border-slate-100 overflow-hidden">
							<img 
								src="https://lh3.googleusercontent.com/u/0/d/1Wr_uC9C32tjzN19PZXLsk3tyBNrzO1wy" 
								alt="Logo" 
								className="w-full h-full object-contain p-1" 
							/>
						</div>

						<div className="overflow-hidden">
							<h1 className="text-lg font-black tracking-tight text-slate-800 leading-none">AKSARA<span className="text-blue-600">-16</span></h1>
							<p className="text-[9px] text-slate-500 mt-1 font-bold tracking-[0.15em] uppercase truncate">Aplikasi Persuratan</p>
						</div>
					</div>
                    
                    {/* Menu Navigation */}
                    <nav className="flex-1 overflow-y-auto custom-scrollbar flex flex-col pb-4">
                        
                        {/* Bento Card 2: Dashboard (Standalone) */}
                        <div className="bg-white rounded-2xl shadow-sm border border-slate-200/60 p-2 mb-3 mx-4 hover:border-slate-300 hover:shadow-md transition-all">
                            <SidebarItem icon={<LayoutDashboard size={18}/>} label="Dashboard Utama" active={activeTab === 'dashboard'} onClick={() => {setActiveTab('dashboard'); setViewState('list');}} />
                        </div>

                        {/* KATEGORI 1 */}
                        <SidebarGroup icon={<ShieldCheck size={16}/>} title="Pembinaan & Disiplin" defaultOpen={['SKORSING', 'PERNYATAAN', 'KONTRAK'].includes(activeTab)}>
                            <SidebarItem icon={<FileSignature size={18}/>} label="Surat Pernyataan" active={activeTab === 'PERNYATAAN'} onClick={() => {setActiveTab('PERNYATAAN'); setViewState('list');}} />
                            <SidebarItem icon={<FileCheck size={18}/>} label="Kontrak Perilaku" active={activeTab === 'KONTRAK'} onClick={() => {setActiveTab('KONTRAK'); setViewState('list');}} />
                            <SidebarItem icon={<FileWarning size={18}/>} label="Surat Skorsing" active={activeTab === 'SKORSING'} onClick={() => {setActiveTab('SKORSING'); setViewState('list');}} />
                        </SidebarGroup>
                        
                        {/* KATEGORI 2 */}
                        <SidebarGroup icon={<MessageCircle size={16}/>} title="Layanan & Konseling" defaultOpen={['BUKU_TAMU', 'KONSELING_KELOMPOK', 'BIMBINGAN_KELOMPOK', 'MEDIASI', 'KONFERENSI_KASUS', 'ALIH_KASUS', 'ADVOKASI'].includes(activeTab)}>
                            <SidebarItem icon={<BookOpen size={18}/>} label="Buku Tamu Harian" active={activeTab === 'BUKU_TAMU'} onClick={() => {setActiveTab('BUKU_TAMU'); setViewState('list');}} />
                            <SidebarItem icon={<Users size={18}/>} label="Konseling Kelompok" active={activeTab === 'KONSELING_KELOMPOK'} onClick={() => {setActiveTab('KONSELING_KELOMPOK'); setViewState('list');}} />
                            <SidebarItem icon={<Users size={18}/>} label="Bimbingan Kelompok" active={activeTab === 'BIMBINGAN_KELOMPOK'} onClick={() => {setActiveTab('BIMBINGAN_KELOMPOK'); setViewState('list');}} />
                            <SidebarItem icon={<Users size={18}/>} label="Berita Acara Mediasi" active={activeTab === 'MEDIASI'} onClick={() => {setActiveTab('MEDIASI'); setViewState('list');}} />
                            <SidebarItem icon={<Users size={18}/>} label="Konferensi Kasus" active={activeTab === 'KONFERENSI_KASUS'} onClick={() => {setActiveTab('KONFERENSI_KASUS'); setViewState('list');}} />
                            <SidebarItem icon={<Share size={18}/>} label="Alih Tangan Kasus" active={activeTab === 'ALIH_KASUS'} onClick={() => {setActiveTab('ALIH_KASUS'); setViewState('list');}} />
                            <SidebarItem icon={<MessageCircle size={18}/>} label="Berita Acara Advokasi" active={activeTab === 'ADVOKASI'} onClick={() => {setActiveTab('ADVOKASI'); setViewState('list');}} />
                        </SidebarGroup>

                        {/* KATEGORI 3 */}
                        <SidebarGroup icon={<Briefcase size={16}/>} title="Kemitraan & Kunjungan" defaultOpen={['UNDANGAN', 'TUGAS_HOMEVISIT', 'LAPORAN_HOMEVISIT'].includes(activeTab)}>
                            <SidebarItem icon={<Mail size={18}/>} label="Undangan Orang Tua" active={activeTab === 'UNDANGAN'} onClick={() => {setActiveTab('UNDANGAN'); setViewState('list');}} />
                            <SidebarItem icon={<Briefcase size={18}/>} label="Tugas Home Visit" active={activeTab === 'TUGAS_HOMEVISIT'} onClick={() => {setActiveTab('TUGAS_HOMEVISIT'); setViewState('list');}} />
                            <SidebarItem icon={<ClipboardList size={18}/>} label="Laporan Home Visit" active={activeTab === 'LAPORAN_HOMEVISIT'} onClick={() => {setActiveTab('LAPORAN_HOMEVISIT'); setViewState('list');}} />
                        </SidebarGroup>

                        {/* KATEGORI 4 */}
                        <SidebarGroup icon={<FileCheck size={16}/>} title="Keterangan & Keluar" defaultOpen={['SKBB', 'REKOMENDASI_STUDI', 'BERHENTI'].includes(activeTab)}>
                            <SidebarItem icon={<ShieldCheck size={18}/>} label="Ket. Berkelakuan Baik" active={activeTab === 'SKBB'} onClick={() => {setActiveTab('SKBB'); setViewState('list');}} />
                            <SidebarItem icon={<FileCheck size={18}/>} label="Rekomendasi Studi" active={activeTab === 'REKOMENDASI_STUDI'} onClick={() => {setActiveTab('REKOMENDASI_STUDI'); setViewState('list');}} />
                            <SidebarItem icon={<UserMinus size={18}/>} label="Berhenti / Keluar" active={activeTab === 'BERHENTI'} onClick={() => {setActiveTab('BERHENTI'); setViewState('list');}} />
                        </SidebarGroup>

                        {/* KATEGORI PENGATURAN */}
                        <SidebarGroup icon={<Building2 size={16}/>} title="Pengaturan Sistem" defaultOpen={['SCHOOL_DATA', 'KIOSK'].includes(activeTab)}>
                            <SidebarItem icon={<Building2 size={18}/>} label="Identitas Sekolah" active={activeTab === 'SCHOOL_DATA'} onClick={() => {setActiveTab('SCHOOL_DATA'); setViewState('school_settings');}} />
                            <SidebarItem icon={<Monitor size={18}/>} label="Resepsionis Digital" active={false} onClick={() => setViewState('kiosk')} />
                        </SidebarGroup>
                    </nav>

                    {/* Bento Card: User Profile */}
                    <div className="m-4 mt-auto bg-white rounded-2xl shadow-sm border border-slate-200/60 p-3 shrink-0 hover:border-slate-300 transition-colors">
                        <div className="flex items-center justify-between">
                            <div className="flex items-center gap-3 overflow-hidden">
                                <div className="w-10 h-10 rounded-xl bg-slate-100 text-slate-600 flex items-center justify-center font-black text-sm shrink-0 border border-slate-200">
                                    <User size={20} strokeWidth={2.5} />
								</div>
								<div className="overflow-hidden">
									<p className="text-sm font-bold text-slate-800 truncate leading-tight">{currentUser?.username || 'User'}</p>
									<div className="flex items-center gap-1.5 mt-0.5">
										<span className="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>
										<p className="text-[10px] text-slate-500 font-medium uppercase tracking-wide">Konselor Aktif</p>
									</div>
								</div>
							</div>
                            <button onClick={() => {
                                Swal.fire({
                                    title: 'Keluar Aplikasi?',
                                    text: "Sesi anda akan diakhiri.",
                                    icon: 'question',
                                    showCancelButton: true,
                                    confirmButtonColor: '#3b82f6',
                                    cancelButtonColor: '#ef4444',
                                    confirmButtonText: 'Ya, Keluar',
                                    cancelButtonText: 'Batal'
                                }).then((result) => {
                                    if (result.isConfirmed) onLogout();
                                });
                            }} className="p-2.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-xl transition-all" title="Keluar">
                                <LogOut size={18}/>
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // SETTINGS (UPDATED WITH USER MANAGEMENT)
        function SettingsView({ schoolData, onSaveSchoolData, onCancel }) {
            const [formData, setFormData] = useState(schoolData);
            const [newUser, setNewUser] = useState({ username: '', password: '' });
            const [showNewUserPass, setShowNewUserPass] = useState(false);

            const handleChange = (e) => setFormData({ ...formData, [e.target.name]: e.target.value });
            
            const handleAddUser = () => {
                if(!newUser.username || !newUser.password) return Swal.fire('Oops!', 'Username dan Password wajib diisi', 'warning');
                const currentUsers = formData.users || [];
                const updatedUsers = [...currentUsers, newUser];
                setFormData({ ...formData, users: updatedUsers });
                setNewUser({ username: '', password: '' });
            };
            
            const handleDeleteUser = (idx) => {
			Swal.fire({
				title: 'Hapus User?',
				text: "User ini akan dihapus dari daftar.",
				icon: 'warning',
				showCancelButton: true,
				confirmButtonColor: '#d33',
				cancelButtonColor: '#3085d6',
				confirmButtonText: 'Ya, Hapus'
			}).then((result) => {
				if (result.isConfirmed) {
					const updatedUsers = formData.users.filter((_, i) => i !== idx);
					setFormData({ ...formData, users: updatedUsers });
				}
			});
		};

            return (
                <div className="max-w-4xl mx-auto bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden mb-10">
                    <div className="bg-gray-50 px-4 md:px-6 py-4 border-b border-gray-200 flex justify-between items-center sticky top-0 z-10">
                        <h2 className="text-lg font-bold text-gray-800">Pengaturan & Manajemen User</h2>
                        <button onClick={onCancel}><X size={24} className="text-gray-400 hover:text-gray-600"/></button>
                    </div>
                    <div className="p-6 overflow-y-auto max-h-[80vh]">
                        <form onSubmit={(e) => { e.preventDefault(); onSaveSchoolData(formData); }} className="space-y-8">
                            
                            {/* USER MANAGEMENT SECTION */}
                            <div className="bg-yellow-50 p-4 rounded-lg border border-yellow-100">
                                <h3 className="text-sm font-bold text-yellow-800 uppercase mb-3 flex items-center gap-2"><User size={16}/> Manajemen Guru BK (Login)</h3>
                                <div className="space-y-4">
                                    <div className="flex gap-2 items-end">
                                        <div className="flex-1">
                                            <label className="block text-xs font-medium text-gray-600">Username Baru</label>
                                            <input type="text" value={newUser.username} onChange={e=>setNewUser({...newUser, username: e.target.value})} className="w-full p-2 text-sm border rounded" placeholder="Contoh: Pak Budi"/>
                                        </div>
                                        <div className="flex-1 relative">
                                            <label className="block text-xs font-medium text-gray-600">Password</label>
                                            <input type={showNewUserPass ? "text" : "password"} value={newUser.password} onChange={e=>setNewUser({...newUser, password: e.target.value})} className="w-full p-2 text-sm border rounded pr-8" placeholder="****"/>
                                             <button type="button" onClick={() => setShowNewUserPass(!showNewUserPass)} className="absolute right-2 top-6 text-gray-400">
                                                {showNewUserPass ? <EyeOff size={14}/> : <Eye size={14}/>}
                                            </button>
                                        </div>
                                        <button type="button" onClick={handleAddUser} className="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded text-sm font-bold">Tambah</button>
                                    </div>
                                    <div className="border-t pt-2">
                                        <p className="text-xs text-gray-500 mb-2">Daftar Guru Terdaftar:</p>
                                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                            {formData.users && formData.users.map((u, idx) => (
                                                <div key={idx} className="flex justify-between items-center bg-white p-2 rounded border shadow-sm">
                                                    <span className="font-semibold text-sm">{u.username}</span>
                                                    <button type="button" onClick={() => handleDeleteUser(idx)} className="text-red-500 hover:text-red-700"><Trash2 size={14}/></button>
                                                </div>
                                            ))}
                                            {(!formData.users || formData.users.length === 0) && <p className="text-xs text-red-500 italic">Belum ada user. Login pakai admin/admin123</p>}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div className="space-y-4 border-t pt-4">
                                <h3 className="text-sm font-bold text-blue-800 uppercase border-b pb-2">Identitas Sekolah</h3>
                                <div><label className="block text-sm font-medium text-gray-700">Pemerintah Daerah</label><input type="text" name="pemerintah" value={formData.pemerintah} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" required /></div>
                                <div><label className="block text-sm font-medium text-gray-700">Instansi</label><input type="text" name="instansi" value={formData.instansi} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" required /></div>
                                <div><label className="block text-sm font-medium text-gray-700">Nama Sekolah</label><input type="text" name="namaSekolah" value={formData.namaSekolah} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" required /></div>
                                <div><label className="block text-sm font-medium text-gray-700">Alamat Lengkap</label><textarea name="alamat" value={formData.alamat} onChange={handleChange} rows="3" className="w-full p-2 border border-gray-300 rounded-md" required></textarea></div>
                            </div>
                            <div className="space-y-4">
                                <h3 className="text-sm font-bold text-blue-800 uppercase border-b pb-2">Logo (Link Gambar)</h3>
                                <div className="grid grid-cols-2 gap-6">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">URL Logo Kiri</label>
                                        <input type="text" name="logoKiri" value={formData.logoKiri || ''} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md text-xs" placeholder="https://..." />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">URL Logo Kanan</label>
                                        <input type="text" name="logoKanan" value={formData.logoKanan || ''} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md text-xs" placeholder="https://..." />
                                    </div>
                                </div>
                            </div>
                            <div className="flex justify-end pt-4"><button type="submit" className="px-6 py-2 bg-blue-600 text-white rounded-lg text-sm flex items-center gap-2"><Save size={16}/> Simpan Semua ke Cloud</button></div>
                        </form>
                    </div>
                </div>
            );
        }

        // LETTER FORM (UPDATED WITH SMART FEATURES)
        function LetterForm({ initialData, onSave, onCancel, currentUser, students, classes, officials }) {
            const defaults = { 
                type: 'SKORSING', 
                nomorSurat: '', 
                tanggal: new Date().toISOString().split('T')[0], 
                tempat: 'Makassar', 
                namaSiswa: '', nisn: '', jenisKelamin: 'Laki-laki', kelas: '', 
                alasan: '', lamaSkorsing: '', tanggalMulai: '', tanggalSelesai: '', 
                namaOrangTua: '', alamatOrangTua: '', noHpOrangTua: '', 
                permasalahan: '', isiPernyataan: '', 
                hariTanggalAcara: '', waktuAcara: '', tempatAcara: '', keperluan: '', lampiran: '-', perihal: 'Undangan Orang Tua/Wali', 
                namaWaliKelas: '', nipWaliKelas: '', 
                tanggalKontrak: new Date().toISOString().split('T')[0], tanggalTinjauan: '', deskripsiPerilaku: '', tujuanPerubahan: '', rencanaTindakan: '', konsekuensi: '', statusKontrak: 'Aktif', 
                // NEW FIELDS for V2
                namaPetugas: '', nipPetugas: '', 
                pihakDitemui: '', statusPihakDitemui: 'Orang Tua', 
                gambaranMasalah: '', hasilPembicaraan: '', tindakLanjut: '', 
                pihakTujuan: '', rincianMasalah: '', riwayatPenanganan: '', 
				// NEW FIELDS FOR V3 (MEDIASI & BERHENTI)
                namaSiswa2: '', kelas2: '', nisn2: '', jenisKelamin2: 'Laki-laki', namaOrangTua2: '',
                namaWaliKelas2: '', nipWaliKelas2: '',
                hasilMediasi: '', kesepakatan: '',
                namaSaksi: '', nipSaksi: '', statusSaksi: 'Wali Kelas', // Saksi BK or General
                alasanBerhenti: '',
				hasilKonferensi: '', tempatAcara: 'Ruang BK', pesertaKonferensi: [{ nama: '', unsur: 'Wali Kelas' }],
				pihakTerkait: '', statusPihakTerkait: '', latarBelakang: '', tujuanAdvokasi: '', hasilAdvokasi: '',
				topikBimbingan: '', tujuanBimbingan: '', uraianKegiatan: '', hasilBimbingan: '', pesertaBimbingan: [{ nama: '', kelas: '' }],
				teknikKonseling: '', fokusMasalah: '', dinamikaKonseling: '', evaluasiKonseling: '', tindakLanjutKonseling: '', klienKonseling: [{ nama: '', kelas: '' }],
                // Shared fields
                penandaTangan: 'Drs. Kepala Sekolah', nipPenandaTangan: '', jabatan: 'Kepala Sekolah', 
                createdBy: currentUser.username 
            };
            
            const [formData, setFormData] = useState(initialData || defaults);
            const [showStudentSuggestions, setShowStudentSuggestions] = useState(false);
			const [showStudentSuggestions2, setShowStudentSuggestions2] = useState(false); // For Student 2
			const [activePesertaIndex, setActivePesertaIndex] = useState(null);
			const [activeKlienIndex, setActiveKlienIndex] = useState(null);
            const [filteredStudents, setFilteredStudents] = useState([]);
			const [isAILoading, setIsAILoading] = useState(false);

            // --- LOGIKA AI SULAP KATA ---
            const handleAskAI = async (stateKey, fieldLabel) => {
                const currentText = formData[stateKey];
                if (!currentText || currentText.trim().length < 3) {
                    Swal.fire('Ketik Dulu!', 'Ketik minimal 1-2 kata kunci (contoh: "rokok wc" atau "bolos pagar") baru klik tombol sulap AI.', 'info');
                    return;
                }

                setIsAILoading(true);
                Swal.fire({
                    title: 'ðŸª„ AI Sedang Merangkai Kata...',
                    html: 'Mohon tunggu sebentar...',
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    didOpen: () => { Swal.showLoading(); }
                });

                try {
                    const response = await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: 'generateAIText',
                            payload: { keyword: currentText, letterType: formData.type, fieldName: fieldLabel }
                        })
                    });
                    const result = await response.json();

                    if (result.status === 'success') {
                        // Memasukkan hasil AI langsung ke textarea (jadi tetap bisa diedit guru!)
                        setFormData(prev => ({ ...prev, [stateKey]: result.result }));
                        Swal.fire({ icon: 'success', title: 'Sulap Berhasil!', text: 'Silakan edit/rapikan lagi jika ada yang kurang pas.', timer: 2500, showConfirmButton: false });
                    } else {
                        Swal.fire('Gagal', result.message, 'error');
                    }
                } catch (err) {
                    Swal.fire('Error', 'Gagal terhubung ke AI. Pastikan internet jalan.', 'error');
                } finally {
                    setIsAILoading(false);
                }
            };

            // --- KOMPONEN TOMBOL SULAP (Biar gampang dipasang di atas kolom) ---
            const AILabel = ({ label, stateKey }) => (
                <div className="flex justify-between items-end mb-1">
                    <label className="block text-sm font-medium text-gray-700">{label}</label>
                    <button type="button" onClick={() => handleAskAI(stateKey, label)} disabled={isAILoading} className="flex items-center gap-1 text-[10px] bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white px-2 py-1 rounded shadow-md transition-all transform hover:-translate-y-0.5 disabled:opacity-50" title="Ubah kata kunci jadi kalimat baku">
                        <Sparkles size={12}/> AI Sulap
                    </button>
                </div>
            );

            const handleChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));

            // --- SMART LOGIC: STUDENT SEARCH 1 ---
            const handleSearchStudent = (e) => {
                const value = e.target.value;
                setFormData(prev => ({ ...prev, namaSiswa: value }));
                
                if (value.length > 2 && students.length > 0) {
                    const filtered = students.filter(s => 
                        s['Nama Lengkap'].toLowerCase().includes(value.toLowerCase()) || 
                        String(s['NISN']).includes(value)
                    );
                    setFilteredStudents(filtered);
                    setShowStudentSuggestions(true);
                } else {
                    setShowStudentSuggestions(false);
                }
            };
			
			// --- SMART LOGIC: STUDENT SEARCH 2 (MEDIASI) ---
             const handleSearchStudent2 = (e) => {
                const value = e.target.value;
                setFormData(prev => ({ ...prev, namaSiswa2: value }));
                
                if (value.length > 2 && students.length > 0) {
                    const filtered = students.filter(s => 
                        s['Nama Lengkap'].toLowerCase().includes(value.toLowerCase()) || 
                        String(s['NISN']).includes(value)
                    );
                    setFilteredStudents(filtered);
                    setShowStudentSuggestions2(true);
                } else {
                    setShowStudentSuggestions2(false);
                }
            };

            const handleSelectStudent = (student, isSecond = false) => {
                // 1. Auto Fill Siswa
                const updates = {};
                const suffix = isSecond ? '2' : '';
                
                updates[`namaSiswa${suffix}`] = student['Nama Lengkap'];
                updates[`nisn${suffix}`] = student['NISN'];
                updates[`kelas${suffix}`] = student['Kelas'];
                updates[`jenisKelamin${suffix}`] = student['Jenis Kelamin'] || 'Laki-laki';

                // 2. Auto Fill Wali Kelas (Cari di DB Kelas)
                if (classes && classes.length > 0) {
                    const kelasInfo = classes.find(c => String(c['Nama Kelas']).toLowerCase() === String(student['Kelas']).toLowerCase());
                    if (kelasInfo) {
                        updates[`namaWaliKelas${suffix}`] = kelasInfo['Nama Wali Kelas'];
                        updates[`nipWaliKelas${suffix}`] = kelasInfo['NIP Wali Kelas'];
                    }
                }

                setFormData(prev => ({ ...prev, ...updates }));
                
                if(isSecond) setShowStudentSuggestions2(false);
                else setShowStudentSuggestions(false);
            };

            // --- SMART LOGIC: PEJABAT ---
            const handleSelectOfficial = (e) => {
                const selectedName = e.target.value;
                if (!selectedName) return;

                const official = officials.find(o => o['Nama Pejabat'] === selectedName);
                if (official) {
                    setFormData(prev => ({
                        ...prev,
                        penandaTangan: official['Nama Pejabat'],
                        nipPenandaTangan: official['NIP'],
                        jabatan: official['Jabatan']
                    }));
                }
            };
			
			const handleAddPeserta = () => setFormData(prev => ({ ...prev, pesertaKonferensi: [...(prev.pesertaKonferensi || []), { nama: '', unsur: '' }] }));
			const handleRemovePeserta = (index) => setFormData(prev => ({ ...prev, pesertaKonferensi: prev.pesertaKonferensi.filter((_, i) => i !== index) }));
			const handleChangePeserta = (index, field, value) => {
				const newPeserta = [...(formData.pesertaKonferensi || [])];
				newPeserta[index][field] = value;
				setFormData(prev => ({ ...prev, pesertaKonferensi: newPeserta }));
			};
			
			// --- LOGIKA DINAMIS NILAI MAPEL (SURAT REKOMENDASI) ---
			const handleAddMapel = () => {
				setFormData(prev => ({
					...prev,
					nilaiMapel: [...(prev.nilaiMapel || []), { mapel: '', nilai: '' }]
				}));
			};
			const handleRemoveMapel = (index) => {
				const newList = [...(formData.nilaiMapel || [])];
				newList.splice(index, 1);
				setFormData(prev => ({ ...prev, nilaiMapel: newList }));
			};
			const handleChangeMapel = (index, field, value) => {
				const newList = [...(formData.nilaiMapel || [])];
				newList[index][field] = value;
				setFormData(prev => ({ ...prev, nilaiMapel: newList }));
			};
			
			const handleAddPesertaBimbingan = () => setFormData(prev => ({ ...prev, pesertaBimbingan: [...(prev.pesertaBimbingan || []), { nama: '', kelas: '' }] }));
            const handleRemovePesertaBimbingan = (index) => setFormData(prev => ({ ...prev, pesertaBimbingan: prev.pesertaBimbingan.filter((_, i) => i !== index) }));
            const handleChangePesertaBimbingan = (index, value) => {
                const newPeserta = [...(formData.pesertaBimbingan || [])];
                newPeserta[index].nama = value;
                setFormData(prev => ({ ...prev, pesertaBimbingan: newPeserta }));
                
                if (value.length > 2) {
                    const filtered = students.filter(s => 
                        s['Nama Lengkap'].toLowerCase().includes(value.toLowerCase())
                    );
                    setFilteredStudents(filtered);
                    setActivePesertaIndex(index); // Menandai baris mana yang sedang mengetik
                } else {
                    setActivePesertaIndex(null);
                }
            };

            const handleSelectPesertaBimbingan = (student, index) => {
                const newPeserta = [...(formData.pesertaBimbingan || [])];
                newPeserta[index].nama = student['Nama Lengkap'];
                newPeserta[index].kelas = student['Kelas'];
                setFormData(prev => ({ ...prev, pesertaBimbingan: newPeserta }));
                setActivePesertaIndex(null); // Tutup dropdown
            };
			
			const handleAddKlien = () => setFormData(prev => ({ ...prev, klienKonseling: [...(prev.klienKonseling || []), { nama: '', kelas: '' }] }));
            const handleRemoveKlien = (index) => setFormData(prev => ({ ...prev, klienKonseling: prev.klienKonseling.filter((_, i) => i !== index) }));
            const handleChangeKlien = (index, value) => {
                const newKlien = [...(formData.klienKonseling || [])];
                newKlien[index].nama = value;
                setFormData(prev => ({ ...prev, klienKonseling: newKlien }));
                if (value.length > 2) {
                    const filtered = students.filter(s => s['Nama Lengkap'].toLowerCase().includes(value.toLowerCase()));
                    setFilteredStudents(filtered);
                    setActiveKlienIndex(index);
                } else {
                    setActiveKlienIndex(null);
                }
            };
            const handleSelectKlien = (student, index) => {
                const newKlien = [...(formData.klienKonseling || [])];
                newKlien[index].nama = student['Nama Lengkap'];
                newKlien[index].kelas = student['Kelas'];
                setFormData(prev => ({ ...prev, klienKonseling: newKlien }));
                setActiveKlienIndex(null);
            };

            return (
                <div className="max-w-4xl mx-auto bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden mb-20 flex flex-col max-h-[90vh]">
                    <datalist id="violationList">
                        <option value="Sering terlambat datang ke sekolah" />
                        <option value="Tidak masuk sekolah tanpa keterangan (Alpa)" />
                        <option value="Merokok di lingkungan sekolah" />
                        <option value="Berkelahi dengan teman sekelas" />
                        <option value="Melompat pagar sekolah" />
                        <option value="Menggunakan atribut tidak lengkap" />
                    </datalist>

                    <div className="bg-gray-50 px-4 md:px-6 py-4 border-b border-gray-200 flex justify-between items-center sticky top-0 z-10">
                        <h2 className="text-lg font-bold text-gray-800">{initialData ? 'Edit Surat' : 'Buat Surat Baru'}</h2>
                        <button onClick={onCancel}><X size={24} className="text-gray-400 hover:text-gray-600" /></button>
                    </div>
                    
                    <div className="overflow-y-auto p-4 md:p-6 flex-1 custom-scrollbar">
                        <form onSubmit={(e) => { e.preventDefault(); onSave(formData); }} className="space-y-6">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div className="space-y-1">
                                    <label className="block text-[11px] font-bold text-gray-500 uppercase tracking-wider mb-2">Pilih Jenis Surat / Layanan</label>
                                    <div className="relative group">
                                        <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <ClipboardList className={`h-5 w-5 transition-colors ${!!initialData ? 'text-gray-400' : 'text-blue-500 group-hover:text-blue-600'}`} />
                                        </div>
                                        <select 
                                            name="type" 
                                            value={formData.type} 
                                            onChange={(e) => setFormData({...defaults, type: e.target.value})} 
                                            disabled={!!initialData} 
                                            className={`w-full pl-10 pr-10 py-3 border appearance-none outline-none transition-all duration-300 shadow-sm rounded-xl ${!!initialData ? 'bg-gray-100 border-gray-200 text-gray-500 cursor-not-allowed' : 'bg-white border-blue-200 text-slate-800 hover:border-blue-400 focus:ring-4 focus:ring-blue-500/20 focus:border-blue-500 font-bold text-sm cursor-pointer'}`}
                                        >
                                            <optgroup label="ðŸ›¡ï¸ Pembinaan & Kedisiplinan">
                                                <option value="PERNYATAAN">Surat Pernyataan Orangtua</option>
                                                <option value="KONTRAK">Kontrak Perilaku Siswa</option>
                                                <option value="SKORSING">Surat Skorsing</option>
                                            </optgroup>
                                            <optgroup label="ðŸ¤ Layanan Responsif & Konseling">
                                                <option value="BUKU_TAMU">Buku Tamu Harian BK</option>
                                                <option value="KONSELING_KELOMPOK">Konseling Kelompok</option>
                                                <option value="BIMBINGAN_KELOMPOK">Bimbingan Kelompok</option>
                                                <option value="MEDIASI">Berita Acara Mediasi</option>
                                                <option value="KONFERENSI_KASUS">Berita Acara Konferensi Kasus</option>
                                                <option value="ALIH_KASUS">Alih Tangan Kasus (Referral)</option>
                                                <option value="ADVOKASI">Berita Acara Advokasi</option>
                                            </optgroup>
                                            <optgroup label="ðŸ¡ Kemitraan & Kunjungan">
                                                <option value="UNDANGAN">Surat Undangan Orangtua</option>
                                                <option value="TUGAS_HOMEVISIT">Surat Tugas Home Visit</option>
                                                <option value="LAPORAN_HOMEVISIT">Laporan Hasil Home Visit</option>
                                            </optgroup>
                                            <optgroup label="ðŸ“„ Surat Keterangan & Keluar">
                                                <option value="SKBB">Ket. Berkelakuan Baik</option>
                                                <option value="REKOMENDASI_STUDI">Surat Rekomendasi Peminatan/Studi</option>
                                                <option value="BERHENTI">Surat Berhenti / Pindah Keluar</option>
                                            </optgroup>
                                        </select>
                                        <div className="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                            <ChevronDown className={`h-5 w-5 transition-transform duration-300 ${!!initialData ? 'text-gray-400' : 'text-blue-500 group-hover:translate-y-0.5'}`} />
                                        </div>
                                    </div>
                                    {!!initialData && <p className="text-[10px] text-orange-500 italic mt-1 pl-1">*Jenis surat dikunci saat mode edit data.</p>}
                                </div>
                                <div className="grid grid-cols-2 gap-4"><div className="space-y-2"><label className="block text-sm font-medium text-gray-700">Tanggal Surat</label><input type="date" name="tanggal" value={formData.tanggal} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" required /></div><div className="space-y-2"><label className="block text-sm font-medium text-gray-700">Tempat Penetapan</label><input type="text" name="tempat" value={formData.tempat} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" required /></div></div>
                            </div>
                            
                            {/* IDENTITAS SISWA */}
							{formData.type !== 'BIMBINGAN_KELOMPOK' && formData.type !== 'KONSELING_KELOMPOK' && (
								<div className="bg-blue-50 p-4 rounded-lg space-y-4 border border-blue-100 relative">
									<h3 className="font-semibold text-blue-800 text-sm uppercase flex items-center gap-2"><User size={16}/> Identitas Siswa</h3>
									<div className="grid grid-cols-1 md:grid-cols-2 gap-4">
										<div className="relative">
											<label className="block text-xs font-medium text-gray-600 mb-1">Nama Siswa (Cari disini...)</label>
											<input type="text" name="namaSiswa" value={formData.namaSiswa} onChange={handleSearchStudent} autoComplete="off" className="w-full p-2 border border-blue-200 rounded-md focus:ring-2 focus:ring-blue-200 focus:outline-none font-semibold" required placeholder="Ketik nama siswa..." />
											{showStudentSuggestions && (
												<div className="autocomplete-items">
													{filteredStudents.map((s, idx) => (
														<div key={idx} onClick={() => handleSelectStudent(s)}>
															<strong>{s['Nama Lengkap']}</strong> <span className="text-gray-500 text-xs">({s['Kelas']})</span>
														</div>
													))}
													{filteredStudents.length === 0 && <div className="text-gray-400 italic">Siswa tidak ditemukan</div>}
												</div>
											)}
										</div>
										<div><label className="block text-xs font-medium text-gray-600 mb-1">NISN</label><input type="text" name="nisn" value={formData.nisn} onChange={handleChange} className="w-full p-2 border border-blue-200 rounded-md focus:ring-2 focus:ring-blue-200 focus:outline-none" /></div>
										<div><label className="block text-xs font-medium text-gray-600 mb-1">Jenis Kelamin</label><select name="jenisKelamin" value={formData.jenisKelamin} onChange={handleChange} className="w-full p-2 border border-blue-200 rounded-md"><option value="Laki-laki">Laki-laki</option><option value="Perempuan">Perempuan</option></select></div>
										<div><label className="block text-xs font-medium text-gray-600 mb-1">Kelas</label><input type="text" name="kelas" value={formData.kelas} onChange={handleChange} className="w-full p-2 border border-blue-200 rounded-md focus:ring-2 focus:ring-blue-200 focus:outline-none" required /></div>
										{formData.type !== 'SKORSING' && formData.type !== 'KONTRAK' && formData.type !== 'SKBB' && (
											<div className="md:col-span-2"><label className="block text-xs font-medium text-gray-600 mb-1">Alamat Siswa</label><input type="text" name="alamatOrangTua" value={formData.alamatOrangTua} onChange={handleChange} className="w-full p-2 border border-blue-200 rounded-md focus:ring-2 focus:ring-blue-200 focus:outline-none" /></div>
										)}
									</div>
								</div>
							)}
							
							{/* KHUSUS MEDIASI: IDENTITAS SISWA 2 */}
                             {formData.type === 'MEDIASI' && (
                                <div className="bg-pink-50 p-4 rounded-lg space-y-4 border border-pink-100 relative">
                                    <h3 className="font-semibold text-pink-800 text-sm uppercase flex items-center gap-2"><User size={16}/> Identitas Siswa (Pihak 2)</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div className="relative">
                                            <label className="block text-xs font-medium text-gray-600 mb-1">Nama Siswa Pihak 2</label>
                                            <input type="text" name="namaSiswa2" value={formData.namaSiswa2} onChange={handleSearchStudent2} autoComplete="off" className="w-full p-2 border border-pink-200 rounded-md focus:ring-2 focus:ring-pink-200 focus:outline-none font-semibold" required />
                                            {showStudentSuggestions2 && (
                                                <div className="autocomplete-items">
                                                    {filteredStudents.map((s, idx) => (
                                                        <div key={idx} onClick={() => handleSelectStudent(s, true)}>
                                                            <strong>{s['Nama Lengkap']}</strong> <span className="text-gray-500 text-xs">({s['Kelas']})</span>
                                                        </div>
                                                    ))}
                                                    {filteredStudents.length === 0 && <div className="text-gray-400 italic">Siswa tidak ditemukan</div>}
                                                </div>
                                            )}
                                        </div>
                                        <div><label className="block text-xs font-medium text-gray-600 mb-1">NISN</label><input type="text" name="nisn2" value={formData.nisn2} onChange={handleChange} className="w-full p-2 border border-pink-200 rounded-md" /></div>
                                        <div><label className="block text-xs font-medium text-gray-600 mb-1">Jenis Kelamin</label><select name="jenisKelamin2" value={formData.jenisKelamin2} onChange={handleChange} className="w-full p-2 border border-pink-200 rounded-md"><option value="Laki-laki">Laki-laki</option><option value="Perempuan">Perempuan</option></select></div>
                                        <div><label className="block text-xs font-medium text-gray-600 mb-1">Kelas</label><input type="text" name="kelas2" value={formData.kelas2} onChange={handleChange} className="w-full p-2 border border-pink-200 rounded-md" required /></div>
                                    </div>
                                </div>
                            )}

                            {/* IDENTITAS ORANG TUA */}
                            {(formData.type === 'PERNYATAAN' || formData.type === 'UNDANGAN' || formData.type === 'SKORSING' || formData.type === 'LAPORAN_HOMEVISIT' || formData.type === 'MEDIASI' || formData.type === 'BERHENTI' || formData.type === 'KONFERENSI_KASUS' || formData.type === 'ADVOKASI') && (
                                <div className="bg-green-50 p-4 rounded-lg space-y-4 border border-green-100">
                                    <h3 className="font-semibold text-green-800 text-sm uppercase flex items-center gap-2"><User size={16}/> Identitas Orang Tua / Wali {formData.type === 'MEDIASI' ? '(Pihak 1 & 2)' : ''}</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div><label className="block text-xs font-medium text-gray-600 mb-1">Nama Orang Tua {formData.type === 'MEDIASI' ? '(Pihak 1)' : ''}</label><input type="text" name="namaOrangTua" value={formData.namaOrangTua} onChange={handleChange} className="w-full p-2 border border-green-200 rounded-md" required/></div>
                                        {formData.type === 'MEDIASI' && (
                                            <div><label className="block text-xs font-medium text-gray-600 mb-1">Nama Orang Tua (Pihak 2)</label><input type="text" name="namaOrangTua2" value={formData.namaOrangTua2} onChange={handleChange} className="w-full p-2 border border-green-200 rounded-md" required/></div>
                                        )}
                                        {formData.type !== 'MEDIASI' && formData.type !== 'BERHENTI' && (
                                            <div><label className="block text-xs font-medium text-gray-600 mb-1">No. HP (Untuk WA)</label><input type="text" name="noHpOrangTua" value={formData.noHpOrangTua} onChange={handleChange} className="w-full p-2 border border-green-200 rounded-md" placeholder="Contoh: 0812..." /></div>
                                        )}
                                        {formData.type === 'BERHENTI' && (
                                            <div className="md:col-span-2"><label className="block text-xs font-medium text-gray-600 mb-1">Alamat Orang Tua</label><input type="text" name="alamatOrangTua" value={formData.alamatOrangTua} onChange={handleChange} className="w-full p-2 border border-green-200 rounded-md" /></div>
                                        )}
                                    </div>
                                </div>
                            )}

                            {/* SKORSING */}
                            {formData.type === 'SKORSING' && (
                                <div className="space-y-4 border-t pt-4">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div><label className="block text-sm font-medium text-gray-700">Nomor Surat</label><input type="text" name="nomorSurat" value={formData.nomorSurat} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" required /></div>
                                    </div>
                                    <div><AILabel label="Pelanggaran" stateKey="alasan" /><textarea name="alasan" value={formData.alasan} onChange={handleChange} rows="3" list="violationList" className="w-full p-2 border border-gray-300 rounded-md" required></textarea></div>
                                    <div className="grid grid-cols-3 gap-4">
                                        <div><label className="block text-sm font-medium text-gray-700">Lama</label><input type="text" name="lamaSkorsing" value={formData.lamaSkorsing} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" required /></div>
                                        <div><label className="block text-sm font-medium text-gray-700">Mulai</label><input type="date" name="tanggalMulai" value={formData.tanggalMulai} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" required /></div>
                                        <div><label className="block text-sm font-medium text-gray-700">Selesai</label><input type="date" name="tanggalSelesai" value={formData.tanggalSelesai} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" required /></div>
                                    </div>
                                </div>
                            )}

                            {/* PERNYATAAN */}
                            {formData.type === 'PERNYATAAN' && (
                                <div>
                                    <div className="mb-4"><AILabel label="Permasalahan / Duduk Perkara" stateKey="permasalahan" /><textarea name="permasalahan" value={formData.permasalahan} onChange={handleChange} rows="2" list="violationList" className="w-full p-2 border border-gray-300 rounded-md" placeholder="Contoh: Sehubungan dengan pelanggaran tata tertib sekolah..." /></div>
                                    <div><AILabel label="Isi Pernyataan" stateKey="isiPernyataan" /><textarea name="isiPernyataan" value={formData.isiPernyataan} onChange={handleChange} rows="4" className="w-full p-2 border border-gray-300 rounded-md" required /></div>
                                </div>
                            )}

                            {/* UNDANGAN */}
                            {formData.type === 'UNDANGAN' && (
                                <div className="space-y-4 border-t pt-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="block text-sm font-medium text-gray-700">Nomor Surat</label><input type="text" name="nomorSurat" value={formData.nomorSurat} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" required /></div>
                                        <div><label className="block text-sm font-medium text-gray-700">Lampiran</label><input type="text" name="lampiran" value={formData.lampiran} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" /></div>
                                        <div className="col-span-2"><label className="block text-sm font-medium text-gray-700">Perihal</label><input type="text" name="perihal" value={formData.perihal} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" /></div>
                                        
                                        {/* KOLOM TANGGAL PINTAR (DATE PICKER TO TEXT) */}
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Hari/Tanggal Acara</label>
                                            <div className="flex shadow-sm">
                                                {/* Pembungkus Ikon yang presisi */}
                                                <div className="relative flex items-center justify-center bg-blue-50 hover:bg-blue-100 border border-r-0 border-gray-300 rounded-l-md px-4 text-blue-600 transition-colors cursor-pointer overflow-hidden">
                                                    
                                                    {/* Ikon dibuat tembus klik dengan pointer-events-none */}
                                                    <Calendar size={18} className="pointer-events-none" />
                                                    
                                                    {/* Kalender Transparan dipaksa ke depan dengan z-50 */}
                                                    <input 
                                                        type="date" 
                                                        onChange={(e) => { 
                                                            if(!e.target.value) return; 
                                                            const d = new Date(e.target.value); 
                                                            const f = d.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }); 
                                                            setFormData(prev => ({...prev, hariTanggalAcara: f})); 
                                                        }} 
                                                        className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-50" 
                                                        title="Pilih Kalender" 
                                                    />
                                                </div>
                                                <input 
                                                    type="text" 
                                                    name="hariTanggalAcara" 
                                                    value={formData.hariTanggalAcara} 
                                                    onChange={handleChange} 
                                                    className="w-full p-2 border border-gray-300 rounded-r-md outline-none focus:ring-2 focus:ring-blue-500 font-semibold text-slate-700" 
                                                    placeholder="Pilih dari kalender ðŸ‘ˆ atau ketik manual..." 
                                                    required 
                                                />
                                            </div>
                                        </div>

                                        <div><label className="block text-sm font-medium text-gray-700">Waktu Acara</label><input type="text" name="waktuAcara" value={formData.waktuAcara} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" placeholder="09.00 WITA - Selesai" required /></div>
                                        <div className="col-span-2"><label className="block text-sm font-medium text-gray-700">Tempat Acara</label><input type="text" name="tempatAcara" value={formData.tempatAcara} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" placeholder="Ruang Guru" required /></div>
                                    </div>
                                    <div><AILabel label="Keperluan" stateKey="keperluan" /><textarea name="keperluan" value={formData.keperluan} onChange={handleChange} rows="2" className="w-full p-2 border border-gray-300 rounded-md" required></textarea></div>
                                    <div className="bg-gray-100 p-4 rounded-md"><h4 className="font-semibold text-xs uppercase mb-2">Data Wali Kelas (Otomatis jika data kelas tersedia)</h4><div className="grid grid-cols-2 gap-4"><div><label className="block text-xs font-medium text-gray-600">Nama Wali Kelas</label><input type="text" name="namaWaliKelas" value={formData.namaWaliKelas} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" /></div><div><label className="block text-xs font-medium text-gray-600">NIP Wali Kelas</label><input type="text" name="nipWaliKelas" value={formData.nipWaliKelas} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" /></div></div></div>
                                </div>
                            )}

                            {/* KONTRAK */}
                            {formData.type === 'KONTRAK' && (
                                <div className="space-y-4 border-t pt-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="block text-sm font-medium text-gray-700">Tanggal Kontrak</label><input type="date" name="tanggalKontrak" value={formData.tanggalKontrak} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" /></div>
                                        <div><label className="block text-sm font-medium text-gray-700">Tanggal Tinjauan</label><input type="date" name="tanggalTinjauan" value={formData.tanggalTinjauan} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" /></div>
                                        <div><label className="block text-sm font-medium text-gray-700">Status Kontrak</label><select name="statusKontrak" value={formData.statusKontrak} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md"><option value="Aktif">Aktif</option><option value="Selesai">Selesai</option><option value="Dibatalkan">Dibatalkan</option></select></div>
                                    </div>
                                    <div><AILabel label="Deskripsi Perilaku" stateKey="deskripsiPerilaku" /><textarea name="deskripsiPerilaku" value={formData.deskripsiPerilaku} onChange={handleChange} rows="2" className="w-full p-2 border border-gray-300 rounded-md" placeholder="Perilaku yang ingin diubah..."></textarea></div>
                                    <div><AILabel label="Tujuan Perubahan" stateKey="tujuanPerubahan" /><textarea name="tujuanPerubahan" value={formData.tujuanPerubahan} onChange={handleChange} rows="2" className="w-full p-2 border border-gray-300 rounded-md" placeholder="Target perilaku baru..."></textarea></div>
                                    <div><AILabel label="Rencana Tindakan Siswa" stateKey="rencanaTindakan" /><textarea name="rencanaTindakan" value={formData.rencanaTindakan} onChange={handleChange} rows="2" className="w-full p-2 border border-gray-300 rounded-md" placeholder="Apa yang akan dilakukan siswa..."></textarea></div>
                                    <div><AILabel label="Konsekuensi (Positif/Negatif)" stateKey="konsekuensi" /><textarea name="konsekuensi" value={formData.konsekuensi} onChange={handleChange} rows="2" className="w-full p-2 border border-gray-300 rounded-md" placeholder="Hadiah jika berhasil / Sanksi jika gagal..."></textarea></div>
                                </div>
                            )}

                            {/* TUGAS HOMEVISIT */}
                            {formData.type === 'TUGAS_HOMEVISIT' && (
                                <div className="space-y-4 border-t pt-4">
                                    <div><label className="block text-sm font-medium text-gray-700">Nomor Surat Tugas</label><input type="text" name="nomorSurat" value={formData.nomorSurat} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" required /></div>
                                    <div className="bg-orange-50 p-4 rounded-md border border-orange-100">
                                        <h4 className="font-semibold text-xs text-orange-800 uppercase mb-2">Guru yang Ditugaskan</h4>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div><label className="block text-xs font-medium text-gray-600">Nama Guru / Petugas</label><input type="text" name="namaPetugas" value={formData.namaPetugas} onChange={handleChange} className="w-full p-2 border border-orange-200 rounded-md" required /></div>
                                            <div><label className="block text-xs font-medium text-gray-600">NIP</label><input type="text" name="nipPetugas" value={formData.nipPetugas} onChange={handleChange} className="w-full p-2 border border-orange-200 rounded-md" /></div>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
											<label className="block text-sm font-medium text-gray-700 mb-1">Hari/Tanggal Kunjungan</label>
											<div className="flex shadow-sm">
												<div className="relative flex items-center justify-center bg-blue-50 hover:bg-blue-100 border border-r-0 border-gray-300 rounded-l-md px-4 text-blue-600 transition-colors cursor-pointer overflow-hidden">
													<Calendar size={18} className="pointer-events-none" />
													<input 
														type="date" 
														onChange={(e) => { 
															if(!e.target.value) return; 
															const d = new Date(e.target.value); 
															const f = d.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }); 
															setFormData(prev => ({...prev, hariTanggalAcara: f})); 
														}} 
														className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-50" 
														title="Pilih Kalender" 
													/>
												</div>
												<input 
													type="text" 
													name="hariTanggalAcara" 
													value={formData.hariTanggalAcara} 
													onChange={handleChange} 
													className="w-full p-2 border border-gray-300 rounded-r-md outline-none focus:ring-2 focus:ring-blue-500 font-semibold text-slate-700" 
													placeholder="Pilih kalender ðŸ‘ˆ atau ketik..." 
													required 
												/>
											</div>
										</div>
                                        <div><label className="block text-sm font-medium text-gray-700">Waktu (Jam)</label><input type="text" name="waktuAcara" value={formData.waktuAcara} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" placeholder="09.00 - 11.00 WITA" required /></div>
                                    </div>
                                    <div><AILabel label="Tujuan/Keperluan" stateKey="keperluan" /><textarea name="keperluan" value={formData.keperluan} onChange={handleChange} rows="2" className="w-full p-2 border border-gray-300 rounded-md" placeholder="Melakukan kunjungan rumah untuk..." required></textarea></div>
                                </div>
                            )}

                            {/* LAPORAN HOME VISIT */}
                            {formData.type === 'LAPORAN_HOMEVISIT' && (
                                <div className="space-y-4 border-t pt-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
											<label className="block text-sm font-medium text-gray-700 mb-1">Hari/Tanggal Kunjungan</label>
											<div className="flex shadow-sm">
												<div className="relative flex items-center justify-center bg-blue-50 hover:bg-blue-100 border border-r-0 border-gray-300 rounded-l-md px-4 text-blue-600 transition-colors cursor-pointer overflow-hidden">
													<Calendar size={18} className="pointer-events-none" />
													<input 
														type="date" 
														onChange={(e) => { 
															if(!e.target.value) return; 
															const d = new Date(e.target.value); 
															const f = d.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }); 
															setFormData(prev => ({...prev, hariTanggalAcara: f})); 
														}} 
														className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-50" 
														title="Pilih Kalender" 
													/>
												</div>
												<input 
													type="text" 
													name="hariTanggalAcara" 
													value={formData.hariTanggalAcara} 
													onChange={handleChange} 
													className="w-full p-2 border border-gray-300 rounded-r-md outline-none focus:ring-2 focus:ring-blue-500 font-semibold text-slate-700" 
													placeholder="Pilih kalender ðŸ‘ˆ atau ketik..." 
												/>
											</div>
										</div>
                                        <div><label className="block text-sm font-medium text-gray-700">Waktu</label><input type="text" name="waktuAcara" value={formData.waktuAcara} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" placeholder="10.00 WITA" /></div>
                                    </div>
                                    <div className="bg-gray-100 p-4 rounded-md">
                                        <h4 className="font-semibold text-xs text-gray-600 uppercase mb-2">Pihak yang Ditemui</h4>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div><label className="block text-xs font-medium text-gray-600">Nama Ditemui</label><input type="text" name="pihakDitemui" value={formData.pihakDitemui} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" /></div>
                                            <div><label className="block text-xs font-medium text-gray-600">Status Hubungan</label><select name="statusPihakDitemui" value={formData.statusPihakDitemui} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md"><option value="">Pilih Hubungan</option><option value="Orang Tua">Orang Tua</option><option value="Suami/Istri">Suami/Istri</option><option value="Kakak">Kakak</option><option value="Adik">Adik</option><option value="Anak">Anak</option><option value="Kakek/Nenek">Kakek/Nenek</option><option value="Paman">Paman</option><option value="Bibi">Bibi</option><option value="Om">Om</option><option value="Tante">Tante</option><option value="Sepupu">Sepupu</option><option value="Keponakan">Keponakan</option><option value="Wali">Wali</option><option value="Tetangga">Tetangga</option><option value="Teman">Teman</option><option value="Lainnya">Lainnya</option></select></div>
                                        </div>
                                    </div>
                                    <div><AILabel label="Gambaran Masalah" stateKey="gambaranMasalah" /><textarea name="gambaranMasalah" value={formData.gambaranMasalah} onChange={handleChange} rows="3" className="w-full p-2 border border-gray-300 rounded-md" placeholder="Deskripsi kondisi siswa/rumah..."></textarea></div>
                                    <div><AILabel label="Hasil Pembicaraan" stateKey="hasilPembicaraan" /><textarea name="hasilPembicaraan" value={formData.hasilPembicaraan} onChange={handleChange} rows="3" className="w-full p-2 border border-gray-300 rounded-md" placeholder="Tanggapan orang tua..."></textarea></div>
                                    <div><AILabel label="Rencana Tindak Lanjut (Kesepakatan)" stateKey="tindakLanjut" /><textarea name="tindakLanjut" value={formData.tindakLanjut} onChange={handleChange} rows="2" className="w-full p-2 border border-gray-300 rounded-md" placeholder="Apa yang akan dilakukan selanjutnya..."></textarea></div>
                                    <div className="bg-orange-50 p-4 rounded-md border border-orange-100">
                                        <h4 className="font-semibold text-xs text-orange-800 uppercase mb-2">Pelapor (Guru BK)</h4>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div><label className="block text-xs font-medium text-gray-600">Nama Guru BK</label><input type="text" name="namaPetugas" value={formData.namaPetugas} onChange={handleChange} className="w-full p-2 border border-orange-200 rounded-md" required /></div>
                                            <div><label className="block text-xs font-medium text-gray-600">NIP</label><input type="text" name="nipPetugas" value={formData.nipPetugas} onChange={handleChange} className="w-full p-2 border border-orange-200 rounded-md" /></div>
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            {/* KONFERENSI KASUS */}
							{formData.type === 'KONFERENSI_KASUS' && (
								<div className="space-y-4 border-t pt-4">
									<div className="grid grid-cols-2 gap-4">
										<div><label className="block text-sm font-medium text-gray-700">Nomor Surat</label><input type="text" name="nomorSurat" value={formData.nomorSurat} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" required /></div>
										<div><label className="block text-sm font-medium text-gray-700">Tempat</label><input type="text" name="tempatAcara" value={formData.tempatAcara} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" required /></div>
									</div>
									<div className="grid grid-cols-2 gap-4">
										<div>
											<label className="block text-sm font-medium text-gray-700 mb-1">Hari/Tanggal Konferensi</label>
											<div className="flex shadow-sm">
												<div className="relative flex items-center justify-center bg-blue-50 hover:bg-blue-100 border border-r-0 border-gray-300 rounded-l-md px-4 text-blue-600 transition-colors cursor-pointer overflow-hidden">
													<Calendar size={18} className="pointer-events-none" />
													<input 
														type="date" 
														onChange={(e) => { 
															if(!e.target.value) return; 
															const d = new Date(e.target.value); 
															const f = d.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }); 
															setFormData(prev => ({...prev, hariTanggalAcara: f})); 
														}} 
														className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-50" 
														title="Pilih Kalender" 
													/>
												</div>
												<input 
													type="text" 
													name="hariTanggalAcara" 
													value={formData.hariTanggalAcara} 
													onChange={handleChange} 
													className="w-full p-2 border border-gray-300 rounded-r-md outline-none focus:ring-2 focus:ring-blue-500 font-semibold text-slate-700" 
													placeholder="Pilih kalender ðŸ‘ˆ atau ketik manual..." 
													required 
												/>
											</div>
										</div>
										<div><label className="block text-sm font-medium text-gray-700">Waktu</label><input type="text" name="waktuAcara" value={formData.waktuAcara} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" placeholder="09.00 WITA - Selesai" required /></div>
									</div>
									<div><AILabel label="Gambaran Masalah / Topik Bahasan" stateKey="permasalahan" /><textarea name="permasalahan" value={formData.permasalahan} onChange={handleChange} rows="3" className="w-full p-2 border border-gray-300 rounded-md" required></textarea></div>
									<div><AILabel label="Hasil Konferensi / Kesepakatan" stateKey="hasilKonferensi" /><textarea name="hasilKonferensi" value={formData.hasilKonferensi} onChange={handleChange} rows="3" className="w-full p-2 border border-gray-300 rounded-md" required></textarea></div>

									<div className="bg-indigo-50 p-4 rounded-md border border-indigo-100">
										<div className="flex justify-between items-center mb-3">
											<h4 className="font-semibold text-xs text-indigo-800 uppercase">Daftar Hadir (Lampiran)</h4>
											<button type="button" onClick={handleAddPeserta} className="text-xs bg-indigo-600 text-white px-2 py-1 rounded hover:bg-indigo-700">+ Tambah Peserta</button>
										</div>
										<p className="text-[10px] text-indigo-600 mb-2 italic">*Siswa, Ortu, BK, & Kepsek sudah otomatis masuk. Masukkan peserta tambahan di sini (Wali kelas, Waka Kesiswaan, dll).</p>
										{(formData.pesertaKonferensi || []).map((p, index) => (
											<div key={index} className="flex gap-2 mb-2 items-end">
												<div className="flex-1"><label className="block text-[10px] text-gray-600">Nama Lengkap</label><input type="text" value={p.nama} onChange={(e) => handleChangePeserta(index, 'nama', e.target.value)} className="w-full p-1.5 text-sm border rounded" placeholder="Contoh: Budi Santoso, S.Pd" /></div>
												<div className="flex-1"><label className="block text-[10px] text-gray-600">Unsur/Jabatan</label><input type="text" value={p.unsur} onChange={(e) => handleChangePeserta(index, 'unsur', e.target.value)} className="w-full p-1.5 text-sm border rounded" placeholder="Wali Kelas" /></div>
												<button type="button" onClick={() => handleRemovePeserta(index)} className="bg-red-100 text-red-600 p-1.5 rounded hover:bg-red-200 mb-[1px]"><Trash2 size={16}/></button>
											</div>
										))}
									</div>

									<div className="bg-orange-50 p-4 rounded-md border border-orange-100">
										<h4 className="font-semibold text-xs text-orange-800 uppercase mb-2">Guru BK / Konselor</h4>
										<div className="grid grid-cols-2 gap-4">
											<div><label className="block text-xs font-medium text-gray-600">Nama Guru BK</label><input type="text" name="namaPetugas" value={formData.namaPetugas} onChange={handleChange} className="w-full p-2 border border-orange-200 rounded-md" required /></div>
											<div><label className="block text-xs font-medium text-gray-600">NIP</label><input type="text" name="nipPetugas" value={formData.nipPetugas} onChange={handleChange} className="w-full p-2 border border-orange-200 rounded-md" /></div>
										</div>
									</div>
								</div>
							)}

                            {/* ALIH TANGAN KASUS */}
                            {formData.type === 'ALIH_KASUS' && (
                                <div className="space-y-4 border-t pt-4">
                                    <div><label className="block text-sm font-medium text-gray-700">Nomor Surat</label><input type="text" name="nomorSurat" value={formData.nomorSurat} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" required /></div>
                                    <div><label className="block text-sm font-medium text-gray-700">Pihak Tujuan (Yth...)</label><input type="text" name="pihakTujuan" value={formData.pihakTujuan} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" placeholder="Kepala Puskesmas / Psikolog / Kapolsek..." required /></div>
                                    <div><AILabel label="Rincian Masalah / Gejala" stateKey="rincianMasalah" /><textarea name="rincianMasalah" value={formData.rincianMasalah} onChange={handleChange} rows="3" className="w-full p-2 border border-gray-300 rounded-md" placeholder="Gejala yang tampak pada siswa..."></textarea></div>
                                    <div><AILabel label="Riwayat Penanganan Sebelumnya" stateKey="riwayatPenanganan" /><textarea name="riwayatPenanganan" value={formData.riwayatPenanganan} onChange={handleChange} rows="3" className="w-full p-2 border border-gray-300 rounded-md" placeholder="Layanan BK yang sudah diberikan..."></textarea></div>
                                    <div className="bg-orange-50 p-4 rounded-md border border-orange-100">
                                        <h4 className="font-semibold text-xs text-orange-800 uppercase mb-2">Konselor / Guru BK</h4>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div><label className="block text-xs font-medium text-gray-600">Nama Guru BK</label><input type="text" name="namaPetugas" value={formData.namaPetugas} onChange={handleChange} className="w-full p-2 border border-orange-200 rounded-md" required /></div>
                                            <div><label className="block text-xs font-medium text-gray-600">NIP</label><input type="text" name="nipPetugas" value={formData.nipPetugas} onChange={handleChange} className="w-full p-2 border border-orange-200 rounded-md" /></div>
                                        </div>
                                    </div>
                                </div>
                            )}
							
                            {/* ADVOKASI */}
							{formData.type === 'ADVOKASI' && (
								<div className="space-y-4 border-t pt-4">
									<div className="grid grid-cols-1 md:grid-cols-3 gap-4">
										<div><label className="block text-sm font-medium text-gray-700">Nomor Surat</label><input type="text" name="nomorSurat" value={formData.nomorSurat} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" required /></div>
										<div><label className="block text-sm font-medium text-gray-700">Nama Pihak Terkait</label><input type="text" name="pihakTerkait" value={formData.pihakTerkait} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" placeholder="Contoh: Budi Santoso" required /></div>
										<div><label className="block text-sm font-medium text-gray-700">Sebagai (Jabatan)</label><input type="text" name="statusPihakTerkait" value={formData.statusPihakTerkait} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" placeholder="Contoh: Guru Matematika" required /></div>
									</div>
									<div><AILabel label="Latar Belakang Masalah" stateKey="latarBelakang" /><textarea name="latarBelakang" value={formData.latarBelakang} onChange={handleChange} rows="2" className="w-full p-2 border border-gray-300 rounded-md" placeholder="Jelaskan masalah atau hak siswa yang terancam..." required></textarea></div>
									<div><AILabel label="Tujuan Advokasi" stateKey="tujuanAdvokasi" /><textarea name="tujuanAdvokasi" value={formData.tujuanAdvokasi} onChange={handleChange} rows="2" className="w-full p-2 border border-gray-300 rounded-md" placeholder="Apa yang ingin dicapai (misal: keringanan SPP, izin ujian)..." required></textarea></div>
									<div><AILabel label="Hasil / Keputusan" stateKey="hasilAdvokasi" /><textarea name="hasilAdvokasi" value={formData.hasilAdvokasi} onChange={handleChange} rows="2" className="w-full p-2 border border-gray-300 rounded-md" placeholder="Hasil kesepakatan setelah negosiasi..." required></textarea></div>
									
									<div className="bg-orange-50 p-4 rounded-md border border-orange-100">
										<h4 className="font-semibold text-xs text-orange-800 uppercase mb-2">Pelaksana Advokasi (Guru BK)</h4>
										<div className="grid grid-cols-2 gap-4">
											<div><label className="block text-xs font-medium text-gray-600">Nama Guru BK</label><input type="text" name="namaPetugas" value={formData.namaPetugas} onChange={handleChange} className="w-full p-2 border border-orange-200 rounded-md" required /></div>
											<div><label className="block text-xs font-medium text-gray-600">NIP</label><input type="text" name="nipPetugas" value={formData.nipPetugas} onChange={handleChange} className="w-full p-2 border border-orange-200 rounded-md" /></div>
										</div>
									</div>
								</div>
							)}
							
                            {/* KONSELING KELOMPOK */}
							{formData.type === 'KONSELING_KELOMPOK' && (
								<div className="space-y-4 border-t pt-4">
									<div className="grid grid-cols-2 gap-4">
										<div><label className="block text-sm font-medium text-gray-700">Nomor Surat</label><input type="text" name="nomorSurat" value={formData.nomorSurat} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" required /></div>
										<div><label className="block text-sm font-medium text-gray-700">Tempat Konseling</label><input type="text" name="tempatAcara" value={formData.tempatAcara} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" placeholder="Ruang Konseling Kelompok" required /></div>
									</div>
									<div className="grid grid-cols-2 gap-4">
										<div><label className="block text-sm font-medium text-gray-700">Hari/Tanggal</label><input type="text" name="hariTanggalAcara" value={formData.hariTanggalAcara} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" required /></div>
										<div><label className="block text-sm font-medium text-gray-700">Waktu Pelaksanaan</label><input type="text" name="waktuAcara" value={formData.waktuAcara} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" placeholder="09.00 - Selesai" required /></div>
									</div>
									
									<div><label className="block text-sm font-medium text-gray-700">Pendekatan / Teknik Konseling (Opsional)</label><input type="text" name="teknikKonseling" value={formData.teknikKonseling} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" placeholder="Contoh: Realita / CBT / Client-Centered" /></div>
									<div><AILabel label="Fokus Masalah" stateKey="fokusMasalah" /><textarea name="fokusMasalah" value={formData.fokusMasalah} onChange={handleChange} rows="2" className="w-full p-2 border border-gray-300 rounded-md" placeholder="Masalah utama siapa yang disepakati untuk dibahas..." required></textarea></div>
									<div><AILabel label="Dinamika / Jalannya Konseling" stateKey="dinamikaKonseling" /><textarea name="dinamikaKonseling" value={formData.dinamikaKonseling} onChange={handleChange} rows="3" className="w-full p-2 border border-gray-300 rounded-md" placeholder="Bagaimana respon anggota, apakah terbuka, menangis, dll..." required></textarea></div>
									<div><AILabel label="Hasil & Evaluasi Laiseg" stateKey="evaluasiKonseling" /><textarea name="evaluasiKonseling" value={formData.evaluasiKonseling} onChange={handleChange} rows="2" className="w-full p-2 border border-gray-300 rounded-md" placeholder="Perasaan klien setelah sesi, insight yang didapat..." required></textarea></div>
									<div><AILabel label="Rencana Tindak Lanjut" stateKey="tindakLanjutKonseling" /><textarea name="tindakLanjutKonseling" value={formData.tindakLanjutKonseling} onChange={handleChange} rows="2" className="w-full p-2 border border-gray-300 rounded-md" placeholder="Perlu sesi ke-2 atau konseling individu?" required></textarea></div>

									<div className="bg-violet-50 p-4 rounded-md border border-violet-100">
										<div className="flex justify-between items-center mb-3">
											<h4 className="font-semibold text-xs text-violet-800 uppercase">Daftar Klien (Anggota Kelompok)</h4>
											<button type="button" onClick={handleAddKlien} className="text-xs bg-violet-600 text-white px-2 py-1 rounded hover:bg-violet-700">+ Tambah Klien</button>
										</div>
										{(formData.klienKonseling || []).map((p, index) => (
											<div key={index} className="flex gap-2 mb-2 items-end">
												<div className="flex-1 relative">
													<label className="block text-[10px] text-gray-600">Nama Lengkap Klien</label>
													<input type="text" value={p.nama} onChange={(e) => handleChangeKlien(index, e.target.value)} className="w-full p-1.5 text-sm border rounded focus:ring-2 focus:ring-violet-200 outline-none" placeholder="Cari nama siswa..." required autoComplete="off"/>
													{activeKlienIndex === index && (
														<div className="autocomplete-items shadow-xl border border-gray-200">
															{filteredStudents.map((s, idx) => (
																<div key={idx} onClick={() => handleSelectKlien(s, index)}>
																	<strong>{s['Nama Lengkap']}</strong> <span className="text-xs text-gray-500">({s['Kelas']})</span>
																</div>
															))}
															{filteredStudents.length === 0 && <div className="p-2 text-gray-400 italic text-xs">Klien tidak ditemukan</div>}
														</div>
													)}
												</div>
												<div className="w-1/3"><label className="block text-[10px] text-gray-600">Kelas</label><input type="text" value={p.kelas} onChange={(e) => { const newKlien = [...(formData.klienKonseling || [])]; newKlien[index].kelas = e.target.value; setFormData(prev => ({...prev, klienKonseling: newKlien}))}} className="w-full p-1.5 text-sm border rounded" placeholder="Kelas..." required/></div>
												<button type="button" onClick={() => handleRemoveKlien(index)} className="bg-red-100 text-red-600 p-1.5 rounded hover:bg-red-200 mb-[1px]"><Trash2 size={16}/></button>
											</div>
										))}
									</div>

									<div className="bg-orange-50 p-4 rounded-md border border-orange-100">
										<h4 className="font-semibold text-xs text-orange-800 uppercase mb-2">Konselor (Guru BK)</h4>
										<div className="grid grid-cols-2 gap-4">
											<div><label className="block text-xs font-medium text-gray-600">Nama Konselor</label><input type="text" name="namaPetugas" value={formData.namaPetugas} onChange={handleChange} className="w-full p-2 border border-orange-200 rounded-md" required /></div>
											<div><label className="block text-xs font-medium text-gray-600">NIP</label><input type="text" name="nipPetugas" value={formData.nipPetugas} onChange={handleChange} className="w-full p-2 border border-orange-200 rounded-md" /></div>
										</div>
									</div>
								</div>
							)}
							
                            {/* BIMBINGAN KELOMPOK */}
							{formData.type === 'BIMBINGAN_KELOMPOK' && (
								<div className="space-y-4 border-t pt-4">
									<div className="grid grid-cols-2 gap-4">
										<div><label className="block text-sm font-medium text-gray-700">Nomor Surat</label><input type="text" name="nomorSurat" value={formData.nomorSurat} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" required /></div>
										<div><label className="block text-sm font-medium text-gray-700">Tempat Bimbingan</label><input type="text" name="tempatAcara" value={formData.tempatAcara} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" placeholder="Contoh: Ruang BK / Taman" required /></div>
									</div>
									<div className="grid grid-cols-2 gap-4">
										<div><label className="block text-sm font-medium text-gray-700">Hari/Tanggal</label><input type="text" name="hariTanggalAcara" value={formData.hariTanggalAcara} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" placeholder="Senin, 10 Januari 2026" required /></div>
										<div><label className="block text-sm font-medium text-gray-700">Waktu Pelaksanaan</label><input type="text" name="waktuAcara" value={formData.waktuAcara} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" placeholder="09.00 - 10.30 WITA" required /></div>
									</div>
									
									<div><label className="block text-sm font-medium text-gray-700">Topik / Materi Bahasan</label><input type="text" name="topikBimbingan" value={formData.topikBimbingan} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" placeholder="Contoh: Bahaya Bullying di Sekolah" required /></div>
									<div><AILabel label="Tujuan Bimbingan" stateKey="tujuanBimbingan" /><textarea name="tujuanBimbingan" value={formData.tujuanBimbingan} onChange={handleChange} rows="2" className="w-full p-2 border border-gray-300 rounded-md" placeholder="Target dari materi yang disampaikan..." required></textarea></div>
									<div><AILabel label="Uraian Kegiatan" stateKey="uraianKegiatan" /><textarea name="uraianKegiatan" value={formData.uraianKegiatan} onChange={handleChange} rows="3" className="w-full p-2 border border-gray-300 rounded-md" placeholder="Deskripsikan dinamika kelompok dan proses berjalannya kegiatan..." required></textarea></div>
									<div><AILabel label="Hasil Bimbingan" stateKey="hasilBimbingan" /><textarea name="hasilBimbingan" value={formData.hasilBimbingan} onChange={handleChange} rows="2" className="w-full p-2 border border-gray-300 rounded-md" placeholder="Kesimpulan yang didapat oleh para siswa..." required></textarea></div>

									<div className="bg-blue-50 p-4 rounded-md border border-blue-100">
										<div className="flex justify-between items-center mb-3">
											<h4 className="font-semibold text-xs text-blue-800 uppercase">Daftar Siswa (Anggota Kelompok)</h4>
											<button type="button" onClick={handleAddPesertaBimbingan} className="text-xs bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700">+ Tambah Siswa</button>
										</div>
										{(formData.pesertaBimbingan || []).map((p, index) => (
											<div key={index} className="flex gap-2 mb-2 items-end">
												<div className="flex-1 relative">
													<label className="block text-[10px] text-gray-600">Nama Lengkap Siswa</label>
													<input type="text" value={p.nama} onChange={(e) => handleChangePesertaBimbingan(index, e.target.value)} className="w-full p-1.5 text-sm border rounded focus:ring-2 focus:ring-blue-200 outline-none" placeholder="Cari nama siswa..." required autoComplete="off" />
													{activePesertaIndex === index && (
														<div className="autocomplete-items shadow-xl border border-gray-200">
															{filteredStudents.map((s, idx) => (
																<div key={idx} onClick={() => handleSelectPesertaBimbingan(s, index)}>
																	<strong>{s['Nama Lengkap']}</strong> <span className="text-xs text-gray-500">({s['Kelas']})</span>
																</div>
															))}
															{filteredStudents.length === 0 && <div className="p-2 text-gray-400 italic text-xs">Siswa tidak ditemukan</div>}
														</div>
													)}
												</div>
												<div className="w-1/3"><label className="block text-[10px] text-gray-600">Kelas</label><input type="text" value={p.kelas} onChange={(e) => handleChangePesertaBimbingan(index, 'kelas', e.target.value)} className="w-full p-1.5 text-sm border rounded" placeholder="Kelas..." required/></div>
												<button type="button" onClick={() => handleRemovePesertaBimbingan(index)} className="bg-red-100 text-red-600 p-1.5 rounded hover:bg-red-200 mb-[1px]"><Trash2 size={16}/></button>
											</div>
										))}
									</div>

									<div className="bg-orange-50 p-4 rounded-md border border-orange-100">
										<h4 className="font-semibold text-xs text-orange-800 uppercase mb-2">Pemimpin Kelompok (Guru BK)</h4>
										<div className="grid grid-cols-2 gap-4">
											<div><label className="block text-xs font-medium text-gray-600">Nama Guru BK</label><input type="text" name="namaPetugas" value={formData.namaPetugas} onChange={handleChange} className="w-full p-2 border border-orange-200 rounded-md" required /></div>
											<div><label className="block text-xs font-medium text-gray-600">NIP</label><input type="text" name="nipPetugas" value={formData.nipPetugas} onChange={handleChange} className="w-full p-2 border border-orange-200 rounded-md" /></div>
										</div>
									</div>
								</div>
							)}

                            {/* SKBB */}
                            {formData.type === 'SKBB' && (
                                <div className="space-y-4 border-t pt-4">
                                    <div><label className="block text-sm font-medium text-gray-700">Nomor Surat</label><input type="text" name="nomorSurat" value={formData.nomorSurat} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" required /></div>
                                    <div><AILabel label="Keperluan Surat" stateKey="keperluan" /><textarea name="keperluan" value={formData.keperluan} onChange={handleChange} rows="2" className="w-full p-2 border border-gray-300 rounded-md" placeholder="Contoh: Persyaratan pendaftaran masuk SMA..." required></textarea></div>
                                </div>
                            )}
                            
                            {/* MEDIASI */}
                             {formData.type === 'MEDIASI' && (
                                <div className="space-y-4 border-t pt-4">
                                    <div><label className="block text-sm font-medium text-gray-700">Nomor Surat</label><input type="text" name="nomorSurat" value={formData.nomorSurat} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" required /></div>
                                    <div><AILabel label="Permasalahan" stateKey="permasalahan" /><textarea name="permasalahan" value={formData.permasalahan} onChange={handleChange} rows="3" className="w-full p-2 border border-gray-300 rounded-md" placeholder="Kronologi masalah antar kedua pihak..."></textarea></div>
                                    <div><AILabel label="Hasil Mediasi / Kesepakatan" stateKey="hasilMediasi" /><textarea name="hasilMediasi" value={formData.hasilMediasi} onChange={handleChange} rows="3" className="w-full p-2 border border-gray-300 rounded-md" placeholder="Poin-poin kesepakatan damai..." required></textarea></div>
                                    
                                    <div className="bg-purple-50 p-4 rounded-md border border-purple-100">
                                        <h4 className="font-semibold text-xs text-purple-800 uppercase mb-2">Data Saksi - Wali Kelas (Otomatis)</h4>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div><label className="block text-xs font-medium text-gray-600">Wali Kelas Pihak 1</label><input type="text" name="namaWaliKelas" value={formData.namaWaliKelas} onChange={handleChange} className="w-full p-2 border border-purple-200 rounded-md" /></div>
                                            <div><label className="block text-xs font-medium text-gray-600">NIP Wali Kelas 1</label><input type="text" name="nipWaliKelas" value={formData.nipWaliKelas} onChange={handleChange} className="w-full p-2 border border-purple-200 rounded-md" /></div>
                                            <div><label className="block text-xs font-medium text-gray-600">Wali Kelas Pihak 2</label><input type="text" name="namaWaliKelas2" value={formData.namaWaliKelas2} onChange={handleChange} className="w-full p-2 border border-purple-200 rounded-md" /></div>
                                            <div><label className="block text-xs font-medium text-gray-600">NIP Wali Kelas 2</label><input type="text" name="nipWaliKelas2" value={formData.nipWaliKelas2} onChange={handleChange} className="w-full p-2 border border-purple-200 rounded-md" /></div>
                                        </div>
                                    </div>

                                    <div className="bg-orange-50 p-4 rounded-md border border-orange-100">
                                        <h4 className="font-semibold text-xs text-orange-800 uppercase mb-2">Saksi Guru BK / Konselor</h4>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div><label className="block text-xs font-medium text-gray-600">Nama Guru BK</label><input type="text" name="namaSaksi" value={formData.namaSaksi} onChange={handleChange} className="w-full p-2 border border-orange-200 rounded-md" required /></div>
                                            <div><label className="block text-xs font-medium text-gray-600">NIP</label><input type="text" name="nipSaksi" value={formData.nipSaksi} onChange={handleChange} className="w-full p-2 border border-orange-200 rounded-md" /></div>
                                        </div>
                                    </div>
                                </div>
                            )}
							
							{/* REKOMENDASI STUDI (UNIVERSAL) */}
                            {formData.type === 'REKOMENDASI_STUDI' && (
                                <div className="space-y-4 border-t pt-4 animate-fade-in-up">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="block text-sm font-medium text-gray-700">Nomor Surat</label><input type="text" name="nomorSurat" value={formData.nomorSurat} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" required /></div>
                                        <div><label className="block text-sm font-medium text-gray-700">Tujuan Keterangan</label><input type="text" name="tujuanSurat" value={formData.tujuanSurat} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" placeholder="Contoh: Panitia PPDB / Seleksi Mahasiswa" required /></div>
                                    </div>

                                    {/* Blok Nilai Dinamis */}
                                    <div className="bg-emerald-50 p-4 rounded-xl border border-emerald-200">
                                        <div className="flex justify-between items-center mb-3">
                                            <h4 className="font-bold text-xs text-emerald-800 uppercase flex items-center gap-1">ðŸ“Š Capaian Akademik (Mapel Menonjol)</h4>
                                            <button type="button" onClick={handleAddMapel} className="text-[10px] font-bold bg-emerald-600 text-white px-3 py-1.5 rounded-lg shadow-sm hover:bg-emerald-700 transition-all">+ Tambah Mapel</button>
                                        </div>
                                        <p className="text-[10px] text-emerald-600 mb-3 italic">*Masukkan 3 atau lebih mata pelajaran yang nilainya paling mendukung untuk jurusan yang akan dituju siswa.</p>
                                        
                                        {(formData.nilaiMapel || []).map((m, index) => (
                                            <div key={index} className="flex gap-2 mb-2 items-end">
                                                <div className="flex-1"><label className="block text-[10px] font-medium text-gray-600 mb-1">Nama Mata Pelajaran</label><input type="text" value={m.mapel} onChange={(e) => handleChangeMapel(index, 'mapel', e.target.value)} className="w-full p-2 text-sm border border-emerald-200 rounded-md focus:ring-2 focus:ring-emerald-200 outline-none" placeholder="Contoh: Matematika" required /></div>
                                                <div className="w-1/3"><label className="block text-[10px] font-medium text-gray-600 mb-1">Nilai Rata-rata</label><input type="number" value={m.nilai} onChange={(e) => handleChangeMapel(index, 'nilai', e.target.value)} className="w-full p-2 text-sm border border-emerald-200 rounded-md focus:ring-2 focus:ring-emerald-200 outline-none" placeholder="Contoh: 88" required /></div>
                                                <button type="button" onClick={() => handleRemoveMapel(index)} className="bg-red-50 text-red-500 p-2 border border-red-100 rounded-md hover:bg-red-100 hover:text-red-700 mb-[1px] transition-colors"><Trash2 size={18}/></button>
                                            </div>
                                        ))}
                                        {(!formData.nilaiMapel || formData.nilaiMapel.length === 0) && <div className="text-center p-3 border-2 border-dashed border-emerald-200 rounded-lg text-xs text-emerald-600 font-medium">Belum ada nilai yang diinput. Klik tombol hijau di atas.</div>}
                                    </div>

                                    {/* Blok Non-Akademik */}
                                    <div><AILabel label="Prestasi / Keaktifan Organisasi (Non-Akademik)" stateKey="prestasi" /><textarea name="prestasi" value={formData.prestasi} onChange={handleChange} rows="2" className="w-full p-2 border border-gray-300 rounded-md" placeholder="Contoh: Aktif di ekskul Pramuka, Juara 2 Lomba Futsal..."></textarea></div>
                                    
                                    <div><AILabel label="Hasil Asesmen / Tes Psikologi (Opsional)" stateKey="hasilAsesmen" /><textarea name="hasilAsesmen" value={formData.hasilAsesmen} onChange={handleChange} rows="2" className="w-full p-2 border border-gray-300 rounded-md" placeholder="Contoh: Memiliki kecerdasan logik-matematik tinggi..."></textarea></div>

                                    {/* Blok Kesimpulan AI */}
                                    <div className="bg-blue-50 p-4 rounded-xl border border-blue-200 space-y-4">
                                        <h4 className="font-bold text-xs text-blue-800 uppercase">ðŸŽ¯ Kesimpulan & Rekomendasi Arah Studi</h4>
                                        <div><label className="block text-xs font-medium text-gray-700 mb-1">Direkomendasikan Melanjutkan Ke (Target Utama)</label><input type="text" name="targetStudi" value={formData.targetStudi} onChange={handleChange} className="w-full p-2 border border-blue-200 rounded-md focus:ring-2 focus:ring-blue-200 outline-none font-bold" placeholder="Contoh: SMK Jurusan Teknik Otomotif / Univ. Hasanuddin" required /></div>
                                        
                                        <div><AILabel label="Uraian Rekomendasi" stateKey="uraianRekomendasi" /><textarea name="uraianRekomendasi" value={formData.uraianRekomendasi} onChange={handleChange} rows="3" className="w-full p-2 border border-blue-200 rounded-md focus:ring-2 focus:ring-blue-200 outline-none" placeholder="Ketik santai lalu panggil AI: 'nilai ipa bagus, anak jago bongkar mesin, cocok smk teknik'" required></textarea></div>
                                    </div>
									
									{/* Blok Guru BK / Konselor */}
                                    <div className="bg-orange-50 p-4 rounded-xl border border-orange-200 space-y-4">
                                        <h4 className="font-bold text-xs text-orange-800 uppercase">ðŸ‘¤ Guru Bimbingan dan Konseling</h4>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-xs font-medium text-gray-700 mb-1">Nama Guru BK</label>
                                                <input type="text" name="namaPetugas" value={formData.namaPetugas} onChange={handleChange} className="w-full p-2 border border-orange-200 rounded-md focus:ring-2 focus:ring-orange-200 outline-none" required placeholder="Nama Lengkap & Gelar" />
                                            </div>
                                            <div>
                                                <label className="block text-xs font-medium text-gray-700 mb-1">NIP (Jika Ada)</label>
                                                <input type="text" name="nipPetugas" value={formData.nipPetugas} onChange={handleChange} className="w-full p-2 border border-orange-200 rounded-md focus:ring-2 focus:ring-orange-200 outline-none" placeholder="NIP / -" />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            {/* BUKU TAMU HARIAN */}
                            {formData.type === 'BUKU_TAMU' && (
                                <div className="space-y-4 border-t pt-4 animate-fade-in-up">
                                    <div className="bg-sky-50 p-4 rounded-xl border border-sky-200 mb-4">
                                        <h3 className="font-bold text-sky-800 text-sm flex items-center gap-2 mb-1"><BookOpen size={16}/> Formulir Buku Tamu Ruang BK</h3>
                                        <p className="text-xs text-sky-600">Gunakan form ini untuk mencatat siswa yang datang ke ruang BK untuk keperluan harian (curhat ringan, istirahat sakit, minta saran) tanpa perlu membuat Berita Acara formal.</p>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="block text-sm font-medium text-gray-700">Waktu Kunjungan (Jam)</label><input type="time" name="waktuAcara" value={formData.waktuAcara} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" required /></div>
                                        <div><label className="block text-sm font-medium text-gray-700">Tanggal Kunjungan</label><input type="date" name="tanggal" value={formData.tanggal} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" required /></div>
                                    </div>
                                    <div><AILabel label="Keperluan Singkat / Keterangan" stateKey="keperluan" /><textarea name="keperluan" value={formData.keperluan} onChange={handleChange} rows="3" className="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-sky-200" placeholder="Contoh: Siswa curhat mengenai masalah tugas kelompok dan meminta saran cara berkomunikasi dengan temannya..." required></textarea></div>
                                </div>
                            )}

                             {/* BERHENTI */}
                             {formData.type === 'BERHENTI' && (
                                <div className="space-y-4 border-t pt-4">
                                    <div><label className="block text-sm font-medium text-gray-700">Nomor Surat</label><input type="text" name="nomorSurat" value={formData.nomorSurat} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" required /></div>
                                    <div><AILabel label="Alasan Berhenti / Keluar" stateKey="alasanBerhenti" /><textarea name="alasanBerhenti" value={formData.alasanBerhenti} onChange={handleChange} rows="3" className="w-full p-2 border border-gray-300 rounded-md" placeholder="Pindah sekolah ke... / Mengundurkan diri karena..." required></textarea></div>
                                    
                                    <div className="bg-gray-100 p-4 rounded-md">
                                        <h4 className="font-semibold text-xs text-gray-600 uppercase mb-2">Saksi (Wali Kelas / Keluarga)</h4>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div className="col-span-2"><label className="block text-xs font-medium text-gray-600">Status Saksi</label><select name="statusSaksi" value={formData.statusSaksi} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md"><option value="Wali Kelas">Wali Kelas</option><option value="Om / Tante">Om / Tante</option><option value="Kakek / Nenek">Kakek / Nenenk</option><option value="Kakak / Adik">Kakak / Adik</option><option value="Sepupu / Keluarga Lain">Sepupu / Keluarga Lain</option></select></div>
                                            <div><label className="block text-xs font-medium text-gray-600">Nama Saksi</label><input type="text" name="namaSaksi" value={formData.namaSaksi} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" required /></div>
                                            <div><label className="block text-xs font-medium text-gray-600">NIP (Jika Guru)</label><input type="text" name="nipSaksi" value={formData.nipSaksi} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" /></div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* TANDA TANGAN KEPALA SEKOLAH - DENGAN DROPDOWN PEJABAT */}
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <h3 className="font-semibold text-gray-800 text-sm uppercase mb-3 flex items-center gap-2"><Briefcase size={16}/> Pejabat Penanda Tangan</h3>
                                <div className="mb-3">
                                    <label className="block text-xs font-medium text-gray-600 mb-1">Pilih Cepat Pejabat (Opsional)</label>
                                    <select onChange={handleSelectOfficial} className="w-full p-2 border border-gray-300 rounded-md text-sm bg-white">
                                        <option value="">-- Pilih Pejabat --</option>
                                        {officials && officials.map((off, idx) => (
                                            <option key={idx} value={off['Nama Pejabat']}>{off['Jabatan']} - {off['Nama Pejabat']}</option>
                                        ))}
                                    </select>
                                </div>
                                <div className="grid grid-cols-3 gap-4">
                                    <div><label className="block text-sm font-medium text-gray-700">Nama</label><input type="text" name="penandaTangan" value={formData.penandaTangan} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" required /></div>
                                    <div><label className="block text-sm font-medium text-gray-700">NIP</label><input type="text" name="nipPenandaTangan" value={formData.nipPenandaTangan} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" /></div>
                                    <div><label className="block text-sm font-medium text-gray-700">Jabatan</label><input type="text" name="jabatan" value={formData.jabatan} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" required /></div>
                                </div>
                            </div>
                            
                            {/* BUTTONS STICKY AT BOTTOM */}
                            <div className="flex justify-end gap-3 pt-4 border-t sticky bottom-0 bg-white p-4 -mx-6 -mb-6 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
                                <button type="button" onClick={onCancel} className="px-4 py-2 text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">Batal</button>
                                <button type="submit" className="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg flex items-center gap-2 shadow-sm transition-colors"><Save size={18} /> Simpan</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // LETTER CONTENT RENDERER (NO CHANGES NEEDED, DATA MAPPED AUTOMATICALLY)
        function LetterContent({ data, schoolData, isPreview }) {
            const containerClass = isPreview ? "bg-white shadow-2xl mx-auto w-[215mm] min-h-[330mm] p-[15mm_20mm] relative text-black leading-normal box-border" : "bg-white w-full h-full text-black leading-normal box-border"; 
            const arialStyle = { fontFamily: 'Times', fontSize: '12pt' };
            const contentStyle = { fontSize: '11pt' }; 
            const renderLogo = (url) => url ? <img src={url} alt="Logo" className="max-h-full max-w-full object-contain" onError={(e) => {e.target.style.display='none'}} /> : null;
            
            const qrData = `VALIDASI DOKUMEN ${schoolData.namaSekolah}%0AJENIS: ${data.type}%0ASISWA: ${data.namaSiswa}%0ANOMOR: ${data.nomorSurat || '-'}%0ATGL: ${formatDate(data.tanggal)}%0A${data.jabatan}: ${data.penandaTangan}%0ADIBUAT OLEH: ${data.createdBy}`;
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?data=${qrData}&size=100x100`;

            return (
                <div className={containerClass} style={arialStyle}>
                    {/* KOP SURAT */}
                    <div className="border-b-4 border-double border-black pb-4 mb-4 flex items-center justify-between relative px-0">
                        <div className="w-[2.5cm] h-[2.5cm] flex items-center justify-center shrink-0">{renderLogo(schoolData.logoKiri)}</div>
                        <div className="text-center flex-1 px-2">
                            <h2 className="font-bold text-[12pt] uppercase tracking-wider leading-tight">{schoolData.pemerintah}</h2>
                            <h2 className="font-bold text-[12pt] uppercase tracking-wider leading-tight">{schoolData.instansi}</h2>
                            <h2 className="font-bold text-[13pt] uppercase leading-tight">{schoolData.namaSekolah}</h2>
                            {!['SKORSING', 'TUGAS_HOMEVISIT', 'ALIH_KASUS', 'SKBB', 'BERHENTI'].includes(data.type) && (<h2 className="font-bold text-[12pt] uppercase leading-tight">BIMBINGAN DAN KONSELING</h2>
                            )}
                            <p className="text-[10pt] italic mt-1 whitespace-pre-line leading-tight">{schoolData.alamat}</p>
                        </div>
                        <div className="w-[2.5cm] h-[2.5cm] flex items-center justify-center shrink-0">{renderLogo(schoolData.logoKanan)}</div>
                    </div>

                    {/* ISI SURAT */}
                    <div style={contentStyle}>
                        {data.type === 'SKORSING' && (<div><div className="text-center mb-6"><h3 className="font-bold underline text-[12pt] uppercase">SURAT KEPUTUSAN SKORSING</h3><p>Nomor: {data.nomorSurat}</p></div><p className="mb-2">Yang bertanda tangan di bawah ini:</p><table className="w-full mb-4"><tbody><tr><td className="w-40 align-top">Nama</td><td>: <span className="font-bold">{data.penandaTangan}</span></td></tr><tr><td className="align-top">NIP</td><td>: {data.nipPenandaTangan || '-'}</td></tr><tr><td className="align-top">Jabatan</td><td>: {data.jabatan}</td></tr></tbody></table><p className="mb-2 text-justify">Berdasarkan hasil rapat Dewan Guru dan Tata Tertib Sekolah, dengan ini memberikan sanksi tegas berupa <strong>SKORSING (Pemberhentian Sementara)</strong> kepada siswa:</p><table className="w-full mb-4 pl-4"><tbody><tr><td className="w-40 align-top">Nama Siswa</td><td>: <strong>{data.namaSiswa}</strong></td></tr><tr><td className="align-top">NISN</td><td>: {data.nisn || '-'}</td></tr><tr><td className="align-top">Jenis Kelamin</td><td>: {data.jenisKelamin}</td></tr><tr><td className="align-top">Kelas</td><td>: {data.kelas}</td></tr><tr><td className="align-top">Pelanggaran</td><td className="text-justify">: {data.alasan}</td></tr></tbody></table><p className="mb-2 text-justify">Adapun masa skorsing berlaku selama <strong>{data.lamaSkorsing}</strong>, terhitung mulai tanggal <strong>{formatDate(data.tanggalMulai)}</strong> sampai dengan <strong>{formatDate(data.tanggalSelesai)}</strong>.</p><p className="mb-6 text-justify">Selama masa skorsing, siswa dikembalikan kepada orang tua/wali untuk dibina di rumah.</p>
                            <div className="flex justify-end mt-8 px-4 gap-4 items-end">
                                 <div className="flex flex-col items-center justify-end h-full pb-2"><img src={qrUrl} alt="Validasi" className="w-[2cm] h-[2cm]" /></div>
                                <div className="text-center min-w-[250px]">
                                    <p className="mb-2">Ditetapkan di: {data.tempat || 'Makassar'}</p><p className="mb-2">Pada Tanggal: {formatDate(data.tanggal)}</p><p className="mb-16 font-bold">{data.jabatan},</p><p className="font-bold underline whitespace-nowrap">{data.penandaTangan}</p><p>NIP. {data.nipPenandaTangan}</p>
                                </div>
                            </div>
                            <div className="mt-4 text-[10pt]"><p>Tembusan:</p><ol className="list-decimal list-inside"><li>Orang Tua/Wali Siswa ({data.namaOrangTua})</li><li>Arsip</li></ol></div></div>)}
                        
                        {data.type === 'PERNYATAAN' && (<div>
                            <div className="text-center mb-4"><h3 className="font-bold underline text-[12pt] uppercase">SURAT PERNYATAAN ORANG TUA / WALI</h3></div>
                            <p className="mb-1">Saya yang bertanda tangan di bawah ini:</p>
                            <table className="w-full mb-2 pl-4"><tbody><tr><td className="w-48 py-0.5 align-top">Nama Orang Tua/Wali</td><td>: <strong>{data.namaOrangTua}</strong></td></tr><tr><td className="py-0.5 align-top">Alamat</td><td>: {data.alamatOrangTua}</td></tr><tr><td className="py-0.5 align-top">No. HP / WA</td><td>: {data.noHpOrangTua}</td></tr></tbody></table>
                            <p className="mb-1">Selaku Orang Tua / Wali dari siswa:</p>
                            <table className="w-full mb-2 pl-4"><tbody><tr><td className="w-48 py-0.5 align-top">Nama Siswa</td><td>: <strong>{data.namaSiswa}</strong></td></tr><tr><td className="py-0.5 align-top">NISN</td><td>: {data.nisn || '-'}</td></tr><tr><td className="py-0.5 align-top">Jenis Kelamin</td><td>: {data.jenisKelamin}</td></tr><tr><td className="py-0.5 align-top">Kelas</td><td>: {data.kelas}</td></tr></tbody></table>
                            {data.permasalahan && (<p className="mb-2 text-justify">{data.permasalahan}</p>)}
                            <p className="mb-2 font-bold">Dengan ini menyatakan dengan sesungguhnya bahwa:</p>
                            <div className="border border-black p-4 mb-4 bg-gray-50 print:bg-transparent min-h-[100px] text-justify italic">"{data.isiPernyataan}"</div>
                            <p className="mb-4 text-justify">Demikian surat pernyataan ini saya buat dengan sadar tanpa paksaan dari pihak manapun.</p>
                            <div className="flex justify-between items-end mt-4 px-2"><div className="text-center min-w-[200px] mb-8"><p className="mb-12">Siswa Yang Bersangkutan,</p><p className="font-bold underline whitespace-nowrap">{data.namaSiswa}</p><p className="text-[10pt]">NIS. {data.nisn || '........................'}</p></div><div className="text-center min-w-[250px] mb-8"><p className="mb-2">{data.tempat || 'Makassar'}, {formatDate(data.tanggal)}</p><p className="mb-12">Orang Tua / Wali,</p><p className="font-bold underline whitespace-nowrap">{data.namaOrangTua}</p></div></div>
                            <div className="flex justify-center mt-0 gap-4 items-end"><div className="flex flex-col items-center justify-end h-full pb-2"><img src={qrUrl} alt="Validasi" className="w-[2cm] h-[2cm]" /></div><div className="text-center min-w-[250px]"><p className="mb-12">Mengetahui,<br/>{data.jabatan}</p><p className="font-bold underline whitespace-nowrap">{data.penandaTangan}</p><p>NIP. {data.nipPenandaTangan}</p></div></div>
                        </div>)}
                        
                        {data.type === 'UNDANGAN' && (<div><div className="flex justify-between mb-4"><div><table className="leading-snug"><tbody><tr><td>Nomor</td><td>: {data.nomorSurat}</td></tr><tr><td>Lampiran</td><td>: {data.lampiran || '-'}</td></tr><tr><td>Perihal</td><td className="font-bold">: {data.perihal || 'Undangan'}</td></tr></tbody></table></div><div className="text-right"><p>{data.tempat || 'Makassar'}, {formatDate(data.tanggal)}</p></div></div><p className="mb-2">Yth. Bapak/Ibu/Wali dari:</p><table className="w-full mb-4 pl-4"><tbody><tr><td className="w-40 align-top">Nama Siswa</td><td>: <strong>{data.namaSiswa}</strong></td></tr><tr><td className="align-top">Kelas</td><td>: {data.kelas}</td></tr><tr><td className="align-top">NISN</td><td>: {data.nisn || '-'}</td></tr></tbody></table><p className="mb-4">Di Tempat</p><p className="mb-4 text-justify">Dengan hormat,<br/>Dalam rangka menjalin sinergi yang baik untuk mendukung proses belajar dan perkembangan positif ananda tercinta di sekolah, kami bermaksud mengundang Bapak/Ibu untuk bersilaturahmi dan berdiskusi pada:</p><table className="w-full mb-3 pl-4"><tbody><tr><td className="w-40 py-1">Hari / Tanggal</td><td>: {data.hariTanggalAcara}</td></tr><tr><td className="py-1">Waktu</td><td>: {data.waktuAcara}</td></tr><tr><td className="py-1">Tempat</td><td>: {data.tempatAcara}</td></tr></tbody></table><div className="mb-6"><p className="mb-3">Adapun hal penting yang akan kita diskusikan bersama terkait dengan:</p><div className="border border-black p-3 text-center w-[85%] mx-auto bg-gray-50 print:bg-transparent">"{data.keperluan}"</div></div><p className="mb-8 text-justify">Mengingat pentingnya acara tersebut, kami sangat mengharapkan kehadiran Bapak/Ibu tepat pada waktunya. Atas perhatian dan kerjasamanya kami ucapkan terima kasih.</p><div className="flex justify-between mt-12 px-8">{data.namaWaliKelas && (<div className="text-center min-w-[200px]"><p className="mb-16">Mengetahui,<br/>Wali Kelas</p><p className="font-bold underline whitespace-nowrap">{data.namaWaliKelas}</p><p>NIP. {data.nipWaliKelas || '-'}</p></div>)}<div className="flex gap-4 items-end ml-auto"><div className="flex flex-col items-center justify-end h-full pb-2"><img src={qrUrl} alt="Validasi" className="w-[2cm] h-[2cm]" /></div><div className="text-center min-w-[250px]"><p className="mb-16">Mengetahui,<br/>{data.jabatan}</p><p className="font-bold underline whitespace-nowrap">{data.penandaTangan}</p><p>NIP. {data.nipPenandaTangan}</p></div></div></div></div>)}
                        
                        {data.type === 'KONTRAK' && (<div><div className="text-center mb-4"><h3 className="font-bold underline text-[12pt] uppercase">KONTRAK PERILAKU SISWA</h3></div><table className="w-full mb-2 border-collapse border border-black text-[11pt]"><tbody><tr><td className="border border-black p-1 font-bold bg-gray-100" colSpan="2">INFORMASI SISWA</td></tr><tr><td className="border border-black p-1 w-48">Nama Siswa</td><td className="border border-black p-1 font-bold">{data.namaSiswa}</td></tr><tr><td className="border border-black p-1">NISN</td><td className="border border-black p-1">{data.nisn}</td></tr><tr><td className="border border-black p-1">Kelas / Gender</td><td className="border border-black p-1">{data.kelas} / {data.jenisKelamin}</td></tr><tr><td className="border border-black p-1">Tanggal Kontrak</td><td className="border border-black p-1">{formatDate(data.tanggalKontrak)}</td></tr><tr><td className="border border-black p-1">Tanggal Tinjauan</td><td className="border border-black p-1">{formatDate(data.tanggalTinjauan) || '-'}</td></tr></tbody></table><div className="space-y-2 text-[11pt]"><div className="border border-black p-1"><p className="font-bold underline mb-0.5">Deskripsi Perilaku yang Akan Diubah:</p><p className="whitespace-pre-line leading-snug">{data.deskripsiPerilaku}</p></div><div className="border border-black p-1"><p className="font-bold underline mb-0.5">Tujuan Perubahan Perilaku:</p><p className="whitespace-pre-line leading-snug">{data.tujuanPerubahan}</p></div><div className="border border-black p-1"><p className="font-bold underline mb-0.5">Rencana Tindakan Siswa:</p><p className="whitespace-pre-line leading-snug">{data.rencanaTindakan}</p></div><div className="grid grid-cols-2 gap-2"><div className="border border-black p-1"><p className="font-bold underline mb-0.5">Konsekuensi:</p><p className="whitespace-pre-line leading-snug">{data.konsekuensi}</p></div><div className="border border-black p-1"><p className="font-bold underline mb-0.5">Status Kontrak:</p><p className="font-bold uppercase leading-snug">{data.statusKontrak}</p></div></div></div><p className="mt-4 mb-2 text-justify text-[11pt] leading-snug">Saya telah membaca dan memahami isi kontrak ini. Saya setuju untuk mengikuti rencana di atas dan menerima konsekuensi yang telah ditetapkan.</p><div className="flex justify-between items-end mt-4 px-2 text-[11pt]"><div className="text-center min-w-[200px] mb-8"><p className="mb-12">Siswa,</p><p className="font-bold underline whitespace-nowrap">{data.namaSiswa}</p></div><div className="text-center min-w-[200px] mb-8"><p className="mb-12">Orang Tua / Wali,</p><p className="font-bold underline">..............................</p></div></div><div className="flex justify-center mt-0 gap-4 items-end"><div className="flex flex-col items-center justify-end h-full pb-2"><img src={qrUrl} alt="Validasi" className="w-[2cm] h-[2cm]" /></div><div className="text-center min-w-[250px]"><p className="mb-1">Mengetahui,</p><p className="mb-12">{data.jabatan}</p><p className="font-bold underline whitespace-nowrap">{data.penandaTangan}</p><p>NIP. {data.nipPenandaTangan}</p></div></div></div>)}

                        {data.type === 'TUGAS_HOMEVISIT' && (
                            <div>
                                <div className="text-center mb-6">
                                    <h3 className="font-bold underline text-[12pt] uppercase">SURAT TUGAS</h3>
                                    <p>Nomor: {data.nomorSurat}</p>
                                </div>
                                <div className="mb-4">
                                    <p className="mb-2">Yang bertanda tangan di bawah ini:</p>
                                    <table className="w-full mb-2 pl-4">
                                        <tbody>
                                            <tr><td className="w-40 align-top">Nama</td><td>: <span className="font-bold">{data.penandaTangan}</span></td></tr>
                                            <tr><td className="align-top">NIP</td><td>: {data.nipPenandaTangan || '-'}</td></tr>
                                            <tr><td className="align-top">Jabatan</td><td>: {data.jabatan}</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div className="mb-4 text-center font-bold text-[12pt]">MEMBERI TUGAS KEPADA:</div>
                                <div className="mb-4">
                                    <table className="w-full mb-2 pl-4">
                                        <tbody>
                                            <tr><td className="w-40 align-top">Nama</td><td>: <span className="font-bold">{data.namaPetugas}</span></td></tr>
                                            <tr><td className="align-top">NIP</td><td>: {data.nipPetugas || '-'}</td></tr>
                                            <tr><td className="align-top">Jabatan</td><td>: Guru BK / Konselor</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div className="mb-6">
                                    <p className="mb-2">Untuk melaksanakan <strong>Kunjungan Rumah (Home Visit)</strong> kepada siswa:</p>
                                    <table className="w-full mb-2 pl-4">
                                        <tbody>
                                            <tr><td className="w-40 align-top">Nama Siswa</td><td>: <strong>{data.namaSiswa}</strong></td></tr>
                                            <tr><td className="align-top">Kelas</td><td>: {data.kelas}</td></tr>
                                            <tr><td className="align-top">Alamat</td><td>: {data.alamatOrangTua || '-'}</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div className="mb-6">
                                    <p className="mb-2">Adapun kegiatan tersebut akan dilaksanakan pada:</p>
                                    <table className="w-full mb-2 pl-4">
                                        <tbody>
                                            <tr><td className="w-40 align-top">Hari / Tanggal</td><td>: {data.hariTanggalAcara}</td></tr>
                                            <tr><td className="align-top">Waktu</td><td>: {data.waktuAcara}</td></tr>
                                            <tr><td className="align-top">Keperluan</td><td>: {data.keperluan}</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                                <p className="mb-8 text-justify">Demikian surat tugas ini diberikan untuk dilaksanakan dengan penuh tanggung jawab.</p>
                                <div className="flex justify-end gap-4 items-end">
                                    <div className="flex flex-col items-center justify-end h-full pb-2"><img src={qrUrl} alt="Validasi" className="w-[2cm] h-[2cm]" /></div>
                                    <div className="text-center min-w-[250px]">
                                        <p className="mb-2">{data.tempat || 'Makassar'}, {formatDate(data.tanggal)}</p>
                                        <p className="mb-16 font-bold">{data.jabatan},</p>
                                        <p className="font-bold underline whitespace-nowrap">{data.penandaTangan}</p>
                                        <p>NIP. {data.nipPenandaTangan}</p>
                                    </div>
                                </div>
                            </div>
                        )}

                        {data.type === 'LAPORAN_HOMEVISIT' && (
                            <div>
                                <div className="text-center mb-6">
                                    <h3 className="font-bold underline text-[12pt] uppercase">LAPORAN HASIL KUNJUNGAN RUMAH</h3>
                                    <p>(HOME VISIT REPORT)</p>
                                </div>
                                <table className="w-full border-collapse border border-black mb-6">
                                    <tbody>
                                        <tr><td className="border border-black p-2 font-bold w-48 bg-gray-100">Nama Siswa</td><td className="border border-black p-2">{data.namaSiswa}</td></tr>
                                        <tr><td className="border border-black p-2 font-bold bg-gray-100">Kelas</td><td className="border border-black p-2">{data.kelas}</td></tr>
                                        <tr><td className="border border-black p-2 font-bold bg-gray-100">Hari / Tanggal</td><td className="border border-black p-2">{data.hariTanggalAcara}</td></tr>
                                        <tr><td className="border border-black p-2 font-bold bg-gray-100">Pihak yang Ditemui</td><td className="border border-black p-2">{data.pihakDitemui} ({data.statusPihakDitemui})</td></tr>
                                    </tbody>
                                </table>
                                <div className="mb-4">
                                    <h4 className="font-bold underline mb-1">A. GAMBARAN MASALAH / TUJUAN KUNJUNGAN</h4>
                                    <div className="border border-black p-2 min-h-[80px] text-justify whitespace-pre-line">{data.gambaranMasalah}</div>
                                </div>
                                <div className="mb-4">
                                    <h4 className="font-bold underline mb-1">B. HASIL PEMBICARAAN</h4>
                                    <div className="border border-black p-2 min-h-[100px] text-justify whitespace-pre-line">{data.hasilPembicaraan}</div>
                                </div>
                                <div className="mb-6">
                                    <h4 className="font-bold underline mb-1">C. RENCANA TINDAK LANJUT (KESEPAKATAN)</h4>
                                    <div className="border border-black p-2 min-h-[80px] text-justify whitespace-pre-line">{data.tindakLanjut}</div>
                                </div>
                                <div className="flex justify-between items-end mt-8 px-2">
                                    <div className="text-center min-w-[200px] mb-4">
                                        <p className="mb-16">Orang Tua / Wali,</p>
                                        <p className="font-bold underline">..............................</p>
                                        <p>{data.statusPihakDitemui}</p>
                                    </div>
                                    <div className="text-center min-w-[200px] mb-4">
                                        <p className="mb-2">{data.tempat || 'Makassar'}, {formatDate(data.tanggal)}</p>
                                        <p className="mb-16">Guru BK / Konselor,</p>
                                        <p className="font-bold underline">{data.namaPetugas}</p>
                                        <p>NIP. {data.nipPetugas || '-'}</p>
                                    </div>
                                </div>
                                <div className="flex justify-center mt-4">
                                    <div className="text-center">
                                        <p className="mb-16">Mengetahui,<br/>{data.jabatan}</p>
                                        <p className="font-bold underline">{data.penandaTangan}</p>
                                        <p>NIP. {data.nipPenandaTangan}</p>
                                    </div>
                                </div>
                            </div>
                        )}
						
						{data.type === 'KONFERENSI_KASUS' && (
							<div>
								{/* HALAMAN 1: BERITA ACARA */}
								<div className="text-center mb-6">
									<h3 className="font-bold underline text-[12pt] uppercase">BERITA ACARA KONFERENSI KASUS</h3>
									<p>Nomor: {data.nomorSurat}</p>
								</div>
								<p className="mb-4 text-justify">Pada hari ini <strong>{data.hariTanggalAcara}</strong>, bertempat di <strong>{data.tempatAcara}</strong>, telah dilaksanakan kegiatan Konferensi Kasus untuk membahas permasalahan dan menyepakati solusi penanganan bagi siswa:</p>
								<table className="w-full mb-4 pl-4">
									<tbody>
										<tr><td className="w-40 py-1">Nama Siswa</td><td>: <strong>{data.namaSiswa}</strong></td></tr>
										<tr><td className="py-1">NISN</td><td>: {data.nisn || '-'}</td></tr>
										<tr><td className="py-1">Kelas / Gender</td><td>: {data.kelas} / {data.jenisKelamin}</td></tr>
										<tr><td className="py-1">Orang Tua / Wali</td><td>: {data.namaOrangTua}</td></tr>
									</tbody>
								</table>
								<div className="mb-2">
                                    <h4 className="font-bold text-sm mb-0.5">A. Gambaran Masalah / Topik Bahasan</h4>
                                    <div className="text-justify whitespace-pre-line pl-4">{data.permasalahan}</div>
                                </div>
                                <div className="mb-4">
                                    <h4 className="font-bold text-sm mb-0.5">B. Hasil Konferensi / Kesepakatan</h4>
                                    <div className="text-justify whitespace-pre-line pl-4">{data.hasilKonferensi}</div>
                                </div>
                                <p className="mb-6 text-sm text-justify">Demikian berita acara konferensi kasus ini dibuat untuk ditindaklanjuti bersama secara kooperatif.</p>

                                {/* Tanda Tangan Konferensi Kasus */}
                                <div className="flex justify-between items-end mt-8 px-4 text-[11pt]">
                                    <div className="text-center min-w-[250px]">
                                        <p>Mengetahui,</p>
                                        <p className="mb-12">{data.jabatan}</p>
                                        <p className="font-bold underline">{data.penandaTangan}</p>
                                        <p>NIP. {data.nipPenandaTangan}</p>
                                    </div>
                                    <div className="text-center min-w-[250px]">
                                        <p className="invisible">Mengetahui,</p>
                                        <p className="mb-12">Guru BK / Konselor,</p>
                                        <p className="font-bold underline">{data.namaPetugas}</p>
                                        <p>NIP. {data.nipPetugas || '-'}</p>
                                    </div>
                                </div>

								{/* HALAMAN 2: LAMPIRAN (Akan tercetak di halaman baru otomatis saat print) */}
								<div style={{ pageBreakBefore: 'always' }} className="pt-8">
									<div className="text-center mb-6">
										<h3 className="font-bold underline text-[12pt] uppercase">LAMPIRAN DAFTAR HADIR</h3>
										<p>Kegiatan Konferensi Kasus Siswa a.n. {data.namaSiswa}</p>
									</div>
									<table className="w-full border-collapse border border-black text-sm">
										<thead>
											<tr className="bg-gray-100">
												<th className="border border-black p-2 w-10">No</th>
												<th className="border border-black p-2">Nama Lengkap</th>
												<th className="border border-black p-2 w-48">Unsur / Jabatan</th>
												<th className="border border-black p-2 w-40">Tanda Tangan</th>
											</tr>
										</thead>
										<tbody>
											<tr><td className="border border-black p-3 text-center">1</td><td className="border border-black p-3">{data.namaSiswa}</td><td className="border border-black p-3 text-center">Siswa</td><td className="border border-black p-3"></td></tr>
											<tr><td className="border border-black p-3 text-center">2</td><td className="border border-black p-3">{data.namaOrangTua}</td><td className="border border-black p-3 text-center">Orang Tua / Wali</td><td className="border border-black p-3"></td></tr>
											<tr><td className="border border-black p-3 text-center">3</td><td className="border border-black p-3">{data.namaPetugas}</td><td className="border border-black p-3 text-center">Guru BK</td><td className="border border-black p-3"></td></tr>
											<tr><td className="border border-black p-3 text-center">4</td><td className="border border-black p-3">{data.penandaTangan}</td><td className="border border-black p-3 text-center">Kepala Sekolah</td><td className="border border-black p-3"></td></tr>
											{(data.pesertaKonferensi || []).map((p, i) => (
												<tr key={i}><td className="border border-black p-3 text-center">{i + 5}</td><td className="border border-black p-3">{p.nama}</td><td className="border border-black p-3 text-center">{p.unsur}</td><td className="border border-black p-3"></td></tr>
											))}
										</tbody>
									</table>
								</div>
							</div>
						)}

                        {data.type === 'ALIH_KASUS' && (
                            <div>
                                <div className="flex justify-between mb-8">
                                    <div>
                                        <table className="leading-snug">
                                            <tbody>
                                                <tr><td>Nomor</td><td>: {data.nomorSurat}</td></tr>
                                                <tr><td>Lampiran</td><td>: 1 (Satu) Berkas</td></tr>
                                                <tr><td>Perihal</td><td className="font-bold">: Alih Tangan Kasus (Referral)</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div className="text-right"><p>{data.tempat || 'Makassar'}, {formatDate(data.tanggal)}</p></div>
                                </div>

                                <div className="mb-6">
                                    <p>Kepada Yth.</p>
                                    <p className="font-bold">{data.pihakTujuan}</p>
                                    <p>di Tempat</p>
                                </div>

                                <p className="mb-2 text-justify">Dengan hormat,</p>
                                <p className="mb-4 text-justify">Berdasarkan hasil pemantauan dan layanan bimbingan konseling yang telah kami lakukan di sekolah, kami memandang perlu untuk mengalih-tangankan penanganan siswa berikut kepada Bapak/Ibu/Saudara yang lebih berwenang/ahli di bidangnya:</p>

                                <table className="w-full mb-6 pl-4">
                                    <tbody>
                                        <tr><td className="w-48 align-top py-1">Nama Siswa</td><td>: <strong>{data.namaSiswa}</strong></td></tr>
                                        <tr><td className="align-top py-1">Kelas / Gender</td><td>: {data.kelas} / {data.jenisKelamin}</td></tr>
                                        <tr><td className="align-top py-1">Alamat</td><td>: {data.alamatOrangTua || '-'}</td></tr>
                                    </tbody>
                                </table>

                                <div className="mb-4">
                                    <p className="font-bold underline mb-1">Rincian Masalah / Gejala yang Tampak:</p>
                                    <p className="text-justify whitespace-pre-line">{data.rincianMasalah}</p>
                                </div>
                                
                                <div className="mb-6">
                                    <p className="font-bold underline mb-1">Riwayat Penanganan di Sekolah:</p>
                                    <p className="text-justify whitespace-pre-line">{data.riwayatPenanganan}</p>
                                </div>

                                <p className="mb-8 text-justify">Besar harapan kami agar Bapak/Ibu dapat memberikan bantuan penanganan yang sesuai untuk siswa tersebut. Demikian surat pengantar ini kami buat, atas perhatian dan kerjasamanya kami ucapkan terima kasih.</p>

                                <div className="flex justify-between items-end mt-12 px-2">
                                    <div className="text-center min-w-[200px]">
                                        <p className="mb-16">Guru BK / Konselor,</p>
                                        <p className="font-bold underline">{data.namaPetugas}</p>
                                        <p>NIP. {data.nipPetugas || '-'}</p>
                                    </div>
                                    <div className="flex gap-4 items-end">
                                        <div className="flex flex-col items-center justify-end h-full pb-2"><img src={qrUrl} alt="Validasi" className="w-[2cm] h-[2cm]" /></div>
                                        <div className="text-center min-w-[200px]">
                                            <p className="mb-16">Mengetahui,<br/>{data.jabatan}</p>
                                            <p className="font-bold underline">{data.penandaTangan}</p>
                                            <p>NIP. {data.nipPenandaTangan}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
						
						{data.type === 'ADVOKASI' && (
							<div>
								<div className="text-center mb-4">
									<h3 className="font-bold underline text-[12pt] uppercase">BERITA ACARA ADVOKASI SISWA</h3>
									<p>Nomor: {data.nomorSurat}</p>
								</div>
								<p className="mb-3 text-justify">Pada hari ini <strong>{formatDate(data.tanggal)}</strong>, bertempat di <strong>{data.tempat || 'Ruang BK'}</strong>, telah dilaksanakan upaya pendampingan/advokasi untuk menjembatani penyelesaian masalah dan pemenuhan hak belajar bagi siswa:</p>
								
								<table className="w-full mb-3 pl-4">
									<tbody>
										<tr><td className="w-40 py-0.5">Nama Siswa</td><td>: <strong>{data.namaSiswa}</strong></td></tr>
										<tr><td className="py-0.5">Kelas</td><td>: {data.kelas}</td></tr>
										<tr><td className="py-0.5">Nama Orang Tua</td><td>: {data.namaOrangTua}</td></tr>
										<tr><td className="py-0.5">Pihak Terkait</td><td>: <strong>{data.pihakTerkait} ({data.statusPihakTerkait})</strong></td></tr>
									</tbody>
								</table>

								<div className="mb-2">
									<h4 className="font-bold text-sm mb-0.5">A. Latar Belakang Masalah</h4>
									<div className="text-justify whitespace-pre-line pl-4">{data.latarBelakang}</div>
								</div>
								
								<div className="mb-2">
									<h4 className="font-bold text-sm mb-0.5">B. Tujuan Advokasi</h4>
									<div className="text-justify whitespace-pre-line pl-4">{data.tujuanAdvokasi}</div>
								</div>

								<div className="mb-4">
									<h4 className="font-bold text-sm mb-0.5">C. Hasil Kesepakatan / Keputusan</h4>
									<div className="text-justify whitespace-pre-line pl-4">{data.hasilAdvokasi}</div>
								</div>

								<p className="mb-4 text-sm text-justify">Demikian berita acara ini dibuat sebagai bentuk pertanggungjawaban profesional dan untuk dipergunakan sebagaimana mestinya.</p>

								{/* Tanda Tangan Khusus Advokasi - Formasi 2 Di Atas, 1 Di Tengah Bawah */}
								<div className="mt-6 text-[11pt]">
									<div className="flex justify-between text-center px-4 mb-6">
										<div className="min-w-[200px]">
											<p className="mb-12">Siswa / Klien,</p>
											<p className="font-bold underline">{data.namaSiswa}</p>
										</div>
										<div className="min-w-[200px]">
											<p className="mb-12">{data.statusPihakTerkait || 'Pihak Terkait'},</p>
											<p className="font-bold underline">{data.pihakTerkait}</p>
										</div>
									</div>
									<div className="flex justify-center text-center">
										<div className="min-w-[250px]">
											<p className="mb-12">Guru BK / Konselor,</p>
											<p className="font-bold underline">{data.namaPetugas}</p>
											<p>NIP. {data.nipPetugas || '-'}</p>
										</div>
									</div>
								</div>
							</div>
						)}
						
						{data.type === 'KONSELING_KELOMPOK' && (
							<div>
								{/* HALAMAN 1: BERITA ACARA INTI */}
								<div className="text-center mb-6">
									<h3 className="font-bold underline text-[12pt] uppercase">BERITA ACARA KONSELING KELOMPOK</h3>
									<p>Nomor: {data.nomorSurat}</p>
								</div>
								<p className="mb-4 text-justify">Pada hari ini telah dilaksanakan layanan Konseling Kelompok (KKP) dengan rincian pelaksanaan sebagai berikut:</p>
								
								<table className="w-full mb-4 pl-4">
									<tbody>
										<tr><td className="w-48 py-1 align-top">Hari / Tanggal</td><td className="align-top">: <strong>{data.hariTanggalAcara}</strong></td></tr>
										<tr><td className="py-1 align-top">Waktu</td><td className="align-top">: {data.waktuAcara}</td></tr>
										<tr><td className="py-1 align-top">Tempat</td><td className="align-top">: {data.tempatAcara}</td></tr>
										{data.teknikKonseling && <tr><td className="py-1 align-top">Pendekatan / Teknik</td><td className="align-top">: {data.teknikKonseling}</td></tr>}
										<tr><td className="py-1 align-top">Jumlah Klien</td><td className="align-top">: {(data.klienKonseling || []).length} Orang Siswa</td></tr>
									</tbody>
								</table>
								
								<div className="mb-2">
									<h4 className="font-bold text-sm mb-0.5">A. Fokus Masalah</h4>
									<div className="text-justify whitespace-pre-line pl-4">{data.fokusMasalah}</div>
								</div>
								
								<div className="mb-2">
									<h4 className="font-bold text-sm mb-0.5">B. Dinamika Konseling</h4>
									<div className="text-justify whitespace-pre-line pl-4">{data.dinamikaKonseling}</div>
								</div>

								<div className="mb-2">
									<h4 className="font-bold text-sm mb-0.5">C. Hasil & Evaluasi (Laiseg)</h4>
									<div className="text-justify whitespace-pre-line pl-4">{data.evaluasiKonseling}</div>
								</div>
								
								<div className="mb-4">
									<h4 className="font-bold text-sm mb-0.5">D. Rencana Tindak Lanjut</h4>
									<div className="text-justify whitespace-pre-line pl-4">{data.tindakLanjutKonseling}</div>
								</div>
								
								<p className="mb-6 text-sm text-justify">Demikian berita acara ini dibuat sebagai bukti fisik penanganan dan pemberian layanan Konseling Kelompok.</p>

								{/* Tanda Tangan Khusus Konseling (Hanya Guru BK) */}
                                <div className="flex justify-end items-end mt-12 px-4 text-[11pt]">
                                    <div className="text-center min-w-[250px]">
                                        <p className="mb-16">Konselor / Guru BK,</p>
                                        <p className="font-bold underline">{data.namaPetugas}</p>
                                        <p>NIP. {data.nipPetugas || '-'}</p>
                                    </div>
                                </div>

								{/* HALAMAN 2: LAMPIRAN (Akan tercetak di halaman baru otomatis) */}
								<div style={{ pageBreakBefore: 'always' }} className="pt-8">
									<div className="text-center mb-6">
										<h3 className="font-bold underline text-[12pt] uppercase">DAFTAR HADIR & IKRAR KERAHASIAAN KLIEN</h3>
										<h3 className="font-bold text-[12pt] uppercase">KONSELING KELOMPOK</h3>
									</div>
									
									<div className="border-2 border-black p-3 mb-4 bg-gray-50 text-justify italic font-semibold">
										"Dengan menandatangani daftar hadir ini, kami selaku anggota kelompok berjanji dan bersedia untuk menjaga kerahasiaan atas seluruh identitas, percakapan, dan permasalahan yang dibahas di dalam sesi konseling ini dari pihak luar mana pun."
									</div>

									<table className="w-full mb-4 text-sm">
										<tbody>
											<tr><td className="w-40 py-1">Hari / Tanggal</td><td>: {data.hariTanggalAcara}</td></tr>
											<tr><td className="py-1">Konselor</td><td>: {data.namaPetugas}</td></tr>
										</tbody>
									</table>

									<table className="w-full border-collapse border border-black text-sm">
										<thead>
											<tr className="bg-gray-100">
												<th className="border border-black p-2 w-10">No</th>
												<th className="border border-black p-2">Nama Lengkap Klien</th>
												<th className="border border-black p-2 w-32">Kelas</th>
												<th className="border border-black p-2 w-40">Tanda Tangan</th>
											</tr>
										</thead>
										<tbody>
											{(data.klienKonseling || []).map((p, i) => (
												<tr key={i}>
													<td className="border border-black p-3 text-center">{i + 1}</td>
													<td className="border border-black p-3">{p.nama}</td>
													<td className="border border-black p-3 text-center">{p.kelas}</td>
													<td className="border border-black p-3"></td>
												</tr>
											))}
										</tbody>
									</table>
								</div>
							</div>
						)}
						
						{data.type === 'BIMBINGAN_KELOMPOK' && (
							<div>
								{/* HALAMAN 1: BERITA ACARA INTI */}
								<div className="text-center mb-6">
									<h3 className="font-bold underline text-[12pt] uppercase">BERITA ACARA BIMBINGAN KELOMPOK</h3>
									<p>Nomor: {data.nomorSurat}</p>
								</div>
								<p className="mb-4 text-justify">Pada hari ini telah dilaksanakan layanan Bimbingan Kelompok (BKP) dengan rincian kegiatan sebagai berikut:</p>
								
								<table className="w-full mb-4 pl-4">
									<tbody>
										<tr><td className="w-48 py-1 align-top">Hari / Tanggal</td><td className="align-top">: <strong>{data.hariTanggalAcara}</strong></td></tr>
										<tr><td className="py-1 align-top">Waktu</td><td className="align-top">: {data.waktuAcara}</td></tr>
										<tr><td className="py-1 align-top">Tempat</td><td className="align-top">: {data.tempatAcara}</td></tr>
										<tr><td className="py-1 align-top">Topik / Materi</td><td className="align-top">: <strong>{data.topikBimbingan}</strong></td></tr>
										<tr><td className="py-1 align-top">Jumlah Peserta</td><td className="align-top">: {(data.pesertaBimbingan || []).length} Orang Siswa</td></tr>
									</tbody>
								</table>
								
								<div className="mb-2">
									<h4 className="font-bold text-sm mb-0.5">A. Tujuan Bimbingan</h4>
									<div className="text-justify whitespace-pre-line pl-4">{data.tujuanBimbingan}</div>
								</div>
								
								<div className="mb-2">
									<h4 className="font-bold text-sm mb-0.5">B. Uraian Kegiatan</h4>
									<div className="text-justify whitespace-pre-line pl-4">{data.uraianKegiatan}</div>
								</div>

								<div className="mb-4">
									<h4 className="font-bold text-sm mb-0.5">C. Hasil Bimbingan</h4>
									<div className="text-justify whitespace-pre-line pl-4">{data.hasilBimbingan}</div>
								</div>
								
								<p className="mb-6 text-sm text-justify">Demikian berita acara ini dibuat sebagai bukti fisik pelaksanaan layanan Bimbingan dan Konseling.</p>

								{/* Tanda Tangan */}
								<div className="flex justify-between items-end mt-8 px-4 text-[11pt]">
									<div className="text-center min-w-[250px]">
										<p>Mengetahui,</p>
										<p className="mb-12">{data.jabatan}</p>
										<p className="font-bold underline">{data.penandaTangan}</p>
										<p>NIP. {data.nipPenandaTangan}</p>
									</div>
									<div className="text-center min-w-[250px]">
										<p className="invisible">Mengetahui,</p>
										<p className="mb-12">Pemimpin Kelompok / Guru BK,</p>
										<p className="font-bold underline">{data.namaPetugas}</p>
										<p>NIP. {data.nipPetugas || '-'}</p>
									</div>
								</div>

								{/* HALAMAN 2: LAMPIRAN (Akan tercetak di halaman baru otomatis) */}
								<div style={{ pageBreakBefore: 'always' }} className="pt-8">
									<div className="text-center mb-6">
										<h3 className="font-bold underline text-[12pt] uppercase">DAFTAR HADIR PESERTA</h3>
										<h3 className="font-bold text-[12pt] uppercase">BIMBINGAN KELOMPOK</h3>
									</div>
									
									<table className="w-full mb-6 text-sm">
										<tbody>
											<tr><td className="w-40 py-1">Hari / Tanggal</td><td>: {data.hariTanggalAcara}</td></tr>
											<tr><td className="py-1">Waktu / Tempat</td><td>: {data.waktuAcara} / {data.tempatAcara}</td></tr>
											<tr><td className="py-1">Topik Bahasan</td><td>: <strong>{data.topikBimbingan}</strong></td></tr>
											<tr><td className="py-1">Pemimpin Kelompok</td><td>: {data.namaPetugas}</td></tr>
										</tbody>
									</table>

									<table className="w-full border-collapse border border-black text-sm">
										<thead>
											<tr className="bg-gray-100">
												<th className="border border-black p-2 w-10">No</th>
												<th className="border border-black p-2">Nama Lengkap Siswa</th>
												<th className="border border-black p-2 w-32">Kelas</th>
												<th className="border border-black p-2 w-40">Tanda Tangan</th>
											</tr>
										</thead>
										<tbody>
											{(data.pesertaBimbingan || []).map((p, i) => (
												<tr key={i}>
													<td className="border border-black p-3 text-center">{i + 1}</td>
													<td className="border border-black p-3">{p.nama}</td>
													<td className="border border-black p-3 text-center">{p.kelas}</td>
													<td className="border border-black p-3"></td>
												</tr>
											))}
										</tbody>
									</table>
								</div>
							</div>
						)}

                        {data.type === 'SKBB' && (
                            <div>
                                <div className="text-center mb-6">
                                    <h3 className="font-bold underline text-[12pt] uppercase">SURAT KETERANGAN BERKELAKUAN BAIK</h3>
                                    <p>Nomor: {data.nomorSurat}</p>
                                </div>
                                <p className="mb-4">Yang bertanda tangan di bawah ini Kepala {schoolData.namaSekolah}, menerangkan bahwa:</p>
                                <table className="w-full mb-6 pl-4">
                                    <tbody>
                                        <tr><td className="w-48 align-top py-1">Nama Siswa</td><td>: <strong>{data.namaSiswa}</strong></td></tr>
                                        <tr><td className="align-top py-1">NISN</td><td>: {data.nisn || '-'}</td></tr>
                                        <tr><td className="align-top py-1">Kelas</td><td>: {data.kelas}</td></tr>
                                        <tr><td className="align-top py-1">Jenis Kelamin</td><td>: {data.jenisKelamin}</td></tr>
                                        <tr><td className="align-top py-1">Asal Sekolah</td><td>: UPT SPF SMP Negeri 16 Makassar</td></tr>
                                    </tbody>
                                </table>

                                <p className="mb-4 text-justify indent-8">Berdasarkan catatan tata tertib siswa dan laporan Bimbingan Konseling di sekolah kami, nama tersebut di atas adalah benar-benar siswa kami dan selama menjadi siswa:</p>
                                
                                <div className="border-2 border-black p-4 mb-4 mx-8 font-bold text-center uppercase bg-gray-50">
                                    BERKELAKUAN BAIK
                                </div>
                                
                                <p className="mb-4 text-justify indent-8">Serta tidak pernah terlibat dalam tindakan Kriminal, Penyalahgunaan Narkoba, maupun Pelanggaran Berat Tata Tertib sekolah lainnya.</p>
                                
                                <p className="mb-2">Surat keterangan ini diberikan untuk keperluan:</p>
                                <div className="font-bold italic text-center mb-6">"{data.keperluan}"</div>

                                <p className="mb-8 text-justify indent-8">Demikian surat keterangan ini dibuat dengan sesungguhnya untuk dapat dipergunakan sebagaimana mestinya.</p>

                                <div className="flex justify-end gap-4 items-end mt-12">
                                    <div className="flex flex-col items-center justify-end h-full pb-2"><img src={qrUrl} alt="Validasi" className="w-[2cm] h-[2cm]" /></div>
                                    <div className="text-center min-w-[250px]">
                                        <p className="mb-2">{data.tempat || 'Makassar'}, {formatDate(data.tanggal)}</p>
                                        <p className="mb-16 font-bold">{data.jabatan},</p>
                                        <p className="font-bold underline whitespace-nowrap">{data.penandaTangan}</p>
                                        <p>NIP. {data.nipPenandaTangan}</p>
                                    </div>
                                </div>
                            </div>
                        )}
						
						{data.type === 'MEDIASI' && (
                            <div>
                                <div className="text-center mb-6">
                                    <h3 className="font-bold underline text-[12pt] uppercase">BERITA ACARA MEDIASI</h3>
                                    <p>Nomor: {data.nomorSurat}</p>
                                </div>
                                <p className="mb-4">Pada hari ini, <strong>{formatDate(data.tanggal)}</strong>, bertempat di Ruang Bimbingan dan Konseling {schoolData.namaSekolah}, telah dilaksanakan mediasi antara:</p>
                                
                                <div className="flex gap-4 mb-4">
                                    <div className="flex-1 border border-black p-2">
                                        <p className="font-bold text-center underline mb-2">PIHAK I</p>
                                        <table className="w-full text-sm">
                                            <tbody>
                                                <tr><td className="w-16">Nama</td><td>: <strong>{data.namaSiswa}</strong></td></tr>
                                                <tr><td>Kelas</td><td>: {data.kelas}</td></tr>
                                                <tr><td>Ortu</td><td>: {data.namaOrangTua}</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div className="flex-1 border border-black p-2">
                                        <p className="font-bold text-center underline mb-2">PIHAK II</p>
                                        <table className="w-full text-sm">
                                            <tbody>
                                                <tr><td className="w-16">Nama</td><td>: <strong>{data.namaSiswa2}</strong></td></tr>
                                                <tr><td>Kelas</td><td>: {data.kelas2}</td></tr>
                                                <tr><td>Ortu</td><td>: {data.namaOrangTua2}</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <div className="mb-4">
                                    <h4 className="font-bold text-sm mb-1">A. PERMASALAHAN</h4>
                                    <div className="text-justify border border-gray-300 p-2 min-h-[50px] whitespace-pre-line">{data.permasalahan}</div>
                                </div>

                                <div className="mb-6">
                                    <h4 className="font-bold text-sm mb-1">B. HASIL MEDIASI / KESEPAKATAN</h4>
                                    <div className="text-justify border border-gray-300 p-2 min-h-[50px] whitespace-pre-line">{data.hasilMediasi}</div>
                                </div>

                                <p className="mb-4 text-sm">Demikian berita acara ini dibuat untuk dipatuhi bersama.</p>

                                {/* TANDA TANGAN KOMPLEKS GRID */}
                                <div className="grid grid-cols-2 gap-y-6 gap-x-4 text-center text-xs">
                                    {/* SISWA */}
                                    <div><p>Pihak I (Siswa),</p><br/><br/><br/><p className="font-bold underline">{data.namaSiswa}</p></div>
                                    <div><p>Pihak II (Siswa),</p><br/><br/><br/><p className="font-bold underline">{data.namaSiswa2}</p></div>
                                    
                                    {/* ORTU */}
                                    <div><p>Orang Tua Pihak I,</p><br/><br/><br/><p className="font-bold underline">{data.namaOrangTua}</p></div>
                                    <div><p>Orang Tua Pihak II,</p><br/><br/><br/><p className="font-bold underline">{data.namaOrangTua2}</p></div>
                                    
                                    {/* WALI KELAS */}
                                    <div><p>Wali Kelas Pihak I,</p><br/><br/><br/><p className="font-bold underline">{data.namaWaliKelas}</p></div>
                                    <div><p>Wali Kelas Pihak II,</p><br/><br/><br/><p className="font-bold underline">{data.namaWaliKelas2}</p></div>

                                    {/* SAKSI DAN KEPSEK */}
                                    <div><p>Saksi (Guru BK),</p><br/><br/><br/><p className="font-bold underline">{data.namaSaksi}</p><p>NIP. {data.nipSaksi}</p></div>
                                    <div><p>Mengetahui Kepala Sekolah,</p><br/><br/><br/><p className="font-bold underline">{data.penandaTangan}</p><p>NIP. {data.nipPenandaTangan}</p></div>
                                </div>
                            </div>
                        )}
						
						{/* CETAK BUKU TAMU PINTAR (DETEKSI OTOMATIS) */}
                        {data.type === 'BUKU_TAMU' && (() => {
                            // Mesin pendeteksi peran tamu
                            const isOrtu = data.namaSiswa && data.namaSiswa.startsWith('Ortu:');
                            const isTamu = data.namaSiswa && data.namaSiswa.startsWith('Tamu:');
                            const isSiswa = !isOrtu && !isTamu;
                            
                            // Membersihkan tulisan "Ortu:" / "Tamu:" agar namanya rapi saat dicetak
                            const cleanName = data.namaSiswa ? data.namaSiswa.replace('Ortu: ', '').replace('Tamu: ', '') : '-';

                            return (
                                <div>
                                    <div className="text-center mb-8">
                                        <h3 className="font-bold underline text-[12pt] uppercase tracking-wider">BUKTI KUNJUNGAN RUANG BK</h3>
                                    </div>
                                    <p className="mb-6 text-justify">Telah berkunjung ke ruang Bimbingan dan Konseling {schoolData.namaSekolah}, <strong>{isOrtu ? 'orang tua / wali siswa' : (isTamu ? 'tamu umum / instansi' : 'siswa')}</strong> dengan identitas sebagai berikut:</p>
                                    
                                    <div className="border border-black p-6 mb-6 bg-gray-50/50">
                                        <table className="w-full text-sm">
                                            <tbody>
                                                <tr><td className="w-40 py-2 border-b border-gray-200">Nama Lengkap</td><td className="border-b border-gray-200">: <strong>{cleanName}</strong></td></tr>
                                                <tr><td className="py-2 border-b border-gray-200">{isOrtu ? 'Siswa yang Diwakili' : (isTamu ? 'Instansi / Jabatan' : 'Kelas / NISN')}</td><td className="border-b border-gray-200">: {isSiswa ? `${data.kelas} / ${data.nisn || '-'}` : data.kelas}</td></tr>
                                                <tr><td className="py-2 border-b border-gray-200">Waktu Kunjungan</td><td className="border-b border-gray-200">: {formatDate(data.tanggal)} | Pukul {data.waktuAcara}</td></tr>
                                                <tr><td className="py-2 align-top pt-3">Tujuan / Keperluan</td><td className="align-top pt-3 text-justify">: {data.keperluan}</td></tr>
                                            </tbody>
                                        </table>
                                    </div>

                                    <p className="mb-10 text-justify text-sm">Kunjungan ini telah dicatat secara resmi ke dalam pangkalan data <strong>Buku Tamu Harian Bimbingan dan Konseling</strong> sebagai {isOrtu ? 'bukti koordinasi dan kunjungan orang tua/wali' : (isTamu ? 'bukti kunjungan kedinasan/tamu' : 'bukti partisipasi aktif siswa')}.</p>

                                    <div className="flex justify-between items-start mt-12 px-4 text-[11pt]">
                                        <div className="text-center w-[250px]">
                                            <p className="mb-1 invisible">Tempat, Tanggal</p>
                                            <p className="mb-20">{isOrtu ? 'Orang Tua / Wali,' : (isTamu ? 'Tamu / Instansi,' : 'Siswa yang berkunjung,')}</p>
                                            <p className="font-bold underline">{cleanName}</p>
                                        </div>
                                        <div className="text-center w-[250px]">
                                            <p className="mb-1">{data.tempat || 'Makassar'}, {formatDate(data.tanggal)}</p>
                                            <p className="mb-20">{data.jabatan || 'Guru BK / Konselor Piket'},</p>
                                            <p className="font-bold underline">{data.penandaTangan}</p>
                                            {data.nipPenandaTangan && data.nipPenandaTangan !== '-' && (
                                                <p>NIP. {data.nipPenandaTangan}</p>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            );
                        })()}
						
						{data.type === 'REKOMENDASI_STUDI' && (
                            <div className="text-[11pt]">
                                <div className="text-center mb-6">
                                    <h3 className="font-bold underline text-[12pt] uppercase tracking-wide">SURAT KETERANGAN REKOMENDASI PEMINATAN / STUDI</h3>
                                    <p>Nomor: {data.nomorSurat}</p>
                                </div>

                                <p className="mb-3 text-justify">
                                    Yang bertanda tangan di bawah ini, Kepala {schoolData.namaSekolah} dan Guru Bimbingan dan Konseling, menerangkan dengan sesungguhnya bahwa:
                                </p>

                                <table className="w-full mb-4 pl-4">
                                    <tbody>
                                        <tr><td className="w-40 py-0.5">Nama Lengkap</td><td>: <strong>{data.namaSiswa}</strong></td></tr>
                                        <tr><td className="py-0.5">NISN</td><td>: {data.nisn || '-'}</td></tr>
                                        <tr><td className="py-0.5">Kelas</td><td>: {data.kelas}</td></tr>
                                        <tr><td className="py-0.5">Jenis Kelamin</td><td>: {data.jenisKelamin || '-'}</td></tr>
                                    </tbody>
                                </table>

                                <p className="mb-2 text-justify">
                                    Berdasarkan hasil evaluasi, pengamatan perilaku, serta capaian akademik dan non-akademik selama menempuh pendidikan, siswa tersebut memiliki rekam jejak sebagai berikut:
                                </p>

                                <div className="mb-3">
                                    <p className="font-bold mb-1">A. Capaian Akademik (Mata Pelajaran Dominan)</p>
                                    <table className="w-full border-collapse border border-black mb-1 text-[10pt]">
                                        <thead>
                                            <tr className="bg-gray-100">
                                                <th className="border border-black px-2 py-1 w-12 text-center">No</th>
                                                <th className="border border-black px-2 py-1 text-left">Mata Pelajaran</th>
                                                <th className="border border-black px-2 py-1 w-32 text-center">Nilai Rata-rata</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {data.nilaiMapel && data.nilaiMapel.length > 0 ? (
                                                data.nilaiMapel.map((m, i) => (
                                                    <tr key={i}>
                                                        <td className="border border-black px-2 py-1 text-center">{i + 1}</td>
                                                        <td className="border border-black px-2 py-1">{m.mapel}</td>
                                                        <td className="border border-black px-2 py-1 text-center font-bold">{m.nilai}</td>
                                                    </tr>
                                                ))
                                            ) : (
                                                <tr><td colSpan="3" className="border border-black px-2 py-1 text-center italic">Tidak ada data nilai yang dilampirkan</td></tr>
                                            )}
                                        </tbody>
                                    </table>
                                </div>

                                <div className="mb-4">
                                    <p className="font-bold mb-1">B. Capaian Non-Akademik & Asesmen Psikologis</p>
                                    <ul className="list-disc pl-6 text-justify">
                                        <li className="mb-1"><strong>Prestasi / Keaktifan:</strong> {data.prestasi || 'Tidak ada catatan khusus.'}</li>
                                        <li><strong>Hasil Asesmen/Minat:</strong> {data.hasilAsesmen || 'Tidak ada catatan khusus.'}</li>
                                    </ul>
                                </div>

                                <div className="mb-4">
                                    <p className="font-bold mb-1">C. Kesimpulan & Rekomendasi</p>
                                    <p className="text-justify mb-2">Memperhatikan potensi dan capaian di atas, maka siswa tersebut <strong>sangat direkomendasikan</strong> untuk melanjutkan pendidikan ke:</p>
                                    <div className="p-3 border-2 border-black text-center mb-3 bg-gray-50">
                                        <p className="font-bold text-[12pt] uppercase tracking-wider">{data.targetStudi}</p>
                                    </div>
                                    <p className="text-justify italic">"{data.uraianRekomendasi}"</p>
                                </div>

                                <p className="text-justify mb-8">
                                    Demikian surat keterangan rekomendasi ini dibuat dengan sebenar-benarnya untuk dapat dipergunakan sebagai bahan pertimbangan oleh <strong>{data.tujuanSurat}</strong>.
                                </p>

                                <div className="flex justify-between items-end mt-4 px-2">
                                    <div className="text-center min-w-[200px]">
                                        <p className="mb-1">Mengetahui,</p>
                                        <p className="mb-16">{data.jabatan}</p>
                                        <p className="font-bold underline">{data.penandaTangan}</p>
                                        <p>NIP. {data.nipPenandaTangan || '-'}</p>
                                    </div>
                                    <div className="flex flex-col items-center justify-end h-full pb-2">
                                        <img src={qrUrl} alt="Validasi" className="w-[2cm] h-[2cm]" />
                                    </div>
                                    <div className="text-center min-w-[200px]">
                                        <p className="mb-1">{data.tempat || 'Makassar'}, {formatDate(data.tanggal)}</p>
                                        <p className="mb-16">Guru Bimbingan dan Konseling</p>
                                        <p className="font-bold underline">{data.namaPetugas}</p>
                                        <p>NIP. {data.nipPetugas || '-'}</p>
                                    </div>
                                </div>
                            </div>
                        )}

                        {data.type === 'BERHENTI' && (
                            <div>
                                <div className="text-center mb-6">
                                    <h3 className="font-bold underline text-[12pt] uppercase">SURAT KETERANGAN PENGUNDURAN DIRI</h3>
                                    <p>Nomor: {data.nomorSurat}</p>
                                </div>
                                <p className="mb-4">Yang bertanda tangan di bawah ini:</p>
                                <table className="w-full mb-4 pl-4">
                                    <tbody>
                                        <tr><td className="w-48 py-1">Nama Orang Tua/Wali</td><td>: <strong>{data.namaOrangTua}</strong></td></tr>
                                        <tr><td className="py-1">Alamat</td><td>: {data.alamatOrangTua}</td></tr>
                                        <tr><td className="py-1">Selaku Orang Tua dari</td><td>:</td></tr>
                                        <tr><td className="py-1 pl-4">Nama Siswa</td><td>: <strong>{data.namaSiswa}</strong></td></tr>
                                        <tr><td className="py-1 pl-4">NISN</td><td>: {data.nisn}</td></tr>
                                        <tr><td className="py-1 pl-4">Kelas</td><td>: {data.kelas}</td></tr>
                                    </tbody>
                                </table>

                                <p className="mb-2 text-justify">Dengan ini mengajukan permohonan <strong>PENGUNDURAN DIRI / BERHENTI</strong> sebagai siswa di {schoolData.namaSekolah}, dikarenakan:</p>
                                <div className="border border-black p-4 mb-4 bg-gray-50 italic text-justify">
                                    "{data.alasanBerhenti}"
                                </div>
                                
                                <p className="mb-6 text-justify">Demikian surat pernyataan pengunduran diri ini saya buat dengan kesadaran sendiri tanpa paksaan dari pihak manapun.</p>

                                <div className="grid grid-cols-2 gap-y-8 gap-x-4 text-center mt-8">
                                    <div>
                                        <p>Siswa yang bersangkutan,</p><br/><br/><br/><p className="font-bold underline">{data.namaSiswa}</p>
                                    </div>
                                    <div>
                                        <p>{data.tempat}, {formatDate(data.tanggal)}</p>
                                        <p>Orang Tua / Wali,</p><br/><br/><br/><p className="font-bold underline">{data.namaOrangTua}</p>
                                    </div>
                                    <div>
                                        <p>Saksi ({data.statusSaksi}),</p><br/><br/><br/><p className="font-bold underline">{data.namaSaksi}</p>
                                    </div>
                                    <div>
                                        <p>Mengetahui Kepala Sekolah,</p><br/><br/><br/><p className="font-bold underline">{data.penandaTangan}</p><p>NIP. {data.nipPenandaTangan}</p>
                                    </div>
                                </div>
                            </div>
                        )}

                    </div>
                </div>
            );
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            return new Date(dateString).toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });
        }
		
		// Fungsi untuk memberikan warna otomatis pada label jenis surat
        function getBadgeStyle(type) {
            const styles = {
                'SKORSING': 'bg-red-100 text-red-700 border-red-200',
                'PERNYATAAN': 'bg-orange-100 text-orange-700 border-orange-200',
                'KONTRAK': 'bg-emerald-100 text-emerald-700 border-emerald-200',
                'UNDANGAN': 'bg-blue-100 text-blue-700 border-blue-200',
                'TUGAS_HOMEVISIT': 'bg-indigo-100 text-indigo-700 border-indigo-200',
                'LAPORAN_HOMEVISIT': 'bg-cyan-100 text-cyan-700 border-cyan-200',
                'ALIH_KASUS': 'bg-fuchsia-100 text-fuchsia-700 border-fuchsia-200',
                'KONFERENSI_KASUS': 'bg-indigo-100 text-indigo-700 border-indigo-200',
                'MEDIASI': 'bg-pink-100 text-pink-700 border-pink-200',
                'ADVOKASI': 'bg-rose-100 text-rose-700 border-rose-200',
                'BIMBINGAN_KELOMPOK': 'bg-emerald-100 text-emerald-700 border-emerald-200',
                'KONSELING_KELOMPOK': 'bg-violet-100 text-violet-700 border-violet-200',
                'SKBB': 'bg-teal-100 text-teal-700 border-teal-200',
                'BERHENTI': 'bg-gray-200 text-gray-700 border-gray-300',
				'BUKU_TAMU': 'bg-sky-100 text-sky-700 border-sky-200',
				'REKOMENDASI_STUDI': 'bg-blue-100 text-blue-800 border-blue-300',
            };
            return styles[type] || 'bg-slate-100 text-slate-700 border-slate-200';
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>

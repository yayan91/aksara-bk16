<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AKSARA - BK16</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* Loading Spinner */
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loader { border-top-color: #3498db; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Autocomplete Dropdown Styles */
        .autocomplete-items {
            position: absolute; border: 1px solid #d4d4d4; border-bottom: none; border-top: none; z-index: 99;
            top: 100%; left: 0; right: 0; max-height: 200px; overflow-y: auto; background-color: white; border-radius: 0 0 8px 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .autocomplete-items div { padding: 10px; cursor: pointer; background-color: #fff; border-bottom: 1px solid #d4d4d4; font-size: 0.875rem; }
        .autocomplete-items div:hover { background-color: #e9e9e9; }
        .autocomplete-active { background-color: DodgerBlue !important; color: #ffffff; }

        @media print {
            /* Kita atur margin langsung di kertas cetak, bukan di div-nya */
            @page { size: 215mm 330mm; margin: 15mm 20mm; } 
            
            /* Hancurkan semua kuncian tinggi layar agar kertas bisa panjang ke bawah */
            html, body, #root, .min-h-screen { 
                background-color: #ffffff !important; 
                height: auto !important; 
                min-height: auto !important; 
                overflow: visible !important; 
                position: relative !important;
            }
            
            /* Sembunyikan elemen UI aplikasi (Sidebar, Navbar, dll) */
            aside, main, .no-print { 
                display: none !important; 
            }
            
            /* Bebaskan area surat agar mengalir alami mengikuti isi teks */
            .print-area { 
                display: block !important; 
                position: relative !important; /* Ini kunci utamanya! Harus relative */
                width: 100% !important; 
                height: auto !important;
                padding: 0 !important; 
                margin: 0 !important;
                box-shadow: none !important; 
                overflow: visible !important;
            }
            
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
    </style>
	
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ==========================================
        // CONFIGURATION
        // ==========================================
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzMEVvwH8q8spX3ECAZwgIh27eQskHtpKavLMZHMSo0RM9sq_BuExIdSStQptkXl7cgXQ/exec"; 
        // ==========================================

        const { useState, useEffect, useRef } = React;

        // --- ICONS ---
        const IconBase = ({ children, size = 24, className = "" }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>);
        const Plus = (props) => <IconBase {...props}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></IconBase>;
        const Trash2 = (props) => <IconBase {...props}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></IconBase>;
        const Edit = (props) => <IconBase {...props}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></IconBase>;
        const Eye = (props) => <IconBase {...props}><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></IconBase>;
        const EyeOff = (props) => <IconBase {...props}><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></IconBase>;
        const Printer = (props) => <IconBase {...props}><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></IconBase>;
        const Search = (props) => <IconBase {...props}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></IconBase>;
        const LayoutDashboard = (props) => <IconBase {...props}><rect x="3" y="3" width="7" height="9"/><rect x="14" y="3" width="7" height="5"/><rect x="14" y="12" width="7" height="9"/><rect x="3" y="16" width="7" height="5"/></IconBase>;
        const FileWarning = (props) => <IconBase {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><path d="M12 9v4"/><path d="M12 17h.01"/></IconBase>;
        const FileSignature = (props) => <IconBase {...props}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M16 13H8"/><path d="M16 17H8"/><path d="M10 9H8"/></IconBase>;
        const Mail = (props) => <IconBase {...props}><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></IconBase>;
        const FileCheck = (props) => <IconBase {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="m9 15 2 2 4-4"/></IconBase>;
        const X = (props) => <IconBase {...props}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></IconBase>;
        const Save = (props) => <IconBase {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>;
        const ArrowLeft = (props) => <IconBase {...props}><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></IconBase>;
        const Building2 = (props) => <IconBase {...props}><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"/><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"/><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"/><path d="M10 6h4"/><path d="M10 10h4"/><path d="M10 14h4"/><path d="M10 18h4"/></IconBase>;
        const Menu = (props) => <IconBase {...props}><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></IconBase>;
        const RotateCcw = (props) => <IconBase {...props}><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></IconBase>;
        const ChevronLeft = (props) => <IconBase {...props}><polyline points="15 18 9 12 15 6"/></IconBase>;
        const ChevronRight = (props) => <IconBase {...props}><polyline points="9 18 15 12 9 6"/></IconBase>;
        const SidebarOpen = (props) => <IconBase {...props}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="9" y1="3" x2="9" y2="21"/></IconBase>;
        const Cloud = (props) => <IconBase {...props}><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></IconBase>;
        const MessageCircle = (props) => <IconBase {...props}><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></IconBase>;
        const History = (props) => <IconBase {...props}><path d="M3 3v5h5"/><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"/><path d="M12 7v5l4 2"/></IconBase>;
        const BarChart2 = (props) => <IconBase {...props}><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></IconBase>;
        const Download = (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></IconBase>;
        const LogOut = (props) => <IconBase {...props}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></IconBase>;
        const User = (props) => <IconBase {...props}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconBase>;
        const Lock = (props) => <IconBase {...props}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></IconBase>;
        const Briefcase = (props) => <IconBase {...props}><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></IconBase>;
        const ClipboardList = (props) => <IconBase {...props}><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></IconBase>;
        const Share = (props) => <IconBase {...props}><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></IconBase>;
        const ShieldCheck = (props) => <IconBase {...props}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="m9 12 2 2 4-4"/></IconBase>;
		const Users = (props) => <IconBase {...props}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></IconBase>;
        const UserMinus = (props) => <IconBase {...props}><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="23" y1="11" x2="17" y2="11"></line></IconBase>;

        // --- LOADING OVERLAY ---
        function LoadingOverlay({ message }) {
            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[60] flex flex-col items-center justify-center text-white">
                    <div className="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
                    <p className="font-semibold text-lg animate-pulse">{message}</p>
                </div>
            );
        }
		
		// --- LOGIN VIEW (UPDATED: SERVER-SIDE CHECK) ---
        function LoginView({ onLogin }) {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [showPass, setShowPass] = useState(false);
            const [error, setError] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault();
                setError('');
                setIsLoading(true);

                try {
                    // MENGIRIM PERMINTAAN LOGIN KE SERVER (GOOGLE APPS SCRIPT)
                    const response = await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: 'login',
                            payload: { username, password }
                        })
                    });
                    const result = await response.json();

                    if (result.status === 'success') {
                        // Alert Keren Saat Berhasil Login
                        Swal.fire({
                            icon: 'success',
                            title: 'Berhasil Masuk!',
                            text: `Selamat datang, ${result.user.username}`,
                            timer: 1500,
                            showConfirmButton: false
                        }).then(() => {
                            onLogin(result.user);
                        });
                    } else {
                        // Alert Keren Saat Gagal
                        Swal.fire({
                            icon: 'error',
                            title: 'Login Gagal',
                            text: result.message || 'Username atau Password Salah!'
                        });
                        setError(result.message || 'Username atau Password Salah!');
                    }
                } catch (err) {
                    setError('Gagal terhubung ke server. Pastikan internet lancar.');
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">
                    {isLoading && <LoadingOverlay message="Tunggu Yah.." />}
                    <div className="absolute inset-0 bg-[url('https://source.unsplash.com/random/1920x1080/?school,book')] bg-cover opacity-20"></div>
                    <div className="bg-white w-full max-w-md p-8 rounded-2xl shadow-2xl relative z-10 animate-fade-in-up">
                        <div className="text-center mb-8">
                            <div className="w-16 h-16 bg-blue-600 rounded-xl flex items-center justify-center mx-auto mb-4 shadow-lg rotate-3">
                                <Lock className="text-white" size={32}/>
                            </div>
                            <h1 className="text-2xl font-bold text-slate-800">AKSARA-BK16</h1>
                            <p className="text-slate-500 text-sm">Aplikasi Kelola Surat BK</p>
                        </div>
                        {error && <div className="bg-red-50 text-red-600 p-3 rounded-lg text-sm mb-4 text-center">{error}</div>}
                        <form onSubmit={handleLogin} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Username</label>
                                <div className="relative">
                                    <User className="absolute left-3 top-2.5 text-gray-400" size={18}/>
                                    <input type="text" value={username} onChange={e => setUsername(e.target.value)} className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Nama Guru" required />
                                </div>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Password</label>
                                <div className="relative">
                                    <Lock className="absolute left-3 top-2.5 text-gray-400" size={18}/>
                                    <input type={showPass ? "text" : "password"} value={password} onChange={e => setPassword(e.target.value)} className="w-full pl-10 pr-10 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="••••••" required />
                                    <button type="button" onClick={() => setShowPass(!showPass)} className="absolute right-3 top-2.5 text-gray-400 hover:text-gray-600">
                                        {showPass ? <EyeOff size={18}/> : <Eye size={18}/>}
                                    </button>
                                </div>
                            </div>
                            <button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 rounded-lg shadow transition-colors">Masuk Aplikasi</button>
                        </form>
                        <div className="mt-6 text-center text-xs text-gray-400">
                            &copy; {new Date().getFullYear()} UPT SPF SMP Negeri 16 Makassar
                        </div>
                    </div>
                </div>
            )
        }

        // --- APP LOGIC ---
        function App() {
            const [currentUser, setCurrentUser] = useState(null);
            
            const [activeTab, setActiveTab] = useState('dashboard');
            const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
            const [isSidebarOpen, setIsSidebarOpen] = useState(true);
            const [itemsPerPage, setItemsPerPage] = useState(5);
            const [currentPage, setCurrentPage] = useState(1);
            
            const [schoolData, setSchoolData] = useState({
                pemerintah: 'PEMERINTAH PROVINSI',
                instansi: 'DINAS PENDIDIKAN',
                namaSekolah: 'NAMA SEKOLAH ANDA',
                alamat: 'Alamat Sekolah Lengkap...',
                logoKiri: '', 
                logoKanan: '',
                users: []
            });

            const [letters, setLetters] = useState([]);
            // DATA BARU DARI BACKEND
            const [students, setStudents] = useState([]);
            const [classes, setClasses] = useState([]);
            const [officials, setOfficials] = useState([]);

            const [loadingState, setLoadingState] = useState({ isLoading: false, message: '' });

            useEffect(() => {
                if (APPS_SCRIPT_URL !== "PASTE_URL_APPS_SCRIPT_DISINI") {
                    fetchData();
                }
            }, []);

            const fetchData = async () => {
                setLoadingState({ isLoading: true, message: 'Sinkronisasi Data...' });
                try {
                    const response = await fetch(APPS_SCRIPT_URL);
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        // Data Surat & Sekolah
                        setLetters(result.data.letters || []);
                        if (result.data.school) {
                            setSchoolData(result.data.school);
                        }
                        // DATA BARU: Simpan ke state
                        if (result.data.students) setStudents(result.data.students);
                        if (result.data.classes) setClasses(result.data.classes);
                        if (result.data.officials) setOfficials(result.data.officials);

                    } else {
                        alert('Gagal mengambil data: ' + result.message);
                    }
                } catch (error) {
                    console.error("Error fetching:", error);
                } finally {
                    setLoadingState({ isLoading: false, message: '' });
                }
            };

            const [viewState, setViewState] = useState('list');
            const [selectedLetter, setSelectedLetter] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
			// --- STATE FILTER LANJUTAN ---
            const [filterType, setFilterType] = useState('Semua');
            const [filterCreator, setFilterCreator] = useState('Semua');
            const [filterStartDate, setFilterStartDate] = useState('');
            const [filterEndDate, setFilterEndDate] = useState('');

            // --- PILIHAN DROPDOWN DINAMIS ---
            const uniqueCreators = ['Semua', ...new Set(letters.map(l => l.createdBy).filter(Boolean))];
            const letterTypesList = ['Semua', 'SKORSING', 'PERNYATAAN', 'KONTRAK', 'UNDANGAN', 'TUGAS_HOMEVISIT', 'LAPORAN_HOMEVISIT', 'ALIH_KASUS', 'MEDIASI', 'KONFERENSI_KASUS', 'ADVOKASI', 'BIMBINGAN_KELOMPOK', 'SKBB', 'BERHENTI'];
            const [historyStudent, setHistoryStudent] = useState(null);

            useEffect(() => { setCurrentPage(1); }, [activeTab, searchTerm, itemsPerPage, filterType, filterCreator, filterStartDate, filterEndDate]);

            // ACTIONS
            const handleDelete = (id) => {
                Swal.fire({
                    title: 'Yakin ingin menghapus?',
                    text: "Data surat ini akan dihapus permanen dari Database!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Ya, Hapus!',
                    cancelButtonText: 'Batal'
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        setLoadingState({ isLoading: true, message: 'Menghapus data...' });
                        try {
                            await fetch(APPS_SCRIPT_URL, {
                                method: 'POST',
                                body: JSON.stringify({ action: 'deleteLetter', payload: { id } })
                            });
                            setLetters(letters.filter(l => l.id !== id));
                            if (selectedLetter && selectedLetter.id === id) { setViewState('list'); setSelectedLetter(null); }
                            
                            // Notifikasi sukses
                            Swal.fire('Terhapus!', 'Data surat berhasil dihapus.', 'success');
                        } catch (error) { 
                            Swal.fire('Gagal!', 'Gagal menghapus data. Periksa koneksi internet.', 'error');
                        } finally { 
                            setLoadingState({ isLoading: false, message: '' }); 
                        }
                    }
                });
            };

            const handleSaveLetter = async (formData) => {
                setLoadingState({ isLoading: true, message: 'Menyimpan Surat ...' });
                const newData = { 
                    ...formData, 
                    id: formData.id || Date.now(),
                    createdBy: formData.id ? formData.createdBy : currentUser.username,
                    lastEditedBy: currentUser.username
                };

                try {
                    await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'saveLetter', payload: newData })
                    });
                    
                    if (viewState === 'create') { setLetters([ newData, ...letters ]); } 
                    else if (viewState === 'edit') { setLetters(letters.map(l => l.id === newData.id ? newData : l)); }
                    
                    setViewState('list');
                    setSelectedLetter(null);
                    Swal.fire({
                        icon: 'success',
                        title: 'Tersimpan!',
                        text: 'Data surat berhasil disimpan ke database.',
                        timer: 1500,
                        showConfirmButton: false
                    });
                } catch (error) { 
                    Swal.fire('Gagal!', 'Terjadi kesalahan saat menyimpan data.', 'error');
                } finally {
                    // BARIS INI YANG SEBELUMNYA HILANG
                    setLoadingState({ isLoading: false, message: '' }); 
                }
            };

            const handleSaveSchoolData = async (data) => {
                setLoadingState({ isLoading: true, message: 'Menyimpan Pengaturan...' });
                try {
                    await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'saveSchoolData', payload: data })
                    });
                    setSchoolData(data);
                    setViewState('list');
                    Swal.fire({
                        icon: 'success',
                        title: 'Pengaturan Disimpan!',
                        showConfirmButton: false,
                        timer: 1500
                    });
                } catch (error) { 
                    Swal.fire('Gagal!', 'Gagal menyimpan pengaturan sekolah.', 'error');
                } finally {
                    // PASTIKAN BARIS INI JUGA ADA DI SINI
                    setLoadingState({ isLoading: false, message: '' }); 
                }
            };

            const handleSendWA = (letter) => {
                if (!letter.noHpOrangTua) {
				Swal.fire('Oops!', 'Nomor HP Orang Tua belum diisi pada surat ini.', 'warning');
				return;
			}
                let phone = letter.noHpOrangTua.replace(/\D/g, '');
                if (phone.startsWith('0')) phone = '62' + phone.slice(1);
                const message = `Yth. Bapak/Ibu Wali dari ${letter.namaSiswa}.%0A%0ABerikut kami sampaikan informasi persuratan sekolah (${letter.type}) dengan nomor ${letter.nomorSurat}.%0AMohon kehadirannya/perhatiannya.%0A%0ATerima kasih.%0A- Tim BK ${schoolData.namaSekolah}`;
                window.open(`https://wa.me/${phone}?text=${message}`, '_blank');
            };

            const handleExportExcel = () => {
                // 1. Fungsi kecil pelindung (escape) agar tanda kutip (") atau koma (,) di inputan guru tidak merusak kolom Excel
                const escapeCSV = (str) => {
                    if (str === null || str === undefined) return '""';
                    const text = String(str);
                    return `"${text.replace(/"/g, '""')}"`; // Ubah " jadi "" sesuai standar CSV
                };

                // 2. Header kolom Excel
                const header = ["ID", "Jenis Surat", "Nomor Surat", "Tanggal", "Nama Siswa", "Kelas", "Keterangan/Perihal", "Pembuat"];
                
                // 3. Menggunakan 'filteredLetters' (Bukan 'letters') agar yang diekspor HANYA yang tampil di tabel saat ini
                const rows = filteredLetters.map(l => [
                    l.id, 
                    escapeCSV(l.type.replace('_', ' ')), 
                    escapeCSV(l.nomorSurat || '-'), 
                    escapeCSV(formatDate(l.tanggal)), 
                    escapeCSV(l.namaSiswa), 
                    escapeCSV(l.kelas), 
                    escapeCSV(l.alasan || l.permasalahan || l.perihal || l.keperluan || l.gambaranMasalah || l.alasanBerhenti || '-'), 
                    escapeCSV(l.createdBy || '-')
                ]);
                
                const csvContent = header.join(",") + "\n" + rows.map(e => e.join(",")).join("\n");
                
                // 4. Menggunakan Blob & BOM (\ufeff) agar Excel membaca karakter khusus dengan sempurna (UTF-8 format)
                const blob = new Blob(["\ufeff", csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", `Laporan_Surat_BK_${new Date().toISOString().slice(0,10)}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link); // Bersihkan sisa link setelah download
                
                // Alert kecil sebagai pemanis
                Swal.fire({
                    icon: 'success',
                    title: 'Berhasil Diunduh!',
                    text: `Laporan sebanyak ${filteredLetters.length} surat telah diekspor.`,
                    timer: 2000,
                    showConfirmButton: false
                });
            };

            // Filtering
            // Filtering Lanjutan
            const filteredLetters = letters
                .filter(l => {
                    if (viewState === 'history' && historyStudent) {
                        return l.namaSiswa.toLowerCase() === historyStudent.toLowerCase();
                    }
                    
                    // 1. Filter Menu Samping (Active Tab)
                    if (activeTab !== 'dashboard' && l.type !== activeTab) return false;

                    // 2. Filter Pencarian Teks
                    const search = searchTerm.toLowerCase();
                    const matchesSearch = (l.namaSiswa && l.namaSiswa.toLowerCase().includes(search)) || 
                                          (l.nomorSurat && l.nomorSurat.toLowerCase().includes(search));
                    if (!matchesSearch) return false;

                    // 3. Filter Jenis Surat
                    if (filterType !== 'Semua' && l.type !== filterType) return false;

                    // 4. Filter Nama Guru (Pembuat)
                    if (filterCreator !== 'Semua' && l.createdBy !== filterCreator) return false;

                    // 5. Filter Rentang Tanggal
                    const letterDate = new Date(l.tanggal);
                    if (filterStartDate && letterDate < new Date(filterStartDate)) return false;
                    if (filterEndDate && letterDate > new Date(filterEndDate)) return false;

                    return true; // Jika lolos semua filter, tampilkan!
                })
                .sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));

            const indexOfLastItem = currentPage * itemsPerPage;
            const indexOfFirstItem = indexOfLastItem - itemsPerPage;
            const currentLetters = itemsPerPage === 'semua' ? filteredLetters : filteredLetters.slice(indexOfFirstItem, indexOfLastItem);
            const totalPages = itemsPerPage === 'semua' ? 1 : Math.ceil(filteredLetters.length / itemsPerPage);
            const headerDate = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            // Dashboard Stats Logic
            const getDashboardStats = () => {
                const types = [
                    { key: 'SKORSING', label: 'Skorsing', icon: <FileWarning/>, color: 'text-red-600', bg: 'bg-red-50', border: 'border-red-200' },
                    { key: 'PERNYATAAN', label: 'Pernyataan', icon: <FileSignature/>, color: 'text-orange-600', bg: 'bg-orange-50', border: 'border-orange-200' },
                    { key: 'UNDANGAN', label: 'Undangan', icon: <Mail/>, color: 'text-blue-600', bg: 'bg-blue-50', border: 'border-blue-200' },
                    { key: 'KONTRAK', label: 'Kontrak Perilaku', icon: <FileCheck/>, color: 'text-emerald-600', bg: 'bg-emerald-50', border: 'border-emerald-200' },
                    { key: 'TUGAS_HOMEVISIT', label: 'Tugas H.Visit', icon: <Briefcase/>, color: 'text-indigo-600', bg: 'bg-indigo-50', border: 'border-indigo-200' },
                    { key: 'LAPORAN_HOMEVISIT', label: 'Laporan H.Visit', icon: <ClipboardList/>, color: 'text-cyan-600', bg: 'bg-cyan-50', border: 'border-cyan-200' },
					{ key: 'MEDIASI', label: 'Mediasi', icon: <Users/>, color: 'text-pink-600', bg: 'bg-pink-50', border: 'border-pink-200' },
					{ key: 'ADVOKASI', label: 'Advokasi', icon: <MessageCircle/>, color: 'text-rose-600', bg: 'bg-rose-50', border: 'border-rose-200' },
					{ key: 'BIMBINGAN_KELOMPOK', label: 'Bimpok', icon: <Users/>, color: 'text-emerald-600', bg: 'bg-emerald-50', border: 'border-emerald-200' },
                    { key: 'ALIH_KASUS', label: 'Alih Kasus', icon: <Share/>, color: 'text-purple-600', bg: 'bg-purple-50', border: 'border-purple-200' },
					{ key: 'KONFERENSI_KASUS', label: 'Konf. Kasus', icon: <Users/>, color: 'text-indigo-600', bg: 'bg-indigo-50', border: 'border-indigo-200' },
                    { key: 'SKBB', label: 'Ket. Baik', icon: <ShieldCheck/>, color: 'text-teal-600', bg: 'bg-teal-50', border: 'border-teal-200' },
					{ key: 'BERHENTI', label: 'Berhenti/Keluar', icon: <UserMinus/>, color: 'text-gray-600', bg: 'bg-gray-50', border: 'border-gray-200' },
                ];
                return types.map(t => ({
                    ...t,
                    count: letters.filter(l => l.type === t.key).length
                }));
            };

            if (!currentUser) {
                return <LoginView onLogin={setCurrentUser} />;
            }

            return (
                <div className="min-h-screen bg-gray-50 flex font-sans text-gray-800">
                    {loadingState.isLoading && <LoadingOverlay message={loadingState.message} />}
                    
                    <aside className={`bg-slate-900 text-white flex-col no-print sticky top-0 h-screen transition-all duration-300 hidden md:flex ${isSidebarOpen ? 'w-64' : 'w-0 overflow-hidden'}`}>
                        <SidebarContent activeTab={activeTab} setActiveTab={setActiveTab} setViewState={setViewState} currentUser={currentUser} onLogout={() => setCurrentUser(null)} />
                    </aside>

                    {isMobileMenuOpen && (
                        <div className="fixed inset-0 bg-black/50 z-40 md:hidden no-print" onClick={() => setIsMobileMenuOpen(false)}>
                            <div className="bg-slate-900 text-white w-64 h-full p-4" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-6"><h1 className="font-bold text-lg">Menu</h1><button onClick={() => setIsMobileMenuOpen(false)}><X size={24}/></button></div>
                                <SidebarContent activeTab={activeTab} setActiveTab={(tab) => { setActiveTab(tab); setIsMobileMenuOpen(false); }} setViewState={(view) => { setViewState(view); setIsMobileMenuOpen(false); }} currentUser={currentUser} onLogout={() => setCurrentUser(null)} />
                            </div>
                        </div>
                    )}

                    <main className="flex-1 overflow-hidden flex flex-col h-screen">
                        <header className="bg-white shadow-sm p-4 flex justify-between items-center no-print flex-shrink-0 z-30 border-b border-gray-200">
                            <div className="flex items-center gap-3">
                                <button className="md:hidden text-gray-600 p-1 hover:bg-gray-100 rounded" onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)}><Menu size={24} /></button>
                                <button className="hidden md:block text-gray-600 p-1 hover:bg-gray-100 rounded" onClick={() => setIsSidebarOpen(!isSidebarOpen)} title="Toggle Sidebar"><SidebarOpen size={24} /></button>
                                <div className="flex flex-col"><div className="font-bold text-lg md:text-xl text-slate-800 flex items-center gap-2"><span className="md:hidden">Aplikasi Kelola Surat BK</span><span className="hidden md:inline">Aplikasi Kelola Surat BK</span> {APPS_SCRIPT_URL === "PASTE_URL_APPS_SCRIPT_DISINI" && <span className="text-xs bg-red-100 text-red-600 px-2 py-1 rounded">⚠️ URL Belum Diseting</span>}</div></div>
                            </div>
                            <div className="flex items-center gap-3 text-right">
                                <div className="hidden sm:block"><p className="text-sm font-semibold text-gray-700">{headerDate}</p><p className="text-xs font-bold text-green-600 flex justify-end items-center gap-1"><Cloud size={12}/>Mappaguru Online</p></div>
                                <div className="flex items-center gap-2 bg-blue-50 px-3 py-1 rounded-full border border-blue-100">
                                    <div className="w-6 h-6 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold text-xs">{currentUser.username.charAt(0)}</div>
                                    <span className="text-sm font-medium text-blue-900">{currentUser.username}</span>
                                </div>
                            </div>
                        </header>

                        {/* MAIN CONTENT AREA - SCROLLABLE INTERNAL */}
                        <div className="flex-1 overflow-y-auto p-4 md:p-6 no-print scroll-smooth">
                            {viewState === 'list' && (
                                <div className="space-y-6 pb-10 max-w-7xl mx-auto">
                                    {activeTab === 'dashboard' && (
                                        <div className="space-y-6">
                                            {/* NEW DASHBOARD GRID */}
                                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                                <div className="col-span-2 md:col-span-4 bg-gradient-to-r from-slate-800 to-slate-700 text-white p-6 rounded-xl shadow-lg flex justify-between items-center">
                                                    <div>
                                                        <h2 className="text-2xl font-bold">{letters.length}</h2>
                                                        <p className="text-slate-300">Total Surat Dikeluarkan</p>
                                                    </div>
                                                    <div className="bg-white/10 p-3 rounded-lg"><BarChart2 size={32}/></div>
                                                </div>
                                                {getDashboardStats().map((stat) => (
                                                    <div key={stat.key} className={`bg-white p-4 rounded-xl shadow-sm border ${stat.border} hover:shadow-md transition-all flex items-center justify-between`}>
                                                        <div>
                                                            <p className="text-xs text-gray-500 uppercase font-semibold">{stat.label}</p>
                                                            <h3 className={`text-xl font-bold ${stat.color}`}>{stat.count}</h3>
                                                        </div>
                                                        <div className={`p-2 rounded-lg ${stat.bg} ${stat.color}`}>
                                                            {React.cloneElement(stat.icon, { size: 20 })}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                            
                                            <div className="flex justify-end">
                                                <button onClick={handleExportExcel} className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg shadow-sm flex items-center gap-2 text-sm font-medium transition-colors"><Download size={16}/> Download Laporan Excel</button>
                                            </div>
                                        </div>
                                    )}

                                    <div className="flex flex-col md:flex-row justify-between items-center gap-4 sticky top-0 z-10 py-2 backdrop-blur-sm">
                                        <div className="relative w-full md:w-auto shadow-sm">
                                            <Search className="absolute left-3 top-2.5 text-gray-400" size={20} />
                                            <input type="text" placeholder="Cari siswa / nomor..." className="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 w-full md:w-72" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
                                        </div>
                                        <div className="flex gap-2 w-full md:w-auto">
                                            <button onClick={fetchData} className="bg-white border border-gray-300 hover:bg-gray-50 text-gray-600 px-4 py-2 rounded-lg flex items-center justify-center gap-2 shadow-sm transition-colors"><RotateCcw size={20} /></button>
                                            <button onClick={() => {setSelectedLetter(null); setViewState('create');}} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center justify-center gap-2 shadow-sm transition-colors flex-1 md:flex-none font-medium"><Plus size={20} /> <span className="hidden sm:inline">Buat</span> Surat Baru</button>
                                        </div>
                                    </div>
									{/* PANEL FILTER LANJUTAN */}
                                    <div className="bg-white p-3 rounded-lg shadow-sm border border-gray-200 flex flex-wrap gap-3 items-end mb-4 animate-fade-in-up">
                                        <div className="flex-1 min-w-[140px]">
                                            <label className="block text-[10px] font-bold text-gray-500 uppercase mb-1">Jenis Surat</label>
                                            <select value={filterType} onChange={(e) => setFilterType(e.target.value)} className="w-full p-2 text-sm border border-gray-300 rounded-md focus:ring-blue-500 outline-none cursor-pointer">
                                                {letterTypesList.map(t => <option key={t} value={t}>{t === 'Semua' ? 'Semua Jenis' : t.replace('_', ' ')}</option>)}
                                            </select>
                                        </div>
                                        <div className="flex-1 min-w-[140px]">
                                            <label className="block text-[10px] font-bold text-gray-500 uppercase mb-1">Guru Pembuat</label>
                                            <select value={filterCreator} onChange={(e) => setFilterCreator(e.target.value)} className="w-full p-2 text-sm border border-gray-300 rounded-md focus:ring-blue-500 outline-none cursor-pointer">
                                                {uniqueCreators.map(c => <option key={c} value={c}>{c}</option>)}
                                            </select>
                                        </div>
                                        <div className="flex-1 min-w-[130px]">
                                            <label className="block text-[10px] font-bold text-gray-500 uppercase mb-1">Dari Tanggal</label>
                                            <input type="date" value={filterStartDate} onChange={(e) => setFilterStartDate(e.target.value)} className="w-full p-1.5 text-sm border border-gray-300 rounded-md focus:ring-blue-500 outline-none" />
                                        </div>
                                        <div className="flex-1 min-w-[130px]">
                                            <label className="block text-[10px] font-bold text-gray-500 uppercase mb-1">Sampai Tanggal</label>
                                            <input type="date" value={filterEndDate} onChange={(e) => setFilterEndDate(e.target.value)} className="w-full p-1.5 text-sm border border-gray-300 rounded-md focus:ring-blue-500 outline-none" />
                                        </div>
                                        <div>
                                            <button onClick={() => { setFilterType('Semua'); setFilterCreator('Semua'); setFilterStartDate(''); setFilterEndDate(''); setSearchTerm(''); }} className="p-2 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-md text-sm font-medium border border-gray-300 h-[38px] transition-colors" title="Reset Semua Filter">
                                                Reset
                                            </button>
                                        </div>
                                    </div>

                                    {/* SCROLLABLE TABLE CONTAINER */}
                                    <div className="bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col max-h-[calc(100vh-250px)]">
                                        <div className="p-4 border-b border-gray-200 flex items-center justify-between bg-gray-50 shrink-0 rounded-t-xl">
                                            <div className="flex items-center gap-2 text-sm text-gray-600"><span>Show</span><select value={itemsPerPage} onChange={(e) => setItemsPerPage(e.target.value === 'semua' ? 'semua' : Number(e.target.value))} className="border border-gray-300 rounded px-2 py-1"><option value={5}>5</option><option value={10}>10</option><option value={20}>20</option><option value={50}>50</option><option value="semua">Semua</option></select></div>
                                            <div className="text-sm text-gray-500">Total: {filteredLetters.length}</div>
                                        </div>
                                        <div className="overflow-auto flex-1 custom-scrollbar">
                                            <table className="w-full text-left min-w-[700px]">
                                                <thead className="bg-gray-50 text-gray-600 font-semibold border-b sticky top-0 z-10 shadow-sm">
                                                    <tr>
                                                        <th className="p-4 w-32">Jenis</th>
                                                        <th className="p-4">Nomor & Pembuat</th>
                                                        <th className="p-4">Siswa</th>
                                                        <th className="p-4 w-32">Tanggal</th>
                                                        <th className="p-4 text-center w-48">Aksi</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-gray-100">
                                                    {currentLetters.length > 0 ? (
                                                        currentLetters.map((letter) => (
                                                            <tr key={letter.id} className="hover:bg-blue-50/50 transition-colors">
                                                                <td className="p-4 align-top"><span className="px-2 py-1 rounded text-[10px] sm:text-xs font-bold whitespace-nowrap bg-slate-100 text-slate-700 border border-slate-200 block w-fit">{letter.type.replace('_', ' ')}</span></td>
                                                                <td className="p-4 align-top">
                                                                    <div className="font-mono text-sm text-gray-800 font-medium">{letter.nomorSurat || '-'}</div>
                                                                    <div className="text-xs text-gray-500 flex items-center gap-1 mt-1"><User size={10}/> {letter.createdBy || '-'}</div>
                                                                </td>
                                                                <td className="p-4 align-top">
                                                                    <div className="font-medium text-sm text-gray-900">{letter.namaSiswa}</div>
                                                                    <div className="text-gray-500 text-xs mt-0.5">{letter.kelas}</div>
                                                                </td>
                                                                <td className="p-4 align-top text-gray-600 text-sm whitespace-nowrap">{formatDate(letter.tanggal)}</td>
                                                                <td className="p-4 align-top"><div className="flex justify-center gap-2">
                                                                    <button onClick={() => {setSelectedLetter(letter); setViewState('detail');}} className="p-1.5 hover:bg-blue-100 text-blue-600 rounded-lg transition-colors" title="Lihat"><Eye size={18} /></button>
                                                                    <button onClick={() => {setSelectedLetter(letter); setViewState('edit');}} className="p-1.5 hover:bg-orange-100 text-orange-600 rounded-lg transition-colors" title="Edit"><Edit size={18} /></button>
                                                                    <button onClick={() => handleSendWA(letter)} className="p-1.5 hover:bg-green-100 text-green-600 rounded-lg transition-colors" title="Kirim WA"><MessageCircle size={18} /></button>
                                                                    <button onClick={() => {setHistoryStudent(letter.namaSiswa); setViewState('history');}} className="p-1.5 hover:bg-purple-100 text-purple-600 rounded-lg transition-colors" title="Track Record"><History size={18} /></button>
                                                                    <button onClick={() => handleDelete(letter.id)} className="p-1.5 hover:bg-red-100 text-red-600 rounded-lg transition-colors" title="Hapus"><Trash2 size={18} /></button>
                                                                </div></td>
                                                            </tr>
                                                        ))
                                                    ) : (<tr><td colSpan="5" className="p-12 text-center text-gray-400">Tidak ada data ditemukan.<br/><span className="text-sm">Klik tombol refresh jika data tidak muncul.</span></td></tr>)}
                                                </tbody>
                                            </table>
                                        </div>
                                        {itemsPerPage !== 'semua' && totalPages > 1 && (
                                            <div className="p-4 border-t border-gray-200 flex items-center justify-between bg-gray-50 shrink-0 rounded-b-xl">
                                                <div className="text-sm text-gray-500">Hal {currentPage} dari {totalPages}</div>
                                                <div className="flex gap-2"><button onClick={() => setCurrentPage(p => Math.max(p - 1, 1))} disabled={currentPage === 1} className="p-2 border rounded bg-white hover:bg-gray-100 disabled:opacity-50 disabled:hover:bg-white"><ChevronLeft size={16} /></button><button onClick={() => setCurrentPage(p => Math.min(p + 1, totalPages))} disabled={currentPage === totalPages} className="p-2 border rounded bg-white hover:bg-gray-100 disabled:opacity-50 disabled:hover:bg-white"><ChevronRight size={16} /></button></div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                            
                            {/* TRACK RECORD VIEW */}
                            {viewState === 'history' && (
                                <div className="space-y-4 max-w-7xl mx-auto">
                                     <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-200 flex justify-between items-center sticky top-0 z-10">
                                        <h2 className="text-lg font-bold flex items-center gap-2"><History className="text-purple-600"/> Track Record: <span className="text-gray-800">{historyStudent}</span></h2>
                                        <button onClick={() => {setHistoryStudent(null); setViewState('list');}} className="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition-colors">Kembali</button>
                                     </div>
                                     <div className="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-200">
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-left min-w-[600px]">
                                                <thead className="bg-gray-50 text-gray-600 font-semibold border-b"><tr><th className="p-4">Jenis</th><th className="p-4">Nomor</th><th className="p-4">Tanggal</th><th className="p-4">Keterangan</th><th className="p-4">Pembuat</th></tr></thead>
                                                <tbody className="divide-y divide-gray-100">
                                                    {filteredLetters.map((letter) => (
                                                        <tr key={letter.id} className="hover:bg-gray-50">
                                                            <td className="p-4"><span className="px-2 py-1 rounded text-[10px] font-bold bg-slate-100 text-slate-700 border border-slate-200">{letter.type.replace('_', ' ')}</span></td>
                                                            <td className="p-4 text-sm font-mono">{letter.nomorSurat}</td>
                                                            <td className="p-4 text-sm">{formatDate(letter.tanggal)}</td>
                                                            <td className="p-4 text-sm italic text-gray-500">{letter.alasan || letter.permasalahan || letter.perihal || letter.keperluan || letter.gambaranMasalah || '-'}</td>
                                                            <td className="p-4 text-xs text-gray-500">{letter.createdBy || '-'}</td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                     </div>
                                </div>
                            )}
                            
                            {viewState === 'school_settings' && (
                                <SettingsView 
                                    schoolData={schoolData} 
                                    onSaveSchoolData={handleSaveSchoolData} 
                                    onCancel={() => setViewState('list')} 
                                />
                            )}
                            {(viewState === 'create' || viewState === 'edit') && (
                                <LetterForm 
                                    initialData={selectedLetter} 
                                    onSave={handleSaveLetter} 
                                    onCancel={() => {setViewState('list'); setSelectedLetter(null);}} 
                                    currentUser={currentUser}
                                    students={students}
                                    classes={classes}
                                    officials={officials}
                                />
                            )}
                            
                            {viewState === 'detail' && selectedLetter && (
                                <div className="flex flex-col h-full bg-gray-100">
                                    <div className="mb-4 flex justify-between items-center bg-white p-4 shadow-sm border-b border-gray-200 sticky top-0 z-20">
                                        <button onClick={() => {setViewState('list'); setSelectedLetter(null);}} className="flex items-center gap-2 text-gray-600 hover:text-gray-900 bg-gray-50 hover:bg-gray-100 px-4 py-2 rounded-lg transition-colors"><ArrowLeft size={20} /> Kembali</button>
                                        <div className="flex gap-2">
                                            <div className="hidden md:flex items-center gap-2 text-xs text-gray-500 bg-gray-50 px-3 py-2 rounded-lg border border-gray-200">
                                                <span>Dibuat: <strong>{selectedLetter.createdBy || '?'}</strong></span>
                                                {selectedLetter.lastEditedBy && <span>| Edit: <strong>{selectedLetter.lastEditedBy}</strong></span>}
                                            </div>
                                            <button onClick={() => window.print()} className="bg-slate-800 hover:bg-slate-900 text-white px-4 py-2 rounded-lg flex items-center gap-2 shadow-sm transition-colors"><Printer size={20} /> Cetak PDF</button>
                                        </div>
                                    </div>
                                    <div className="flex-1 overflow-auto p-4 flex justify-center bg-gray-100">
                                        <LetterContent data={selectedLetter} schoolData={schoolData} isPreview={true} />
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>

                    {/* HIDDEN PRINT AREA */}
                    {viewState === 'detail' && selectedLetter && (<div className="print-area hidden"><LetterContent data={selectedLetter} schoolData={schoolData} isPreview={false} /></div>)}
                </div>
            );
        }

        // --- COMPONENTS ---
        function SidebarContent({ activeTab, setActiveTab, setViewState, currentUser, onLogout }) {
            return (
                <div className="flex flex-col h-full">
                    <div className="p-6 border-b border-slate-700 bg-slate-900"><div className="flex items-center gap-3"><Cloud className="text-blue-400" size={28} /><h1 className="text-xl font-bold whitespace-nowrap tracking-tight">AKSARA-BK16</h1></div><p className="text-xs text-slate-400 mt-2 whitespace-nowrap">"Administrasi BK"</p></div>
                    <nav className="flex-1 p-4 space-y-1.5 overflow-y-auto custom-scrollbar">
                        <SidebarItem icon={<LayoutDashboard size={20}/>} label="Dashboard" active={activeTab === 'dashboard'} onClick={() => {setActiveTab('dashboard'); setViewState('list');}} />
                        
                        <div className="pt-6 pb-2 px-3 text-[10px] font-bold text-slate-500 uppercase tracking-wider">Surat Pelanggaran</div>
                        <SidebarItem icon={<FileWarning size={20}/>} label="Surat Skorsing" active={activeTab === 'SKORSING'} onClick={() => {setActiveTab('SKORSING'); setViewState('list');}} />
                        <SidebarItem icon={<FileSignature size={20}/>} label="Surat Pernyataan" active={activeTab === 'PERNYATAAN'} onClick={() => {setActiveTab('PERNYATAAN'); setViewState('list');}} />
                        <SidebarItem icon={<FileCheck size={20}/>} label="Kontrak Perilaku" active={activeTab === 'KONTRAK'} onClick={() => {setActiveTab('KONTRAK'); setViewState('list');}} />
                        
                        <div className="pt-6 pb-2 px-3 text-[10px] font-bold text-slate-500 uppercase tracking-wider">Administrasi & Layanan</div>
                        <SidebarItem icon={<Mail size={20}/>} label="Undangan Orang Tua" active={activeTab === 'UNDANGAN'} onClick={() => {setActiveTab('UNDANGAN'); setViewState('list');}} />
                        <SidebarItem icon={<Briefcase size={20}/>} label="Surat Tugas Home Visit" active={activeTab === 'TUGAS_HOMEVISIT'} onClick={() => {setActiveTab('TUGAS_HOMEVISIT'); setViewState('list');}} />
                        <SidebarItem icon={<ClipboardList size={20}/>} label="Laporan Home Visit" active={activeTab === 'LAPORAN_HOMEVISIT'} onClick={() => {setActiveTab('LAPORAN_HOMEVISIT'); setViewState('list');}} />
                        <SidebarItem icon={<Share size={20}/>} label="Alih Tangan Kasus" active={activeTab === 'ALIH_KASUS'} onClick={() => {setActiveTab('ALIH_KASUS'); setViewState('list');}} />
						<SidebarItem icon={<Users size={20}/>} label="Konferensi Kasus" active={activeTab === 'KONFERENSI_KASUS'} onClick={() => {setActiveTab('KONFERENSI_KASUS'); setViewState('list');}} />
						<SidebarItem icon={<Users size={20}/>} label="Berita Acara Mediasi" active={activeTab === 'MEDIASI'} onClick={() => {setActiveTab('MEDIASI'); setViewState('list');}} />
						<SidebarItem icon={<MessageCircle size={20}/>} label="Berita Acara Advokasi" active={activeTab === 'ADVOKASI'} onClick={() => {setActiveTab('ADVOKASI'); setViewState('list');}} />
						<SidebarItem icon={<Users size={20}/>} label="Bimbingan Kelompok" active={activeTab === 'BIMBINGAN_KELOMPOK'} onClick={() => {setActiveTab('BIMBINGAN_KELOMPOK'); setViewState('list');}} />
                        <SidebarItem icon={<ShieldCheck size={20}/>} label="Ket. Berkelakuan Baik" active={activeTab === 'SKBB'} onClick={() => {setActiveTab('SKBB'); setViewState('list');}} />
						<SidebarItem icon={<UserMinus size={20}/>} label="Berhenti / Keluar" active={activeTab === 'BERHENTI'} onClick={() => {setActiveTab('BERHENTI'); setViewState('list');}} />

                        <div className="pt-6 pb-2 px-3 text-[10px] font-bold text-slate-500 uppercase tracking-wider">Pengaturan</div>
                        <SidebarItem icon={<Building2 size={20}/>} label="Identitas Sekolah" active={activeTab === 'SCHOOL_DATA'} onClick={() => {setActiveTab('SCHOOL_DATA'); setViewState('school_settings');}} />
                    </nav>
                    <div className="p-4 border-t border-slate-700 bg-slate-900">
                        <button onClick={() => {
                            Swal.fire({
                                title: 'Keluar Aplikasi?',
                                text: "Anda harus login kembali nanti.",
                                icon: 'question',
                                showCancelButton: true,
                                confirmButtonColor: '#3085d6',
                                cancelButtonColor: '#d33',
                                confirmButtonText: 'Ya, Keluar',
                                cancelButtonText: 'Batal'
                            }).then((result) => {
                                if (result.isConfirmed) onLogout();
                            });
                        }} className="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-red-400 hover:bg-slate-800 hover:text-red-300 transition-colors">
                            <LogOut size={20}/> <span className="font-medium text-sm">Keluar</span>
                        </button>
                    </div>
                </div>
            );
        }

        function SidebarItem({ icon, label, active, onClick }) {
            return (<button onClick={onClick} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all ${active ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/20' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}`}><span className="shrink-0">{icon}</span><span className="font-medium text-sm whitespace-nowrap">{label}</span></button>);
        }

        // SETTINGS (UPDATED WITH USER MANAGEMENT)
        function SettingsView({ schoolData, onSaveSchoolData, onCancel }) {
            const [formData, setFormData] = useState(schoolData);
            const [newUser, setNewUser] = useState({ username: '', password: '' });
            const [showNewUserPass, setShowNewUserPass] = useState(false);

            const handleChange = (e) => setFormData({ ...formData, [e.target.name]: e.target.value });
            
            const handleAddUser = () => {
                if(!newUser.username || !newUser.password) return Swal.fire('Oops!', 'Username dan Password wajib diisi', 'warning');
                const currentUsers = formData.users || [];
                const updatedUsers = [...currentUsers, newUser];
                setFormData({ ...formData, users: updatedUsers });
                setNewUser({ username: '', password: '' });
            };
            
            const handleDeleteUser = (idx) => {
			Swal.fire({
				title: 'Hapus User?',
				text: "User ini akan dihapus dari daftar.",
				icon: 'warning',
				showCancelButton: true,
				confirmButtonColor: '#d33',
				cancelButtonColor: '#3085d6',
				confirmButtonText: 'Ya, Hapus'
			}).then((result) => {
				if (result.isConfirmed) {
					const updatedUsers = formData.users.filter((_, i) => i !== idx);
					setFormData({ ...formData, users: updatedUsers });
				}
			});
		};

            return (
                <div className="max-w-4xl mx-auto bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden mb-10">
                    <div className="bg-gray-50 px-4 md:px-6 py-4 border-b border-gray-200 flex justify-between items-center sticky top-0 z-10">
                        <h2 className="text-lg font-bold text-gray-800">Pengaturan & Manajemen User</h2>
                        <button onClick={onCancel}><X size={24} className="text-gray-400 hover:text-gray-600"/></button>
                    </div>
                    <div className="p-6 overflow-y-auto max-h-[80vh]">
                        <form onSubmit={(e) => { e.preventDefault(); onSaveSchoolData(formData); }} className="space-y-8">
                            
                            {/* USER MANAGEMENT SECTION */}
                            <div className="bg-yellow-50 p-4 rounded-lg border border-yellow-100">
                                <h3 className="text-sm font-bold text-yellow-800 uppercase mb-3 flex items-center gap-2"><User size={16}/> Manajemen Guru BK (Login)</h3>
                                <div className="space-y-4">
                                    <div className="flex gap-2 items-end">
                                        <div className="flex-1">
                                            <label className="block text-xs font-medium text-gray-600">Username Baru</label>
                                            <input type="text" value={newUser.username} onChange={e=>setNewUser({...newUser, username: e.target.value})} className="w-full p-2 text-sm border rounded" placeholder="Contoh: Pak Budi"/>
                                        </div>
                                        <div className="flex-1 relative">
                                            <label className="block text-xs font-medium text-gray-600">Password</label>
                                            <input type={showNewUserPass ? "text" : "password"} value={newUser.password} onChange={e=>setNewUser({...newUser, password: e.target.value})} className="w-full p-2 text-sm border rounded pr-8" placeholder="****"/>
                                             <button type="button" onClick={() => setShowNewUserPass(!showNewUserPass)} className="absolute right-2 top-6 text-gray-400">
                                                {showNewUserPass ? <EyeOff size={14}/> : <Eye size={14}/>}
                                            </button>
                                        </div>
                                        <button type="button" onClick={handleAddUser} className="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded text-sm font-bold">Tambah</button>
                                    </div>
                                    <div className="border-t pt-2">
                                        <p className="text-xs text-gray-500 mb-2">Daftar Guru Terdaftar:</p>
                                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                            {formData.users && formData.users.map((u, idx) => (
                                                <div key={idx} className="flex justify-between items-center bg-white p-2 rounded border shadow-sm">
                                                    <span className="font-semibold text-sm">{u.username}</span>
                                                    <button type="button" onClick={() => handleDeleteUser(idx)} className="text-red-500 hover:text-red-700"><Trash2 size={14}/></button>
                                                </div>
                                            ))}
                                            {(!formData.users || formData.users.length === 0) && <p className="text-xs text-red-500 italic">Belum ada user. Login pakai admin/admin123</p>}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div className="space-y-4 border-t pt-4">
                                <h3 className="text-sm font-bold text-blue-800 uppercase border-b pb-2">Identitas Sekolah</h3>
                                <div><label className="block text-sm font-medium text-gray-700">Pemerintah Daerah</label><input type="text" name="pemerintah" value={formData.pemerintah} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" required /></div>
                                <div><label className="block text-sm font-medium text-gray-700">Instansi</label><input type="text" name="instansi" value={formData.instansi} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" required /></div>
                                <div><label className="block text-sm font-medium text-gray-700">Nama Sekolah</label><input type="text" name="namaSekolah" value={formData.namaSekolah} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" required /></div>
                                <div><label className="block text-sm font-medium text-gray-700">Alamat Lengkap</label><textarea name="alamat" value={formData.alamat} onChange={handleChange} rows="3" className="w-full p-2 border border-gray-300 rounded-md" required></textarea></div>
                            </div>
                            <div className="space-y-4">
                                <h3 className="text-sm font-bold text-blue-800 uppercase border-b pb-2">Logo (Link Gambar)</h3>
                                <div className="grid grid-cols-2 gap-6">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">URL Logo Kiri</label>
                                        <input type="text" name="logoKiri" value={formData.logoKiri || ''} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md text-xs" placeholder="https://..." />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">URL Logo Kanan</label>
                                        <input type="text" name="logoKanan" value={formData.logoKanan || ''} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md text-xs" placeholder="https://..." />
                                    </div>
                                </div>
                            </div>
                            <div className="flex justify-end pt-4"><button type="submit" className="px-6 py-2 bg-blue-600 text-white rounded-lg text-sm flex items-center gap-2"><Save size={16}/> Simpan Semua ke Cloud</button></div>
                        </form>
                    </div>
                </div>
            );
        }

        // LETTER FORM (UPDATED WITH SMART FEATURES)
        function LetterForm({ initialData, onSave, onCancel, currentUser, students, classes, officials }) {
            const defaults = { 
                type: 'SKORSING', 
                nomorSurat: '', 
                tanggal: new Date().toISOString().split('T')[0], 
                tempat: 'Makassar', 
                namaSiswa: '', nisn: '', jenisKelamin: 'Laki-laki', kelas: '', 
                alasan: '', lamaSkorsing: '', tanggalMulai: '', tanggalSelesai: '', 
                namaOrangTua: '', alamatOrangTua: '', noHpOrangTua: '', 
                permasalahan: '', isiPernyataan: '', 
                hariTanggalAcara: '', waktuAcara: '', tempatAcara: '', keperluan: '', lampiran: '-', perihal: 'Undangan Orang Tua/Wali', 
                namaWaliKelas: '', nipWaliKelas: '', 
                tanggalKontrak: new Date().toISOString().split('T')[0], tanggalTinjauan: '', deskripsiPerilaku: '', tujuanPerubahan: '', rencanaTindakan: '', konsekuensi: '', statusKontrak: 'Aktif', 
                // NEW FIELDS for V2
                namaPetugas: '', nipPetugas: '', 
                pihakDitemui: '', statusPihakDitemui: 'Orang Tua', 
                gambaranMasalah: '', hasilPembicaraan: '', tindakLanjut: '', 
                pihakTujuan: '', rincianMasalah: '', riwayatPenanganan: '', 
				// NEW FIELDS FOR V3 (MEDIASI & BERHENTI)
                namaSiswa2: '', kelas2: '', nisn2: '', jenisKelamin2: 'Laki-laki', namaOrangTua2: '',
                namaWaliKelas2: '', nipWaliKelas2: '',
                hasilMediasi: '', kesepakatan: '',
                namaSaksi: '', nipSaksi: '', statusSaksi: 'Wali Kelas', // Saksi BK or General
                alasanBerhenti: '',
				hasilKonferensi: '', tempatAcara: 'Ruang BK', pesertaKonferensi: [{ nama: '', unsur: 'Wali Kelas' }],
				pihakTerkait: '', statusPihakTerkait: '', latarBelakang: '', tujuanAdvokasi: '', hasilAdvokasi: '',
				topikBimbingan: '', tujuanBimbingan: '', uraianKegiatan: '', hasilBimbingan: '', pesertaBimbingan: [{ nama: '', kelas: '' }],
                // Shared fields
                penandaTangan: 'Drs. Kepala Sekolah', nipPenandaTangan: '', jabatan: 'Kepala Sekolah', 
                createdBy: currentUser.username 
            };
            
            const [formData, setFormData] = useState(initialData || defaults);
            const [showStudentSuggestions, setShowStudentSuggestions] = useState(false);
			const [showStudentSuggestions2, setShowStudentSuggestions2] = useState(false); // For Student 2
			const [activePesertaIndex, setActivePesertaIndex] = useState(null);
            const [filteredStudents, setFilteredStudents] = useState([]);

            const handleChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));

            // --- SMART LOGIC: STUDENT SEARCH 1 ---
            const handleSearchStudent = (e) => {
                const value = e.target.value;
                setFormData(prev => ({ ...prev, namaSiswa: value }));
                
                if (value.length > 2 && students.length > 0) {
                    const filtered = students.filter(s => 
                        s['Nama Lengkap'].toLowerCase().includes(value.toLowerCase()) || 
                        String(s['NISN']).includes(value)
                    );
                    setFilteredStudents(filtered);
                    setShowStudentSuggestions(true);
                } else {
                    setShowStudentSuggestions(false);
                }
            };
			
			// --- SMART LOGIC: STUDENT SEARCH 2 (MEDIASI) ---
             const handleSearchStudent2 = (e) => {
                const value = e.target.value;
                setFormData(prev => ({ ...prev, namaSiswa2: value }));
                
                if (value.length > 2 && students.length > 0) {
                    const filtered = students.filter(s => 
                        s['Nama Lengkap'].toLowerCase().includes(value.toLowerCase()) || 
                        String(s['NISN']).includes(value)
                    );
                    setFilteredStudents(filtered);
                    setShowStudentSuggestions2(true);
                } else {
                    setShowStudentSuggestions2(false);
                }
            };

            const handleSelectStudent = (student, isSecond = false) => {
                // 1. Auto Fill Siswa
                const updates = {};
                const suffix = isSecond ? '2' : '';
                
                updates[`namaSiswa${suffix}`] = student['Nama Lengkap'];
                updates[`nisn${suffix}`] = student['NISN'];
                updates[`kelas${suffix}`] = student['Kelas'];
                updates[`jenisKelamin${suffix}`] = student['Jenis Kelamin'] || 'Laki-laki';

                // 2. Auto Fill Wali Kelas (Cari di DB Kelas)
                if (classes && classes.length > 0) {
                    const kelasInfo = classes.find(c => String(c['Nama Kelas']).toLowerCase() === String(student['Kelas']).toLowerCase());
                    if (kelasInfo) {
                        updates[`namaWaliKelas${suffix}`] = kelasInfo['Nama Wali Kelas'];
                        updates[`nipWaliKelas${suffix}`] = kelasInfo['NIP Wali Kelas'];
                    }
                }

                setFormData(prev => ({ ...prev, ...updates }));
                
                if(isSecond) setShowStudentSuggestions2(false);
                else setShowStudentSuggestions(false);
            };

            // --- SMART LOGIC: PEJABAT ---
            const handleSelectOfficial = (e) => {
                const selectedName = e.target.value;
                if (!selectedName) return;

                const official = officials.find(o => o['Nama Pejabat'] === selectedName);
                if (official) {
                    setFormData(prev => ({
                        ...prev,
                        penandaTangan: official['Nama Pejabat'],
                        nipPenandaTangan: official['NIP'],
                        jabatan: official['Jabatan']
                    }));
                }
            };
			
			const handleAddPeserta = () => setFormData(prev => ({ ...prev, pesertaKonferensi: [...(prev.pesertaKonferensi || []), { nama: '', unsur: '' }] }));
			const handleRemovePeserta = (index) => setFormData(prev => ({ ...prev, pesertaKonferensi: prev.pesertaKonferensi.filter((_, i) => i !== index) }));
			const handleChangePeserta = (index, field, value) => {
				const newPeserta = [...(formData.pesertaKonferensi || [])];
				newPeserta[index][field] = value;
				setFormData(prev => ({ ...prev, pesertaKonferensi: newPeserta }));
			};
			
			const handleAddPesertaBimbingan = () => setFormData(prev => ({ ...prev, pesertaBimbingan: [...(prev.pesertaBimbingan || []), { nama: '', kelas: '' }] }));
            const handleRemovePesertaBimbingan = (index) => setFormData(prev => ({ ...prev, pesertaBimbingan: prev.pesertaBimbingan.filter((_, i) => i !== index) }));
            const handleChangePesertaBimbingan = (index, value) => {
                const newPeserta = [...(formData.pesertaBimbingan || [])];
                newPeserta[index].nama = value;
                setFormData(prev => ({ ...prev, pesertaBimbingan: newPeserta }));
                
                if (value.length > 2) {
                    const filtered = students.filter(s => 
                        s['Nama Lengkap'].toLowerCase().includes(value.toLowerCase())
                    );
                    setFilteredStudents(filtered);
                    setActivePesertaIndex(index); // Menandai baris mana yang sedang mengetik
                } else {
                    setActivePesertaIndex(null);
                }
            };

            const handleSelectPesertaBimbingan = (student, index) => {
                const newPeserta = [...(formData.pesertaBimbingan || [])];
                newPeserta[index].nama = student['Nama Lengkap'];
                newPeserta[index].kelas = student['Kelas'];
                setFormData(prev => ({ ...prev, pesertaBimbingan: newPeserta }));
                setActivePesertaIndex(null); // Tutup dropdown
            };

            return (
                <div className="max-w-4xl mx-auto bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden mb-20 flex flex-col max-h-[90vh]">
                    <datalist id="violationList">
                        <option value="Sering terlambat datang ke sekolah" />
                        <option value="Tidak masuk sekolah tanpa keterangan (Alpa)" />
                        <option value="Merokok di lingkungan sekolah" />
                        <option value="Berkelahi dengan teman sekelas" />
                        <option value="Melompat pagar sekolah" />
                        <option value="Menggunakan atribut tidak lengkap" />
                    </datalist>

                    <div className="bg-gray-50 px-4 md:px-6 py-4 border-b border-gray-200 flex justify-between items-center sticky top-0 z-10">
                        <h2 className="text-lg font-bold text-gray-800">{initialData ? 'Edit Surat' : 'Buat Surat Baru'}</h2>
                        <button onClick={onCancel}><X size={24} className="text-gray-400 hover:text-gray-600" /></button>
                    </div>
                    
                    <div className="overflow-y-auto p-4 md:p-6 flex-1 custom-scrollbar">
                        <form onSubmit={(e) => { e.preventDefault(); onSave(formData); }} className="space-y-6">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div className="space-y-2">
                                    <label className="block text-sm font-medium text-gray-700">Jenis Surat</label>
                                    <select name="type" value={formData.type} onChange={(e) => setFormData({...defaults, type: e.target.value})} disabled={!!initialData} className="w-full p-2 border border-gray-300 rounded-md font-semibold text-blue-900 bg-blue-50">
                                        <optgroup label="Pelanggaran">
                                            <option value="SKORSING">Surat Skorsing</option>
                                            <option value="PERNYATAAN">Surat Pernyataan Orangtua</option>
                                            <option value="KONTRAK">Kontrak Perilaku Siswa</option>
											<option value="MEDIASI">Berita Acara Mediasi (2 Pihak)</option>
                                        </optgroup>
                                        <optgroup label="Administrasi & Layanan">
                                            <option value="UNDANGAN">Surat Undangan Orangtua</option>
                                            <option value="TUGAS_HOMEVISIT">Surat Tugas Home Visit</option>
                                            <option value="LAPORAN_HOMEVISIT">Laporan Hasil Home Visit</option>
                                            <option value="ALIH_KASUS">Alih Tangan Kasus (Referral)</option>
											<option value="KONFERENSI_KASUS">Berita Acara Konferensi Kasus</option>
											<option value="ADVOKASI">Berita Acara Advokasi</option>
											<option value="BIMBINGAN_KELOMPOK">Berita Acara Bimbingan Kelompok</option>
                                            <option value="SKBB">Ket. Berkelakuan Baik</option>
											<option value="BERHENTI">Surat Berhenti / Keluar</option>
                                        </optgroup>
                                    </select>
                                </div>
                                <div className="grid grid-cols-2 gap-4"><div className="space-y-2"><label className="block text-sm font-medium text-gray-700">Tanggal Surat</label><input type="date" name="tanggal" value={formData.tanggal} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" required /></div><div className="space-y-2"><label className="block text-sm font-medium text-gray-700">Tempat Penetapan</label><input type="text" name="tempat" value={formData.tempat} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" required /></div></div>
                            </div>
                            
                            {/* IDENTITAS SISWA - OTOMATIS SEMBUNYI JIKA BIMBINGAN KELOMPOK */}
							{formData.type !== 'BIMBINGAN_KELOMPOK' && (
								<div className="bg-blue-50 p-4 rounded-lg space-y-4 border border-blue-100 relative">
									<h3 className="font-semibold text-blue-800 text-sm uppercase flex items-center gap-2"><User size={16}/> Identitas Siswa</h3>
									<div className="grid grid-cols-1 md:grid-cols-2 gap-4">
										<div className="relative">
											<label className="block text-xs font-medium text-gray-600 mb-1">Nama Siswa (Cari disini...)</label>
											<input 
												type="text" 
												name="namaSiswa" 
												value={formData.namaSiswa} 
												onChange={handleSearchStudent} 
												autoComplete="off"
												className="w-full p-2 border border-blue-200 rounded-md focus:ring-2 focus:ring-blue-200 focus:outline-none font-semibold" 
												required 
												placeholder="Ketik nama siswa..."
											/>
											{/* Suggestions Dropdown */}
											{showStudentSuggestions && (
												<div className="autocomplete-items">
													{filteredStudents.map((s, idx) => (
														<div key={idx} onClick={() => handleSelectStudent(s)}>
															<strong>{s['Nama Lengkap']}</strong> <span className="text-gray-500 text-xs">({s['Kelas']})</span>
														</div>
													))}
													{filteredStudents.length === 0 && <div className="text-gray-400 italic">Siswa tidak ditemukan</div>}
												</div>
											)}
										</div>
										<div><label className="block text-xs font-medium text-gray-600 mb-1">NISN</label><input type="text" name="nisn" value={formData.nisn} onChange={handleChange} className="w-full p-2 border border-blue-200 rounded-md focus:ring-2 focus:ring-blue-200 focus:outline-none" /></div>
										<div><label className="block text-xs font-medium text-gray-600 mb-1">Jenis Kelamin</label><select name="jenisKelamin" value={formData.jenisKelamin} onChange={handleChange} className="w-full p-2 border border-blue-200 rounded-md"><option value="Laki-laki">Laki-laki</option><option value="Perempuan">Perempuan</option></select></div>
										<div><label className="block text-xs font-medium text-gray-600 mb-1">Kelas</label><input type="text" name="kelas" value={formData.kelas} onChange={handleChange} className="w-full p-2 border border-blue-200 rounded-md focus:ring-2 focus:ring-blue-200 focus:outline-none" required /></div>
										{formData.type !== 'SKORSING' && formData.type !== 'KONTRAK' && formData.type !== 'SKBB' && (
											<div className="md:col-span-2"><label className="block text-xs font-medium text-gray-600 mb-1">Alamat Siswa</label><input type="text" name="alamatOrangTua" value={formData.alamatOrangTua} onChange={handleChange} className="w-full p-2 border border-blue-200 rounded-md focus:ring-2 focus:ring-blue-200 focus:outline-none" /></div>
										)}
									</div>
								</div>
							)}
							
							{/* KHUSUS MEDIASI: IDENTITAS SISWA 2 */}
                             {formData.type === 'MEDIASI' && (
                                <div className="bg-pink-50 p-4 rounded-lg space-y-4 border border-pink-100 relative">
                                    <h3 className="font-semibold text-pink-800 text-sm uppercase flex items-center gap-2"><User size={16}/> Identitas Siswa (Pihak 2)</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div className="relative">
                                            <label className="block text-xs font-medium text-gray-600 mb-1">Nama Siswa Pihak 2</label>
                                            <input 
                                                type="text" 
                                                name="namaSiswa2" 
                                                value={formData.namaSiswa2} 
                                                onChange={handleSearchStudent2} 
                                                autoComplete="off"
                                                className="w-full p-2 border border-pink-200 rounded-md focus:ring-2 focus:ring-pink-200 focus:outline-none font-semibold" 
                                                required 
                                            />
                                            {/* Suggestions Dropdown 2 */}
                                            {showStudentSuggestions2 && (
                                                <div className="autocomplete-items">
                                                    {filteredStudents.map((s, idx) => (
                                                        <div key={idx} onClick={() => handleSelectStudent(s, true)}>
                                                            <strong>{s['Nama Lengkap']}</strong> <span className="text-gray-500 text-xs">({s['Kelas']})</span>
                                                        </div>
                                                    ))}
                                                    {filteredStudents.length === 0 && <div className="text-gray-400 italic">Siswa tidak ditemukan</div>}
                                                </div>
                                            )}
                                        </div>
                                        <div><label className="block text-xs font-medium text-gray-600 mb-1">NISN</label><input type="text" name="nisn2" value={formData.nisn2} onChange={handleChange} className="w-full p-2 border border-pink-200 rounded-md" /></div>
                                        <div><label className="block text-xs font-medium text-gray-600 mb-1">Jenis Kelamin</label><select name="jenisKelamin2" value={formData.jenisKelamin2} onChange={handleChange} className="w-full p-2 border border-pink-200 rounded-md"><option value="Laki-laki">Laki-laki</option><option value="Perempuan">Perempuan</option></select></div>
                                        <div><label className="block text-xs font-medium text-gray-600 mb-1">Kelas</label><input type="text" name="kelas2" value={formData.kelas2} onChange={handleChange} className="w-full p-2 border border-pink-200 rounded-md" required /></div>
                                    </div>
                                </div>
                            )}
							

                            {/* IDENTITAS ORANG TUA - CONDITIONAL */}
                            {(formData.type === 'PERNYATAAN' || formData.type === 'UNDANGAN' || formData.type === 'SKORSING' || formData.type === 'LAPORAN_HOMEVISIT' || formData.type === 'MEDIASI' || formData.type === 'BERHENTI' || formData.type === 'KONFERENSI_KASUS' || formData.type === 'ADVOKASI') && (
                                <div className="bg-green-50 p-4 rounded-lg space-y-4 border border-green-100">
                                    <h3 className="font-semibold text-green-800 text-sm uppercase flex items-center gap-2"><User size={16}/> Identitas Orang Tua / Wali {formData.type === 'MEDIASI' ? '(Pihak 1 & 2)' : ''}</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div><label className="block text-xs font-medium text-gray-600 mb-1">Nama Orang Tua {formData.type === 'MEDIASI' ? '(Pihak 1)' : ''}</label><input type="text" name="namaOrangTua" value={formData.namaOrangTua} onChange={handleChange} className="w-full p-2 border border-green-200 rounded-md" required/></div>
                                        {formData.type === 'MEDIASI' && (
                                            <div><label className="block text-xs font-medium text-gray-600 mb-1">Nama Orang Tua (Pihak 2)</label><input type="text" name="namaOrangTua2" value={formData.namaOrangTua2} onChange={handleChange} className="w-full p-2 border border-green-200 rounded-md" required/></div>
                                        )}
                                        {formData.type !== 'MEDIASI' && formData.type !== 'BERHENTI' && (
                                            <div><label className="block text-xs font-medium text-gray-600 mb-1">No. HP (Untuk WA)</label><input type="text" name="noHpOrangTua" value={formData.noHpOrangTua} onChange={handleChange} className="w-full p-2 border border-green-200 rounded-md" placeholder="Contoh: 0812..." /></div>
                                        )}
                                        {formData.type === 'BERHENTI' && (
                                            <div className="md:col-span-2"><label className="block text-xs font-medium text-gray-600 mb-1">Alamat Orang Tua</label><input type="text" name="alamatOrangTua" value={formData.alamatOrangTua} onChange={handleChange} className="w-full p-2 border border-green-200 rounded-md" /></div>
                                        )}
                                    </div>
                                </div>
                            )}

                            {/* FORM KHUSUS SKORSING */}
                            {formData.type === 'SKORSING' && (
                                <div className="space-y-4 border-t pt-4">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div><label className="block text-sm font-medium text-gray-700">Nomor Surat</label><input type="text" name="nomorSurat" value={formData.nomorSurat} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" required /></div>
                                    </div>
                                    <div><label className="block text-sm font-medium text-gray-700">Pelanggaran</label><textarea name="alasan" value={formData.alasan} onChange={handleChange} rows="3" list="violationList" className="w-full p-2 border border-gray-300 rounded-md" required></textarea></div>
                                    <div className="grid grid-cols-3 gap-4">
                                        <div><label className="block text-sm font-medium text-gray-700">Lama</label><input type="text" name="lamaSkorsing" value={formData.lamaSkorsing} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" required /></div>
                                        <div><label className="block text-sm font-medium text-gray-700">Mulai</label><input type="date" name="tanggalMulai" value={formData.tanggalMulai} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" required /></div>
                                        <div><label className="block text-sm font-medium text-gray-700">Selesai</label><input type="date" name="tanggalSelesai" value={formData.tanggalSelesai} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" required /></div>
                                    </div>
                                </div>
                            )}

                            {/* FORM KHUSUS PERNYATAAN */}
                            {formData.type === 'PERNYATAAN' && (
                                <div>
                                    <div className="mb-4"><label className="block text-sm font-medium text-gray-700">Permasalahan / Duduk Perkara</label><textarea name="permasalahan" value={formData.permasalahan} onChange={handleChange} rows="2" list="violationList" className="w-full p-2 border border-gray-300 rounded-md" placeholder="Contoh: Sehubungan dengan pelanggaran tata tertib sekolah..." /></div>
                                    <div><label className="block text-sm font-medium text-gray-700">Isi Pernyataan</label><textarea name="isiPernyataan" value={formData.isiPernyataan} onChange={handleChange} rows="4" className="w-full p-2 border border-gray-300 rounded-md" required /></div>
                                </div>
                            )}

                            {/* FORM KHUSUS UNDANGAN */}
                            {formData.type === 'UNDANGAN' && (
                                <div className="space-y-4 border-t pt-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="block text-sm font-medium text-gray-700">Nomor Surat</label><input type="text" name="nomorSurat" value={formData.nomorSurat} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" required /></div>
                                        <div><label className="block text-sm font-medium text-gray-700">Lampiran</label><input type="text" name="lampiran" value={formData.lampiran} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" /></div>
                                        <div className="col-span-2"><label className="block text-sm font-medium text-gray-700">Perihal</label><input type="text" name="perihal" value={formData.perihal} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" /></div>
                                        <div><label className="block text-sm font-medium text-gray-700">Hari/Tanggal Acara</label><input type="text" name="hariTanggalAcara" value={formData.hariTanggalAcara} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" placeholder="Senin, 10 Januari 2024" required /></div>
                                        <div><label className="block text-sm font-medium text-gray-700">Waktu Acara</label><input type="text" name="waktuAcara" value={formData.waktuAcara} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" placeholder="09.00 WITA - Selesai" required /></div>
                                        <div className="col-span-2"><label className="block text-sm font-medium text-gray-700">Tempat Acara</label><input type="text" name="tempatAcara" value={formData.tempatAcara} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" placeholder="Ruang Guru" required /></div>
                                    </div>
                                    <div><label className="block text-sm font-medium text-gray-700">Keperluan</label><textarea name="keperluan" value={formData.keperluan} onChange={handleChange} rows="2" className="w-full p-2 border border-gray-300 rounded-md" required></textarea></div>
                                    <div className="bg-gray-100 p-4 rounded-md"><h4 className="font-semibold text-xs uppercase mb-2">Data Wali Kelas (Otomatis jika data kelas tersedia)</h4><div className="grid grid-cols-2 gap-4"><div><label className="block text-xs font-medium text-gray-600">Nama Wali Kelas</label><input type="text" name="namaWaliKelas" value={formData.namaWaliKelas} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" /></div><div><label className="block text-xs font-medium text-gray-600">NIP Wali Kelas</label><input type="text" name="nipWaliKelas" value={formData.nipWaliKelas} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" /></div></div></div>
                                </div>
                            )}

                            {/* FORM KHUSUS KONTRAK */}
                            {formData.type === 'KONTRAK' && (
                                <div className="space-y-4 border-t pt-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="block text-sm font-medium text-gray-700">Tanggal Kontrak</label><input type="date" name="tanggalKontrak" value={formData.tanggalKontrak} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" /></div>
                                        <div><label className="block text-sm font-medium text-gray-700">Tanggal Tinjauan</label><input type="date" name="tanggalTinjauan" value={formData.tanggalTinjauan} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" /></div>
                                        <div><label className="block text-sm font-medium text-gray-700">Status Kontrak</label><select name="statusKontrak" value={formData.statusKontrak} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md"><option value="Aktif">Aktif</option><option value="Selesai">Selesai</option><option value="Dibatalkan">Dibatalkan</option></select></div>
                                    </div>
                                    <div><label className="block text-sm font-medium text-gray-700">Deskripsi Perilaku</label><textarea name="deskripsiPerilaku" value={formData.deskripsiPerilaku} onChange={handleChange} rows="2" className="w-full p-2 border border-gray-300 rounded-md" placeholder="Perilaku yang ingin diubah..."></textarea></div>
                                    <div><label className="block text-sm font-medium text-gray-700">Tujuan Perubahan</label><textarea name="tujuanPerubahan" value={formData.tujuanPerubahan} onChange={handleChange} rows="2" className="w-full p-2 border border-gray-300 rounded-md" placeholder="Target perilaku baru..."></textarea></div>
                                    <div><label className="block text-sm font-medium text-gray-700">Rencana Tindakan Siswa</label><textarea name="rencanaTindakan" value={formData.rencanaTindakan} onChange={handleChange} rows="2" className="w-full p-2 border border-gray-300 rounded-md" placeholder="Apa yang akan dilakukan siswa..."></textarea></div>
                                    <div><label className="block text-sm font-medium text-gray-700">Konsekuensi (Positif/Negatif)</label><textarea name="konsekuensi" value={formData.konsekuensi} onChange={handleChange} rows="2" className="w-full p-2 border border-gray-300 rounded-md" placeholder="Hadiah jika berhasil / Sanksi jika gagal..."></textarea></div>
                                </div>
                            )}

                            {/* FORM KHUSUS TUGAS HOME VISIT */}
                            {formData.type === 'TUGAS_HOMEVISIT' && (
                                <div className="space-y-4 border-t pt-4">
                                    <div><label className="block text-sm font-medium text-gray-700">Nomor Surat Tugas</label><input type="text" name="nomorSurat" value={formData.nomorSurat} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" required /></div>
                                    <div className="bg-orange-50 p-4 rounded-md border border-orange-100">
                                        <h4 className="font-semibold text-xs text-orange-800 uppercase mb-2">Guru yang Ditugaskan</h4>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div><label className="block text-xs font-medium text-gray-600">Nama Guru / Petugas</label><input type="text" name="namaPetugas" value={formData.namaPetugas} onChange={handleChange} className="w-full p-2 border border-orange-200 rounded-md" required /></div>
                                            <div><label className="block text-xs font-medium text-gray-600">NIP</label><input type="text" name="nipPetugas" value={formData.nipPetugas} onChange={handleChange} className="w-full p-2 border border-orange-200 rounded-md" /></div>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="block text-sm font-medium text-gray-700">Hari/Tanggal Kunjungan</label><input type="text" name="hariTanggalAcara" value={formData.hariTanggalAcara} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" placeholder="Senin, 10 Januari 2024" required /></div>
                                        <div><label className="block text-sm font-medium text-gray-700">Waktu (Jam)</label><input type="text" name="waktuAcara" value={formData.waktuAcara} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" placeholder="09.00 - 11.00 WITA" required /></div>
                                    </div>
                                    <div><label className="block text-sm font-medium text-gray-700">Tujuan/Keperluan</label><textarea name="keperluan" value={formData.keperluan} onChange={handleChange} rows="2" className="w-full p-2 border border-gray-300 rounded-md" placeholder="Melakukan kunjungan rumah untuk..." required></textarea></div>
                                </div>
                            )}

                            {/* FORM KHUSUS LAPORAN HOME VISIT */}
                            {formData.type === 'LAPORAN_HOMEVISIT' && (
                                <div className="space-y-4 border-t pt-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="block text-sm font-medium text-gray-700">Hari/Tanggal Kunjungan</label><input type="text" name="hariTanggalAcara" value={formData.hariTanggalAcara} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" placeholder="Senin, 10 Januari 2024" /></div>
                                        <div><label className="block text-sm font-medium text-gray-700">Waktu</label><input type="text" name="waktuAcara" value={formData.waktuAcara} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" placeholder="10.00 WITA" /></div>
                                    </div>
                                    <div className="bg-gray-100 p-4 rounded-md">
                                        <h4 className="font-semibold text-xs text-gray-600 uppercase mb-2">Pihak yang Ditemui</h4>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div><label className="block text-xs font-medium text-gray-600">Nama</label><input type="text" name="pihakDitemui" value={formData.pihakDitemui} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" /></div>
                                            <div><label className="block text-xs font-medium text-gray-600">Status Hubungan</label><select name="statusPihakDitemui" value={formData.statusPihakDitemui} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md"><option value="Orang Tua">Orang Tua (Ayah/Ibu)</option><option value="Wali">Wali</option><option value="Paman/Bibi">Paman/Bibi</option><option value="Kakek/Nenek">Kakek/Nenek</option></select></div>
                                        </div>
                                    </div>
                                    <div><label className="block text-sm font-medium text-gray-700">Gambaran Masalah</label><textarea name="gambaranMasalah" value={formData.gambaranMasalah} onChange={handleChange} rows="3" className="w-full p-2 border border-gray-300 rounded-md" placeholder="Deskripsi kondisi siswa/rumah..."></textarea></div>
                                    <div><label className="block text-sm font-medium text-gray-700">Hasil Pembicaraan</label><textarea name="hasilPembicaraan" value={formData.hasilPembicaraan} onChange={handleChange} rows="3" className="w-full p-2 border border-gray-300 rounded-md" placeholder="Tanggapan orang tua..."></textarea></div>
                                    <div><label className="block text-sm font-medium text-gray-700">Rencana Tindak Lanjut (Kesepakatan)</label><textarea name="tindakLanjut" value={formData.tindakLanjut} onChange={handleChange} rows="2" className="w-full p-2 border border-gray-300 rounded-md" placeholder="Apa yang akan dilakukan selanjutnya..."></textarea></div>
                                    <div className="bg-orange-50 p-4 rounded-md border border-orange-100">
                                        <h4 className="font-semibold text-xs text-orange-800 uppercase mb-2">Pelapor (Guru BK)</h4>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div><label className="block text-xs font-medium text-gray-600">Nama Guru BK</label><input type="text" name="namaPetugas" value={formData.namaPetugas} onChange={handleChange} className="w-full p-2 border border-orange-200 rounded-md" required /></div>
                                            <div><label className="block text-xs font-medium text-gray-600">NIP</label><input type="text" name="nipPetugas" value={formData.nipPetugas} onChange={handleChange} className="w-full p-2 border border-orange-200 rounded-md" /></div>
                                        </div>
                                    </div>
                                </div>
                            )}
							
							{formData.type === 'KONFERENSI_KASUS' && (
								<div className="space-y-4 border-t pt-4">
									<div className="grid grid-cols-2 gap-4">
										<div><label className="block text-sm font-medium text-gray-700">Nomor Surat</label><input type="text" name="nomorSurat" value={formData.nomorSurat} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" required /></div>
										<div><label className="block text-sm font-medium text-gray-700">Tempat</label><input type="text" name="tempatAcara" value={formData.tempatAcara} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" required /></div>
									</div>
									<div className="grid grid-cols-2 gap-4">
										<div><label className="block text-sm font-medium text-gray-700">Hari/Tanggal Konferensi</label><input type="text" name="hariTanggalAcara" value={formData.hariTanggalAcara} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" placeholder="Senin, 10 Januari 2026" required /></div>
										<div><label className="block text-sm font-medium text-gray-700">Waktu</label><input type="text" name="waktuAcara" value={formData.waktuAcara} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" placeholder="09.00 WITA - Selesai" required /></div>
									</div>
									<div><label className="block text-sm font-medium text-gray-700">Gambaran Masalah / Topik Bahasan</label><textarea name="permasalahan" value={formData.permasalahan} onChange={handleChange} rows="3" className="w-full p-2 border border-gray-300 rounded-md" required></textarea></div>
									<div><label className="block text-sm font-medium text-gray-700">Hasil Konferensi / Kesepakatan</label><textarea name="hasilKonferensi" value={formData.hasilKonferensi} onChange={handleChange} rows="3" className="w-full p-2 border border-gray-300 rounded-md" required></textarea></div>

									<div className="bg-indigo-50 p-4 rounded-md border border-indigo-100">
										<div className="flex justify-between items-center mb-3">
											<h4 className="font-semibold text-xs text-indigo-800 uppercase">Daftar Hadir (Lampiran)</h4>
											<button type="button" onClick={handleAddPeserta} className="text-xs bg-indigo-600 text-white px-2 py-1 rounded hover:bg-indigo-700">+ Tambah Peserta</button>
										</div>
										<p className="text-[10px] text-indigo-600 mb-2 italic">*Siswa, Ortu, BK, & Kepsek sudah otomatis masuk. Masukkan peserta tambahan di sini (Wali kelas, Waka Kesiswaan, dll).</p>
										{(formData.pesertaKonferensi || []).map((p, index) => (
											<div key={index} className="flex gap-2 mb-2 items-end">
												<div className="flex-1"><label className="block text-[10px] text-gray-600">Nama Lengkap</label><input type="text" value={p.nama} onChange={(e) => handleChangePeserta(index, 'nama', e.target.value)} className="w-full p-1.5 text-sm border rounded" placeholder="Contoh: Budi Santoso, S.Pd" /></div>
												<div className="flex-1"><label className="block text-[10px] text-gray-600">Unsur/Jabatan</label><input type="text" value={p.unsur} onChange={(e) => handleChangePeserta(index, 'unsur', e.target.value)} className="w-full p-1.5 text-sm border rounded" placeholder="Wali Kelas" /></div>
												<button type="button" onClick={() => handleRemovePeserta(index)} className="bg-red-100 text-red-600 p-1.5 rounded hover:bg-red-200 mb-[1px]"><Trash2 size={16}/></button>
											</div>
										))}
									</div>

									<div className="bg-orange-50 p-4 rounded-md border border-orange-100">
										<h4 className="font-semibold text-xs text-orange-800 uppercase mb-2">Guru BK / Konselor</h4>
										<div className="grid grid-cols-2 gap-4">
											<div><label className="block text-xs font-medium text-gray-600">Nama Guru BK</label><input type="text" name="namaPetugas" value={formData.namaPetugas} onChange={handleChange} className="w-full p-2 border border-orange-200 rounded-md" required /></div>
											<div><label className="block text-xs font-medium text-gray-600">NIP</label><input type="text" name="nipPetugas" value={formData.nipPetugas} onChange={handleChange} className="w-full p-2 border border-orange-200 rounded-md" /></div>
										</div>
									</div>
								</div>
							)}

                            {/* FORM KHUSUS ALIH TANGAN KASUS */}
                            {formData.type === 'ALIH_KASUS' && (
                                <div className="space-y-4 border-t pt-4">
                                    <div><label className="block text-sm font-medium text-gray-700">Nomor Surat</label><input type="text" name="nomorSurat" value={formData.nomorSurat} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" required /></div>
                                    <div><label className="block text-sm font-medium text-gray-700">Pihak Tujuan (Yth...)</label><input type="text" name="pihakTujuan" value={formData.pihakTujuan} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" placeholder="Kepala Puskesmas / Psikolog / Kapolsek..." required /></div>
                                    <div><label className="block text-sm font-medium text-gray-700">Rincian Masalah / Gejala</label><textarea name="rincianMasalah" value={formData.rincianMasalah} onChange={handleChange} rows="3" className="w-full p-2 border border-gray-300 rounded-md" placeholder="Gejala yang tampak pada siswa..."></textarea></div>
                                    <div><label className="block text-sm font-medium text-gray-700">Riwayat Penanganan Sebelumnya</label><textarea name="riwayatPenanganan" value={formData.riwayatPenanganan} onChange={handleChange} rows="3" className="w-full p-2 border border-gray-300 rounded-md" placeholder="Layanan BK yang sudah diberikan..."></textarea></div>
                                    <div className="bg-orange-50 p-4 rounded-md border border-orange-100">
                                        <h4 className="font-semibold text-xs text-orange-800 uppercase mb-2">Konselor / Guru BK</h4>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div><label className="block text-xs font-medium text-gray-600">Nama Guru BK</label><input type="text" name="namaPetugas" value={formData.namaPetugas} onChange={handleChange} className="w-full p-2 border border-orange-200 rounded-md" required /></div>
                                            <div><label className="block text-xs font-medium text-gray-600">NIP</label><input type="text" name="nipPetugas" value={formData.nipPetugas} onChange={handleChange} className="w-full p-2 border border-orange-200 rounded-md" /></div>
                                        </div>
                                    </div>
                                </div>
                            )}
							
							{formData.type === 'ADVOKASI' && (
								<div className="space-y-4 border-t pt-4">
									<div className="grid grid-cols-1 md:grid-cols-3 gap-4">
										<div><label className="block text-sm font-medium text-gray-700">Nomor Surat</label><input type="text" name="nomorSurat" value={formData.nomorSurat} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" required /></div>
										<div><label className="block text-sm font-medium text-gray-700">Nama Pihak Terkait</label><input type="text" name="pihakTerkait" value={formData.pihakTerkait} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" placeholder="Contoh: Budi Santoso" required /></div>
										<div><label className="block text-sm font-medium text-gray-700">Sebagai (Jabatan)</label><input type="text" name="statusPihakTerkait" value={formData.statusPihakTerkait} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" placeholder="Contoh: Guru Matematika" required /></div>
									</div>
									<div><label className="block text-sm font-medium text-gray-700">Latar Belakang Masalah</label><textarea name="latarBelakang" value={formData.latarBelakang} onChange={handleChange} rows="2" className="w-full p-2 border border-gray-300 rounded-md" placeholder="Jelaskan masalah atau hak siswa yang terancam..." required></textarea></div>
									<div><label className="block text-sm font-medium text-gray-700">Tujuan Advokasi</label><textarea name="tujuanAdvokasi" value={formData.tujuanAdvokasi} onChange={handleChange} rows="2" className="w-full p-2 border border-gray-300 rounded-md" placeholder="Apa yang ingin dicapai (misal: keringanan SPP, izin ujian)..." required></textarea></div>
									<div><label className="block text-sm font-medium text-gray-700">Hasil / Keputusan</label><textarea name="hasilAdvokasi" value={formData.hasilAdvokasi} onChange={handleChange} rows="2" className="w-full p-2 border border-gray-300 rounded-md" placeholder="Hasil kesepakatan setelah negosiasi..." required></textarea></div>
									
									<div className="bg-orange-50 p-4 rounded-md border border-orange-100">
										<h4 className="font-semibold text-xs text-orange-800 uppercase mb-2">Pelaksana Advokasi (Guru BK)</h4>
										<div className="grid grid-cols-2 gap-4">
											<div><label className="block text-xs font-medium text-gray-600">Nama Guru BK</label><input type="text" name="namaPetugas" value={formData.namaPetugas} onChange={handleChange} className="w-full p-2 border border-orange-200 rounded-md" required /></div>
											<div><label className="block text-xs font-medium text-gray-600">NIP</label><input type="text" name="nipPetugas" value={formData.nipPetugas} onChange={handleChange} className="w-full p-2 border border-orange-200 rounded-md" /></div>
										</div>
									</div>
								</div>
							)}
							
							{formData.type === 'BIMBINGAN_KELOMPOK' && (
								<div className="space-y-4 border-t pt-4">
									<div className="grid grid-cols-2 gap-4">
										<div><label className="block text-sm font-medium text-gray-700">Nomor Surat</label><input type="text" name="nomorSurat" value={formData.nomorSurat} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" required /></div>
										<div><label className="block text-sm font-medium text-gray-700">Tempat Bimbingan</label><input type="text" name="tempatAcara" value={formData.tempatAcara} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" placeholder="Contoh: Ruang BK / Taman" required /></div>
									</div>
									<div className="grid grid-cols-2 gap-4">
										<div><label className="block text-sm font-medium text-gray-700">Hari/Tanggal</label><input type="text" name="hariTanggalAcara" value={formData.hariTanggalAcara} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" placeholder="Senin, 10 Januari 2026" required /></div>
										<div><label className="block text-sm font-medium text-gray-700">Waktu Pelaksanaan</label><input type="text" name="waktuAcara" value={formData.waktuAcara} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" placeholder="09.00 - 10.30 WITA" required /></div>
									</div>
									
									<div><label className="block text-sm font-medium text-gray-700">Topik / Materi Bahasan</label><input type="text" name="topikBimbingan" value={formData.topikBimbingan} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" placeholder="Contoh: Bahaya Bullying di Sekolah" required /></div>
									<div><label className="block text-sm font-medium text-gray-700">Tujuan Bimbingan</label><textarea name="tujuanBimbingan" value={formData.tujuanBimbingan} onChange={handleChange} rows="2" className="w-full p-2 border border-gray-300 rounded-md" placeholder="Target dari materi yang disampaikan..." required></textarea></div>
									<div><label className="block text-sm font-medium text-gray-700">Uraian Kegiatan</label><textarea name="uraianKegiatan" value={formData.uraianKegiatan} onChange={handleChange} rows="3" className="w-full p-2 border border-gray-300 rounded-md" placeholder="Deskripsikan dinamika kelompok dan proses berjalannya kegiatan..." required></textarea></div>
									<div><label className="block text-sm font-medium text-gray-700">Hasil Bimbingan</label><textarea name="hasilBimbingan" value={formData.hasilBimbingan} onChange={handleChange} rows="2" className="w-full p-2 border border-gray-300 rounded-md" placeholder="Kesimpulan yang didapat oleh para siswa..." required></textarea></div>

									<div className="bg-blue-50 p-4 rounded-md border border-blue-100">
										<div className="flex justify-between items-center mb-3">
											<h4 className="font-semibold text-xs text-blue-800 uppercase">Daftar Siswa (Anggota Kelompok)</h4>
											<button type="button" onClick={handleAddPesertaBimbingan} className="text-xs bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700">+ Tambah Siswa</button>
										</div>
										{(formData.pesertaBimbingan || []).map((p, index) => (
											<div key={index} className="flex gap-2 mb-2 items-end">
												<div className="flex-1 relative">
													<label className="block text-[10px] text-gray-600">Nama Lengkap Siswa</label>
													<input 
														type="text" 
														value={p.nama} 
														onChange={(e) => handleChangePesertaBimbingan(index, e.target.value)} 
														className="w-full p-1.5 text-sm border rounded focus:ring-2 focus:ring-blue-200 outline-none" 
														placeholder="Cari nama siswa..." 
														required
														autoComplete="off"
													/>
													{/* Dropdown Saran Nama Khusus Baris Ini */}
													{activePesertaIndex === index && (
														<div className="autocomplete-items shadow-xl border border-gray-200">
															{filteredStudents.map((s, idx) => (
																<div key={idx} onClick={() => handleSelectPesertaBimbingan(s, index)}>
																	<strong>{s['Nama Lengkap']}</strong> <span className="text-xs text-gray-500">({s['Kelas']})</span>
																</div>
															))}
															{filteredStudents.length === 0 && <div className="p-2 text-gray-400 italic text-xs">Siswa tidak ditemukan</div>}
														</div>
													)}
												</div>
												<div className="w-1/3"><label className="block text-[10px] text-gray-600">Kelas</label><input type="text" value={p.kelas} onChange={(e) => handleChangePesertaBimbingan(index, 'kelas', e.target.value)} className="w-full p-1.5 text-sm border rounded" placeholder="Kelas..." required/></div>
												<button type="button" onClick={() => handleRemovePesertaBimbingan(index)} className="bg-red-100 text-red-600 p-1.5 rounded hover:bg-red-200 mb-[1px]"><Trash2 size={16}/></button>
											</div>
										))}
									</div>

									<div className="bg-orange-50 p-4 rounded-md border border-orange-100">
										<h4 className="font-semibold text-xs text-orange-800 uppercase mb-2">Pemimpin Kelompok (Guru BK)</h4>
										<div className="grid grid-cols-2 gap-4">
											<div><label className="block text-xs font-medium text-gray-600">Nama Guru BK</label><input type="text" name="namaPetugas" value={formData.namaPetugas} onChange={handleChange} className="w-full p-2 border border-orange-200 rounded-md" required /></div>
											<div><label className="block text-xs font-medium text-gray-600">NIP</label><input type="text" name="nipPetugas" value={formData.nipPetugas} onChange={handleChange} className="w-full p-2 border border-orange-200 rounded-md" /></div>
										</div>
									</div>
								</div>
							)}

                            {/* FORM KHUSUS SKBB */}
                            {formData.type === 'SKBB' && (
                                <div className="space-y-4 border-t pt-4">
                                    <div><label className="block text-sm font-medium text-gray-700">Nomor Surat</label><input type="text" name="nomorSurat" value={formData.nomorSurat} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" required /></div>
                                    <div><label className="block text-sm font-medium text-gray-700">Keperluan Surat</label><textarea name="keperluan" value={formData.keperluan} onChange={handleChange} rows="2" className="w-full p-2 border border-gray-300 rounded-md" placeholder="Contoh: Persyaratan pendaftaran masuk SMA..." required></textarea></div>
                                </div>
                            )}
							
							{/* FORM KHUSUS MEDIASI */}
                             {formData.type === 'MEDIASI' && (
                                <div className="space-y-4 border-t pt-4">
                                    <div><label className="block text-sm font-medium text-gray-700">Nomor Surat</label><input type="text" name="nomorSurat" value={formData.nomorSurat} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" required /></div>
                                    <div><label className="block text-sm font-medium text-gray-700">Permasalahan</label><textarea name="permasalahan" value={formData.permasalahan} onChange={handleChange} rows="3" className="w-full p-2 border border-gray-300 rounded-md" placeholder="Kronologi masalah antar kedua pihak..."></textarea></div>
                                    <div><label className="block text-sm font-medium text-gray-700">Hasil Mediasi / Kesepakatan</label><textarea name="hasilMediasi" value={formData.hasilMediasi} onChange={handleChange} rows="3" className="w-full p-2 border border-gray-300 rounded-md" placeholder="Poin-poin kesepakatan damai..." required></textarea></div>
                                    
                                    <div className="bg-purple-50 p-4 rounded-md border border-purple-100">
                                        <h4 className="font-semibold text-xs text-purple-800 uppercase mb-2">Data Saksi - Wali Kelas (Otomatis)</h4>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div><label className="block text-xs font-medium text-gray-600">Wali Kelas Pihak 1</label><input type="text" name="namaWaliKelas" value={formData.namaWaliKelas} onChange={handleChange} className="w-full p-2 border border-purple-200 rounded-md" /></div>
                                            <div><label className="block text-xs font-medium text-gray-600">NIP Wali Kelas 1</label><input type="text" name="nipWaliKelas" value={formData.nipWaliKelas} onChange={handleChange} className="w-full p-2 border border-purple-200 rounded-md" /></div>
                                            <div><label className="block text-xs font-medium text-gray-600">Wali Kelas Pihak 2</label><input type="text" name="namaWaliKelas2" value={formData.namaWaliKelas2} onChange={handleChange} className="w-full p-2 border border-purple-200 rounded-md" /></div>
                                            <div><label className="block text-xs font-medium text-gray-600">NIP Wali Kelas 2</label><input type="text" name="nipWaliKelas2" value={formData.nipWaliKelas2} onChange={handleChange} className="w-full p-2 border border-purple-200 rounded-md" /></div>
                                        </div>
                                    </div>

                                    <div className="bg-orange-50 p-4 rounded-md border border-orange-100">
                                        <h4 className="font-semibold text-xs text-orange-800 uppercase mb-2">Saksi Guru BK / Konselor</h4>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div><label className="block text-xs font-medium text-gray-600">Nama Guru BK</label><input type="text" name="namaSaksi" value={formData.namaSaksi} onChange={handleChange} className="w-full p-2 border border-orange-200 rounded-md" required /></div>
                                            <div><label className="block text-xs font-medium text-gray-600">NIP</label><input type="text" name="nipSaksi" value={formData.nipSaksi} onChange={handleChange} className="w-full p-2 border border-orange-200 rounded-md" /></div>
                                        </div>
                                    </div>
                                </div>
                            )}

                             {/* FORM KHUSUS BERHENTI */}
                             {formData.type === 'BERHENTI' && (
                                <div className="space-y-4 border-t pt-4">
                                    <div><label className="block text-sm font-medium text-gray-700">Nomor Surat</label><input type="text" name="nomorSurat" value={formData.nomorSurat} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" required /></div>
                                    <div><label className="block text-sm font-medium text-gray-700">Alasan Berhenti / Keluar</label><textarea name="alasanBerhenti" value={formData.alasanBerhenti} onChange={handleChange} rows="3" className="w-full p-2 border border-gray-300 rounded-md" placeholder="Pindah sekolah ke... / Mengundurkan diri karena..." required></textarea></div>
                                    
                                    <div className="bg-gray-100 p-4 rounded-md">
                                        <h4 className="font-semibold text-xs text-gray-600 uppercase mb-2">Saksi (Wali Kelas / Keluarga)</h4>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div className="col-span-2"><label className="block text-xs font-medium text-gray-600">Status Saksi</label><select name="statusSaksi" value={formData.statusSaksi} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md"><option value="Wali Kelas">Wali Kelas</option><option value="Om / Tante">Om / Tante</option><option value="Kakek / Nenek">Kakek / Nenenk</option><option value="Kakak / Adik">Kakak / Adik</option><option value="Sepupu / Keluarga Lain">Sepupu / Keluarga Lain</option></select></div>
                                            <div><label className="block text-xs font-medium text-gray-600">Nama Saksi</label><input type="text" name="namaSaksi" value={formData.namaSaksi} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" required /></div>
                                            <div><label className="block text-xs font-medium text-gray-600">NIP (Jika Guru)</label><input type="text" name="nipSaksi" value={formData.nipSaksi} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" /></div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* TANDA TANGAN KEPALA SEKOLAH - DENGAN DROPDOWN PEJABAT */}
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <h3 className="font-semibold text-gray-800 text-sm uppercase mb-3 flex items-center gap-2"><Briefcase size={16}/> Pejabat Penanda Tangan</h3>
                                <div className="mb-3">
                                    <label className="block text-xs font-medium text-gray-600 mb-1">Pilih Cepat Pejabat (Opsional)</label>
                                    <select onChange={handleSelectOfficial} className="w-full p-2 border border-gray-300 rounded-md text-sm bg-white">
                                        <option value="">-- Pilih Pejabat --</option>
                                        {officials && officials.map((off, idx) => (
                                            <option key={idx} value={off['Nama Pejabat']}>{off['Jabatan']} - {off['Nama Pejabat']}</option>
                                        ))}
                                    </select>
                                </div>
                                <div className="grid grid-cols-3 gap-4">
                                    <div><label className="block text-sm font-medium text-gray-700">Nama</label><input type="text" name="penandaTangan" value={formData.penandaTangan} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" required /></div>
                                    <div><label className="block text-sm font-medium text-gray-700">NIP</label><input type="text" name="nipPenandaTangan" value={formData.nipPenandaTangan} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" /></div>
                                    <div><label className="block text-sm font-medium text-gray-700">Jabatan</label><input type="text" name="jabatan" value={formData.jabatan} onChange={handleChange} className="w-full p-2 border border-gray-300 rounded-md" required /></div>
                                </div>
                            </div>
                            
                            {/* BUTTONS STICKY AT BOTTOM */}
                            <div className="flex justify-end gap-3 pt-4 border-t sticky bottom-0 bg-white p-4 -mx-6 -mb-6 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
                                <button type="button" onClick={onCancel} className="px-4 py-2 text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">Batal</button>
                                <button type="submit" className="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg flex items-center gap-2 shadow-sm transition-colors"><Save size={18} /> Simpan</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // LETTER CONTENT RENDERER (NO CHANGES NEEDED, DATA MAPPED AUTOMATICALLY)
        function LetterContent({ data, schoolData, isPreview }) {
            const containerClass = isPreview ? "bg-white shadow-2xl mx-auto w-[215mm] min-h-[330mm] p-[15mm_20mm] relative text-black leading-normal box-border" : "bg-white w-full h-full text-black leading-normal box-border"; 
            const arialStyle = { fontFamily: 'Times', fontSize: '12pt' };
            const contentStyle = { fontSize: '11pt' }; 
            const renderLogo = (url) => url ? <img src={url} alt="Logo" className="max-h-full max-w-full object-contain" onError={(e) => {e.target.style.display='none'}} /> : null;
            
            const qrData = `VALIDASI DOKUMEN ${schoolData.namaSekolah}%0AJENIS: ${data.type}%0ASISWA: ${data.namaSiswa}%0ANOMOR: ${data.nomorSurat || '-'}%0ATGL: ${formatDate(data.tanggal)}%0A${data.jabatan}: ${data.penandaTangan}%0ADIBUAT OLEH: ${data.createdBy}`;
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?data=${qrData}&size=100x100`;

            return (
                <div className={containerClass} style={arialStyle}>
                    {/* KOP SURAT */}
                    <div className="border-b-4 border-double border-black pb-4 mb-4 flex items-center justify-between relative px-0">
                        <div className="w-[2.5cm] h-[2.5cm] flex items-center justify-center shrink-0">{renderLogo(schoolData.logoKiri)}</div>
                        <div className="text-center flex-1 px-2">
                            <h2 className="font-bold text-[12pt] uppercase tracking-wider leading-tight">{schoolData.pemerintah}</h2>
                            <h2 className="font-bold text-[12pt] uppercase tracking-wider leading-tight">{schoolData.instansi}</h2>
                            <h2 className="font-bold text-[13pt] uppercase leading-tight">{schoolData.namaSekolah}</h2>
                            {!['SKORSING', 'TUGAS_HOMEVISIT', 'ALIH_KASUS', 'SKBB', 'BERHENTI'].includes(data.type) && (<h2 className="font-bold text-[12pt] uppercase leading-tight">BIMBINGAN DAN KONSELING</h2>
                            )}
                            <p className="text-[10pt] italic mt-1 whitespace-pre-line leading-tight">{schoolData.alamat}</p>
                        </div>
                        <div className="w-[2.5cm] h-[2.5cm] flex items-center justify-center shrink-0">{renderLogo(schoolData.logoKanan)}</div>
                    </div>

                    {/* ISI SURAT */}
                    <div style={contentStyle}>
                        {data.type === 'SKORSING' && (<div><div className="text-center mb-6"><h3 className="font-bold underline text-[12pt] uppercase">SURAT KEPUTUSAN SKORSING</h3><p>Nomor: {data.nomorSurat}</p></div><p className="mb-2">Yang bertanda tangan di bawah ini:</p><table className="w-full mb-4"><tbody><tr><td className="w-40 align-top">Nama</td><td>: <span className="font-bold">{data.penandaTangan}</span></td></tr><tr><td className="align-top">NIP</td><td>: {data.nipPenandaTangan || '-'}</td></tr><tr><td className="align-top">Jabatan</td><td>: {data.jabatan}</td></tr></tbody></table><p className="mb-2 text-justify">Berdasarkan hasil rapat Dewan Guru dan Tata Tertib Sekolah, dengan ini memberikan sanksi tegas berupa <strong>SKORSING (Pemberhentian Sementara)</strong> kepada siswa:</p><table className="w-full mb-4 pl-4"><tbody><tr><td className="w-40 align-top">Nama Siswa</td><td>: <strong>{data.namaSiswa}</strong></td></tr><tr><td className="align-top">NISN</td><td>: {data.nisn || '-'}</td></tr><tr><td className="align-top">Jenis Kelamin</td><td>: {data.jenisKelamin}</td></tr><tr><td className="align-top">Kelas</td><td>: {data.kelas}</td></tr><tr><td className="align-top">Pelanggaran</td><td className="text-justify">: {data.alasan}</td></tr></tbody></table><p className="mb-2 text-justify">Adapun masa skorsing berlaku selama <strong>{data.lamaSkorsing}</strong>, terhitung mulai tanggal <strong>{formatDate(data.tanggalMulai)}</strong> sampai dengan <strong>{formatDate(data.tanggalSelesai)}</strong>.</p><p className="mb-6 text-justify">Selama masa skorsing, siswa dikembalikan kepada orang tua/wali untuk dibina di rumah.</p>
                            <div className="flex justify-end mt-8 px-4 gap-4 items-end">
                                 <div className="flex flex-col items-center justify-end h-full pb-2"><img src={qrUrl} alt="Validasi" className="w-[2cm] h-[2cm]" /></div>
                                <div className="text-center min-w-[250px]">
                                    <p className="mb-2">Ditetapkan di: {data.tempat || 'Makassar'}</p><p className="mb-2">Pada Tanggal: {formatDate(data.tanggal)}</p><p className="mb-16 font-bold">{data.jabatan},</p><p className="font-bold underline whitespace-nowrap">{data.penandaTangan}</p><p>NIP. {data.nipPenandaTangan}</p>
                                </div>
                            </div>
                            <div className="mt-4 text-[10pt]"><p>Tembusan:</p><ol className="list-decimal list-inside"><li>Orang Tua/Wali Siswa ({data.namaOrangTua})</li><li>Arsip</li></ol></div></div>)}
                        
                        {data.type === 'PERNYATAAN' && (<div>
                            <div className="text-center mb-4"><h3 className="font-bold underline text-[12pt] uppercase">SURAT PERNYATAAN ORANG TUA / WALI</h3></div>
                            <p className="mb-1">Saya yang bertanda tangan di bawah ini:</p>
                            <table className="w-full mb-2 pl-4"><tbody><tr><td className="w-48 py-0.5 align-top">Nama Orang Tua/Wali</td><td>: <strong>{data.namaOrangTua}</strong></td></tr><tr><td className="py-0.5 align-top">Alamat</td><td>: {data.alamatOrangTua}</td></tr><tr><td className="py-0.5 align-top">No. HP / WA</td><td>: {data.noHpOrangTua}</td></tr></tbody></table>
                            <p className="mb-1">Selaku Orang Tua / Wali dari siswa:</p>
                            <table className="w-full mb-2 pl-4"><tbody><tr><td className="w-48 py-0.5 align-top">Nama Siswa</td><td>: <strong>{data.namaSiswa}</strong></td></tr><tr><td className="py-0.5 align-top">NISN</td><td>: {data.nisn || '-'}</td></tr><tr><td className="py-0.5 align-top">Jenis Kelamin</td><td>: {data.jenisKelamin}</td></tr><tr><td className="py-0.5 align-top">Kelas</td><td>: {data.kelas}</td></tr></tbody></table>
                            {data.permasalahan && (<p className="mb-2 text-justify">{data.permasalahan}</p>)}
                            <p className="mb-2 font-bold">Dengan ini menyatakan dengan sesungguhnya bahwa:</p>
                            <div className="border border-black p-4 mb-4 bg-gray-50 print:bg-transparent min-h-[100px] text-justify italic">"{data.isiPernyataan}"</div>
                            <p className="mb-4 text-justify">Demikian surat pernyataan ini saya buat dengan sadar tanpa paksaan dari pihak manapun.</p>
                            <div className="flex justify-between items-end mt-4 px-2"><div className="text-center min-w-[200px] mb-8"><p className="mb-12">Siswa Yang Bersangkutan,</p><p className="font-bold underline whitespace-nowrap">{data.namaSiswa}</p><p className="text-[10pt]">NIS. {data.nisn || '........................'}</p></div><div className="text-center min-w-[250px] mb-8"><p className="mb-2">{data.tempat || 'Makassar'}, {formatDate(data.tanggal)}</p><p className="mb-12">Orang Tua / Wali,</p><p className="font-bold underline whitespace-nowrap">{data.namaOrangTua}</p></div></div>
                            <div className="flex justify-center mt-0 gap-4 items-end"><div className="flex flex-col items-center justify-end h-full pb-2"><img src={qrUrl} alt="Validasi" className="w-[2cm] h-[2cm]" /></div><div className="text-center min-w-[250px]"><p className="mb-12">Mengetahui,<br/>{data.jabatan}</p><p className="font-bold underline whitespace-nowrap">{data.penandaTangan}</p><p>NIP. {data.nipPenandaTangan}</p></div></div>
                        </div>)}
                        
                        {data.type === 'UNDANGAN' && (<div><div className="flex justify-between mb-4"><div><table className="leading-snug"><tbody><tr><td>Nomor</td><td>: {data.nomorSurat}</td></tr><tr><td>Lampiran</td><td>: {data.lampiran || '-'}</td></tr><tr><td>Perihal</td><td className="font-bold">: {data.perihal || 'Undangan'}</td></tr></tbody></table></div><div className="text-right"><p>{data.tempat || 'Makassar'}, {formatDate(data.tanggal)}</p></div></div><p className="mb-2">Yth. Bapak/Ibu/Wali dari:</p><table className="w-full mb-4 pl-4"><tbody><tr><td className="w-40 align-top">Nama Siswa</td><td>: <strong>{data.namaSiswa}</strong></td></tr><tr><td className="align-top">Kelas</td><td>: {data.kelas}</td></tr><tr><td className="align-top">NISN</td><td>: {data.nisn || '-'}</td></tr></tbody></table><p className="mb-4">Di Tempat</p><p className="mb-4 text-justify">Dengan hormat,<br/>Sehubungan dengan pentingnya hal yang ingin kami sampaikan mengenai perkembangan putra/putri Bapak/Ibu, maka kami mengundang Bapak/Ibu untuk hadir di sekolah pada:</p><table className="w-full mb-6 pl-4"><tbody><tr><td className="w-40 py-1">Hari / Tanggal</td><td>: {data.hariTanggalAcara}</td></tr><tr><td className="py-1">Waktu</td><td>: {data.waktuAcara}</td></tr><tr><td className="py-1">Tempat</td><td>: {data.tempatAcara}</td></tr><tr><td className="py-1 align-top">Keperluan</td><td className="align-top">: {data.keperluan}</td></tr></tbody></table><p className="mb-8 text-justify">Mengingat pentingnya acara tersebut, kami sangat mengharapkan kehadiran Bapak/Ibu tepat pada waktunya. Atas perhatian dan kerjasamanya kami ucapkan terima kasih.</p><div className="flex justify-between mt-12 px-8">{data.namaWaliKelas && (<div className="text-center min-w-[200px]"><p className="mb-16">Mengetahui,<br/>Wali Kelas</p><p className="font-bold underline whitespace-nowrap">{data.namaWaliKelas}</p><p>NIP. {data.nipWaliKelas || '-'}</p></div>)}<div className="flex gap-4 items-end ml-auto"><div className="flex flex-col items-center justify-end h-full pb-2"><img src={qrUrl} alt="Validasi" className="w-[2cm] h-[2cm]" /></div><div className="text-center min-w-[250px]"><p className="mb-16">Mengetahui,<br/>{data.jabatan}</p><p className="font-bold underline whitespace-nowrap">{data.penandaTangan}</p><p>NIP. {data.nipPenandaTangan}</p></div></div></div></div>)}
                        
                        {data.type === 'KONTRAK' && (<div><div className="text-center mb-4"><h3 className="font-bold underline text-[12pt] uppercase">KONTRAK PERILAKU SISWA</h3></div><table className="w-full mb-2 border-collapse border border-black text-[11pt]"><tbody><tr><td className="border border-black p-1 font-bold bg-gray-100" colSpan="2">INFORMASI SISWA</td></tr><tr><td className="border border-black p-1 w-48">Nama Siswa</td><td className="border border-black p-1 font-bold">{data.namaSiswa}</td></tr><tr><td className="border border-black p-1">NISN</td><td className="border border-black p-1">{data.nisn}</td></tr><tr><td className="border border-black p-1">Kelas / Gender</td><td className="border border-black p-1">{data.kelas} / {data.jenisKelamin}</td></tr><tr><td className="border border-black p-1">Tanggal Kontrak</td><td className="border border-black p-1">{formatDate(data.tanggalKontrak)}</td></tr><tr><td className="border border-black p-1">Tanggal Tinjauan</td><td className="border border-black p-1">{formatDate(data.tanggalTinjauan) || '-'}</td></tr></tbody></table><div className="space-y-2 text-[11pt]"><div className="border border-black p-1"><p className="font-bold underline mb-0.5">Deskripsi Perilaku yang Akan Diubah:</p><p className="whitespace-pre-line leading-snug">{data.deskripsiPerilaku}</p></div><div className="border border-black p-1"><p className="font-bold underline mb-0.5">Tujuan Perubahan Perilaku:</p><p className="whitespace-pre-line leading-snug">{data.tujuanPerubahan}</p></div><div className="border border-black p-1"><p className="font-bold underline mb-0.5">Rencana Tindakan Siswa:</p><p className="whitespace-pre-line leading-snug">{data.rencanaTindakan}</p></div><div className="grid grid-cols-2 gap-2"><div className="border border-black p-1"><p className="font-bold underline mb-0.5">Konsekuensi:</p><p className="whitespace-pre-line leading-snug">{data.konsekuensi}</p></div><div className="border border-black p-1"><p className="font-bold underline mb-0.5">Status Kontrak:</p><p className="font-bold uppercase leading-snug">{data.statusKontrak}</p></div></div></div><p className="mt-4 mb-2 text-justify text-[11pt] leading-snug">Saya telah membaca dan memahami isi kontrak ini. Saya setuju untuk mengikuti rencana di atas dan menerima konsekuensi yang telah ditetapkan.</p><div className="flex justify-between items-end mt-4 px-2 text-[11pt]"><div className="text-center min-w-[200px] mb-8"><p className="mb-12">Siswa,</p><p className="font-bold underline whitespace-nowrap">{data.namaSiswa}</p></div><div className="text-center min-w-[200px] mb-8"><p className="mb-12">Orang Tua / Wali,</p><p className="font-bold underline">..............................</p></div></div><div className="flex justify-center mt-0 gap-4 items-end"><div className="flex flex-col items-center justify-end h-full pb-2"><img src={qrUrl} alt="Validasi" className="w-[2cm] h-[2cm]" /></div><div className="text-center min-w-[250px]"><p className="mb-1">Mengetahui,</p><p className="mb-12">{data.jabatan}</p><p className="font-bold underline whitespace-nowrap">{data.penandaTangan}</p><p>NIP. {data.nipPenandaTangan}</p></div></div></div>)}

                        {data.type === 'TUGAS_HOMEVISIT' && (
                            <div>
                                <div className="text-center mb-6">
                                    <h3 className="font-bold underline text-[12pt] uppercase">SURAT TUGAS</h3>
                                    <p>Nomor: {data.nomorSurat}</p>
                                </div>
                                <div className="mb-4">
                                    <p className="mb-2">Yang bertanda tangan di bawah ini:</p>
                                    <table className="w-full mb-2 pl-4">
                                        <tbody>
                                            <tr><td className="w-40 align-top">Nama</td><td>: <span className="font-bold">{data.penandaTangan}</span></td></tr>
                                            <tr><td className="align-top">NIP</td><td>: {data.nipPenandaTangan || '-'}</td></tr>
                                            <tr><td className="align-top">Jabatan</td><td>: {data.jabatan}</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div className="mb-4 text-center font-bold text-[12pt]">MEMBERI TUGAS KEPADA:</div>
                                <div className="mb-4">
                                    <table className="w-full mb-2 pl-4">
                                        <tbody>
                                            <tr><td className="w-40 align-top">Nama</td><td>: <span className="font-bold">{data.namaPetugas}</span></td></tr>
                                            <tr><td className="align-top">NIP</td><td>: {data.nipPetugas || '-'}</td></tr>
                                            <tr><td className="align-top">Jabatan</td><td>: Guru BK / Konselor</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div className="mb-6">
                                    <p className="mb-2">Untuk melaksanakan <strong>Kunjungan Rumah (Home Visit)</strong> kepada siswa:</p>
                                    <table className="w-full mb-2 pl-4">
                                        <tbody>
                                            <tr><td className="w-40 align-top">Nama Siswa</td><td>: <strong>{data.namaSiswa}</strong></td></tr>
                                            <tr><td className="align-top">Kelas</td><td>: {data.kelas}</td></tr>
                                            <tr><td className="align-top">Alamat</td><td>: {data.alamatOrangTua || '-'}</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div className="mb-6">
                                    <p className="mb-2">Adapun kegiatan tersebut akan dilaksanakan pada:</p>
                                    <table className="w-full mb-2 pl-4">
                                        <tbody>
                                            <tr><td className="w-40 align-top">Hari / Tanggal</td><td>: {data.hariTanggalAcara}</td></tr>
                                            <tr><td className="align-top">Waktu</td><td>: {data.waktuAcara}</td></tr>
                                            <tr><td className="align-top">Keperluan</td><td>: {data.keperluan}</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                                <p className="mb-8 text-justify">Demikian surat tugas ini diberikan untuk dilaksanakan dengan penuh tanggung jawab.</p>
                                <div className="flex justify-end gap-4 items-end">
                                    <div className="flex flex-col items-center justify-end h-full pb-2"><img src={qrUrl} alt="Validasi" className="w-[2cm] h-[2cm]" /></div>
                                    <div className="text-center min-w-[250px]">
                                        <p className="mb-2">{data.tempat || 'Makassar'}, {formatDate(data.tanggal)}</p>
                                        <p className="mb-16 font-bold">{data.jabatan},</p>
                                        <p className="font-bold underline whitespace-nowrap">{data.penandaTangan}</p>
                                        <p>NIP. {data.nipPenandaTangan}</p>
                                    </div>
                                </div>
                            </div>
                        )}

                        {data.type === 'LAPORAN_HOMEVISIT' && (
                            <div>
                                <div className="text-center mb-6">
                                    <h3 className="font-bold underline text-[12pt] uppercase">LAPORAN HASIL KUNJUNGAN RUMAH</h3>
                                    <p>(HOME VISIT REPORT)</p>
                                </div>
                                <table className="w-full border-collapse border border-black mb-6">
                                    <tbody>
                                        <tr><td className="border border-black p-2 font-bold w-48 bg-gray-100">Nama Siswa</td><td className="border border-black p-2">{data.namaSiswa}</td></tr>
                                        <tr><td className="border border-black p-2 font-bold bg-gray-100">Kelas</td><td className="border border-black p-2">{data.kelas}</td></tr>
                                        <tr><td className="border border-black p-2 font-bold bg-gray-100">Hari / Tanggal</td><td className="border border-black p-2">{data.hariTanggalAcara}</td></tr>
                                        <tr><td className="border border-black p-2 font-bold bg-gray-100">Pihak yang Ditemui</td><td className="border border-black p-2">{data.pihakDitemui} ({data.statusPihakDitemui})</td></tr>
                                    </tbody>
                                </table>
                                <div className="mb-4">
                                    <h4 className="font-bold underline mb-1">A. GAMBARAN MASALAH / TUJUAN KUNJUNGAN</h4>
                                    <div className="border border-black p-2 min-h-[80px] text-justify whitespace-pre-line">{data.gambaranMasalah}</div>
                                </div>
                                <div className="mb-4">
                                    <h4 className="font-bold underline mb-1">B. HASIL PEMBICARAAN</h4>
                                    <div className="border border-black p-2 min-h-[100px] text-justify whitespace-pre-line">{data.hasilPembicaraan}</div>
                                </div>
                                <div className="mb-6">
                                    <h4 className="font-bold underline mb-1">C. RENCANA TINDAK LANJUT (KESEPAKATAN)</h4>
                                    <div className="border border-black p-2 min-h-[80px] text-justify whitespace-pre-line">{data.tindakLanjut}</div>
                                </div>
                                <div className="flex justify-between items-end mt-8 px-2">
                                    <div className="text-center min-w-[200px] mb-4">
                                        <p className="mb-16">Orang Tua / Wali,</p>
                                        <p className="font-bold underline">..............................</p>
                                        <p>{data.statusPihakDitemui}</p>
                                    </div>
                                    <div className="text-center min-w-[200px] mb-4">
                                        <p className="mb-2">{data.tempat || 'Makassar'}, {formatDate(data.tanggal)}</p>
                                        <p className="mb-16">Guru BK / Konselor,</p>
                                        <p className="font-bold underline">{data.namaPetugas}</p>
                                        <p>NIP. {data.nipPetugas || '-'}</p>
                                    </div>
                                </div>
                                <div className="flex justify-center mt-4">
                                    <div className="text-center">
                                        <p className="mb-16">Mengetahui,<br/>{data.jabatan}</p>
                                        <p className="font-bold underline">{data.penandaTangan}</p>
                                        <p>NIP. {data.nipPenandaTangan}</p>
                                    </div>
                                </div>
                            </div>
                        )}
						
						{data.type === 'KONFERENSI_KASUS' && (
							<div>
								{/* HALAMAN 1: BERITA ACARA */}
								<div className="text-center mb-6">
									<h3 className="font-bold underline text-[12pt] uppercase">BERITA ACARA KONFERENSI KASUS</h3>
									<p>Nomor: {data.nomorSurat}</p>
								</div>
								<p className="mb-4 text-justify">Pada hari ini <strong>{data.hariTanggalAcara}</strong>, bertempat di <strong>{data.tempatAcara}</strong>, telah dilaksanakan kegiatan Konferensi Kasus untuk membahas permasalahan dan menyepakati solusi penanganan bagi siswa:</p>
								<table className="w-full mb-4 pl-4">
									<tbody>
										<tr><td className="w-40 py-1">Nama Siswa</td><td>: <strong>{data.namaSiswa}</strong></td></tr>
										<tr><td className="py-1">NISN</td><td>: {data.nisn || '-'}</td></tr>
										<tr><td className="py-1">Kelas / Gender</td><td>: {data.kelas} / {data.jenisKelamin}</td></tr>
										<tr><td className="py-1">Orang Tua / Wali</td><td>: {data.namaOrangTua}</td></tr>
									</tbody>
								</table>
								<div className="mb-2">
                                    <h4 className="font-bold text-sm mb-0.5">A. Gambaran Masalah / Topik Bahasan</h4>
                                    <div className="text-justify whitespace-pre-line pl-4">{data.permasalahan}</div>
                                </div>
                                <div className="mb-4">
                                    <h4 className="font-bold text-sm mb-0.5">B. Hasil Konferensi / Kesepakatan</h4>
                                    <div className="text-justify whitespace-pre-line pl-4">{data.hasilKonferensi}</div>
                                </div>
                                <p className="mb-6 text-sm text-justify">Demikian berita acara konferensi kasus ini dibuat untuk ditindaklanjuti bersama secara kooperatif.</p>

                                {/* Tanda Tangan Konferensi Kasus */}
                                <div className="flex justify-between items-end mt-8 px-4 text-[11pt]">
                                    <div className="text-center min-w-[250px]">
                                        <p>Mengetahui,</p>
                                        <p className="mb-12">{data.jabatan}</p>
                                        <p className="font-bold underline">{data.penandaTangan}</p>
                                        <p>NIP. {data.nipPenandaTangan}</p>
                                    </div>
                                    <div className="text-center min-w-[250px]">
                                        <p className="invisible">Mengetahui,</p>
                                        <p className="mb-12">Guru BK / Konselor,</p>
                                        <p className="font-bold underline">{data.namaPetugas}</p>
                                        <p>NIP. {data.nipPetugas || '-'}</p>
                                    </div>
                                </div>

								{/* HALAMAN 2: LAMPIRAN (Akan tercetak di halaman baru otomatis saat print) */}
								<div style={{ pageBreakBefore: 'always' }} className="pt-8">
									<div className="text-center mb-6">
										<h3 className="font-bold underline text-[12pt] uppercase">LAMPIRAN DAFTAR HADIR</h3>
										<p>Kegiatan Konferensi Kasus Siswa a.n. {data.namaSiswa}</p>
									</div>
									<table className="w-full border-collapse border border-black text-sm">
										<thead>
											<tr className="bg-gray-100">
												<th className="border border-black p-2 w-10">No</th>
												<th className="border border-black p-2">Nama Lengkap</th>
												<th className="border border-black p-2 w-48">Unsur / Jabatan</th>
												<th className="border border-black p-2 w-40">Tanda Tangan</th>
											</tr>
										</thead>
										<tbody>
											<tr><td className="border border-black p-3 text-center">1</td><td className="border border-black p-3">{data.namaSiswa}</td><td className="border border-black p-3 text-center">Siswa</td><td className="border border-black p-3"></td></tr>
											<tr><td className="border border-black p-3 text-center">2</td><td className="border border-black p-3">{data.namaOrangTua}</td><td className="border border-black p-3 text-center">Orang Tua / Wali</td><td className="border border-black p-3"></td></tr>
											<tr><td className="border border-black p-3 text-center">3</td><td className="border border-black p-3">{data.namaPetugas}</td><td className="border border-black p-3 text-center">Guru BK</td><td className="border border-black p-3"></td></tr>
											<tr><td className="border border-black p-3 text-center">4</td><td className="border border-black p-3">{data.penandaTangan}</td><td className="border border-black p-3 text-center">Kepala Sekolah</td><td className="border border-black p-3"></td></tr>
											{(data.pesertaKonferensi || []).map((p, i) => (
												<tr key={i}><td className="border border-black p-3 text-center">{i + 5}</td><td className="border border-black p-3">{p.nama}</td><td className="border border-black p-3 text-center">{p.unsur}</td><td className="border border-black p-3"></td></tr>
											))}
										</tbody>
									</table>
								</div>
							</div>
						)}

                        {data.type === 'ALIH_KASUS' && (
                            <div>
                                <div className="flex justify-between mb-8">
                                    <div>
                                        <table className="leading-snug">
                                            <tbody>
                                                <tr><td>Nomor</td><td>: {data.nomorSurat}</td></tr>
                                                <tr><td>Lampiran</td><td>: 1 (Satu) Berkas</td></tr>
                                                <tr><td>Perihal</td><td className="font-bold">: Alih Tangan Kasus (Referral)</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div className="text-right"><p>{data.tempat || 'Makassar'}, {formatDate(data.tanggal)}</p></div>
                                </div>

                                <div className="mb-6">
                                    <p>Kepada Yth.</p>
                                    <p className="font-bold">{data.pihakTujuan}</p>
                                    <p>di Tempat</p>
                                </div>

                                <p className="mb-2 text-justify">Dengan hormat,</p>
                                <p className="mb-4 text-justify">Berdasarkan hasil pemantauan dan layanan bimbingan konseling yang telah kami lakukan di sekolah, kami memandang perlu untuk mengalih-tangankan penanganan siswa berikut kepada Bapak/Ibu/Saudara yang lebih berwenang/ahli di bidangnya:</p>

                                <table className="w-full mb-6 pl-4">
                                    <tbody>
                                        <tr><td className="w-48 align-top py-1">Nama Siswa</td><td>: <strong>{data.namaSiswa}</strong></td></tr>
                                        <tr><td className="align-top py-1">Kelas / Gender</td><td>: {data.kelas} / {data.jenisKelamin}</td></tr>
                                        <tr><td className="align-top py-1">Alamat</td><td>: {data.alamatOrangTua || '-'}</td></tr>
                                    </tbody>
                                </table>

                                <div className="mb-4">
                                    <p className="font-bold underline mb-1">Rincian Masalah / Gejala yang Tampak:</p>
                                    <p className="text-justify whitespace-pre-line">{data.rincianMasalah}</p>
                                </div>
                                
                                <div className="mb-6">
                                    <p className="font-bold underline mb-1">Riwayat Penanganan di Sekolah:</p>
                                    <p className="text-justify whitespace-pre-line">{data.riwayatPenanganan}</p>
                                </div>

                                <p className="mb-8 text-justify">Besar harapan kami agar Bapak/Ibu dapat memberikan bantuan penanganan yang sesuai untuk siswa tersebut. Demikian surat pengantar ini kami buat, atas perhatian dan kerjasamanya kami ucapkan terima kasih.</p>

                                <div className="flex justify-between items-end mt-12 px-2">
                                    <div className="text-center min-w-[200px]">
                                        <p className="mb-16">Guru BK / Konselor,</p>
                                        <p className="font-bold underline">{data.namaPetugas}</p>
                                        <p>NIP. {data.nipPetugas || '-'}</p>
                                    </div>
                                    <div className="flex gap-4 items-end">
                                        <div className="flex flex-col items-center justify-end h-full pb-2"><img src={qrUrl} alt="Validasi" className="w-[2cm] h-[2cm]" /></div>
                                        <div className="text-center min-w-[200px]">
                                            <p className="mb-16">Mengetahui,<br/>{data.jabatan}</p>
                                            <p className="font-bold underline">{data.penandaTangan}</p>
                                            <p>NIP. {data.nipPenandaTangan}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
						
						{data.type === 'ADVOKASI' && (
							<div>
								<div className="text-center mb-4">
									<h3 className="font-bold underline text-[12pt] uppercase">BERITA ACARA ADVOKASI SISWA</h3>
									<p>Nomor: {data.nomorSurat}</p>
								</div>
								<p className="mb-3 text-justify">Pada hari ini <strong>{formatDate(data.tanggal)}</strong>, bertempat di <strong>{data.tempat || 'Ruang BK'}</strong>, telah dilaksanakan upaya pendampingan/advokasi untuk menjembatani penyelesaian masalah dan pemenuhan hak belajar bagi siswa:</p>
								
								<table className="w-full mb-3 pl-4">
									<tbody>
										<tr><td className="w-40 py-0.5">Nama Siswa</td><td>: <strong>{data.namaSiswa}</strong></td></tr>
										<tr><td className="py-0.5">Kelas</td><td>: {data.kelas}</td></tr>
										<tr><td className="py-0.5">Nama Orang Tua</td><td>: {data.namaOrangTua}</td></tr>
										<tr><td className="py-0.5">Pihak Terkait</td><td>: <strong>{data.pihakTerkait} ({data.statusPihakTerkait})</strong></td></tr>
									</tbody>
								</table>

								<div className="mb-2">
									<h4 className="font-bold text-sm mb-0.5">A. Latar Belakang Masalah</h4>
									<div className="text-justify whitespace-pre-line pl-4">{data.latarBelakang}</div>
								</div>
								
								<div className="mb-2">
									<h4 className="font-bold text-sm mb-0.5">B. Tujuan Advokasi</h4>
									<div className="text-justify whitespace-pre-line pl-4">{data.tujuanAdvokasi}</div>
								</div>

								<div className="mb-4">
									<h4 className="font-bold text-sm mb-0.5">C. Hasil Kesepakatan / Keputusan</h4>
									<div className="text-justify whitespace-pre-line pl-4">{data.hasilAdvokasi}</div>
								</div>

								<p className="mb-4 text-sm text-justify">Demikian berita acara ini dibuat sebagai bentuk pertanggungjawaban profesional dan untuk dipergunakan sebagaimana mestinya.</p>

								{/* Tanda Tangan Khusus Advokasi - Formasi 2 Di Atas, 1 Di Tengah Bawah */}
								<div className="mt-6 text-[11pt]">
									<div className="flex justify-between text-center px-4 mb-6">
										<div className="min-w-[200px]">
											<p className="mb-12">Siswa / Klien,</p>
											<p className="font-bold underline">{data.namaSiswa}</p>
										</div>
										<div className="min-w-[200px]">
											<p className="mb-12">{data.statusPihakTerkait || 'Pihak Terkait'},</p>
											<p className="font-bold underline">{data.pihakTerkait}</p>
										</div>
									</div>
									<div className="flex justify-center text-center">
										<div className="min-w-[250px]">
											<p className="mb-12">Guru BK / Konselor,</p>
											<p className="font-bold underline">{data.namaPetugas}</p>
											<p>NIP. {data.nipPetugas || '-'}</p>
										</div>
									</div>
								</div>
							</div>
						)}
						
						{data.type === 'BIMBINGAN_KELOMPOK' && (
							<div>
								{/* HALAMAN 1: BERITA ACARA INTI */}
								<div className="text-center mb-6">
									<h3 className="font-bold underline text-[12pt] uppercase">BERITA ACARA BIMBINGAN KELOMPOK</h3>
									<p>Nomor: {data.nomorSurat}</p>
								</div>
								<p className="mb-4 text-justify">Pada hari ini telah dilaksanakan layanan Bimbingan Kelompok (BKP) dengan rincian kegiatan sebagai berikut:</p>
								
								<table className="w-full mb-4 pl-4">
									<tbody>
										<tr><td className="w-48 py-1 align-top">Hari / Tanggal</td><td className="align-top">: <strong>{data.hariTanggalAcara}</strong></td></tr>
										<tr><td className="py-1 align-top">Waktu</td><td className="align-top">: {data.waktuAcara}</td></tr>
										<tr><td className="py-1 align-top">Tempat</td><td className="align-top">: {data.tempatAcara}</td></tr>
										<tr><td className="py-1 align-top">Topik / Materi</td><td className="align-top">: <strong>{data.topikBimbingan}</strong></td></tr>
										<tr><td className="py-1 align-top">Jumlah Peserta</td><td className="align-top">: {(data.pesertaBimbingan || []).length} Orang Siswa</td></tr>
									</tbody>
								</table>
								
								<div className="mb-2">
									<h4 className="font-bold text-sm mb-0.5">A. Tujuan Bimbingan</h4>
									<div className="text-justify whitespace-pre-line pl-4">{data.tujuanBimbingan}</div>
								</div>
								
								<div className="mb-2">
									<h4 className="font-bold text-sm mb-0.5">B. Uraian Kegiatan</h4>
									<div className="text-justify whitespace-pre-line pl-4">{data.uraianKegiatan}</div>
								</div>

								<div className="mb-4">
									<h4 className="font-bold text-sm mb-0.5">C. Hasil Bimbingan</h4>
									<div className="text-justify whitespace-pre-line pl-4">{data.hasilBimbingan}</div>
								</div>
								
								<p className="mb-6 text-sm text-justify">Demikian berita acara ini dibuat sebagai bukti fisik pelaksanaan layanan Bimbingan dan Konseling.</p>

								{/* Tanda Tangan */}
								<div className="flex justify-between items-end mt-8 px-4 text-[11pt]">
									<div className="text-center min-w-[250px]">
										<p>Mengetahui,</p>
										<p className="mb-12">{data.jabatan}</p>
										<p className="font-bold underline">{data.penandaTangan}</p>
										<p>NIP. {data.nipPenandaTangan}</p>
									</div>
									<div className="text-center min-w-[250px]">
										<p className="invisible">Mengetahui,</p>
										<p className="mb-12">Pemimpin Kelompok / Guru BK,</p>
										<p className="font-bold underline">{data.namaPetugas}</p>
										<p>NIP. {data.nipPetugas || '-'}</p>
									</div>
								</div>

								{/* HALAMAN 2: LAMPIRAN (Akan tercetak di halaman baru otomatis) */}
								<div style={{ pageBreakBefore: 'always' }} className="pt-8">
									<div className="text-center mb-6">
										<h3 className="font-bold underline text-[12pt] uppercase">DAFTAR HADIR PESERTA</h3>
										<h3 className="font-bold text-[12pt] uppercase">BIMBINGAN KELOMPOK</h3>
									</div>
									
									<table className="w-full mb-6 text-sm">
										<tbody>
											<tr><td className="w-40 py-1">Hari / Tanggal</td><td>: {data.hariTanggalAcara}</td></tr>
											<tr><td className="py-1">Waktu / Tempat</td><td>: {data.waktuAcara} / {data.tempatAcara}</td></tr>
											<tr><td className="py-1">Topik Bahasan</td><td>: <strong>{data.topikBimbingan}</strong></td></tr>
											<tr><td className="py-1">Pemimpin Kelompok</td><td>: {data.namaPetugas}</td></tr>
										</tbody>
									</table>

									<table className="w-full border-collapse border border-black text-sm">
										<thead>
											<tr className="bg-gray-100">
												<th className="border border-black p-2 w-10">No</th>
												<th className="border border-black p-2">Nama Lengkap Siswa</th>
												<th className="border border-black p-2 w-32">Kelas</th>
												<th className="border border-black p-2 w-40">Tanda Tangan</th>
											</tr>
										</thead>
										<tbody>
											{(data.pesertaBimbingan || []).map((p, i) => (
												<tr key={i}>
													<td className="border border-black p-3 text-center">{i + 1}</td>
													<td className="border border-black p-3">{p.nama}</td>
													<td className="border border-black p-3 text-center">{p.kelas}</td>
													<td className="border border-black p-3"></td>
												</tr>
											))}
										</tbody>
									</table>
								</div>
							</div>
						)}

                        {data.type === 'SKBB' && (
                            <div>
                                <div className="text-center mb-6">
                                    <h3 className="font-bold underline text-[12pt] uppercase">SURAT KETERANGAN BERKELAKUAN BAIK</h3>
                                    <p>Nomor: {data.nomorSurat}</p>
                                </div>
                                <p className="mb-4">Yang bertanda tangan di bawah ini Kepala {schoolData.namaSekolah}, menerangkan bahwa:</p>
                                <table className="w-full mb-6 pl-4">
                                    <tbody>
                                        <tr><td className="w-48 align-top py-1">Nama Siswa</td><td>: <strong>{data.namaSiswa}</strong></td></tr>
                                        <tr><td className="align-top py-1">NISN</td><td>: {data.nisn || '-'}</td></tr>
                                        <tr><td className="align-top py-1">Kelas</td><td>: {data.kelas}</td></tr>
                                        <tr><td className="align-top py-1">Jenis Kelamin</td><td>: {data.jenisKelamin}</td></tr>
                                        <tr><td className="align-top py-1">Asal Sekolah</td><td>: UPT SPF SMP Negeri 16 Makassar</td></tr>
                                    </tbody>
                                </table>

                                <p className="mb-4 text-justify indent-8">Berdasarkan catatan tata tertib siswa dan laporan Bimbingan Konseling di sekolah kami, nama tersebut di atas adalah benar-benar siswa kami dan selama menjadi siswa:</p>
                                
                                <div className="border-2 border-black p-4 mb-4 mx-8 font-bold text-center uppercase bg-gray-50">
                                    BERKELAKUAN BAIK
                                </div>
                                
                                <p className="mb-4 text-justify indent-8">Serta tidak pernah terlibat dalam tindakan Kriminal, Penyalahgunaan Narkoba, maupun Pelanggaran Berat Tata Tertib sekolah lainnya.</p>
                                
                                <p className="mb-2">Surat keterangan ini diberikan untuk keperluan:</p>
                                <div className="font-bold italic text-center mb-6">"{data.keperluan}"</div>

                                <p className="mb-8 text-justify indent-8">Demikian surat keterangan ini dibuat dengan sesungguhnya untuk dapat dipergunakan sebagaimana mestinya.</p>

                                <div className="flex justify-end gap-4 items-end mt-12">
                                    <div className="flex flex-col items-center justify-end h-full pb-2"><img src={qrUrl} alt="Validasi" className="w-[2cm] h-[2cm]" /></div>
                                    <div className="text-center min-w-[250px]">
                                        <p className="mb-2">{data.tempat || 'Makassar'}, {formatDate(data.tanggal)}</p>
                                        <p className="mb-16 font-bold">{data.jabatan},</p>
                                        <p className="font-bold underline whitespace-nowrap">{data.penandaTangan}</p>
                                        <p>NIP. {data.nipPenandaTangan}</p>
                                    </div>
                                </div>
                            </div>
                        )}
						
						{data.type === 'MEDIASI' && (
                            <div>
                                <div className="text-center mb-6">
                                    <h3 className="font-bold underline text-[12pt] uppercase">BERITA ACARA MEDIASI</h3>
                                    <p>Nomor: {data.nomorSurat}</p>
                                </div>
                                <p className="mb-4">Pada hari ini, <strong>{formatDate(data.tanggal)}</strong>, bertempat di Ruang Bimbingan dan Konseling {schoolData.namaSekolah}, telah dilaksanakan mediasi antara:</p>
                                
                                <div className="flex gap-4 mb-4">
                                    <div className="flex-1 border border-black p-2">
                                        <p className="font-bold text-center underline mb-2">PIHAK I</p>
                                        <table className="w-full text-sm">
                                            <tbody>
                                                <tr><td className="w-16">Nama</td><td>: <strong>{data.namaSiswa}</strong></td></tr>
                                                <tr><td>Kelas</td><td>: {data.kelas}</td></tr>
                                                <tr><td>Ortu</td><td>: {data.namaOrangTua}</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div className="flex-1 border border-black p-2">
                                        <p className="font-bold text-center underline mb-2">PIHAK II</p>
                                        <table className="w-full text-sm">
                                            <tbody>
                                                <tr><td className="w-16">Nama</td><td>: <strong>{data.namaSiswa2}</strong></td></tr>
                                                <tr><td>Kelas</td><td>: {data.kelas2}</td></tr>
                                                <tr><td>Ortu</td><td>: {data.namaOrangTua2}</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <div className="mb-4">
                                    <h4 className="font-bold text-sm mb-1">A. PERMASALAHAN</h4>
                                    <div className="text-justify border border-gray-300 p-2 min-h-[50px] whitespace-pre-line">{data.permasalahan}</div>
                                </div>

                                <div className="mb-6">
                                    <h4 className="font-bold text-sm mb-1">B. HASIL MEDIASI / KESEPAKATAN</h4>
                                    <div className="text-justify border border-gray-300 p-2 min-h-[50px] whitespace-pre-line">{data.hasilMediasi}</div>
                                </div>

                                <p className="mb-4 text-sm">Demikian berita acara ini dibuat untuk dipatuhi bersama.</p>

                                {/* TANDA TANGAN KOMPLEKS GRID */}
                                <div className="grid grid-cols-2 gap-y-6 gap-x-4 text-center text-xs">
                                    {/* SISWA */}
                                    <div><p>Pihak I (Siswa),</p><br/><br/><br/><p className="font-bold underline">{data.namaSiswa}</p></div>
                                    <div><p>Pihak II (Siswa),</p><br/><br/><br/><p className="font-bold underline">{data.namaSiswa2}</p></div>
                                    
                                    {/* ORTU */}
                                    <div><p>Orang Tua Pihak I,</p><br/><br/><br/><p className="font-bold underline">{data.namaOrangTua}</p></div>
                                    <div><p>Orang Tua Pihak II,</p><br/><br/><br/><p className="font-bold underline">{data.namaOrangTua2}</p></div>
                                    
                                    {/* WALI KELAS */}
                                    <div><p>Wali Kelas Pihak I,</p><br/><br/><br/><p className="font-bold underline">{data.namaWaliKelas}</p></div>
                                    <div><p>Wali Kelas Pihak II,</p><br/><br/><br/><p className="font-bold underline">{data.namaWaliKelas2}</p></div>

                                    {/* SAKSI DAN KEPSEK */}
                                    <div><p>Saksi (Guru BK),</p><br/><br/><br/><p className="font-bold underline">{data.namaSaksi}</p><p>NIP. {data.nipSaksi}</p></div>
                                    <div><p>Mengetahui Kepala Sekolah,</p><br/><br/><br/><p className="font-bold underline">{data.penandaTangan}</p><p>NIP. {data.nipPenandaTangan}</p></div>
                                </div>
                            </div>
                        )}

                        {data.type === 'BERHENTI' && (
                            <div>
                                <div className="text-center mb-6">
                                    <h3 className="font-bold underline text-[12pt] uppercase">SURAT KETERANGAN PENGUNDURAN DIRI</h3>
                                    <p>Nomor: {data.nomorSurat}</p>
                                </div>
                                <p className="mb-4">Yang bertanda tangan di bawah ini:</p>
                                <table className="w-full mb-4 pl-4">
                                    <tbody>
                                        <tr><td className="w-48 py-1">Nama Orang Tua/Wali</td><td>: <strong>{data.namaOrangTua}</strong></td></tr>
                                        <tr><td className="py-1">Alamat</td><td>: {data.alamatOrangTua}</td></tr>
                                        <tr><td className="py-1">Selaku Orang Tua dari</td><td>:</td></tr>
                                        <tr><td className="py-1 pl-4">Nama Siswa</td><td>: <strong>{data.namaSiswa}</strong></td></tr>
                                        <tr><td className="py-1 pl-4">NISN</td><td>: {data.nisn}</td></tr>
                                        <tr><td className="py-1 pl-4">Kelas</td><td>: {data.kelas}</td></tr>
                                    </tbody>
                                </table>

                                <p className="mb-2 text-justify">Dengan ini mengajukan permohonan <strong>PENGUNDURAN DIRI / BERHENTI</strong> sebagai siswa di {schoolData.namaSekolah}, dikarenakan:</p>
                                <div className="border border-black p-4 mb-4 bg-gray-50 italic text-justify">
                                    "{data.alasanBerhenti}"
                                </div>
                                
                                <p className="mb-6 text-justify">Demikian surat pernyataan pengunduran diri ini saya buat dengan kesadaran sendiri tanpa paksaan dari pihak manapun.</p>

                                <div className="grid grid-cols-2 gap-y-8 gap-x-4 text-center mt-8">
                                    <div>
                                        <p>Siswa yang bersangkutan,</p><br/><br/><br/><p className="font-bold underline">{data.namaSiswa}</p>
                                    </div>
                                    <div>
                                        <p>{data.tempat}, {formatDate(data.tanggal)}</p>
                                        <p>Orang Tua / Wali,</p><br/><br/><br/><p className="font-bold underline">{data.namaOrangTua}</p>
                                    </div>
                                    <div>
                                        <p>Saksi ({data.statusSaksi}),</p><br/><br/><br/><p className="font-bold underline">{data.namaSaksi}</p>
                                    </div>
                                    <div>
                                        <p>Mengetahui Kepala Sekolah,</p><br/><br/><br/><p className="font-bold underline">{data.penandaTangan}</p><p>NIP. {data.nipPenandaTangan}</p>
                                    </div>
                                </div>
                            </div>
                        )}

                    </div>
                </div>
            );
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            return new Date(dateString).toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>

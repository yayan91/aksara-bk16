<!DOCTYPE html>
<html lang="id" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIAP-BK | 16</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        darkbg: '#0f172a',
                        lightbg: '#f8fafc',
                        primary: '#3b82f6',
                    },
                    animation: {
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'slide-in': 'slideIn 0.3s ease-out forwards',
                        'fade-out': 'fadeOut 0.3s ease-in forwards',
                    },
                    keyframes: {
                        slideIn: {
                            '0%': { transform: 'translateX(100%)', opacity: '0' },
                            '100%': { transform: 'translateX(0)', opacity: '1' },
                        },
                        fadeOut: {
                            '0%': { opacity: '1' },
                            '100%': { opacity: '0' },
                        }
                    }
                }
            }
        }
    </script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Noto+Serif:wght@400;700&display=swap" rel="stylesheet">
    <!-- SweetAlert2 (Masih dipakai untuk Confirm Delete/Logout) -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- jsPDF & AutoTable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <!-- Chart.js (Statistik) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SheetJS (Excel) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- QRious (QR Code Generator) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

    <style>
        body { font-family: 'Poppins', sans-serif; }
        
        /* Background Styles */
        .bg-custom-dark { 
            background-color: #0f172a; 
            background-image: url('https://images.unsplash.com/photo-1557683316-973673baf926?q=80&w=2029&auto=format&fit=crop');
            background-blend-mode: overlay;
            background-size: cover;
            background-attachment: fixed;
        }
        .bg-custom-light {
            background-color: #f1f5f9;
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* Glassmorphism Dynamic */
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        .light .glass {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(200, 200, 200, 0.5);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }

        /* Animations */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        .float-anim { animation: float 6s ease-in-out infinite; }
        
        .btn-press:active { transform: scale(0.95); }
        .hide { display: none !important; }
        
        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(59, 130, 246, 0.5); border-radius: 4px; }
        
        /* Timeline Styles */
        .timeline-line::before {
            content: '';
            position: absolute;
            top: 0; bottom: 0; left: 15px;
            width: 3px; background: #e2e8f0;
            z-index: 0;
        }
        .dark .timeline-line::before { background: #334155; }

        /* Loading Overlay (Initial Load) */
        #loading {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.9); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            color: white; flex-direction: column;
        }

        /* Toast Container */
        #toast-container {
            position: fixed; top: 20px; right: 20px; z-index: 10000;
            display: flex; flex-direction: column; gap: 10px;
        }

        /* Skeleton Shimmer */
        .skeleton {
            background: #e2e8f0;
            background: linear-gradient(90deg, #e2e8f0 25%, #f1f5f9 50%, #e2e8f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        .dark .skeleton {
            background: #334155;
            background: linear-gradient(90deg, #334155 25%, #475569 50%, #334155 75%);
            background-size: 200% 100%;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body id="main-body" class="bg-custom-dark min-h-screen text-slate-800 dark:text-white flex flex-col transition-colors duration-500">

    <!-- TOAST CONTAINER -->
    <div id="toast-container"></div>

    <!-- LOADING OVERLAY -->
    <div id="loading" class="hide">
        <div class="relative">
            <div class="w-16 h-16 border-4 border-blue-500 border-dashed rounded-full animate-spin"></div>
            <div class="absolute top-0 left-0 w-16 h-16 border-4 border-t-blue-300 border-transparent rounded-full animate-pulse"></div>
        </div>
        <p class="mt-4 text-blue-200 font-medium tracking-wider animate-pulse">PROSES DATA...</p>
    </div>

    <!-- MAIN CONTAINER -->
    <div class="flex-grow w-full max-w-md mx-auto md:max-w-6xl p-4 flex flex-col relative">

        <!-- PROFESSIONAL APP HEADER -->
        <header id="app-header" class="hide mb-6 sticky top-2 z-50">
			<div class="glass rounded-2xl p-3 md:p-4 shadow-lg flex justify-between items-center transition-all duration-300">
				<div class="flex items-center gap-3 md:gap-4 cursor-pointer" onclick="goHome()">
					<div class="w-10 h-10 md:w-12 md:h-12 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center shadow-lg shadow-blue-500/20">
						<img id="header-logo" src="https://drive.google.com/thumbnail?id=1Z6g-sCdw-k7W8dnw12NeagPkroLlmk-L" class="w-7 h-7 md:w-9 md:h-9 object-contain" alt="Logo Sekolah">
                    </div>
                    <div>
                        <h1 class="text-lg md:text-xl font-bold dark:text-white text-slate-800 tracking-wide leading-tight">SIAP-BK <span class="text-blue-500">PRO</span></h1>
                        <p id="greeting-text" class="text-[10px] md:text-xs dark:text-slate-300 text-slate-500 font-light">Sistem Informasi Administrasi & Pelayanan BK</p>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <!-- Refresh Button -->
                    <button onclick="refreshApp()" id="btn-refresh" class="w-10 h-10 rounded-xl bg-slate-200 dark:bg-slate-700 flex items-center justify-center text-slate-600 dark:text-blue-400 transition hover:scale-105 shadow-inner" title="Refresh Data">
                        <i class="fa-solid fa-arrows-rotate"></i>
                    </button>

                    <!-- Theme Toggle -->
                    <button onclick="toggleTheme()" class="w-10 h-10 rounded-xl bg-slate-200 dark:bg-slate-700 flex items-center justify-center text-slate-600 dark:text-yellow-300 transition hover:scale-105 shadow-inner">
                        <i id="theme-icon" class="fa-solid fa-sun"></i>
                    </button>

                    <div class="hidden md:flex flex-col text-right">
                        <span id="user-display" class="text-sm font-semibold dark:text-white text-slate-800">Guru BK</span>
                        <span class="text-[10px] text-green-500 font-bold uppercase tracking-wider">Online</span>
                    </div>
                    
                    <button onclick="logout()" class="group relative bg-slate-200 dark:bg-slate-800/50 hover:bg-red-500 dark:hover:bg-red-500 text-slate-600 dark:text-white hover:text-white w-10 h-10 rounded-xl shadow border border-transparent dark:border-white/5 flex items-center justify-center transition-all duration-300" title="Logout">
                        <i class="fa-solid fa-power-off"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- FLOATING HOME BUTTON -->
        <button id="btn-back" onclick="goHome()" class="hide fixed bottom-24 right-6 md:bottom-10 md:right-10 bg-gradient-to-r from-blue-600 to-indigo-600 text-white w-14 h-14 rounded-full shadow-2xl flex items-center justify-center text-xl z-50 hover:from-blue-500 hover:to-indigo-500 btn-press transition-all duration-300 ring-4 ring-blue-500/30 group">
            <i class="fa-solid fa-house group-hover:scale-110 transition-transform"></i>
        </button>

        <!-- 1. LOGIN PAGE -->
        <section id="page-login" class="flex-1 flex items-center justify-center min-h-[85vh]">
            <div class="w-full max-w-5xl bg-white/40 dark:bg-slate-900/40 backdrop-blur-xl rounded-[2rem] shadow-2xl overflow-hidden flex flex-col lg:flex-row border border-white/50 dark:border-slate-700/50 relative">
                
                <button onclick="showMobileInfo()" class="lg:hidden absolute top-6 right-6 w-10 h-10 rounded-full bg-white dark:bg-slate-800 shadow-md flex items-center justify-center text-blue-500 z-30 transition hover:scale-110 border border-gray-100 dark:border-slate-700">
                    <i class="fa-solid fa-circle-info text-xl animate-pulse-fast"></i>
                </button>

                <div class="hidden lg:flex w-1/2 bg-gradient-to-br from-blue-600 via-indigo-700 to-purple-800 p-12 flex-col justify-between relative overflow-hidden text-white">
                    <div class="absolute -top-20 -left-20 w-64 h-64 bg-white/10 rounded-full blur-3xl"></div>
                    <div class="absolute bottom-10 -right-10 w-48 h-48 bg-blue-400/20 rounded-full blur-2xl"></div>
                    <div class="absolute top-1/2 left-1/4 w-32 h-32 bg-purple-400/20 rounded-full blur-xl"></div>
                    
                    <div class="relative z-10">
                        <div class="w-24 h-25 bg-white/20 backdrop-blur-md rounded-2xl flex items-center justify-center mb-8 shadow-inner border border-white/30 p-2">
                            <img src="https://lh3.googleusercontent.com/u/0/d/1Wr_uC9C32tjzN19PZXLsk3tyBNrzO1wy" class="w-full h-full object-contain drop-shadow-md" alt="Logo Sekolah">
                        </div>
                        <h1 class="text-4xl font-extrabold mb-2 tracking-tight leading-tight">SIAP-BK <span class="text-yellow-400">PRO</span></h1>
                        <h2 class="text-lg font-medium text-blue-100 mb-6 tracking-wide uppercase">UPT SPF SMP Negeri 16 Makassar</h2>
                        
                        <div class="h-1 w-16 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-full mb-6"></div>
                        
                        <p class="text-blue-50/90 leading-relaxed mb-8 font-light text-sm">
                            Sistem Informasi Administrasi & Pelayanan Bimbingan Konseling. Platform digital modern untuk mencatat, menganalisis, dan memprediksi tren perkembangan siswa secara komprehensif dengan dukungan Kecerdasan Buatan (AI).
                        </p>
                        
                        <div class="space-y-4">
                            <div class="flex items-center gap-3 text-sm text-blue-50">
                                <div class="w-6 h-6 rounded-full bg-green-500/20 flex items-center justify-center"><i class="fa-solid fa-check text-green-400 text-xs"></i></div>
                                <span class="font-medium">AI Smart Analytics & Forecasting</span>
                            </div>
                            <div class="flex items-center gap-3 text-sm text-blue-50">
                                <div class="w-6 h-6 rounded-full bg-green-500/20 flex items-center justify-center"><i class="fa-solid fa-check text-green-400 text-xs"></i></div>
                                <span class="font-medium">Automated Reporting & QR Validation</span>
                            </div>
                            <div class="flex items-center gap-3 text-sm text-blue-50">
                                <div class="w-6 h-6 rounded-full bg-green-500/20 flex items-center justify-center"><i class="fa-solid fa-check text-green-400 text-xs"></i></div>
                                <span class="font-medium">Secure Google Cloud Database</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="relative z-10 text-xs text-blue-200/60 font-light mt-10">
                        Build 2026 &copy; Developed by Muhammad Hasratul
                    </div>
                </div>

                <div class="w-full lg:w-1/2 p-8 md:p-12 lg:p-16 flex flex-col justify-center relative bg-white/60 dark:bg-slate-900/60">
                    <div class="w-full max-w-sm mx-auto">
                        
                        <div class="text-center mb-8">
                            <img src="https://drive.google.com/thumbnail?id=1Z6g-sCdw-k7W8dnw12NeagPkroLlmk-L" 
                                 class="w-20 h-20 lg:w-24 lg:h-24 mx-auto mb-4 drop-shadow-xl float-anim object-contain" 
                                 alt="Logo Sekolah">
                            <h2 class="text-2xl font-bold dark:text-white text-slate-800 lg:hidden">SIAP-BK PRO</h2>
                            <p class="dark:text-slate-400 text-slate-500 text-xs mt-1 lg:hidden">UPT SPF SMP NEGERI 16 MAKASSAR</p>
                            
                            <h2 class="text-2xl md:text-3xl font-bold dark:text-white text-slate-800 hidden lg:block">Selamat Datang</h2>
                            <p class="dark:text-slate-400 text-slate-500 text-sm mt-2 hidden lg:block">Silakan masuk ke akun Anda</p>
                        </div>
                        
                        <form onsubmit="handleLogin(event)" class="space-y-5 relative z-10">
                            <div class="text-left relative group">
                                <i class="fa-solid fa-user absolute left-4 top-3.5 text-gray-400 group-focus-within:text-blue-500 transition z-20"></i>
                                <input type="text" id="login-username" class="w-full pl-11 pr-4 py-3 rounded-xl border border-gray-200 dark:border-slate-700 bg-white dark:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500 font-medium text-gray-700 dark:text-white transition-all shadow-sm" placeholder="Username" required>
                            </div>
                            <div class="text-left relative group">
                                <i class="fa-solid fa-lock absolute left-4 top-3.5 text-gray-400 group-focus-within:text-blue-500 transition z-20"></i>
                                <input type="password" id="login-password" class="w-full pl-11 pr-12 py-3 rounded-xl border border-gray-200 dark:border-slate-700 bg-white dark:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500 font-medium text-gray-700 dark:text-white transition-all shadow-sm" placeholder="Password" required>
                                <button type="button" onclick="togglePasswordVisibility()" class="absolute right-4 top-3.5 text-gray-400 hover:text-blue-500 transition z-20 focus:outline-none" title="Lihat Password">
                                    <i id="eye-icon" class="fa-solid fa-eye-slash"></i>
                                </button>
                            </div>
                            
                            <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-indigo-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-blue-500/30 hover:shadow-blue-500/50 hover:-translate-y-1 transition-all duration-300 btn-press mt-4">
                                MASUK APLIKASI <i class="fa-solid fa-arrow-right-to-bracket ml-2"></i>
                            </button>
                        </form>
                        
                    </div>
                </div>
                
            </div>
        </section>

        <!-- 2. DASHBOARD GRID (PREMIUM DASHBOARD) -->
        <section id="page-dashboard" class="hide flex-1 pb-10">
            
            <!-- HEADING & SEARCH -->
            <div class="flex flex-col xl:flex-row justify-between items-end mb-6 gap-4">
                <div class="text-center xl:text-left w-full xl:w-auto">
                    <h2 class="text-3xl font-bold dark:text-white text-slate-800 drop-shadow-sm">Dashboard</h2>
                    <p class="dark:text-blue-200 text-slate-500 font-light text-sm">Statistik & Menu Layanan</p>
                </div>
                
                <div class="flex flex-col md:flex-row items-center gap-2 bg-slate-200 dark:bg-slate-800 p-1.5 rounded-xl shadow-inner w-full xl:w-auto">
                    
                    <select id="dashboard-filter-type" onchange="toggleDateFilter()" class="bg-white dark:bg-slate-700 text-slate-700 dark:text-white px-4 py-2 rounded-lg text-sm font-bold outline-none border border-transparent focus:ring-2 focus:ring-blue-500 transition shadow-sm cursor-pointer">
                        <option value="all">Semua Waktu</option>
                        <option value="Ganjil">Semester Ganjil</option>
                        <option value="Genap">Semester Genap</option>
                        <option value="custom">Rentang Tanggal</option>
                    </select>

                    <div id="dashboard-custom-date" class="hidden items-center gap-2 animate-slide-in">
                        <input type="date" id="dash-date-start" class="bg-white dark:bg-slate-700 text-slate-700 dark:text-white px-2 py-1.5 rounded-lg text-xs outline-none shadow-sm border border-transparent focus:ring-2 focus:ring-blue-500">
                        <span class="text-slate-500 dark:text-slate-400 text-xs font-bold">-</span>
                        <input type="date" id="dash-date-end" class="bg-white dark:bg-slate-700 text-slate-700 dark:text-white px-2 py-1.5 rounded-lg text-xs outline-none shadow-sm border border-transparent focus:ring-2 focus:ring-blue-500">
                        <button onclick="applyDashboardFilter()" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded-lg text-xs font-bold transition shadow-sm btn-press" title="Terapkan Filter Tanggal"><i class="fa-solid fa-filter"></i></button>
                    </div>

                </div>
                
                <div class="w-full xl:w-72 relative">
                    <div class="flex bg-white dark:bg-slate-800 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700 overflow-hidden">
                        <input type="text" id="global-student-search" placeholder="Cari Siswa..." class="w-full px-4 py-2 bg-transparent outline-none text-slate-700 dark:text-white text-sm">
                        <button onclick="searchStudentHistory()" class="bg-blue-600 text-white px-4 hover:bg-blue-700 transition"><i class="fa-solid fa-search"></i></button>
                    </div>
                </div>
            </div>

            <!-- EXECUTIVE SUMMARY CARDS (NEW) -->
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <!-- Card 1 -->
                <div class="glass p-4 rounded-2xl shadow-lg relative overflow-hidden group hover:-translate-y-1 transition-all duration-300">
                    <div class="absolute right-0 top-0 w-24 h-24 bg-blue-500/10 rounded-bl-full transition-all group-hover:scale-110"></div>
                    <p class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">Total Layanan</p>
                    <h3 class="text-2xl md:text-3xl font-bold text-blue-600 dark:text-blue-400 mt-1" id="stat-total">0</h3>
                    <p class="text-[10px] text-gray-400 mt-2">Semua Jenis Layanan</p>
                    <i class="fa-solid fa-folder-open absolute bottom-4 right-4 text-4xl text-gray-200 dark:text-slate-700/50"></i>
                </div>
                <!-- Card 2 -->
                <div class="glass p-4 rounded-2xl shadow-lg relative overflow-hidden group hover:-translate-y-1 transition-all duration-300">
                    <div class="absolute right-0 top-0 w-24 h-24 bg-green-500/10 rounded-bl-full transition-all group-hover:scale-110"></div>
                    <p class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">Siswa Terbantu</p>
                    <h3 class="text-2xl md:text-3xl font-bold text-green-600 dark:text-green-400 mt-1" id="stat-students">0</h3>
                    <p class="text-[10px] text-gray-400 mt-2">Siswa Unik</p>
                    <i class="fa-solid fa-user-check absolute bottom-4 right-4 text-4xl text-gray-200 dark:text-slate-700/50"></i>
                </div>
                <!-- Card 3 -->
                <div class="glass p-4 rounded-2xl shadow-lg relative overflow-hidden group hover:-translate-y-1 transition-all duration-300">
                    <div class="absolute right-0 top-0 w-24 h-24 bg-purple-500/10 rounded-bl-full transition-all group-hover:scale-110"></div>
                    <p class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">Top Layanan</p>
                    <h3 class="text-lg md:text-xl font-bold text-purple-600 dark:text-purple-400 mt-1 line-clamp-1" id="stat-top">-</h3>
                    <p class="text-[10px] text-gray-400 mt-2">Frekuensi Tertinggi</p>
                    <i class="fa-solid fa-ranking-star absolute bottom-4 right-4 text-4xl text-gray-200 dark:text-slate-700/50"></i>
                </div>
                <!-- Card 4 -->
                <div class="glass p-4 rounded-2xl shadow-lg relative overflow-hidden group hover:-translate-y-1 transition-all duration-300">
                    <div class="absolute right-0 top-0 w-24 h-24 bg-orange-500/10 rounded-bl-full transition-all group-hover:scale-110"></div>
                    <p class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">Penyelesaian</p>
                    <h3 class="text-2xl md:text-3xl font-bold text-orange-600 dark:text-orange-400 mt-1" id="stat-status">0%</h3>
                    <p class="text-[10px] text-gray-400 mt-2">Kasus Selesai</p>
                    <i class="fa-solid fa-check-double absolute bottom-4 right-4 text-4xl text-gray-200 dark:text-slate-700/50"></i>
                </div>
            </div>

            <div id="ai-smart-insight" class="bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 rounded-2xl p-4 mb-6 shadow-lg shadow-purple-500/30 text-white flex items-center gap-4 animate-slide-in hide">
                <div class="bg-white/20 p-3 rounded-full backdrop-blur-sm animate-pulse-fast">
                    <i class="fa-solid fa-wand-magic-sparkles text-xl text-yellow-300"></i>
                </div>
                <div>
                    <h4 class="text-sm font-bold tracking-wide uppercase text-white/90">AI Smart Insight</h4>
                    <p id="ai-insight-text" class="text-sm font-medium mt-0.5">Menganalisis pola layanan siswa...</p>
                </div>
            </div>
			
			<div id="hot-zone-klasemen" class="glass rounded-2xl p-5 mb-6 shadow-lg border-l-4 border-orange-500 hide animate-slide-in">
                <div class="flex justify-between items-center border-b dark:border-white/10 border-slate-200 pb-3 mb-4">
                    <h3 class="text-sm md:text-base font-bold text-orange-600 dark:text-orange-400 uppercase tracking-wider flex items-center gap-2">
                        <i class="fa-solid fa-fire-flame-curved animate-pulse"></i> Klasemen Kerawanan Kelas
                    </h3>
                    <span class="text-[10px] bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-400 px-2 py-1 rounded font-bold border border-orange-200 dark:border-orange-800 shadow-sm">Top Kelas</span>
                </div>
                <div id="klasemen-list" class="space-y-3 max-h-[250px] overflow-y-auto custom-scroll pr-2">
                    <p class="text-xs text-center text-slate-400">Menganalisis data kelas...</p>
                </div>
            </div>

            <div id="bidang-layanan-klasemen" class="glass rounded-2xl p-5 mb-8 shadow-lg border-l-4 border-purple-500 hide animate-slide-in">
                <div class="flex justify-between items-center border-b dark:border-white/10 border-slate-200 pb-3 mb-4">
                    <h3 class="text-sm md:text-base font-bold text-purple-600 dark:text-purple-400 uppercase tracking-wider flex items-center gap-2">
                        <i class="fa-solid fa-chart-pie animate-pulse"></i> Klasemen Bidang Masalah
                    </h3>
                    <span class="text-[10px] bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-400 px-2 py-1 rounded font-bold border border-purple-200 dark:border-purple-800 shadow-sm">Distribusi Bidang</span>
                </div>
                <div id="bidang-list" class="space-y-3 max-h-[250px] overflow-y-auto custom-scroll pr-2">
                    <p class="text-xs text-center text-slate-400">Menganalisis data bidang...</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                
                <div class="glass p-5 rounded-2xl shadow-lg relative overflow-hidden lg:col-span-2 flex flex-col">
                    <div class="flex justify-between items-center mb-4 border-b dark:border-white/10 border-slate-200 pb-2">
                        <h3 class="text-sm font-bold dark:text-white text-slate-700 uppercase tracking-wider">Analitik Layanan</h3>
                        <button onclick="toggleChartType()" class="text-xs bg-slate-100 dark:bg-slate-700 px-3 py-1 rounded-full hover:bg-slate-200 transition text-slate-600 dark:text-white font-medium shadow-sm">
                            <i class="fa-solid fa-chart-pie mr-1"></i> Ganti Tampilan
                        </button>
                    </div>
                    <div class="h-64 w-full flex-1">
                        <canvas id="statsChart"></canvas>
                    </div>
                </div>

                <div class="glass p-5 rounded-2xl shadow-lg relative overflow-hidden flex flex-col h-[350px]">
                    <div class="flex justify-between items-center mb-4 border-b dark:border-white/10 border-slate-200 pb-2">
                        <h3 class="text-sm font-bold text-red-500 uppercase tracking-wider flex items-center gap-2">
                            <i class="fa-solid fa-triangle-exclamation animate-pulse"></i> Early Warning
                        </h3>
                    </div>
                    <div id="early-warning-list" class="flex-1 overflow-y-auto custom-scroll space-y-3 pr-2">
                        <p class="text-xs text-center text-slate-400 mt-10">Memuat data risiko...</p>
                    </div>
                </div>

            </div>

            <!-- MENU GRID (GROUPED) -->
            <!-- KELOMPOK 1 -->
			
			<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div class="glass p-5 rounded-2xl shadow-lg relative flex flex-col h-[350px]">
                    <div class="flex justify-between items-center mb-4 border-b dark:border-white/10 border-slate-200 pb-2">
                        <h3 class="text-sm font-bold dark:text-white text-slate-700 uppercase tracking-wider flex items-center gap-2">
                            <i class="fa-solid fa-user-check text-green-500"></i> Siswa Terbantu
                        </h3>
                        <span id="badge-total-siswa" class="text-[10px] bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400 px-2 py-1 rounded font-bold border border-green-200 dark:border-green-800">0 Siswa</span>
                    </div>
                    <div id="helped-students-list" class="flex-1 overflow-y-auto custom-scroll space-y-3 pr-2">
                        <p class="text-xs text-center text-slate-400 mt-10">Merekap data siswa...</p>
                    </div>
                </div>

                <div class="glass p-5 rounded-2xl shadow-lg relative flex flex-col h-[350px]">
                    <div class="flex justify-between items-center mb-4 border-b dark:border-white/10 border-slate-200 pb-2">
                        <h3 class="text-sm font-bold dark:text-white text-slate-700 uppercase tracking-wider flex items-center gap-2">
                            <i class="fa-solid fa-list-check text-blue-500"></i> Rincian Seluruh Layanan
                        </h3>
                        <span class="text-[10px] text-slate-400">Total 10 Kategori</span>
                    </div>
                    <div id="all-services-list" class="flex-1 overflow-y-auto custom-scroll space-y-2 pr-2">
                        <p class="text-xs text-center text-slate-400 mt-10">Merekap data layanan...</p>
                    </div>
                </div>
            </div>
			
			<div class="mb-8 flex justify-center">
                <button onclick="runAiForecast()" class="group relative px-8 py-3 bg-gradient-to-r from-purple-600 via-indigo-600 to-blue-600 text-white rounded-2xl font-bold shadow-xl shadow-indigo-500/20 hover:scale-105 transition-all duration-300 btn-press flex items-center gap-3 overflow-hidden">
                    <div class="absolute inset-0 bg-white/20 group-hover:translate-x-full transition-transform duration-700 -skew-x-12"></div>
                    <i class="fa-solid fa-crystal-ball animate-spin-slow text-xl"></i>
                    <span>PREDIKSI TREN & ANALISIS PREVENTIF (AI)</span>
                </button>
            </div>
			
            <div class="mb-8">
                <div class="flex items-center gap-4 mb-4">
                    <div class="h-px bg-gray-300 dark:bg-gray-700 flex-1"></div>
                    <h3 class="text-lg font-bold text-slate-600 dark:text-blue-200 uppercase tracking-widest text-center">Layanan Utama</h3>
                    <div class="h-px bg-gray-300 dark:bg-gray-700 flex-1"></div>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
                    <div onclick="openService('7_Layanan_Individu', 'Konseling Individu')" class="glass hover:bg-white/20 dark:hover:bg-white/10 p-6 rounded-2xl shadow-lg flex flex-col items-center justify-center gap-4 cursor-pointer transition-all duration-300 border-t-4 border-blue-400 btn-press group bg-white/60 dark:bg-transparent hover:-translate-y-1 hover:shadow-xl">
                        <div class="w-16 h-16 rounded-2xl bg-blue-500/20 flex items-center justify-center group-hover:bg-blue-500 group-hover:scale-110 transition-all duration-300 shadow-lg shadow-blue-500/10">
                            <i class="fa-solid fa-user-shield text-3xl text-blue-600 dark:text-blue-200 group-hover:text-white transition-colors"></i>
                        </div>
                        <span class="text-sm md:text-base font-semibold dark:text-white text-slate-700 text-center z-10">Konseling Individu</span>
                    </div>
                    <div onclick="openService('8_Layanan_Kelompok', 'Konseling Kelompok')" class="glass hover:bg-white/20 dark:hover:bg-white/10 p-6 rounded-2xl shadow-lg flex flex-col items-center justify-center gap-4 cursor-pointer transition-all duration-300 border-t-4 border-green-400 btn-press group bg-white/60 dark:bg-transparent hover:-translate-y-1 hover:shadow-xl">
                        <div class="w-16 h-16 rounded-2xl bg-green-500/20 flex items-center justify-center group-hover:bg-green-500 group-hover:scale-110 transition-all duration-300 shadow-lg shadow-green-500/10">
                            <i class="fa-solid fa-users-rays text-3xl text-green-600 dark:text-green-200 group-hover:text-white transition-colors"></i>
                        </div>
                        <span class="text-sm md:text-base font-semibold dark:text-white text-slate-700 text-center z-10">Konseling Kelompok</span>
                    </div>
                    <div onclick="openService('9_Bimbingan_Kelompok', 'Bimbingan Kelompok')" class="glass hover:bg-white/20 dark:hover:bg-white/10 p-6 rounded-2xl shadow-lg flex flex-col items-center justify-center gap-4 cursor-pointer transition-all duration-300 border-t-4 border-purple-400 btn-press group bg-white/60 dark:bg-transparent hover:-translate-y-1 hover:shadow-xl">
                        <div class="w-16 h-16 rounded-2xl bg-purple-500/20 flex items-center justify-center group-hover:bg-purple-500 group-hover:scale-110 transition-all duration-300 shadow-lg shadow-purple-500/10">
                            <i class="fa-solid fa-chalkboard-user text-3xl text-purple-600 dark:text-purple-200 group-hover:text-white transition-colors"></i>
                        </div>
                        <span class="text-sm md:text-base font-semibold dark:text-white text-slate-700 text-center z-10">Bimbingan Kelompok</span>
                    </div>
                    <div onclick="openService('11_Layanan_Klasikal', 'Layanan Klasikal')" class="glass hover:bg-white/20 dark:hover:bg-white/10 p-6 rounded-2xl shadow-lg flex flex-col items-center justify-center gap-4 cursor-pointer transition-all duration-300 border-t-4 border-red-400 btn-press group bg-white/60 dark:bg-transparent hover:-translate-y-1 hover:shadow-xl">
                        <div class="w-16 h-16 rounded-2xl bg-red-500/20 flex items-center justify-center group-hover:bg-red-500 group-hover:scale-110 transition-all duration-300 shadow-lg shadow-red-500/10">
                            <i class="fa-solid fa-person-chalkboard text-3xl text-red-600 dark:text-red-200 group-hover:text-white transition-colors"></i>
                        </div>
                        <span class="text-sm md:text-base font-semibold dark:text-white text-slate-700 text-center z-10">Layanan Klasikal</span>
                    </div>
                </div>
            </div>
			

            <!-- KELOMPOK 2 -->
            <div class="mb-8">
                <div class="flex items-center gap-4 mb-4">
                    <div class="h-px bg-gray-300 dark:bg-gray-700 flex-1"></div>
                    <h3 class="text-lg font-bold text-slate-600 dark:text-blue-200 uppercase tracking-widest text-center">Layanan Responsif</h3>
                    <div class="h-px bg-gray-300 dark:bg-gray-700 flex-1"></div>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
                    <div onclick="openService('12_Konferensi_Kasus', 'Konferensi Kasus')" class="glass hover:bg-white/20 dark:hover:bg-white/10 p-6 rounded-2xl shadow-lg flex flex-col items-center justify-center gap-4 cursor-pointer transition-all duration-300 border-t-4 border-cyan-400 btn-press group bg-white/60 dark:bg-transparent hover:-translate-y-1 hover:shadow-xl">
                        <div class="w-16 h-16 rounded-2xl bg-cyan-500/20 flex items-center justify-center group-hover:bg-cyan-500 group-hover:scale-110 transition-all duration-300 shadow-lg shadow-cyan-500/10">
                            <i class="fa-solid fa-users-gear text-3xl text-cyan-600 dark:text-cyan-200 group-hover:text-white transition-colors"></i>
                        </div>
                        <span class="text-sm md:text-base font-semibold dark:text-white text-slate-700 text-center z-10">Konferensi Kasus</span>
                    </div>
                    <div onclick="openService('13_Alih_Tangan_Kasus', 'Alih Tangan Kasus')" class="glass hover:bg-white/20 dark:hover:bg-white/10 p-6 rounded-2xl shadow-lg flex flex-col items-center justify-center gap-4 cursor-pointer transition-all duration-300 border-t-4 border-teal-400 btn-press group bg-white/60 dark:bg-transparent hover:-translate-y-1 hover:shadow-xl">
                        <div class="w-16 h-16 rounded-2xl bg-teal-500/20 flex items-center justify-center group-hover:bg-teal-500 group-hover:scale-110 transition-all duration-300 shadow-lg shadow-teal-500/10">
                            <i class="fa-solid fa-share-from-square text-3xl text-teal-600 dark:text-teal-200 group-hover:text-white transition-colors"></i>
                        </div>
                        <span class="text-sm md:text-base font-semibold dark:text-white text-slate-700 text-center z-10">Alih Tangan Kasus</span>
                    </div>
                    <div onclick="openService('14_Mediasi', 'Mediasi')" class="glass hover:bg-white/20 dark:hover:bg-white/10 p-6 rounded-2xl shadow-lg flex flex-col items-center justify-center gap-4 cursor-pointer transition-all duration-300 border-t-4 border-pink-400 btn-press group bg-white/60 dark:bg-transparent hover:-translate-y-1 hover:shadow-xl">
                        <div class="w-16 h-16 rounded-2xl bg-pink-500/20 flex items-center justify-center group-hover:bg-pink-500 group-hover:scale-110 transition-all duration-300 shadow-lg shadow-pink-500/10">
                            <i class="fa-solid fa-handshake-angle text-3xl text-pink-600 dark:text-pink-200 group-hover:text-white transition-colors"></i>
                        </div>
                        <span class="text-sm md:text-base font-semibold dark:text-white text-slate-700 text-center z-10">Mediasi</span>
                    </div>
                    <div onclick="openService('15_Advokasi', 'Advokasi')" class="glass hover:bg-white/20 dark:hover:bg-white/10 p-6 rounded-2xl shadow-lg flex flex-col items-center justify-center gap-4 cursor-pointer transition-all duration-300 border-t-4 border-indigo-400 btn-press group bg-white/60 dark:bg-transparent hover:-translate-y-1 hover:shadow-xl">
                        <div class="w-16 h-16 rounded-2xl bg-indigo-500/20 flex items-center justify-center group-hover:bg-indigo-500 group-hover:scale-110 transition-all duration-300 shadow-lg shadow-indigo-500/10">
                            <i class="fa-solid fa-gavel text-3xl text-indigo-600 dark:text-indigo-200 group-hover:text-white transition-colors"></i>
                        </div>
                        <span class="text-sm md:text-base font-semibold dark:text-white text-slate-700 text-center z-10">Advokasi</span>
                    </div>
                </div>
            </div>

            <!-- KELOMPOK 3 -->
            <div class="mb-8">
                <div class="flex items-center gap-4 mb-4">
                    <div class="h-px bg-gray-300 dark:bg-gray-700 flex-1"></div>
                    <h3 class="text-lg font-bold text-slate-600 dark:text-blue-200 uppercase tracking-widest text-center">Dukungan Sistem</h3>
                    <div class="h-px bg-gray-300 dark:bg-gray-700 flex-1"></div>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4 md:gap-6">
                    <div onclick="openService('10_Konsultasi', 'Konsultasi')" class="glass hover:bg-white/20 dark:hover:bg-white/10 p-6 rounded-2xl shadow-lg flex flex-col items-center justify-center gap-4 cursor-pointer transition-all duration-300 border-t-4 border-orange-400 btn-press group bg-white/60 dark:bg-transparent hover:-translate-y-1 hover:shadow-xl">
                        <div class="w-16 h-16 rounded-2xl bg-orange-500/20 flex items-center justify-center group-hover:bg-orange-500 group-hover:scale-110 transition-all duration-300 shadow-lg shadow-orange-500/10">
                            <i class="fa-solid fa-handshake-simple text-3xl text-orange-600 dark:text-orange-200 group-hover:text-white transition-colors"></i>
                        </div>
                        <span class="text-sm md:text-base font-semibold dark:text-white text-slate-700 text-center z-10">Konsultasi</span>
                    </div>
                    <div onclick="openService('16_Dukungan_Sistem', 'Dukungan Sistem')" class="glass hover:bg-white/20 dark:hover:bg-white/10 p-6 rounded-2xl shadow-lg flex flex-col items-center justify-center gap-4 cursor-pointer transition-all duration-300 border-t-4 border-slate-400 btn-press group bg-white/60 dark:bg-transparent hover:-translate-y-1 hover:shadow-xl">
                        <div class="w-16 h-16 rounded-2xl bg-slate-500/20 flex items-center justify-center group-hover:bg-slate-500 group-hover:scale-110 transition-all duration-300 shadow-lg shadow-slate-500/10">
                            <i class="fa-solid fa-network-wired text-3xl text-slate-600 dark:text-slate-200 group-hover:text-white transition-colors"></i>
                        </div>
                        <span class="text-sm md:text-base font-semibold dark:text-white text-slate-700 text-center z-10">Dukungan Sistem</span>
                    </div>
                    <div onclick="showAbout()" class="glass hover:bg-white/20 dark:hover:bg-white/10 p-6 rounded-2xl shadow-lg flex flex-col items-center justify-center gap-4 cursor-pointer transition-all duration-300 border-t-4 border-gray-400 btn-press group bg-white/60 dark:bg-transparent hover:-translate-y-1 hover:shadow-xl">
                        <div class="w-16 h-16 rounded-2xl bg-gray-500/20 flex items-center justify-center group-hover:bg-gray-500 group-hover:scale-110 transition-all duration-300 shadow-lg shadow-gray-500/10">
                            <i class="fa-solid fa-circle-info text-3xl text-gray-600 dark:text-gray-200 group-hover:text-white transition-colors"></i>
                        </div>
                        <span class="text-sm md:text-base font-semibold dark:text-white text-slate-700 text-center z-10">Info Aplikasi</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- 3. SERVICE DETAIL (WITH DATE FILTER & PAGINATION) -->
        <section id="page-service" class="hide flex-1 pb-10 flex flex-col h-screen">
            <!-- Title Bar & Toolbar -->
            <div class="flex-none flex flex-col gap-4 mb-4 pt-2">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <h2 id="service-title" class="text-2xl font-bold dark:text-white text-slate-800 drop-shadow-md">Judul Layanan</h2>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="px-2 py-0.5 rounded text-[10px] bg-green-500/20 text-green-600 dark:text-green-300 border border-green-500/30">Active</span>
                            <p class="dark:text-blue-200 text-slate-500 text-xs">Mappaguru Online</p>
                        </div>
                    </div>
                    
                    <!-- NEW: DATE FILTER INPUTS -->
                    <div class="flex flex-col md:flex-row gap-2 bg-white/50 dark:bg-slate-800/50 p-2 rounded-xl border border-gray-200 dark:border-slate-700 backdrop-blur-sm">
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-bold text-gray-500 uppercase">Filter Tgl:</span>
                            <input type="date" id="filter-start" onchange="renderDataList()" class="p-1 rounded border border-gray-300 text-xs text-slate-700 dark:bg-slate-700 dark:text-white">
                            <span class="text-xs">-</span>
                            <input type="date" id="filter-end" onchange="renderDataList()" class="p-1 rounded border border-gray-300 text-xs text-slate-700 dark:bg-slate-700 dark:text-white">
                        </div>
                    </div>

                    <div class="flex gap-2 flex-wrap">
                        <button onclick="exportExcel()" class="bg-green-600 hover:bg-green-500 text-white px-3 py-2 rounded-xl text-sm font-bold shadow-lg transition btn-press flex items-center gap-2" title="Download Excel">
                            <i class="fa-solid fa-file-excel"></i> <span class="hidden md:inline">Excel</span>
                        </button>
                        <button onclick="printRecap()" class="glass hover:bg-white/20 dark:text-white text-slate-700 px-3 py-2 rounded-xl text-sm font-semibold transition flex items-center gap-2 border border-slate-300 dark:border-white/20" title="Cetak Rekap Sesuai Filter">
                            <i class="fa-solid fa-print"></i> <span class="hidden md:inline">Rekap</span>
                        </button>
                        <button onclick="showForm()" class="bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-lg transition btn-press flex items-center gap-2">
                            <i class="fa-solid fa-plus"></i> <span class="hidden md:inline">Input</span>
                        </button>
                    </div>
                </div>

                <div class="relative w-full">
                    <i class="fa-solid fa-search absolute left-4 top-3 text-gray-400"></i>
                    <input type="text" id="service-search" onkeyup="renderDataList()" placeholder="Cari data (Nama, Kelas, Masalah)..." 
                           class="w-full pl-10 pr-4 py-2.5 rounded-xl border border-gray-300 dark:border-gray-600 bg-white/80 dark:bg-slate-800/50 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none transition shadow-sm">
                </div>
            </div>

            <!-- Data List Container with Scroll -->
            <div id="data-container" class="flex-1 overflow-y-auto space-y-4 pr-2 custom-scroll mb-4">
                <!-- Data or Skeleton will be injected here -->
            </div>

            <!-- PAGINATION CONTROLS -->
            <div id="pagination-controls" class="flex flex-col md:flex-row justify-between items-center gap-4 p-4 bg-white/90 dark:bg-slate-800/90 backdrop-blur-md border-t dark:border-slate-700 rounded-t-2xl shadow-[0_-5px_20px_rgba(0,0,0,0.05)] sticky bottom-0 z-20">
                <div class="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-300">
                    <span>Tampil:</span>
                    <select id="rows-per-page" onchange="changeRowsPerPage()" class="bg-gray-100 dark:bg-slate-700 border border-gray-300 dark:border-slate-600 rounded px-2 py-1 focus:outline-none">
                        <option value="5">5</option>
                        <option value="10" selected>10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                        <option value="all">Semua</option>
                    </select>
                    <span id="showing-info" class="hidden md:inline ml-2">Menampilkan 0-0 dari 0</span>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="changePage(-1)" id="btn-prev" class="px-3 py-1.5 rounded-lg bg-gray-200 dark:bg-slate-700 hover:bg-gray-300 dark:hover:bg-slate-600 disabled:opacity-50 transition"><i class="fa-solid fa-chevron-left"></i></button>
                    <span id="page-info" class="text-sm font-bold mx-2">Page 1</span>
                    <button onclick="changePage(1)" id="btn-next" class="px-3 py-1.5 rounded-lg bg-gray-200 dark:bg-slate-700 hover:bg-gray-300 dark:hover:bg-slate-600 disabled:opacity-50 transition"><i class="fa-solid fa-chevron-right"></i></button>
                </div>
            </div>
        </section>

        <!-- FEATURE 3: STUDENT PROFILE TIMELINE -->
        <section id="page-student-profile" class="hide flex-1 pb-10 flex flex-col">
            <div class="flex-none mb-6">
                <button onclick="goHome()" class="text-sm text-blue-500 hover:underline mb-2"><i class="fa-solid fa-arrow-left"></i> Kembali ke Dashboard</button>
                
                <div class="flex justify-between items-center mt-2">
                    <h2 class="text-2xl font-bold dark:text-white text-slate-800">Riwayat Layanan Siswa</h2>
                    <button id="btn-print-profile" class="hidden bg-gradient-to-r from-purple-500 to-pink-500 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-lg hover:shadow-pink-500/30 transition hover:-translate-y-1 items-center gap-2">
                        <i class="fa-solid fa-file-pdf"></i> <span class="hidden md:inline">Cetak Profil</span>
                    </button>
                </div>

                <div class="glass p-4 rounded-xl mt-4 flex items-center gap-4">
                    <div class="w-16 h-16 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center text-3xl">
                        <i class="fa-solid fa-user-graduate dark:text-white text-slate-500"></i>
                    </div>
                    <div>
                        <h3 id="profile-name" class="text-xl font-bold dark:text-white text-slate-800">Nama Siswa</h3>
                        <p id="profile-class" class="text-sm dark:text-blue-200 text-slate-500">Kelas -</p>
                    </div>
                </div>
            </div>

            <div id="timeline-container" class="flex-1 overflow-y-auto pr-2 custom-scroll relative timeline-line pl-4 max-h-[60vh]"></div>
        </section>

        <!-- 4. MODAL FORM -->
        <section id="page-form" class="hide flex-1 pb-10 flex flex-col h-full animate-fade-in-up relative z-10">
            <div class="flex-none mb-4">
                <button type="button" onclick="closeForm()" class="text-sm font-bold text-slate-500 hover:text-blue-500 dark:text-slate-400 dark:hover:text-blue-400 transition flex items-center gap-2 px-3 py-1.5 rounded-lg hover:bg-slate-200/50 dark:hover:bg-slate-800/50 w-max">
                    <i class="fa-solid fa-arrow-left"></i> Batal & Kembali
                </button>
            </div>

            <div class="bg-white/80 dark:bg-slate-900/80 backdrop-blur-md w-full rounded-3xl shadow-xl overflow-hidden border border-gray-200 dark:border-slate-700 flex-1 flex flex-col">
                
                <div class="bg-gradient-to-r from-blue-600 to-indigo-700 p-6 md:p-8 flex justify-between items-center text-white shadow-md relative overflow-hidden">
                    <div class="absolute -right-10 -top-10 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
                    <div class="absolute -left-10 -bottom-10 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
                    
                    <div class="flex items-center gap-4 relative z-10">
                        <div class="bg-white/20 p-3 rounded-xl backdrop-blur-sm shadow-inner"><i class="fa-solid fa-file-signature text-xl"></i></div>
                        <div>
                            <h3 class="font-bold text-xl md:text-2xl tracking-wide" id="form-header">Input Data</h3>
                            <p class="text-blue-100 text-xs mt-1" id="form-sub-header">Silakan lengkapi formulir di bawah ini</p>
                        </div>
                    </div>
                </div>
                
                <div class="flex-1 overflow-y-auto custom-scroll p-6 md:p-10 bg-slate-50/50 dark:bg-slate-900/50">
                    <form id="dynamic-form" onsubmit="handleSave(event)" class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-8">
                        </form>
                </div>

                <div class="p-5 md:p-6 bg-white dark:bg-slate-800 border-t border-gray-200 dark:border-slate-700 flex justify-between items-center z-10 shadow-[0_-5px_20px_rgba(0,0,0,0.05)]">
                    <p class="text-xs text-slate-500 dark:text-slate-400 hidden md:block">Pastikan data sudah benar sebelum menyimpan.</p>
                    <div class="flex gap-4 w-full md:w-auto justify-end">
                        <button type="button" onclick="document.getElementById('dynamic-form').requestSubmit()" class="w-full md:w-auto px-8 py-3 rounded-xl bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-bold shadow-lg shadow-blue-500/30 transition-all hover:-translate-y-1 btn-press flex items-center justify-center gap-2">
                            <i class="fa-solid fa-save"></i> SIMPAN DATA
                        </button>
                    </div>
                </div>

            </div>
        </section>

        <!-- PROFESSIONAL APP FOOTER -->
        <footer id="app-footer" class="hide mt-auto pt-6 pb-2">
            <div class="text-center">
                <div class="inline-flex items-center gap-2 px-4 py-1 rounded-full bg-white/5 border dark:border-white/5 border-slate-200 backdrop-blur-sm">
                    <span class="text-[10px] dark:text-slate-400 text-slate-500 font-light">Sistem Informasi Administrasi & Pelayanan BK</span>
                    <span class="w-1 h-1 rounded-full bg-slate-500"></span>
                    <span class="text-[10px] dark:text-slate-400 text-slate-500 font-light">Build 2026</span>
                </div>
                <p class="text-[10px] text-slate-500 mt-2 font-light">Developed with <i class="fa-solid fa-heart text-red-500 text-[8px] mx-0.5"></i> by Muhammad Hasratul</p>
            </div>
        </footer>

    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbxJLO0Koh8hXqbul3ILVkO-I7caseyH2KXZzcfYKqTGXn938t_YPBdQPiWV7D9Td-s/exec"; 

        // State
        let currentUser = null;
        let currentSheet = "";
        let currentTitle = "";
        let metaData = {};
        let activeDataList = [];
        let editMode = false;
        let editId = null;
        let cachedAllServices = null; 
        let chartType = 'bar'; // State for chart toggle

        // Pagination & Filter
        let currentPage = 1;
        let rowsPerPage = 10;
        let filteredData = []; 

        // --- THEME ---
        function toggleTheme() {
            const html = document.documentElement, body = document.body, icon = document.getElementById('theme-icon');
            if (html.classList.contains('dark')) {
                html.classList.remove('dark'); html.classList.add('light');
                body.classList.remove('bg-custom-dark'); body.classList.add('bg-custom-light');
                icon.className = 'fa-solid fa-moon'; localStorage.setItem('theme', 'light');
            } else {
                html.classList.add('dark'); html.classList.remove('light');
                body.classList.add('bg-custom-dark'); body.classList.remove('bg-custom-light');
                icon.className = 'fa-solid fa-sun'; localStorage.setItem('theme', 'dark');
            }
        }
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            const body = document.getElementById('main-body') || document.body;
            if (savedTheme === 'light') {
                document.documentElement.classList.remove('dark'); document.documentElement.classList.add('light');
                body.classList.remove('bg-custom-dark'); body.classList.add('bg-custom-light');
            }
        })();

        // --- UTILS ---
        function togglePasswordVisibility() {
            const pwdInput = document.getElementById('login-password'), icon = document.getElementById('eye-icon');
            if (pwdInput.type === 'password') { pwdInput.type = 'text'; icon.classList.remove('fa-eye-slash'); icon.classList.add('fa-eye'); } 
            else { pwdInput.type = 'password'; icon.classList.remove('fa-eye'); icon.classList.add('fa-eye-slash'); }
        }

        const getBase64FromUrl = async (url) => {
            if(!url) return null;
            try { const data = await fetch(url); const blob = await data.blob(); return new Promise((resolve) => { const reader = new FileReader(); reader.readAsDataURL(blob); reader.onloadend = () => resolve(reader.result); }); } catch (e) { console.warn("Image Error:", url); return null; }
        };

        const toProperCase = (str) => { if(!str) return ''; return str.replace(/\w\S*/g, function(txt){ return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase(); }); };
        const getItemDate = (item) => item['Tanggal_Layanan'] || item['Tanggal'] || item['Tanggal_Kegiatan'];

        // --- NEW HELPER: FORMAT TANGGAL INDONESIA ---
        const formatTanggalIndo = (dateStr) => {
            if(!dateStr) return '-';
            const d = new Date(dateStr);
            if(isNaN(d.getTime())) return dateStr;
            return d.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
        };

        // --- NEW: TOAST NOTIFICATION ---
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const colorClass = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            const iconClass = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
            
            toast.className = `flex items-center gap-3 px-4 py-3 rounded-xl shadow-2xl text-white font-medium transform transition-all duration-300 translate-x-10 opacity-0 ${colorClass} min-w-[300px] animate-slide-in`;
            toast.innerHTML = `<i class="fa-solid ${iconClass} text-xl"></i><span>${message}</span>`;
            
            container.appendChild(toast);
            
            // Remove after 3s
            setTimeout(() => {
                toast.classList.add('animate-fade-out');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // --- NEW: SKELETON LOADING ---
        function renderSkeleton() {
            const container = document.getElementById('data-container');
            container.innerHTML = '';
            // Render 5 skeletons
            for(let i=0; i<5; i++) {
                const skel = document.createElement('div');
                skel.className = "bg-white/50 dark:bg-slate-800/50 rounded-xl p-5 shadow-sm border border-gray-100 dark:border-slate-700 flex flex-col md:flex-row gap-4";
                skel.innerHTML = `
                    <div class="flex-1 space-y-3">
                        <div class="h-4 bg-gray-200 dark:bg-slate-700 rounded w-1/4 skeleton"></div>
                        <div class="h-6 bg-gray-200 dark:bg-slate-700 rounded w-3/4 skeleton"></div>
                        <div class="h-4 bg-gray-200 dark:bg-slate-700 rounded w-1/2 skeleton"></div>
                    </div>
                    <div class="flex gap-2">
                        <div class="w-10 h-10 bg-gray-200 dark:bg-slate-700 rounded-lg skeleton"></div>
                        <div class="w-10 h-10 bg-gray-200 dark:bg-slate-700 rounded-lg skeleton"></div>
                    </div>
                `;
                container.appendChild(skel);
            }
        }

        // --- NEW: PERSONAL GREETING ---
        function updateGreeting() {
            if(!currentUser) return;
            const hour = new Date().getHours();
            let greet = "Selamat Pagi";
            if(hour >= 12 && hour < 15) greet = "Selamat Siang";
            else if(hour >= 15 && hour < 18) greet = "Selamat Sore";
            else if(hour >= 18) greet = "Selamat Malam";
            
            const firstName = currentUser.nama.split(',')[0].split(' ')[0];
            document.getElementById('greeting-text').innerHTML = `<span class="text-blue-500 font-bold">${greet}, Pak/Bu ${firstName}!</span> Siap melayani siswa hari ini?`;
        }

        // --- NEW: REFRESH APP ---
        async function refreshApp() {
            const btn = document.getElementById('btn-refresh');
            if(btn) btn.classList.add('animate-spin');
            
            // note+++ KOSONGKAN CACHE SECARA PAKSA SAAT TOMBOL REFRESH DITEKAN
            cachedAllServices = null;
            
            // Refresh Metadata & Stats
            await initApp();
            
            // If currently viewing a sheet, refresh that list too
            if(!document.getElementById('page-service').classList.contains('hide') && currentSheet) {
                await openService(currentSheet, currentTitle);
            } 
            
            if(btn) btn.classList.remove('animate-spin');
            showToast('Data berhasil diperbarui');
        }

        // --- NAVIGATION ---
        function showSection(id) {
            document.querySelectorAll('section').forEach(el => el.classList.add('hide'));
            const target = document.getElementById(id);
            target.classList.remove('hide');
            target.classList.add('animate-[fadeIn_0.5s_ease-out]');
            
            if(id === 'page-login') {
                document.getElementById('app-header').classList.add('hide');
                document.getElementById('app-footer').classList.add('hide');
                document.getElementById('btn-back').classList.add('hide');
            } else {
                document.getElementById('app-header').classList.remove('hide');
                document.getElementById('app-footer').classList.remove('hide');
                if(id === 'page-dashboard') document.getElementById('btn-back').classList.add('hide');
                else document.getElementById('btn-back').classList.remove('hide');
            }
        }

        function goHome() {
            showSection('page-dashboard');
            currentSheet = "";
            loadDashboardStats();
        }

        function logout() {
            Swal.fire({
                title: '<span class="text-2xl font-bold dark:text-white text-slate-800">Akhiri Sesi?</span>',
                html: '<p class="text-sm text-slate-500 dark:text-slate-400 mt-2">Pastikan semua laporan layanan siswa hari ini sudah Anda simpan.</p>',
                icon: 'question',
                iconColor: '#3b82f6',
                showCancelButton: true,
                confirmButtonText: '<i class="fa-solid fa-power-off mr-2"></i>Ya, Keluar',
                cancelButtonText: 'Batal',
                buttonsStyling: false,
                customClass: {
                    popup: 'rounded-[2rem] border border-slate-200 dark:border-slate-700 bg-white/90 dark:bg-slate-900/90 backdrop-blur-xl shadow-2xl',
                    confirmButton: 'px-6 py-3 bg-gradient-to-r from-red-500 to-rose-600 text-white font-bold rounded-xl shadow-lg hover:shadow-red-500/30 transition-all hover:-translate-y-1 mx-2 btn-press',
                    cancelButton: 'px-6 py-3 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 font-bold rounded-xl transition-all hover:bg-slate-200 dark:hover:bg-slate-700 border border-slate-200 dark:border-slate-700 mx-2 btn-press'
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    currentUser = null;
                    localStorage.removeItem('bk_user');
                    showSection('page-login');
                    
                    // Alert Dadah!
                    Swal.fire({
                        icon: 'success',
                        title: '<span class="text-lg font-bold dark:text-white text-slate-800">Sampai Jumpa!</span>',
                        showConfirmButton: false,
                        timer: 1500,
                        customClass: { popup: 'rounded-[2rem] border border-slate-200 dark:border-slate-700 bg-white/90 dark:bg-slate-900/90 backdrop-blur-xl shadow-lg w-auto' }
                    });
                }
            })
        }
		
		// --- POPUP INFO LOGIN (KHUSUS MOBILE) ---
        function showMobileInfo() {
            Swal.fire({
                title: '<span class="text-indigo-600 font-bold">SIAP-BK PRO</span>',
                html: `
                    <div class="text-left text-sm text-slate-600 dark:text-slate-300">
                        <p class="font-bold text-slate-800 dark:text-white mb-2 border-b pb-2">UPT SPF SMP Negeri 16 Makassar</p>
                        <p class="mb-3">Sistem Informasi Administrasi & Pelayanan Bimbingan Konseling. Platform digital modern dengan dukungan Kecerdasan Buatan (AI).</p>
                        <ul class="space-y-2">
                            <li><i class="fa-solid fa-check text-green-500 mr-2"></i> AI Smart Analytics</li>
                            <li><i class="fa-solid fa-check text-green-500 mr-2"></i> Automated Reporting</li>
                            <li><i class="fa-solid fa-check text-green-500 mr-2"></i> Secure Database</li>
                        </ul>
                        <p class="mt-4 text-[10px] text-slate-400 text-center">Build 2026 &copy; Developed by Muhammad Hasratul</p>
                    </div>
                `,
                iconHtml: '<i class="fa-solid fa-shield-halved text-blue-500"></i>',
                customClass: { icon: 'border-none' },
                confirmButtonColor: '#3b82f6',
                confirmButtonText: 'Tutup'
            });
        }

        // --- API CALL DENGAN PENYAMARAN CORS (ANTI BLOKIR) ---
        async function apiCall(params, method = 'GET', body = null) {
            if(params.action === 'login' || params.action === 'getMetadata') document.getElementById('loading').classList.remove('hide');
            
            try {
                let url = API_URL + "?";
                for (const key in params) { url += `${key}=${encodeURIComponent(params[key])}&`; }
                
                let options = { method: method };
                if (method === 'POST') {
                    options.body = JSON.stringify(body);
                    // Trik jitu melewati blokir keamanan Google
                    options.headers = { "Content-Type": "text/plain;charset=utf-8" }; 
                }
                
                const response = await fetch(url, options);
                return await response.json();
            } catch (error) {
                console.error("Error Detail:", error); 
                Swal.fire({ title: "Koneksi Gagal", text: "Cek internet Anda atau URL API.", icon: "error" }); 
                return null;
            } finally { 
                document.getElementById('loading').classList.add('hide'); 
            }
        }

        // --- AUTH ---
        async function handleLogin(e) {
            e.preventDefault();
            const u = document.getElementById('login-username').value;
            const p = document.getElementById('login-password').value;
            if(!u || !p) return;
            
            const res = await apiCall({ action: 'login', username: u, password: p });
            
            if (res && res.status === 'success') {
                currentUser = res.data;
                localStorage.setItem('bk_user', JSON.stringify(currentUser));
                
                //  Alert Mewah Masuk Sukses
                Swal.fire({
                    icon: 'success',
                    iconColor: '#10b981',
                    title: '<span class="text-xl font-bold dark:text-white text-slate-800">Akses Diberikan!</span>',
                    html: `<p class="text-sm text-slate-500 dark:text-slate-400">Selamat bekerja kembali, <strong>${currentUser.nama.split(',')[0]}</strong>.</p>`,
                    showConfirmButton: false,
                    timer: 2000,
                    customClass: { popup: 'rounded-[2rem] border border-slate-200 dark:border-slate-700 bg-white/90 dark:bg-slate-900/90 backdrop-blur-xl shadow-2xl' }
                }).then(() => {
                    initApp();
                });
            } else { 
                //  Alert Mewah Gagal Masuk
                Swal.fire({
                    icon: 'error',
                    iconColor: '#ef4444',
                    title: '<span class="text-xl font-bold dark:text-white text-slate-800">Akses Ditolak</span>',
                    html: `<p class="text-sm text-slate-500 dark:text-slate-400 mt-2">${res?.message || "Username atau password Anda salah."}</p>`,
                    confirmButtonText: '<i class="fa-solid fa-rotate-right mr-2"></i>Coba Lagi',
                    buttonsStyling: false,
                    customClass: {
                        popup: 'rounded-[2rem] border border-slate-200 dark:border-slate-700 bg-white/90 dark:bg-slate-900/90 backdrop-blur-xl shadow-2xl',
                        confirmButton: 'px-8 py-3 bg-slate-800 dark:bg-slate-700 text-white font-bold rounded-xl shadow-lg transition-all hover:-translate-y-1 mt-4 btn-press'
                    }
                }); 
            }
        }

        async function initApp() {
            document.getElementById('user-display').innerText = currentUser.nama.split(',')[0];
            updateGreeting(); // Update Greeting
            
            const meta = await apiCall({ action: 'getMetadata' });
            if(meta && meta.status === 'success') {
                metaData = meta;
                if(meta.sekolah.logo_url) {
                    document.getElementById('header-logo').src = meta.sekolah.logo_url;
                    document.querySelector('#page-login img').src = meta.sekolah.logo_url;
                }
            }
            showSection('page-dashboard');
            loadDashboardStats();
        }

        window.onload = () => {
            const saved = localStorage.getItem('bk_user');
            if (saved) { currentUser = JSON.parse(saved); initApp(); } 
            else { showSection('page-login'); }
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.getElementById('theme-icon').className = savedTheme === 'light' ? 'fa-solid fa-moon' : 'fa-solid fa-sun';
        };

        // --- PREMIUM DASHBOARD LOGIC ---
        const fetchData = async (sheet) => {
            const res = await apiCall({ action: 'getData', sheetName: sheet, username: currentUser.username });
            return res && res.status === 'success' ? res.data : [];
        };

        function toggleChartType() {
            chartType = chartType === 'bar' ? 'doughnut' : 'bar';
            loadDashboardStats();
        }
		
		// --- PENGENDALI SMART FILTER DASHBOARD ---
        function toggleDateFilter() {
            const type = document.getElementById('dashboard-filter-type').value;
            const dateContainer = document.getElementById('dashboard-custom-date');
            
            if (type === 'custom') {
                // Munculkan kotak kalender
                dateContainer.classList.remove('hidden');
                dateContainer.classList.add('flex');
            } else {
                // Sembunyikan kotak kalender
                dateContainer.classList.add('hidden');
                dateContainer.classList.remove('flex');
                // Langsung hitung ulang dashboard jika pilih Ganjil/Genap/Semua
                applyDashboardFilter();
            }
        }

        function applyDashboardFilter() {
            loadDashboardStats(); // Refresh semua angka
        }

        async function loadDashboardStats() {
            const sheets = [
                '7_Layanan_Individu', '8_Layanan_Kelompok', '9_Bimbingan_Kelompok', '10_Konsultasi', '11_Layanan_Klasikal',
                '12_Konferensi_Kasus', '13_Alih_Tangan_Kasus', '14_Mediasi', '15_Advokasi', '16_Dukungan_Sistem'
            ];
            
            // Check cache or fetch
            let results = [];
            if(cachedAllServices) {
                results = sheets.map(s => cachedAllServices[s] || []);
            } else {
                const promises = sheets.map(s => fetchData(s));
                results = await Promise.all(promises);
                cachedAllServices = {};
                sheets.forEach((s, i) => cachedAllServices[s] = results[i]);
            }
			
			// ... (kode caching bapak sebelumnya: results = await Promise.all(promises); dll) ...

            // ==========================================
            // KODE BARU: FILTER SEMESTER & RENTANG TANGGAL
            // ==========================================
            const filterType = document.getElementById('dashboard-filter-type') ? document.getElementById('dashboard-filter-type').value : 'all';
            const startDateVal = document.getElementById('dash-date-start') ? document.getElementById('dash-date-start').value : '';
            const endDateVal = document.getElementById('dash-date-end') ? document.getElementById('dash-date-end').value : '';
            
            // Kita timpa sementara variabel 'results' khusus untuk hitungan dashboard ini
            results = results.map(sheetData => {
                return sheetData.filter(item => {
                    // 1. Jika Semua Waktu, loloskan
                    if (filterType === 'all') return true; 

                    // 2. Jika filter berdasarkan SEMESTER
                    if (filterType === 'Ganjil' || filterType === 'Genap') {
                        // Membaca langsung dari kolom 'Semester' yang Bapak buat di backend!
                        return item['Semester'] === filterType; 
                    }

                    // 3. Jika filter berdasarkan RENTANG TANGGAL (Custom)
                    if (filterType === 'custom') {
                        const dateStr = item['Tanggal_Layanan'] || item['Tanggal'] || item['Tanggal_Kegiatan'];
                        if (!dateStr) return false; 
                        
                        const itemDate = new Date(dateStr);
                        if (isNaN(itemDate.getTime())) return false;
                        
                        // Nol-kan jam agar perbandingan tangal lebih akurat
                        itemDate.setHours(0,0,0,0);
                        let pass = true;
                        
                        if (startDateVal) {
                            let sDate = new Date(startDateVal); sDate.setHours(0,0,0,0);
                            if (itemDate < sDate) pass = false;
                        }
                        if (endDateVal) {
                            let eDate = new Date(endDateVal); eDate.setHours(23,59,59,999); // Akhir hari
                            if (itemDate > eDate) pass = false;
                        }
                        return pass;
                    }
                    
                    return true;
                });
            });
            // ==========================================
            // AKHIR KODE FILTER
            // ==========================================

            // 1. CALCULATE SUMMARY STATS
            // ... (KODE LAMA BAPAK BERLANJUT KE BAWAH) ...

            // 1. CALCULATE SUMMARY STATS
            let totalLayanan = 0;
            let siswaSet = new Set();
            let countsPerSheet = {};
            
            // Variabel baru agar hitungannya akurat
            let selesaiCount = 0;
            let pendingCount = 0; 
            let totalLayananBerstatus = 0; 

            sheets.forEach((sheet, idx) => {
                const data = results[idx];
                totalLayanan += data.length;
                countsPerSheet[sheet] = data.length;

                data.forEach(item => {
                    // Unique Student Count
                    if(item.Nama_Siswa) siswaSet.add(item.Nama_Siswa);
                    if(item.Nama_Siswa_1) siswaSet.add(item.Nama_Siswa_1);
                    
                    // Status Count (DIPERBAIKI: Hanya cek yang punya field status)
                    const statusVal = item.Status_Konseling || item.Status_Proses || item.Status_Rujukan || item.Status_Mediasi || item.Status_Advokasi;
                    
                    if (statusVal) {
                        totalLayananBerstatus++; // Hitung total layanan yang memang butuh status
                        const s = statusVal.toLowerCase();
                        
                        // Kategori Selesai / Ditutup
                        if(s.includes('selesai') || s.includes('berhasil') || s.includes('diterima') || s.includes('drop out') || s.includes('gagal')) {
                            selesaiCount++;
                        } else {
                            // Kategori Masih Berjalan (Proses, Aktif, Berlanjut, Dikirim, dsb)
                            pendingCount++;
                        }
                    }
                });
            });

            // Find Top Service
            let topService = "-";
            let maxCount = 0;
            const labelsMap = {
                '7_Layanan_Individu': 'Individu', '8_Layanan_Kelompok': 'Kelompok', 
                '9_Bimbingan_Kelompok': 'Bim. Kelompok', '10_Konsultasi': 'Konsultasi', 
                '11_Layanan_Klasikal': 'Klasikal', '12_Konferensi_Kasus': 'Konferensi',
                '13_Alih_Tangan_Kasus': 'Alih Tangan', '14_Mediasi': 'Mediasi',
                '15_Advokasi': 'Advokasi', '16_Dukungan_Sistem': 'Dukungan'
            };
            
            for(let [key, val] of Object.entries(countsPerSheet)) {
                if(val > maxCount) { maxCount = val; topService = labelsMap[key]; }
            }

            // PERBAIKAN: Persentase selesai hanya dihitung dari layanan yang butuh status
            const percentSelesai = totalLayananBerstatus > 0 ? Math.round((selesaiCount / totalLayananBerstatus) * 100) : 100;

            // UPDATE UI CARDS
            document.getElementById('stat-total').innerText = totalLayanan;
            document.getElementById('stat-students').innerText = siswaSet.size;
            document.getElementById('stat-top').innerText = topService;
            document.getElementById('stat-status').innerText = `${percentSelesai}%`;
			
			// --- note+++ LOGIKA AI SMART INSIGHT & EARLY WARNING ---
            
            // A. Early Warning System (Hitung frekuensi siswa bermasalah/dilayani)
            let studentCounts = {};
            sheets.forEach((sheet, idx) => {
                // Abaikan sheet dukungan sistem atau konsultasi (karena targetnya bukan siswa spesifik)
                if(sheet === '16_Dukungan_Sistem' || sheet === '10_Konsultasi') return; 
                
                results[idx].forEach(item => {
                    const names = [];
                    // Kumpulkan semua variabel yang mungkin berisi nama siswa
                    if(item.Nama_Siswa) names.push({ name: item.Nama_Siswa, kls: item.Kelas });
                    if(item.Nama_Siswa_1) names.push({ name: item.Nama_Siswa_1, kls: item.Kelas_1 || item.Kelas });
                    if(item.Nama_Siswa_2) names.push({ name: item.Nama_Siswa_2, kls: item.Kelas_2 || item.Kelas });
                    
                    names.forEach(n => {
                        if(!n.name) return;
                        if(!studentCounts[n.name]) studentCounts[n.name] = { count: 0, kls: n.kls || '-' };
                        studentCounts[n.name].count++;
                    });
                });
            });

            // Urutkan siswa berdasarkan jumlah kasus/layanan terbanyak (Top 5)
            const topStudents = Object.entries(studentCounts)
                .map(([name, data]) => ({ name, count: data.count, kls: data.kls }))
                .sort((a, b) => b.count - a.count)
                .filter(s => s.count >= 2) // Hanya tampilkan yang minimal punya 2 riwayat
                .slice(0, 5); // Ambil 5 teratas

            // Render ke UI Panel Early Warning
            const warningContainer = document.getElementById('early-warning-list');
            warningContainer.innerHTML = '';
            
            if(topStudents.length === 0) {
                warningContainer.innerHTML = `<div class="flex flex-col items-center justify-center h-full opacity-60"><i class="fa-solid fa-shield-halved text-4xl mb-3 text-green-500"></i><p class="text-xs text-center dark:text-slate-300 text-slate-500">Aman. Belum ada siswa yang butuh perhatian khusus.</p></div>`;
            } else {
                topStudents.forEach((s) => {
                    let badgeColor = s.count >= 4 ? 'bg-red-100 text-red-600 border-red-200' : 'bg-yellow-100 text-yellow-700 border-yellow-200';
                    let iconStr = s.count >= 4 ? '<i class="fa-solid fa-fire animate-pulse"></i>' : '<i class="fa-solid fa-triangle-exclamation"></i>';
                    
                    warningContainer.innerHTML += `
                        <div class="p-3 rounded-xl bg-white/50 dark:bg-slate-800/50 border border-gray-100 dark:border-slate-700 flex justify-between items-center hover:-translate-y-1 transition group cursor-pointer shadow-sm" onclick="document.getElementById('global-student-search').value='${s.name}'; searchStudentHistory();">
                            <div class="min-w-0 pr-2">
                                <p class="text-sm font-bold dark:text-white text-slate-700 group-hover:text-blue-500 transition truncate">${s.name}</p>
                                <p class="text-[10px] dark:text-slate-400 text-slate-500 mt-0.5">Kelas ${s.kls}</p>
                            </div>
                            <div class="px-2 py-1 rounded text-[10px] font-bold border ${badgeColor} flex items-center gap-1 shrink-0">
                                ${iconStr} ${s.count}x
                            </div>
                        </div>
                    `;
                });
            }

            // B. AI Smart Insight Logic (Menganalisis dari Data Dashboard)
            let insightMsg = "";
            
            if (totalLayanan === 0) {
                insightMsg = "Sistem masih kosong. Mari mulai catat layanan pertamamu hari ini!";
            } else if (topStudents.length > 0 && topStudents[0].count >= 4) {
                insightMsg = ` <strong>Perhatian:</strong> Siswa <strong>${topStudents[0].name}</strong> tercatat memiliki ${topStudents[0].count} riwayat layanan. Pertimbangkan untuk memanggil orang tua atau melakukan Konferensi Kasus.`;
            } else if (pendingCount > 0) {
                insightMsg = ` <strong>Pengingat:</strong> Ada <strong>${pendingCount} layanan</strong> yang berstatus belum selesai/dalam proses. Jangan lupa di-follow up ya!`;
            } else {
                insightMsg = " <strong>Luar biasa!</strong> Semua catatan layanan siswa berstatus selesai/berhasil. Pertahankan kinerjamu!";
            }

            // Tampilkan Insight Box
            const insightBox = document.getElementById('ai-smart-insight');
            document.getElementById('ai-insight-text').innerHTML = insightMsg;
            insightBox.classList.remove('hide');
            // --- note+++ END LOGIKA ---

            // 2. RENDER PREMIUM CHART (Sekarang menampung SEMUA 10 Layanan, tidak digabung lagi)
            const ctx = document.getElementById('statsChart').getContext('2d');
            if(window.myStatsChart) window.myStatsChart.destroy();

            const allLabels = Object.values(labelsMap); // Mengambil 10 Nama Layanan
            const allCounts = sheets.map(s => countsPerSheet[s]); // Mengambil 10 Angkanya

            // Kumpulan 10 Warna Estetik untuk tiap layanan
            const chartColors = [
                'rgba(59, 130, 246, 0.8)', 'rgba(34, 197, 94, 0.8)', 'rgba(168, 85, 247, 0.8)', 
                'rgba(249, 115, 22, 0.8)', 'rgba(239, 68, 68, 0.8)', 'rgba(6, 182, 212, 0.8)',
                'rgba(20, 184, 166, 0.8)', 'rgba(236, 72, 153, 0.8)', 'rgba(99, 102, 241, 0.8)', 'rgba(100, 116, 139, 0.8)'
            ];

            window.myStatsChart = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: allLabels,
                    datasets: [{
                        label: 'Total',
                        data: allCounts,
                        backgroundColor: chartColors,
                        borderColor: 'transparent',
                        borderWidth: 0,
                        borderRadius: chartType === 'bar' ? 4 : 0,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { display: chartType === 'doughnut', position: 'right', labels: { color: '#94a3b8', font: {size: 10} } },
                    },
                    scales: chartType === 'bar' ? {
                        y: { beginAtZero: true, grid: { display: false }, ticks: { color: '#94a3b8' }, border: { display: false } },
                        x: { grid: { display: false }, ticks: { color: '#94a3b8', font: {size: 9}, maxRotation: 45, minRotation: 45 }, border: { display: false } }
                    } : { y: { display: false }, x: { display: false } }
                }
            });

            // --- note+++ LOGIKA DAFTAR SISWA TERBANTU & RINCIAN LAYANAN ---
            
            // A. Rincian 10 Layanan (Diurutkan dari yang terbanyak)
            const serviceListEl = document.getElementById('all-services-list');
            serviceListEl.innerHTML = '';
            
            const sortedServices = Object.entries(countsPerSheet).sort((a,b) => b[1] - a[1]);
            let colorIndex = 0;
            
            sortedServices.forEach(([sheetKey, count]) => {
                const label = labelsMap[sheetKey];
                const bg = chartColors[colorIndex % chartColors.length];
                serviceListEl.innerHTML += `
                    <div class="flex justify-between items-center p-2.5 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700/50 transition cursor-pointer" onclick="openService('${sheetKey}', '${label}')">
                        <div class="flex items-center gap-3">
                            <span class="w-3 h-3 rounded-full shadow" style="background-color: ${bg};"></span>
                            <span class="text-sm font-medium text-slate-700 dark:text-slate-300">${label}</span>
                        </div>
                        <span class="font-bold text-slate-800 dark:text-white bg-slate-100 dark:bg-slate-800 px-3 py-1 rounded-full text-xs">${count}</span>
                    </div>
                `;
                colorIndex++;
            });

            // B. Daftar Siswa Terbantu (Revisi Super Cerdas: Hitung Frekuensi + Ekstrak Nama dari Tag Input)
            let studentStats = {};
            
            sheets.forEach((sheet, idx) => {
                if(sheet === '16_Dukungan_Sistem' || sheet === '10_Konsultasi') return; 
                
                results[idx].forEach(item => {
                    // Ambil tanggal dengan aman
                    const dateStr = item['Tanggal_Layanan'] || item['Tanggal'] || item['Tanggal_Kegiatan'];
                    let itemDate = new Date(dateStr);
                    if (isNaN(itemDate.getTime())) itemDate = new Date(0); 
                    
                    const processStudent = (rawName, kls) => {
                        if(!rawName || typeof rawName !== 'string') return;
                        
                        // Pecah nama jika dipisah koma (sangat berguna untuk Layanan Kelompok)
                        const namesArray = rawName.split(',');
                        
                        namesArray.forEach(n => {
                            let cleanName = n.trim(); // Contoh awal: "Andi (8A)"
                            if(!cleanName) return;
                            
                            let finalClass = kls || '-';

                            // note+++ LOGIKA BARU: EKSTRAK NAMA & KELAS DARI TAG INPUT ---
                            // Jika namanya mengandung tanda kurung, kita pisahkan namanya dengan kelasnya!
                            if (cleanName.includes('(') && cleanName.includes(')')) {
                                let parts = cleanName.split('(');
                                cleanName = parts[0].trim(); // Ambil namanya saja: "Andi"
                                finalClass = parts[1].replace(')', '').trim(); // Ambil kelasnya saja: "8A"
                            }
                            
                            const lowerName = cleanName.toLowerCase();
                            
                            // Jika siswa belum ada di objek, buat slot baru
                            if(!studentStats[lowerName]) {
                                studentStats[lowerName] = { 
                                    name: cleanName, // Simpan hanya namanya (Andi)
                                    kls: finalClass, 
                                    service: labelsMap[sheet], 
                                    date: itemDate,
                                    count: 0 
                                };
                            }
                            
                            // Tambah hitungan layanannya
                            studentStats[lowerName].count++;
                            
                            // Update ke layanan & tanggal terbaru jika data ini lebih baru
                            if(itemDate > studentStats[lowerName].date) {
                                studentStats[lowerName].date = itemDate;
                                studentStats[lowerName].service = labelsMap[sheet];
                                if(finalClass !== '-') studentStats[lowerName].kls = finalClass; 
                            }
                        });
                    };

                    // Lempar semua kemungkinan field nama siswa ke fungsi pemroses
                    if(item.Nama_Siswa) processStudent(item.Nama_Siswa, item.Kelas);
                    if(item.Nama_Siswa_1) processStudent(item.Nama_Siswa_1, item.Kelas_1 || item.Kelas);
                    if(item.Nama_Siswa_2) processStudent(item.Nama_Siswa_2, item.Kelas_2 || item.Kelas);
                    if(item.Anggota_Kelompok_Siswa) processStudent(item.Anggota_Kelompok_Siswa, item.Kelas); 
                });
            });

            // Ubah object ke array dan urutkan (Prioritas 1: Jumlah Terbanyak, Prioritas 2: Terkini)
            let uniqueHelped = Object.values(studentStats);
            uniqueHelped.sort((a, b) => {
                if (b.count !== a.count) return b.count - a.count; 
                return b.date - a.date; 
            });

            // Render ke UI
            const studentListEl = document.getElementById('helped-students-list');
            document.getElementById('badge-total-siswa').innerText = `${uniqueHelped.length} Siswa`;
            studentListEl.innerHTML = '';

            if(uniqueHelped.length === 0) {
                studentListEl.innerHTML = `<p class="text-xs text-center text-slate-400 mt-10">Belum ada siswa yang tercatat.</p>`;
            } else {
                uniqueHelped.forEach(s => {
                    studentListEl.innerHTML += `
                        <div class="flex justify-between items-center p-3 rounded-xl bg-white/50 dark:bg-slate-800/50 border border-gray-100 dark:border-slate-700 hover:-translate-y-1 transition group cursor-pointer shadow-sm" onclick="document.getElementById('global-student-search').value='${s.name}'; searchStudentHistory();">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-400 to-indigo-500 flex items-center justify-center text-white font-bold shadow-md uppercase">
                                    ${s.name.charAt(0)}
                                </div>
                                <div class="min-w-0">
                                    <p class="text-sm font-bold dark:text-white text-slate-700 truncate group-hover:text-blue-500 transition">${s.name}</p>
                                    <div class="flex items-center gap-2 mt-0.5">
                                        <span class="text-[10px] bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 px-1.5 py-0.5 rounded">Kls ${s.kls}</span>
                                        <span class="text-[10px] text-blue-500 font-medium truncate">Terakhir: ${s.service}</span>
                                    </div>
                                </div>
                            </div>
                            <span class="text-[10px] font-bold bg-blue-100 text-blue-600 dark:bg-blue-900/40 dark:text-blue-300 px-2 py-1 rounded-lg shrink-0 border border-blue-200 dark:border-blue-800">${s.count}x Layanan</span>
                        </div>
                    `;
                });
            }
			
			// --- FITUR BARU: KLASEMEN HOT-ZONE KELAS & SISWA DOMINAN (TAMPIL SEMUA) ---
            let classDataMap = {}; 
            
            // 1. PRE-FILL KELAS dari database siswa
            if (metaData && metaData.siswa) {
                metaData.siswa.forEach(s => {
                    let c = s.kelas ? String(s.kelas).replace(/\s+/g, '').toUpperCase() : '';
                    if (c && c !== '-' && c !== 'NULL' && !classDataMap[c]) {
                        classDataMap[c] = { total: 0, students: {} };
                    }
                });
            }

            // 2. PRE-FILL BIDANG LAYANAN
            let bidangDataMap = {
                "Pribadi": { total: 0, students: {} },
                "Sosial": { total: 0, students: {} },
                "Belajar": { total: 0, students: {} },
                "Karir": { total: 0, students: {} }
            };

            // Loop seluruh data layanan
            sheets.forEach((sheet, idx) => {
                results[idx].forEach(item => {
                    
                    // ==========================================
                    // A. LOGIKA KELAS (Hanya Layanan Langsung ke Siswa)
                    // ==========================================
                    if(sheet !== '16_Dukungan_Sistem' && sheet !== '10_Konsultasi') {
                        const addClassData = (rawName, rawClass) => {
                            if(!rawName || typeof rawName !== 'string') return;
                            let c = rawClass ? String(rawClass).replace(/\s+/g, '').toUpperCase() : '';
                            let name = rawName.trim();
                            
                            if (name.includes('(') && name.includes(')')) {
                                let parts = name.split('(');
                                name = parts[0].trim();
                                c = parts[1].replace(')', '').replace(/\s+/g, '').toUpperCase();
                            }
                            if(!c || c === '-' || c === 'NULL') return; 
                            
                            if(!classDataMap[c]) classDataMap[c] = { total: 0, students: {} };
                            classDataMap[c].total++; 
                            
                            const lowerName = name.toLowerCase();
                            if(!classDataMap[c].students[lowerName]) classDataMap[c].students[lowerName] = { name: name, count: 0 };
                            classDataMap[c].students[lowerName].count++;
                        };

                        if(item.Nama_Siswa) addClassData(item.Nama_Siswa, item.Kelas);
                        if(item.Nama_Siswa_1) addClassData(item.Nama_Siswa_1, item.Kelas_1 || item.Kelas);
                        if(item.Nama_Siswa_2) addClassData(item.Nama_Siswa_2, item.Kelas_2 || item.Kelas);
                        if(item.Anggota_Kelompok_Siswa) {
                            item.Anggota_Kelompok_Siswa.split(',').forEach(m => addClassData(m, item.Kelas));
                        }
                    }

                    // ==========================================
                    // B. LOGIKA BIDANG (BACA SEMUA LAYANAN TERMASUK KONSULTASI)
                    // ==========================================
                    let bidang = item['Bidang_Bimbingan'] || item['Bidang_Layanan'];
                    if(bidang && bidang !== '-') {
                        let b = bidang.trim();
                        if(b.toLowerCase().includes('pibadi')) b = 'Pribadi'; // Auto-koreksi typo lama
                        
                        if(!bidangDataMap[b]) bidangDataMap[b] = { total: 0, students: {} };
                        
                        // 1. Selalu tambahkan total kasus di bidang ini (Meski tanpa siswa)
                        bidangDataMap[b].total++;
                        
                        // 2. Fungsi merekap siswa JIKA ADA
                        const addStudentToBidang = (rawName) => {
                            if(!rawName || typeof rawName !== 'string') return;
                            let name = rawName.trim();
                            if (name.includes('(') && name.includes(')')) name = name.split('(')[0].trim();
                            if(!name || name.toLowerCase() === 'null' || name === '-') return;
                            
                            const lowerName = name.toLowerCase();
                            if(!bidangDataMap[b].students[lowerName]) bidangDataMap[b].students[lowerName] = { name: name, count: 0 };
                            bidangDataMap[b].students[lowerName].count++;
                        };

                        // Hanya jalankan fungsi jika field namanya tidak kosong
                        if(item.Nama_Siswa) addStudentToBidang(item.Nama_Siswa);
                        if(item.Nama_Siswa_1) addStudentToBidang(item.Nama_Siswa_1);
                        if(item.Nama_Siswa_2) addStudentToBidang(item.Nama_Siswa_2);
                        if(item.Anggota_Kelompok_Siswa) item.Anggota_Kelompok_Siswa.split(',').forEach(m => addStudentToBidang(m));
                    }
                });
            });

            // --- RENDER KLASEMEN KELAS ---
            const sortedClasses = Object.entries(classDataMap)
                .map(([className, data]) => ({ className, total: data.total, students: data.students }))
                .sort((a, b) => b.total - a.total); 

            const klasemenContainer = document.getElementById('hot-zone-klasemen');
            const klasemenList = document.getElementById('klasemen-list');
            if (klasemenList) klasemenList.innerHTML = '';

            if(sortedClasses.length > 0 && klasemenContainer) {
                klasemenContainer.classList.remove('hide');
                sortedClasses.forEach((cls, index) => {
                    
                    // PERUBAHAN DI SINI: Hapus .slice(0, 3) agar SEMUA siswa yang terlibat tampil
                    const topStudents = Object.values(cls.students).sort((a, b) => b.count - a.count); 
                    
                    let studentText = topStudents.length > 0 
                        ? topStudents.map(s => `<span class="font-bold text-slate-700 dark:text-slate-200">${s.name}</span> <span class="text-[10px] opacity-70 border border-gray-300 dark:border-gray-600 rounded px-1">${s.count}x</span>`).join(', ')
                        : `<span class="text-green-500 font-bold italic">Nihil / Aman</span>`;
                    
                    let rankColors = "bg-slate-200 dark:bg-slate-700 text-slate-500 dark:text-slate-400"; 
                    let rankIcon = `<span class="font-black text-sm">${index + 1}</span>`;
                    let badgeClass = cls.total > 0 ? "bg-red-100 text-red-600 dark:bg-red-900/40 dark:text-red-400 border border-red-200 dark:border-red-800" : "bg-green-100 text-green-600 dark:bg-green-900/40 dark:text-green-400 border border-green-200 dark:border-green-800";
                    let pulseEffect = cls.total > 0 ? "animate-pulse shadow-sm" : "";
                    
                    if(cls.total > 0 && index === 0) { 
                        rankColors = "bg-gradient-to-br from-red-600 to-red-500 text-white shadow-lg shadow-red-500/40 ring-2 ring-red-300 dark:ring-red-800";
                        rankIcon = `<i class="fa-solid fa-triangle-exclamation fa-beat-fade"></i>`; 
                    } else if(cls.total > 0 && index === 1) { 
                        rankColors = "bg-gradient-to-br from-orange-500 to-orange-400 text-white shadow-md shadow-orange-500/30";
                        rankIcon = `<i class="fa-solid fa-circle-exclamation"></i>`; 
                    } else if(cls.total > 0 && index === 2) { 
                        rankColors = "bg-gradient-to-br from-amber-500 to-yellow-400 text-white shadow-md";
                        rankIcon = `<i class="fa-solid fa-bell"></i>`; 
                    } else if(cls.total === 0) {
                        rankColors = "bg-green-100 dark:bg-green-900/40 text-green-600 dark:text-green-400";
                        rankIcon = `<i class="fa-solid fa-check"></i>`;
                    }

                    klasemenList.innerHTML += `
                        <div class="flex items-center gap-4 p-3 rounded-xl bg-white/60 dark:bg-slate-800/60 border border-gray-100 dark:border-slate-700 hover:shadow-md hover:bg-orange-50 dark:hover:bg-slate-700/80 hover:-translate-y-1 transition-all duration-300 cursor-default">
                            <div class="w-11 h-11 rounded-full flex justify-center items-center shrink-0 ${rankColors} border-2 border-white dark:border-slate-800">
                                ${rankIcon}
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between items-center mb-0.5">
                                    <h4 class="font-bold text-slate-800 dark:text-white text-base">Kelas ${cls.className}</h4>
                                    <span class="px-2 py-0.5 rounded text-[10px] font-bold ${badgeClass} shrink-0 ${pulseEffect}">${cls.total} Layanan</span>
                                </div>
                                <p class="text-xs text-slate-500 dark:text-slate-400 mt-1 leading-relaxed">
                                    <i class="fa-solid ${cls.total > 0 ? 'fa-users-viewfinder text-orange-400' : 'fa-shield text-green-500'} mr-1"></i> Terlibat: ${studentText}
                                </p>
                            </div>
                        </div>
                    `;
                });
            }

            // --- RENDER KLASEMEN BIDANG ---
            const sortedBidang = Object.entries(bidangDataMap)
                .map(([bidangName, data]) => ({ bidangName, total: data.total, students: data.students }))
                .sort((a, b) => b.total - a.total);

            const bidangContainer = document.getElementById('bidang-layanan-klasemen');
            const bidangList = document.getElementById('bidang-list');
            if (bidangList) bidangList.innerHTML = '';

            if(sortedBidang.length > 0 && bidangContainer) {
                bidangContainer.classList.remove('hide');
                sortedBidang.forEach((bdg, index) => {
                    const topStudents = Object.values(bdg.students).sort((a, b) => b.count - a.count).slice(0, 5); 
                    
                    // Logika Cerdas: Cek apakah ada layanan tapi tidak ada siswanya
                    let studentText = "";
                    if (bdg.total > 0) {
                        if (topStudents.length > 0) {
                            studentText = topStudents.map(s => `<span class="font-bold text-slate-700 dark:text-slate-200">${s.name}</span> <span class="text-[10px] opacity-70 border border-gray-300 dark:border-gray-600 rounded px-1">${s.count}x</span>`).join(', ');
                            if (Object.keys(bdg.students).length > 5) studentText += ` <span class="text-[10px] text-purple-500 italic font-bold">+ lainnya</span>`;
                        } else {
                            // Kasus ada, tapi tidak ada siswanya (Cth: Konsultasi dgn Guru, Rapat, dll)
                            studentText = `<span class="italic text-slate-400 font-medium">Layanan Umum / Non-Siswa</span>`;
                        }
                    } else {
                        studentText = `<span class="text-green-500 font-bold italic">Nihil / Aman</span>`;
                    }
                    
                    let rankColors = "bg-slate-200 dark:bg-slate-700 text-slate-500 dark:text-slate-400";
                    let rankIcon = `<span class="font-black text-sm">${index + 1}</span>`;
                    let badgeClassBdg = bdg.total > 0 ? "bg-purple-100 text-purple-600 dark:bg-purple-900/40 dark:text-purple-400 border-purple-200 dark:border-purple-800" : "bg-green-100 text-green-600 dark:bg-green-900/40 dark:text-green-400 border-green-200 dark:border-green-800";

                    if(bdg.total > 0 && index === 0) { 
                        rankColors = "bg-gradient-to-br from-purple-600 to-indigo-500 text-white shadow-lg shadow-purple-500/40 ring-2 ring-purple-300 dark:ring-purple-800";
                        rankIcon = `<i class="fa-solid fa-chart-pie"></i>`;
                    } else if(bdg.total > 0 && index === 1) { 
                        rankColors = "bg-gradient-to-br from-fuchsia-500 to-pink-500 text-white shadow-md";
                        rankIcon = `<i class="fa-solid fa-layer-group"></i>`;
                    } else if(bdg.total === 0) {
                        rankColors = "bg-green-100 dark:bg-green-900/40 text-green-600 dark:text-green-400";
                        rankIcon = `<i class="fa-solid fa-check"></i>`;
                    }

                    bidangList.innerHTML += `
                        <div class="flex items-center gap-4 p-3 rounded-xl bg-white/60 dark:bg-slate-800/60 border border-gray-100 dark:border-slate-700 hover:shadow-md hover:bg-purple-50 dark:hover:bg-slate-700/80 hover:-translate-y-1 transition-all duration-300 cursor-default">
                            <div class="w-11 h-11 rounded-full flex justify-center items-center shrink-0 ${rankColors} border-2 border-white dark:border-slate-800">
                                ${rankIcon}
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between items-center mb-0.5">
                                    <h4 class="font-bold text-slate-800 dark:text-white text-base">Bidang ${bdg.bidangName}</h4>
                                    <span class="px-2 py-0.5 rounded text-[10px] font-bold ${badgeClassBdg} border shrink-0 shadow-sm">${bdg.total} Layanan</span>
                                </div>
                                <p class="text-xs text-slate-500 dark:text-slate-400 mt-1 leading-relaxed">
                                    <i class="fa-solid ${bdg.total > 0 && topStudents.length > 0 ? 'fa-users text-purple-400' : 'fa-shield text-green-500'} mr-1"></i> Terlibat: ${studentText}
                                </p>
                            </div>
                        </div>
                    `;
                });
            }
			
        } // Penutup dari fungsi loadDashboardStats()

        // --- TIMELINE SEARCH ---
        function searchStudentHistory() {
            const keyword = document.getElementById('global-student-search').value.toLowerCase();
            if(!keyword) return;
            if(!cachedAllServices) { Swal.fire("Tunggu", "Data sedang dimuat...", "info"); return; }

            let history = [];
            const sheetLabels = {
                '7_Layanan_Individu': { label: 'Konseling Individu', icon: 'fa-user', color: 'blue' },
                '8_Layanan_Kelompok': { label: 'Konseling Kelompok', icon: 'fa-users', color: 'green' },
                // ... (Existing mappings) ...
                '9_Bimbingan_Kelompok': { label: 'Bim. Kelompok', icon: 'fa-chalkboard-user', color: 'purple' },
                '10_Konsultasi': { label: 'Konsultasi', icon: 'fa-handshake', color: 'orange' },
                '11_Layanan_Klasikal': { label: 'Klasikal', icon: 'fa-person-chalkboard', color: 'red' },
                '12_Konferensi_Kasus': { label: 'Konferensi', icon: 'fa-users-gear', color: 'cyan' },
                '13_Alih_Tangan_Kasus': { label: 'Alih Tangan', icon: 'fa-share-from-square', color: 'teal' },
                '14_Mediasi': { label: 'Mediasi', icon: 'fa-handshake-angle', color: 'pink' },
                '15_Advokasi': { label: 'Advokasi', icon: 'fa-gavel', color: 'indigo' },
                '16_Dukungan_Sistem': { label: 'Dukungan', icon: 'fa-network-wired', color: 'slate' }
            };

            for(const [sheet, data] of Object.entries(cachedAllServices)) {
                data.forEach(item => {
                    const names = (item['Nama_Siswa'] || item['Nama_Siswa_1'] || item['Nama_Siswa_2'] || item['Anggota_Kelompok_Siswa'] || item['Nama_Konsulti'] || item['Sasaran_Layanan'] || '').toLowerCase();
                    if(names.includes(keyword)) {
                        const conf = sheetLabels[sheet] || { label: 'Lainnya', color: 'gray' };
                        history.push({ ...item, _type: conf, _date: getItemDate(item) || '0000-00-00' });
                    }
                });
            }

            if(history.length === 0) { Swal.fire("Info", "Tidak ada riwayat.", "info"); return; }
            history.sort((a, b) => new Date(b._date) - new Date(a._date));

            const container = document.getElementById('timeline-container');
            container.innerHTML = '';
            document.getElementById('profile-name').innerText = toProperCase(keyword);
            document.getElementById('profile-class').innerText = `Total: ${history.length} Riwayat Layanan`;

            history.forEach(h => {
                const dateFmt = new Date(h._date).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
                
                // 1. Tentukan Judul
                const detail = h['Topik_Layanan'] || h['Identifikasi_Masalah'] || h['Deskripsi_Kasus'] || h['Pokok_Masalah'] || h['Nama_Kegiatan'] || 'Detail Layanan';
                
                // 2. Tentukan Isi Teks (Pintar: Cegah Duplikasi dengan Judul)
                let textIsi = h['Identifikasi_Masalah'] || h['Deskripsi_Kasus'] || h['Pokok_Masalah'] || '-';
                
                if (detail === textIsi) {
                    // Kalau sama persis dengan judul, ganti isinya dengan info pendukung
                    if (h['Pihak_Terlibat']) textIsi = `Pihak Terlibat: ${h['Pihak_Terlibat']}`;
                    else if (h['Pihak_Penerima']) textIsi = `Dirujuk ke: ${h['Pihak_Penerima']}`;
                    else if (h['Bidang_Bimbingan'] || h['Bidang_Layanan']) textIsi = `Bidang Layanan: ${h['Bidang_Bimbingan'] || h['Bidang_Layanan']}`;
                    else textIsi = "Tindak Lanjut: " + (h['Tindak_Lanjut'] || h['Alternatif_Pemecahan'] || '-');
                }

                // 3. Ambil Hasil & Status
                const hasil = h['Hasil'] || h['Hasil_Keputusan'] || h['Hasil_Kesepakatan'] || h['Hasil_Advokasi'] || '-';
                const status = h['Status_Konseling'] || h['Status_Proses'] || h['Status_Mediasi'] || h['Status_Advokasi'] || h['Status_Rujukan'] || 'Selesai';
                
                container.innerHTML += `
                    <div class="relative pl-8 pb-8 group">
                        <div class="absolute left-[-5px] top-1 w-4 h-4 rounded-full bg-${h._type.color}-500 border-2 border-white dark:border-slate-800 shadow z-10"></div>
                        <div class="glass p-4 rounded-xl shadow-sm hover:shadow-md transition-all hover:-translate-y-1">
                            <div class="flex justify-between items-start">
                                <div class="flex-1 pr-4">
                                    <span class="text-xs font-bold text-${h._type.color}-500 uppercase tracking-wide mb-1 block">${h._type.label}</span>
                                    <h4 class="font-bold dark:text-white text-slate-800 text-lg leading-snug">${detail}</h4>
                                </div>
                                <span class="text-xs dark:text-slate-400 text-slate-500 bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded shrink-0">${dateFmt}</span>
                            </div>
                            <p class="text-sm dark:text-slate-300 text-slate-600 mt-3 leading-relaxed">${textIsi}</p>
                            <p class="text-sm dark:text-slate-300 text-slate-600 mt-2 leading-relaxed"><span class="font-semibold opacity-70">Hasil:</span> ${hasil}</p>
                            <div class="mt-3 text-xs font-semibold inline-block bg-slate-50 dark:bg-slate-800/50 px-3 py-1.5 rounded-lg border border-slate-100 dark:border-slate-700">Status: <span class="${String(status).toLowerCase().includes('selesai') || String(status).toLowerCase().includes('berhasil') ? 'text-green-500' : 'text-yellow-500'}">${status}</span></div>
                        </div>
                    </div>`;
            });
            showSection('page-student-profile');
			
				// Tampilkan tombol cetak dan pasangkan fungsinya
            const printBtn = document.getElementById('btn-print-profile');
            printBtn.classList.remove('hidden');
            printBtn.classList.add('flex');
            printBtn.onclick = () => printStudentProfile(history, toProperCase(keyword));
        }

        // --- SERVICE LIST ---
        async function openService(sheetName, title) {
            currentSheet = sheetName;
            currentTitle = title;
            document.getElementById('service-title').innerText = title;
            document.getElementById('service-search').value = ''; 
            document.getElementById('filter-start').value = '';
            document.getElementById('filter-end').value = '';
            currentPage = 1;
            rowsPerPage = 10;
            document.getElementById('rows-per-page').value = "10";
            
            showSection('page-service');
            renderSkeleton(); // SHOW SKELETON

            const res = await apiCall({ action: 'getData', sheetName: sheetName, username: currentUser.username });
            if(res && res.status === 'success') {
                activeDataList = res.data;
                renderDataList();
            } else {
                Swal.fire("Gagal", "Tidak dapat mengambil data.", "error");
            }
        }

        function renderDataList() {
            // Filter
            const search = document.getElementById('service-search').value.toLowerCase();
            const startStr = document.getElementById('filter-start').value;
            const endStr = document.getElementById('filter-end').value;
            const startDate = startStr ? new Date(startStr) : null;
            const endDate = endStr ? new Date(endStr) : null;

            filteredData = activeDataList.filter(item => {
                let textMatch = true;
                if (search) { const text = Object.values(item).join(' ').toLowerCase(); textMatch = text.includes(search); }
                let dateMatch = true;
                if (startDate || endDate) {
                    const dStr = getItemDate(item);
                    if (dStr) {
                        const itemDate = new Date(dStr);
                        if (startDate && itemDate < startDate) dateMatch = false;
                        if (endDate && itemDate > endDate) dateMatch = false;
                    }
                }
                return textMatch && dateMatch;
            });

            const container = document.getElementById('data-container');
            container.innerHTML = '';

            // Empty State Estetik
            if (filteredData.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-20 opacity-70">
                        <div class="w-32 h-32 bg-slate-100 dark:bg-slate-800 rounded-full flex items-center justify-center mb-6 shadow-inner">
                            <i class="fa-solid fa-folder-open text-5xl text-slate-300 dark:text-slate-600"></i>
                        </div>
                        <p class="dark:text-white text-slate-600 font-bold text-lg">Belum Ada Data</p>
                        <p class="text-slate-400 text-sm mt-1">Silakan input data baru atau ubah filter pencarian.</p>
                        <button onclick="showForm()" class="mt-6 px-6 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-full text-sm font-bold shadow-lg shadow-blue-500/30 transition hover:-translate-y-1">
                            <i class="fa-solid fa-plus mr-2"></i> Input Data Baru
                        </button>
                    </div>`;
                updatePaginationUI(0, 0, 0);
                return;
            }

            // Pagination Logic
            const totalItems = filteredData.length;
            let startIdx = 0, endIdx = totalItems;
            if (rowsPerPage !== 'all') {
                const limit = parseInt(rowsPerPage);
                const maxPage = Math.ceil(totalItems / limit);
                if (currentPage > maxPage) currentPage = maxPage;
                if (currentPage < 1) currentPage = 1;
                startIdx = (currentPage - 1) * limit;
                endIdx = Math.min(startIdx + limit, totalItems);
            }
            const pageData = filteredData.slice(startIdx, endIdx);

            // --- LOOPING DATA UTAMA ---
            pageData.forEach(item => {
                let date = getItemDate(item) || '-';
                let main = 'Data Layanan';
                let sub = '-';

                // --- HELPER 1: FORMAT NAMA & KELAS ---
                const formatNamaKelas = (nama, kls) => {
                    if (!nama) return 'Tanpa Nama';
                    return kls ? `${nama} (${kls})` : nama;
                };

                // --- HELPER 2: AMBIL BIDANG & STATUS ---
                const getBidang = () => {
                    let b = item['Bidang_Bimbingan'] || item['Bidang_Layanan'];
                    return b ? `[${b}] ` : ''; 
                };
                const getStatus = () => {
                    let s = item['Status_Konseling'] || item['Status_Proses'] || item['Status_Mediasi'] || item['Status_Advokasi'] || item['Status_Rujukan'];
                    return s ? ` (Status: ${s})` : ''; 
                };

                // --- HELPER 3: EARLY WARNING SYSTEM (FITUR BARU)  ---
                const getRiskBadge = (studentName) => {
                    if (!studentName || !cachedAllServices) return ''; // Cek ketersediaan data
                    
                    // Jangan hitung jika ini bukan nama siswa (misal nama kegiatan/guru)
                    if (currentSheet === '16_Dukungan_Sistem' || currentSheet === '10_Konsultasi') return '';

                    let totalKasus = 0;
                    // Loop semua sheet yang ada di memori (cache)
                    Object.values(cachedAllServices).forEach(sheetData => {
                        sheetData.forEach(row => {
                            // Cek apakah nama siswa ini muncul di data lain
                            const rowName = (row['Nama_Siswa'] || row['Nama_Siswa_1'] || row['Nama_Siswa_2'] || '').toLowerCase();
                            if (rowName.includes(studentName.toLowerCase())) totalKasus++;
                        });
                    });

                    // Logika Penentuan Level Risiko
                    if (totalKasus >= 5) {
                        return `<span class="ml-2 inline-flex items-center gap-1 px-2 py-0.5 rounded text-[10px] font-bold bg-red-100 text-red-600 border border-red-200" title="Siswa ini memiliki ${totalKasus} riwayat kasus!"><i class="fa-solid fa-fire animate-pulse"></i> ${totalKasus}x Kasus</span>`;
                    } else if (totalKasus >= 3) {
                        return `<span class="ml-2 inline-flex items-center gap-1 px-2 py-0.5 rounded text-[10px] font-bold bg-yellow-100 text-yellow-700 border border-yellow-200" title="Perhatian! Siswa ini sudah ${totalKasus} kali terlibat."><i class="fa-solid fa-triangle-exclamation"></i> ${totalKasus}x</span>`;
                    }
                    return '';
                };

                // Variabel untuk menyimpan Nama Siswa Murni (untuk dicek risikonya)
                let namaSiswaCheck = ''; 

                // --- LOGIKA TAMPILAN PER LAYANAN ---

                if (currentSheet === '7_Layanan_Individu') {
                    namaSiswaCheck = item['Nama_Siswa']; // Simpan nama untuk dicek
                    main = formatNamaKelas(item['Nama_Siswa'], item['Kelas']);
                    let ke = item['Konseling_Ke'] || '-';
                    let masalah = item['Identifikasi_Masalah'] || 'Masalah belum diisi';
                    sub = `${getBidang()}Konseling Ke-${ke}: ${masalah}${getStatus()}`;

                } else if (currentSheet === '8_Layanan_Kelompok' || currentSheet === '9_Bimbingan_Kelompok') {
                    main = item['Identifikasi_Masalah'] || item['Topik_Layanan'] || 'Topik Kelompok';
                    let anggota = item['Anggota_Kelompok_Siswa'] || '';
                    let count = anggota.split(',').length; 
                    sub = `${getBidang()}${anggota ? `Anggota: ${count} Siswa` : 'Anggota kosong'}${getStatus()}`;

                } else if (currentSheet === '10_Konsultasi') {
                    let nama = item['Nama_Konsulti'] || 'Tanpa Nama';
                    let statusK = item['Status_Konsulti'] || '-';
                    main = `${nama} (${statusK})`;
                    sub = `${getBidang()}Topik: ${item['Uraian_Topik'] || item['Topik_Layanan'] || '-'}`;

                } else if (currentSheet === '11_Layanan_Klasikal') {
                    main = item['Topik_Layanan'] || 'Materi Klasikal';
                    let sasaran = item['Sasaran_Layanan'] || '-';
                    sub = `${getBidang()}Sasaran: Kelas ${sasaran}`;

                } else if (currentSheet === '12_Konferensi_Kasus') {
                    namaSiswaCheck = item['Nama_Siswa'];
                    main = formatNamaKelas(item['Nama_Siswa'], item['Kelas']);
                    let pihak = item['Pihak_Terlibat'] || '-';
                    sub = `${getBidang()}Bersama: ${pihak}`;

                } else if (currentSheet === '13_Alih_Tangan_Kasus') {
                    namaSiswaCheck = item['Nama_Siswa'];
                    main = formatNamaKelas(item['Nama_Siswa'], item['Kelas']);
                    let penerima = item['Pihak_Penerima'] || 'Pihak Luar';
                    sub = `${getBidang()}Dirujuk ke: ${penerima}${getStatus()}`;

                } else if (currentSheet === '14_Mediasi') {
                    // Untuk mediasi, kita cek salah satu saja atau biarkan kosong dulu agar tidak terlalu ramai
                    let s1 = item['Nama_Siswa_1'] || 'Pihak 1';
                    let s2 = item['Nama_Siswa_2'] || 'Pihak 2';
                    main = `${s1} & ${s2}`; 
                    sub = `${getBidang()}${item['Pokok_Masalah'] ? `Masalah: ${item['Pokok_Masalah']}` : 'Masalah Mediasi'}${getStatus()}`;

                } else if (currentSheet === '15_Advokasi') {
                    namaSiswaCheck = item['Nama_Siswa'];
                    main = formatNamaKelas(item['Nama_Siswa'], item['Kelas']);
                    let terkait = item['Pihak_Terkait'] || '-';
                    sub = `${getBidang()}Terkait: ${terkait}${getStatus()}`;

                } else if (currentSheet === '16_Dukungan_Sistem') {
                    main = item['Nama_Kegiatan'] || 'Kegiatan';
                    sub = item['Peran_GuruBK'] ? `Peran: ${item['Peran_GuruBK']}` : '-';

                } else {
                    main = item['Nama_Siswa'] || item['Nama_Siswa_1'] || item['Nama_Kegiatan'] || 'Data Layanan';
                    sub = item['Deskripsi_Kasus'] || item['Pokok_Masalah'] || item['Kelas'] || 'Keterangan umum';
                }
                
                // --- GENERATE WARNING BADGE ---
                // Kita panggil fungsi Early Warning dan tempelkan di sebelah Judul (Main)
                const warningBadge = getRiskBadge(namaSiswaCheck);

                // --- RENDER KARTU ---
                const card = document.createElement('div');
                card.className = "bg-white/95 dark:bg-slate-800/80 backdrop-blur rounded-xl p-5 shadow-lg border-l-4 border-blue-500 hover:shadow-xl hover:translate-x-1 transition-all duration-300 flex flex-col md:flex-row justify-between gap-4 group";
                card.innerHTML = `
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-200 text-[10px] font-bold px-2 py-0.5 rounded uppercase tracking-wider">${currentTitle.split(' ')[0]}</span>
                            <span class="text-xs text-gray-400"><i class="fa-regular fa-calendar mr-1"></i>${date}</span>
                        </div>
                        
                        <div class="flex items-start justify-between">
                            <h4 class="font-bold dark:text-white text-slate-800 text-lg group-hover:text-blue-500 transition break-words leading-tight flex-1">
                                ${main} ${warningBadge} 
                            </h4>
                        </div>
                        
                        <p class="text-sm dark:text-slate-400 text-slate-600 mt-2 break-words leading-relaxed">
                            ${sub}
                        </p>
                    </div>
                    <div class="flex items-center gap-2 border-t dark:border-slate-700 md:border-t-0 md:border-l border-gray-100 pt-3 md:pt-0 md:pl-4 flex-shrink-0">
                        <button onclick="printItem('${item.ID_Unik}')" class="w-10 h-10 flex items-center justify-center bg-gray-100 dark:bg-slate-700 hover:bg-gray-200 dark:hover:bg-slate-600 text-slate-600 dark:text-white rounded-lg transition" title="Cetak PDF"><i class="fa-solid fa-print"></i></button>
                        <button onclick="editItem('${item.ID_Unik}')" class="w-10 h-10 flex items-center justify-center bg-yellow-50 dark:bg-yellow-900/30 hover:bg-yellow-100 dark:hover:bg-yellow-900/50 text-yellow-600 dark:text-yellow-400 rounded-lg transition" title="Edit"><i class="fa-solid fa-pen"></i></button>
                        <button onclick="deleteItem('${item.ID_Unik}')" class="w-10 h-10 flex items-center justify-center bg-red-50 dark:bg-red-900/30 hover:bg-red-100 dark:hover:bg-red-900/50 text-red-600 dark:text-red-400 rounded-lg transition" title="Hapus"><i class="fa-solid fa-trash"></i></button>
                    </div>
                `;
                container.appendChild(card);
            });
            updatePaginationUI(startIdx + 1, endIdx, totalItems);
        }

        function changeRowsPerPage() { rowsPerPage = document.getElementById('rows-per-page').value; currentPage = 1; renderDataList(); }
        function changePage(direction) { currentPage += direction; renderDataList(); }
        function updatePaginationUI(start, end, total) {
            document.getElementById('showing-info').innerText = `Menampilkan ${start}-${end} dari ${total} data`;
            document.getElementById('page-info').innerText = `Page ${currentPage}`;
            const btnPrev = document.getElementById('btn-prev'), btnNext = document.getElementById('btn-next');
            btnPrev.disabled = currentPage === 1 || total === 0;
            if (rowsPerPage === 'all') btnNext.disabled = true;
            else btnNext.disabled = currentPage >= Math.ceil(total / parseInt(rowsPerPage)) || total === 0;
        }

        // --- EXPORT & PRINT (Unchanged Logic) ---
        function exportExcel() {
            if(filteredData.length === 0) { Swal.fire("Kosong", "Tidak ada data (sesuai filter) untuk diexport.", "warning"); return; }
            const cleanData = filteredData.map(({ ID_Unik, rowIndex, Created_By, ...rest }) => rest);
            const ws = XLSX.utils.json_to_sheet(cleanData); const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Data Layanan"); XLSX.writeFile(wb, `Export_${currentTitle}.xlsx`);
        }

        function printRecap() {
            if(filteredData.length === 0) { Swal.fire("Kosong", "Tidak ada data untuk dicetak.", "warning"); return; }
            const sDate = document.getElementById('filter-start').value;
            const eDate = document.getElementById('filter-end').value;
            let periode = "";
            if(sDate && eDate) {
                const d1 = new Date(sDate).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'});
                const d2 = new Date(eDate).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'});
                periode = `Periode: ${d1} s.d. ${d2}`;
            }
            generatePDF(filteredData, `Rekapitulasi_${currentTitle}`, true, periode);
        }

        function printItem(id) {
            const item = activeDataList.find(x => x.ID_Unik === id);
            generatePDF([item], `Laporan_${currentTitle}`, false);
        }

        // --- PDF FUNCTION (UPDATED - BACK TO ORIGINAL WITH PRO STYLING) ---
        async function generatePDF(data, filename, isRecap, subTitle = "") {
            const { jsPDF } = window.jspdf;
            const orientation = isRecap ? 'landscape' : 'portrait';
            const format = isRecap ? [330.2, 215.9] : [215.9, 330.2]; // Ukuran F4
            const doc = new jsPDF({ orientation, unit: 'mm', format });
            const s = metaData.sekolah || {};
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const centerX = pageWidth / 2;

            // 1. HEADER KOP SURAT
            const addHeader = async () => {
                doc.setFont("times", "normal");
                const defaultLogoKiri = "https://drive.google.com/thumbnail?id=1Z6g-sCdw-k7W8dnw12NeagPkroLlmk-L";
                const defaultLogoKanan = ""; 
                
                const urlKiri = s.logo_kiri || s.logo_url || defaultLogoKiri;
                const urlKanan = s.logo_kanan || defaultLogoKanan; 
                
                if (urlKiri) { 
                    const imgData = await getBase64FromUrl(urlKiri); 
                    if (imgData) doc.addImage(imgData, 'PNG', 10, 10, 25, 25); 
                }
                if (urlKanan) { 
                    const imgData2 = await getBase64FromUrl(urlKanan); 
                    if (imgData2) doc.addImage(imgData2, 'PNG', pageWidth - 35, 10, 25, 25); 
                }

                let currentY = 15;
                // Semua Kop Surat ukuran 12, KECUALI NAMA SEKOLAH ukuran 14
                doc.setFontSize(12); doc.text((s.pemerintah || "PEMERINTAH KOTA").toUpperCase(), centerX, currentY, { align: 'center' });
                currentY += 5; doc.text((s.instansi || "DINAS PENDIDIKAN").toUpperCase(), centerX, currentY, { align: 'center' });
                
                currentY += 6; doc.setFont("times", "bold"); doc.setFontSize(14); doc.text((s.nama || "NAMA SEKOLAH").toUpperCase(), centerX, currentY, { align: 'center' });
                
                currentY += 5; doc.setFontSize(12); doc.text((s.judul_bk || "BIMBINGAN DAN KONSELING").toUpperCase(), centerX, currentY, { align: 'center' });
                currentY += 5; doc.setFont("times", "normal"); doc.setFontSize(12); doc.text(s.alamat || "Alamat Sekolah Lengkap", centerX, currentY, { align: 'center' });
                
                // Garis Kop
                currentY += 4; doc.setLineWidth(0.8); doc.line(10, currentY, pageWidth - 10, currentY); 
                doc.setLineWidth(0.3); doc.line(10, currentY + 1.2, pageWidth - 10, currentY + 1.2); 
                return currentY + 10;
            };

            let startY = await addHeader();

            // 2. ISI TABEL
            if (isRecap) {
                // === MODE REKAP ===
                doc.setFont("times", "bold"); doc.setFontSize(12);
                doc.text(`REKAPITULASI ${currentTitle.toUpperCase()}`, centerX, startY, { align: 'center' });
                if(subTitle) { startY += 5; doc.setFontSize(11); doc.setFont("times", "italic"); doc.text(subTitle, centerX, startY, { align: 'center' }); }
                
                if(data.length > 0) {
                    const allKeys = Object.keys(data[0]);
                    let relevantKeys = [];
                    
                    // --- KUSTOMISASI KOLOM CETAK REKAP ---
                    if (currentSheet === '7_Layanan_Individu') {
                        relevantKeys = ['Tanggal_Layanan', 'Nama_Siswa', 'Kelas', 'Bidang_Bimbingan', 'Identifikasi_Masalah', 'Alternatif_Pemecahan', 'Hasil', 'Status_Konseling'];
                    } else if (currentSheet === '8_Layanan_Kelompok') {
                        relevantKeys = ['Tanggal_Layanan', 'Anggota_Kelompok_Siswa', 'Bidang_Layanan', 'Identifikasi_Masalah', 'Hasil', 'Status_Proses'];
                    } else if (currentSheet === '9_Bimbingan_Kelompok') {
                        relevantKeys = ['Tanggal_Layanan', 'Anggota_Kelompok_Siswa', 'Bidang_Layanan', 'Tujuan_Layanan', 'Identifikasi', 'Status_Proses'];
                    } else if (currentSheet === '10_Konsultasi') {
                        relevantKeys = ['Tanggal_Layanan', 'Nama_Konsulti', 'Status_Konsulti', 'Bidang_Bimbingan', 'Uraian_Topik', 'Hasil_Konsultasi', 'Tindak_Lanjut'];
                    } else {
                        const excludedKeys = ['ID_Unik', 'rowIndex', 'Created_By'];
                        relevantKeys = allKeys.filter(k => !excludedKeys.includes(k)).slice(0, 8);
                    }

                    // Format Header
                    const headerDisplay = relevantKeys.map(h => toProperCase(h.replace(/_/g, ' ')));
                    
                    // Format Isi Tabel
                    const body = data.map(row => relevantKeys.map(h => {
                         let val = row[h];
                         if(h && h.includes('Tanggal')) val = formatTanggalIndo(val);
                         return val;
                    }));

                    doc.autoTable({
                        startY: startY + 5, head: [headerDisplay], body: body, theme: 'grid',
                        // Font Times 11 untuk Rekap
                        styles: { font: "times", fontSize: 11, cellPadding: 1.5, lineWidth: 0.1, lineColor: 0 },
                        headStyles: { fillColor: [220, 220, 220], textColor: 0, fontStyle: 'bold', lineWidth: 0.1 },
                        margin: { top: 10, left: 10, right: 10, bottom: 20 }
                    });
                }
            } else {
                // === MODE LAPORAN SATUAN ===
                const item = data[0]; 
                // Kotak Judul
                doc.setFillColor(240, 240, 240); doc.rect(centerX - 60, startY - 5, 120, 10, 'F');
                doc.setFont("times", "bold"); doc.setFontSize(12); doc.setTextColor(0, 0, 0); 
                doc.text(`LAPORAN ${currentTitle.toUpperCase()}`, centerX, startY + 1.5, { align: 'center' });
                
                let currentY = startY + 15;
                const excludedKeys = ['ID_Unik', 'rowIndex', 'Created_By'];
                const keys = Object.keys(item).filter(k => !excludedKeys.includes(k));
                
                const bodyData = keys.map(key => {
                    let val = item[key] || '-';
                    if(key.includes('Tanggal')) val = formatTanggalIndo(val);
                    return [toProperCase(key.replace(/_/g, ' ')), String(val)];
                });

                doc.autoTable({
                    startY: currentY, head: [['DATA / INFORMASI', 'KETERANGAN']], body: bodyData, theme: 'grid', 
                    // Font Times 11 & Padding diperkecil jadi 1.5 (agar baris lebih rapat)
                    styles: { font: "times", fontSize: 11, cellPadding: 1.5, lineColor: [0, 0, 0], lineWidth: 0.1, valign: 'middle', overflow: 'linebreak' },
                    // Background biru dibuang, diganti abu-abu terang elegan
                    headStyles: { fillColor: [220, 220, 220], textColor: 0, fontStyle: 'bold', halign: 'center', cellPadding: 2 },
                    // Lebar kolom DATA diperkecil jadi 45 agar kolom KETERANGAN lebih dekat
                    columnStyles: { 0: { cellWidth: 45, fillColor: 255, fontStyle: 'bold', textColor: [0, 0, 0] }, 1: { cellWidth: 'auto', fillColor: 255, textColor: 0 } },
                    margin: { left: 15, right: 15 }
                });
            }

            // 3. LOGIKA TANDA TANGAN & 4. QR CODE (GABUNGAN)
            let finalY = doc.lastAutoTable ? doc.lastAutoTable.finalY + 15 : startY + 50;
            const limitPage = pageHeight - 60; 
            if(finalY > limitPage) { doc.addPage(); finalY = 40; }

            const dateStr = new Date().toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'});
            
            doc.setFont("times", "normal"); doc.setFontSize(11); doc.setTextColor(0,0,0);
            
            // Ambil data Kepsek dari Metadata (jika ada)
            const namaKepsek = (metaData.sekolah && metaData.sekolah.kepsek) ? metaData.sekolah.kepsek : "..............................";
            const nipKepsek = (metaData.sekolah && metaData.sekolah.nip_kepsek) ? metaData.sekolah.nip_kepsek : "..................";

            // Siapkan text QR Code terlebih dahulu
            let qrText = "";
            if (isRecap) {
                const periodText = subTitle ? subTitle : "Semua Periode";
                qrText = `DOKUMEN SAH SIAP-BK.\nJenis: REKAP ${currentTitle}\nTotal: ${data.length}\nGuru BK: ${currentUser.nama}\nKepsek: ${namaKepsek}`;
            } else {
                const studentName = data[0]['Nama_Siswa'] || data[0]['Nama_Siswa_1'] || data[0]['Nama_Kegiatan'] || '-';
                qrText = `DOKUMEN SAH SIAP-BK.\nJenis: ${currentTitle}\nSiswa: ${studentName}\nTgl: ${dateStr}\nGuru BK: ${currentUser.nama}`;
            }

            // Generate Image QR Code
            let qrImage = null;
            try {
                const qr = new QRious({ value: qrText, size: 100, level: 'H' });
                qrImage = qr.toDataURL();
            } catch (qrErr) { console.warn("QR Error", qrErr); }

            let sigTopY = finalY;

            // KONDISI 1: JIKA REKAP ATAU LAYANAN YANG BUTUH 2 TANDA TANGAN (KEPSEK & GURU BK)
            if (isRecap || ['12_Konferensi_Kasus', '13_Alih_Tangan_Kasus'].includes(currentSheet)) {
                
                doc.text("Mengetahui,", 40, sigTopY, { align: 'center' });
                doc.text("Kepala Sekolah", 40, sigTopY + 5, { align: 'center' });
                doc.text(`Makassar, ${dateStr}`, pageWidth - 40, sigTopY, { align: 'center' });
                doc.text("Guru Bimbingan Konseling", pageWidth - 40, sigTopY + 5, { align: 'center' });
                
                // Print QR di TENGAH (antara Kepsek dan Guru BK)
                if (qrImage) {
                    doc.addImage(qrImage, 'PNG', centerX - 12.5, sigTopY - 2, 25, 25);
                    doc.setFontSize(7); doc.text("Scan Validasi", centerX, sigTopY + 26, { align: 'center' });
                    doc.setFontSize(11); // kembalikan ukuran font
                }

                finalY += 25;
                
                // Tanda Tangan Kepsek (Kiri)
                doc.setFont("times", "bold"); doc.text(namaKepsek, 40, finalY, { align: 'center' });
                const kWidth = doc.getTextWidth(namaKepsek); doc.setLineWidth(0.2); doc.line(40 - kWidth/2, finalY + 1, 40 + kWidth/2, finalY + 1);
                doc.setFont("times", "normal"); doc.text(`NIP. ${nipKepsek}`, 40, finalY + 5, { align: 'center' });
                
                // Tanda Tangan Guru BK (Kanan)
                doc.setFont("times", "bold"); doc.text(currentUser.nama, pageWidth - 40, finalY, { align: 'center' });
                const bWidth = doc.getTextWidth(currentUser.nama); doc.line(pageWidth - 40 - bWidth/2, finalY + 1, pageWidth - 40 + bWidth/2, finalY + 1);
                doc.setFont("times", "normal"); doc.text(`NIP. ${currentUser.nip}`, pageWidth - 40, finalY + 5, { align: 'center' });

            } 
            // KONDISI 2: HANYA GURU BK SAJA
            else {
                // Geser posisi teks Guru BK agak ke kanan sedikit agar seimbang dengan QR Code di kirinya
                doc.text(`Makassar, ${dateStr}`, centerX + 25, sigTopY, { align: 'center' });
                doc.text("Guru Bimbingan Konseling", centerX + 25, sigTopY + 5, { align: 'center' });
                
                // Print QR di SAMPING KIRI Guru BK
                if (qrImage) {
                    doc.addImage(qrImage, 'PNG', centerX - 45, sigTopY - 2, 25, 25);
                    doc.setFontSize(7); doc.text("Scan Validasi", centerX - 32.5, sigTopY + 26, { align: 'center' });
                    doc.setFontSize(11); // kembalikan ukuran font
                }

                finalY += 25;
                
                doc.setFont("times", "bold"); doc.text(currentUser.nama, centerX + 25, finalY, { align: 'center' });
                const textWidth = doc.getTextWidth(currentUser.nama);
                doc.setLineWidth(0.2); doc.line(centerX + 25 - (textWidth / 2), finalY + 1, centerX + 25 + (textWidth / 2), finalY + 1);
                doc.setFont("times", "normal"); doc.text(`NIP. ${currentUser.nip}`, centerX + 25, finalY + 5, { align: 'center' });
            }

            try { 
                const blob = doc.output('blob'); 
                const blobURL = URL.createObjectURL(blob); 
                window.open(blobURL, '_blank'); 
            } catch (e) { 
                doc.save(`${filename}.pdf`); 
            }
        }

        // --- FORM ---
        function getFieldsConfig(sheetName) { /* ... unchanged ... */ 
            const common = [{ key: 'Tanggal_Layanan', label: 'Tanggal Layanan', type: 'date' }, { key: 'Tahun_Ajar', label: 'Tahun Ajaran', type: 'text', placeholder: 'Contoh: 2025/2026' }, { key: 'Semester', label: 'Semester', type: 'select', options: ['Ganjil', 'Genap'] }];
            if(sheetName === '7_Layanan_Individu') return [...common, { key: 'Konseling_Ke', label: 'Konseling Ke-', type: 'number' }, { key: 'Nama_Siswa', label: 'Nama Siswa', type: 'select', options: 'siswa' }, { key: 'Kelas', label: 'Kelas', type: 'readonly' }, { key: 'NISN', label: 'NISN', type: 'readonly' }, { key: 'Ruang', label: 'Ruang', type: 'text' }, { key: 'Komponen_Layanan', label: 'Komponen Layanan', type: 'select', options: ['Layanan Dasar', 'Layanan Peminatan', 'Layanan Responsif', 'Dukungan Sistem'] }, { key: 'Bidang_Bimbingan', label: 'Bidang Bimbingan', type: 'select', options: ['Pribadi', 'Sosial', 'Belajar', 'Karir','Pibadi Sosial'] }, { key: 'Identifikasi_Masalah', label: 'Identifikasi Masalah', type: 'text' }, { key: 'Penjelasan_Masalah', label: 'Penjelasan Masalah', type: 'textarea' }, { key: 'Pendekatan', label: 'Pendekatan', type: 'select', options: 'pendekatan' }, { key: 'Teknik_Konseling', label: 'Teknik Konseling', type: 'select', options: 'teknik' }, { key: 'Aspek_Layanan', label: 'Aspek Layanan', type: 'select', options: 'aspek' }, { key: 'Alternatif_Pemecahan', label: 'Alternatif Pemecahan', type: 'textarea' }, { key: 'Hasil', label: 'Hasil Konseling', type: 'textarea' }, { key: 'Status_Konseling', label: 'Status', type: 'select', options: ['Proses', 'Selesai', 'Rujuk', 'Drop Out'] }];
            if(sheetName === '8_Layanan_Kelompok') return [...common, { key: 'Durasi', label: 'Durasi (Menit)', type: 'text' }, { key: 'Tempat', label: 'Tempat', type: 'text' }, { key: 'Anggota_Kelompok_Siswa', label: 'Anggota Kelompok (Siswa)', type: 'multi-select-siswa', placeholder: 'Ketik nama siswa lalu pilih...' }, { key: 'Komponen_Layanan', label: 'Komponen', type: 'select', options: ['Layanan Responsif', 'Layanan Dasar'] }, { key: 'Bidang_Layanan', label: 'Bidang', type: 'select', options: ['Pribadi', 'Sosial', 'Belajar', 'Karir','Pibadi Sosial'] }, { key: 'Identifikasi_Masalah', label: 'Identifikasi Masalah', type: 'text' }, { key: 'Pendekatan', label: 'Pendekatan', type: 'select', options: 'pendekatan' }, { key: 'Teknik_Konseling', label: 'Teknik', type: 'select', options: 'teknik' }, { key: 'Aspek_Layanan', label: 'Aspek', type: 'select', options: 'aspek' }, { key: 'Penyebab_Masalah', label: 'Penyebab Masalah', type: 'textarea' }, { key: 'Alternatif_Pemecahan', label: 'Alternatif Pemecahan', type: 'textarea' }, { key: 'Hasil', label: 'Hasil Layanan', type: 'textarea' }, { key: 'Status_Proses', label: 'Status Proses', type: 'select', options: ['Aktif', 'Selesai'] }];
            if(sheetName === '9_Bimbingan_Kelompok') return [...common, { key: 'Durasi', label: 'Durasi (Menit)', type: 'text' }, { key: 'Anggota_Kelompok_Siswa', label: 'Anggota Kelompok', type: 'multi-select-siswa', placeholder: 'Ketik nama siswa lalu pilih...' }, { key: 'Komponen_Layanan', label: 'Komponen', type: 'select', options: ['Layanan Dasar', 'Layanan Peminatan'] }, { key: 'Bidang_Layanan', label: 'Bidang', type: 'select', options: ['Pribadi', 'Sosial', 'Belajar', 'Karir','Pibadi Sosial'] }, { key: 'Aspek_Layanan', label: 'Aspek', type: 'select', options: 'aspek' }, { key: 'Topik_Layanan', label: 'Topik Layanan', type: 'text', placeholder: 'Contoh: Bahaya Cyberbullying' }, { key: 'Tujuan_Layanan', label: 'Tujuan Layanan', type: 'textarea' }, { key: 'Eksperientasi_Awal', label: 'Tahap Awal', type: 'textarea' }, { key: 'Identifikasi', label: 'Tahap Identifikasi', type: 'textarea' }, { key: 'Analisis', label: 'Tahap Analisis', type: 'textarea' }, { key: 'Generalisasi', label: 'Tahap Generalisasi', type: 'textarea' }, { key: 'Status_Proses', label: 'Status', type: 'select', options: ['Selesai', 'Berlanjut'] }];
            if(sheetName === '10_Konsultasi') return [...common, { key: 'Durasi', label: 'Durasi', type: 'text' }, { key: 'Nama_Konsulti', label: 'Nama Konsulti (Orang Tua/Guru)', type: 'text' }, { key: 'Status_Konsulti', label: 'Status Konsulti', type: 'select', options: ['Orang Tua', 'Guru Mapel', 'Wali Kelas', 'Lainnya'] }, { key: 'Nama_Konsultan_GuruBK', label: 'Nama Konsultan (Guru BK)', type: 'text', value: currentUser.nama }, { key: 'Komponen_Layanan', label: 'Komponen', type: 'select', options: ['Dukungan Sistem', 'Layanan Responsif'] }, { key: 'Bidang_Bimbingan', label: 'Bidang', type: 'select', options: ['Pribadi', 'Sosial', 'Belajar', 'Karir','Pibadi Sosial'] }, { key: 'Uraian_Topik', label: 'Uraian Topik', type: 'textarea' }, { key: 'Hasil_Konsultasi', label: 'Hasil Konsultasi', type: 'textarea' }, { key: 'Tindak_Lanjut', label: 'Tindak Lanjut', type: 'textarea' }];
            if(sheetName === '11_Layanan_Klasikal') return [{ key: 'Tanggal', label: 'Tanggal', type: 'date' }, { key: 'Semester', label: 'Semester', type: 'select', options: ['Ganjil', 'Genap'] }, { key: 'Sasaran_Layanan', label: 'Sasaran (Kelas)', type: 'text' }, { key: 'Jumlah_Peserta', label: 'Jumlah Peserta', type: 'number' }, { key: 'Topik_Layanan', label: 'Topik Layanan', type: 'text' }, { key: 'Bidang_Layanan', label: 'Bidang', type: 'select', options: ['Pribadi', 'Sosial', 'Belajar', 'Karir','Pibadi Sosial'] }, { key: 'Metode_Layanan', label: 'Metode', type: 'text' }, { key: 'Media_Sumber', label: 'Media / Sumber', type: 'text' }, { key: 'Tujuan_Layanan', label: 'Tujuan', type: 'textarea' }, { key: 'Aspek_Layanan', label: 'Aspek', type: 'select', options: 'aspek' }, { key: 'Capaian_Layanan', label: 'Capaian', type: 'textarea' }, { key: 'Evaluasi_Tindak_Lanjut', label: 'Evaluasi & Tindak Lanjut', type: 'textarea' }, { key: 'Dokumentasi_Link', label: 'Link Dokumentasi (Foto/Drive)', type: 'text' }];
            if(sheetName === '12_Konferensi_Kasus') return [...common, { key: 'Nama_Siswa', label: 'Nama Siswa (Kasus)', type: 'select', options: 'siswa' }, { key: 'Kelas', label: 'Kelas', type: 'readonly' }, { key: 'NISN', label: 'NISN', type: 'readonly' }, { key: 'Pihak_Terlibat', label: 'Pihak Terlibat (Ortu/Kepsek)', type: 'text' }, { key: 'Tempat_Pertemuan', label: 'Tempat Pertemuan', type: 'text' }, { key: 'Deskripsi_Kasus', label: 'Deskripsi Kasus', type: 'textarea' }, { key: 'Hasil_Keputusan', label: 'Hasil Keputusan (Berita Acara)', type: 'textarea' }, { key: 'Tindak_Lanjut', label: 'Tindak Lanjut', type: 'textarea' }];
            if(sheetName === '13_Alih_Tangan_Kasus') return [...common, { key: 'Nama_Siswa', label: 'Nama Siswa', type: 'select', options: 'siswa' }, { key: 'Kelas', label: 'Kelas', type: 'readonly' }, { key: 'NISN', label: 'NISN', type: 'readonly' }, { key: 'Pihak_Penerima', label: 'Dirujuk Kepada (Psikolog/Dokter/dll)', type: 'text' }, { key: 'Alamat_Penerima', label: 'Alamat Pihak Penerima', type: 'text' }, { key: 'Alasan_Rujukan', label: 'Alasan Rujukan', type: 'textarea' }, { key: 'Dokumen_Penyerta', label: 'Dokumen Penyerta (Rekam Medis dll)', type: 'text' }, { key: 'Hasil_Rujukan', label: 'Hasil (Umpan Balik)', type: 'textarea' }, { key: 'Status_Rujukan', label: 'Status', type: 'select', options: ['Dikirim', 'Diterima', 'Selesai'] }];
            if(sheetName === '14_Mediasi') return [
				...common, 
				// Pihak 1
				{ key: 'Nama_Siswa_1', label: 'Pihak 1 (Siswa)', type: 'select', options: 'siswa' }, 
				{ key: 'Kelas_1', label: 'Kelas Pihak 1', type: 'readonly' }, // <--- INI KITA TAMBAH
				
				// Pihak 2 (Kita ubah jadi select siswa juga, dan tambah kelasnya)
				{ key: 'Nama_Siswa_2', label: 'Pihak 2 (Siswa Lawan)', type: 'select', options: 'siswa' }, 
				{ key: 'Kelas_2', label: 'Kelas Pihak 2', type: 'readonly' }, // <--- INI KITA TAMBAH

				{ key: 'Pokok_Masalah', label: 'Pokok Masalah', type: 'textarea' }, 
				{ key: 'Hasil_Kesepakatan', label: 'Isi Perjanjian Damai', type: 'textarea' }, 
				{ key: 'Status_Mediasi', label: 'Status', type: 'select', options: ['Berhasil Damai', 'Gagal', 'Perlu Tindak Lanjut'] }
			];
            if(sheetName === '15_Advokasi') return [...common, { key: 'Nama_Siswa', label: 'Nama Siswa', type: 'select', options: 'siswa' }, { key: 'Kelas', label: 'Kelas', type: 'readonly' }, { key: 'NISN', label: 'NISN', type: 'readonly' }, { key: 'Pihak_Terkait', label: 'Pihak Terkait (Yang melanggar hak)', type: 'text' }, { key: 'Kronologi_Masalah', label: 'Kronologi Kejadian', type: 'textarea' }, { key: 'Bentuk_Advokasi', label: 'Bentuk Advokasi / Pembelaan', type: 'textarea' }, { key: 'Hasil_Advokasi', label: 'Hasil Advokasi', type: 'textarea' }, { key: 'Status_Advokasi', label: 'Status', type: 'select', options: ['Berjalan', 'Selesai'] }];
            if(sheetName === '16_Dukungan_Sistem') return [{ key: 'Tanggal_Kegiatan', label: 'Tanggal Kegiatan', type: 'date' }, { key: 'Tahun_Ajar', label: 'Tahun Ajaran', type: 'text', placeholder: 'Contoh: 2025/2026' }, { key: 'Semester', label: 'Semester', type: 'select', options: ['Ganjil', 'Genap'] }, { key: 'Nama_Kegiatan', label: 'Nama Kegiatan (MGBK/Diklat/Rapat)', type: 'text' }, { key: 'Penyelenggara', label: 'Penyelenggara', type: 'text' }, { key: 'Peran_GuruBK', label: 'Peran Guru BK', type: 'select', options: ['Peserta', 'Panitia', 'Narasumber'] }, { key: 'Tempat', label: 'Tempat', type: 'text' }, { key: 'Deskripsi_Kegiatan', label: 'Deskripsi Singkat', type: 'textarea' }, { key: 'Hasil_Kegiatan', label: 'Hasil / Output', type: 'textarea' }];
            return [];
        }
        function showForm(isEdit = false, id = null) {
            editMode = isEdit;
            editId = id;
            document.getElementById('form-header').innerText = isEdit ? `Edit Data` : `Input Data Baru`;
            document.getElementById('form-sub-header').innerText = currentTitle; // Tampilkan nama layanan
            
            const form = document.getElementById('dynamic-form');
            form.innerHTML = '';
            
            const fields = getFieldsConfig(currentSheet);
            let existingData = {};
            if(isEdit) existingData = activeDataList.find(x => x.ID_Unik === id) || {};
            
            fields.forEach((f, index) => {
                const div = document.createElement('div'); 
                
                //  LOGIKA LEBAR KOLOM
                const isFullWidth = f.type === 'textarea' || f.type === 'multi-select-siswa' || f.key.includes('Identifikasi') || f.key.includes('Masalah');
                
                div.className = `flex flex-col relative group transform transition-all duration-500 opacity-0 translate-y-4 ${isFullWidth ? 'md:col-span-2' : ''}`;
                setTimeout(() => { div.classList.remove('opacity-0', 'translate-y-4'); }, 30 * index); // Animasi lebih cepat

                //  DESAIN LABEL 
                const label = document.createElement('label'); 
                let iconLabel = '<i class="fa-solid fa-cube text-blue-400"></i>';
                if(f.type === 'date') iconLabel = '<i class="fa-regular fa-calendar text-green-400"></i>';
                if(f.type === 'select' || f.type === 'multi-select-siswa') iconLabel = '<i class="fa-solid fa-list-ul text-purple-400"></i>';
                if(f.type === 'textarea') iconLabel = '<i class="fa-solid fa-align-left text-orange-400"></i>';
                
                label.className = "text-[11px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-2 ml-1 flex items-center gap-2"; 
                label.innerHTML = `${iconLabel} ${f.label}`;

                let input;
                const val = isEdit ? (existingData[f.key] || '') : (f.value || '');
                
                //  DESAIN KOTAK INPUT
                const baseClass = "w-full p-4 rounded-xl border border-gray-200 dark:border-slate-700 bg-white/80 dark:bg-slate-800 text-slate-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white dark:focus:bg-slate-800 font-medium placeholder-gray-400 shadow-sm transition-all hover:border-blue-300 dark:hover:border-slate-500 group-hover:shadow-md";
                
                if (f.type === 'select') {
                    if (f.options === 'siswa') {
                        input = document.createElement('input');
                        input.setAttribute('list', `list-${f.key}`);
                        input.className = baseClass;
                        input.value = val;
                        input.placeholder = "Ketik untuk mencari nama siswa..."; 
                        const datalist = document.createElement('datalist');
                        datalist.id = `list-${f.key}`;
                        let opts = metaData[f.options] || [];
                        datalist.innerHTML = opts.map(o => {
                            if(typeof o === 'object') return `<option value="${o.nama}">${o.kelas} - ${o.nisn || ''}</option>`; 
                            return `<option value="${o}"></option>`;
                        }).join('');
                        if(f.key.includes('Nama_Siswa')) { input.onchange = (e) => autoFillSiswa(e.target.value, f.key); }
                        div.appendChild(datalist);
                    } else {
                        input = document.createElement('select'); 
                        input.className = baseClass + " cursor-pointer appearance-none"; 
                        input.style.backgroundImage = `url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e")`;
                        input.style.backgroundPosition = `right 1.2rem center`;
                        input.style.backgroundRepeat = `no-repeat`;
                        input.style.backgroundSize = `1.2em 1.2em`;

                        let opts = f.options || [];
                        if(typeof f.options === 'string') opts = metaData[f.options] || [];
                        input.innerHTML = `<option value="">-- Pilih ${f.label} --</option>` + opts.map(o => {
                            if(typeof o === 'object') return `<option value="${o.nama}" ${o.nama===val?'selected':''}>${o.nama} (${o.kelas})</option>`;
                            return `<option value="${o}" ${o===val?'selected':''}>${o}</option>`;
                        }).join('');
                        if(f.key.includes('Nama_Siswa')) { input.onchange = (e) => autoFillSiswa(e.target.value, f.key); }
                    }
                } else if (f.type === 'textarea') {
                    input = document.createElement('textarea'); 
                    input.className = baseClass + " min-h-[120px] resize-y leading-relaxed"; 
                    input.rows = 3; input.value = val; 
                    input.placeholder = f.placeholder || `Ketikkan detail ${f.label.toLowerCase()} di sini...`;
                } else if (f.type === 'date') {
                    input = document.createElement('input'); 
                    input.type = 'date'; input.className = baseClass + " cursor-pointer";
                    if(val) { let d = new Date(val); if(!isNaN(d)) input.value = d.toISOString().split('T')[0]; }
                } else if (f.type === 'multi-select-siswa') {
                    // Logic Multi-select persis seperti revisi 1
                    input = document.createElement('div');
                    input.className = "relative w-full";
                    
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = "hidden"; hiddenInput.name = f.key; hiddenInput.id = `field-${f.key}`; hiddenInput.value = val;
                    
                    const tagsContainer = document.createElement('div');
                    tagsContainer.className = baseClass + " min-h-[55px] flex flex-wrap gap-2 items-center p-2 cursor-text";
                    
                    const searchInput = document.createElement('input');
                    searchInput.type = "text"; searchInput.className = "flex-1 outline-none bg-transparent min-w-[150px] text-sm dark:text-white mt-1";
                    searchInput.placeholder = f.placeholder || "Ketik nama siswa...";
                    
                    const dropdown = document.createElement('div');
                    dropdown.className = "absolute z-50 w-full bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 rounded-xl mt-2 shadow-2xl max-h-48 overflow-y-auto hidden custom-scroll";
                    
                    tagsContainer.appendChild(searchInput);
                    input.appendChild(tagsContainer); input.appendChild(dropdown); input.appendChild(hiddenInput);
                    
                    let tagsArray = val ? val.split(',').map(t => t.trim()).filter(Boolean) : [];
                    
                    const renderTags = () => {
                        Array.from(tagsContainer.children).forEach(child => { if(child !== searchInput) tagsContainer.removeChild(child); });
                        tagsArray.forEach((tag, index) => {
                            const tagEl = document.createElement('span');
                            tagEl.className = "bg-blue-100 dark:bg-blue-900/60 text-blue-700 dark:text-blue-300 text-xs px-2.5 py-1.5 rounded-lg flex items-center gap-2 border border-blue-200 dark:border-blue-800 shadow-sm font-semibold";
                            tagEl.innerHTML = `<span>${tag}</span> <i class="fa-solid fa-xmark cursor-pointer hover:text-red-500 transition-colors"></i>`;
                            tagEl.querySelector('i').onclick = (e) => { e.stopPropagation(); tagsArray.splice(index, 1); renderTags(); };
                            tagsContainer.insertBefore(tagEl, searchInput);
                        });
                        hiddenInput.value = tagsArray.join(', ');
                    };

                    tagsContainer.onclick = () => searchInput.focus();
                    searchInput.onkeyup = (e) => {
                        const keyword = e.target.value.toLowerCase();
                        dropdown.innerHTML = '';
                        if(!keyword) { dropdown.classList.add('hidden'); return; }
                        
                        const matches = metaData.siswa.filter(s => s.nama.toLowerCase().includes(keyword)).slice(0, 10);
                        if(matches.length === 0) {
                            dropdown.innerHTML = `<div class="p-3 text-xs text-gray-500 dark:text-gray-400 text-center">Nama tidak ditemukan</div>`;
                            dropdown.classList.remove('hidden'); return;
                        }
                        
                        matches.forEach(s => {
                            const opt = document.createElement('div');
                            opt.className = "p-2.5 hover:bg-blue-50 dark:hover:bg-slate-700 cursor-pointer text-sm border-b dark:border-slate-700/50 last:border-0 transition-colors";
                            opt.innerHTML = `<div class="font-bold dark:text-white text-slate-700">${s.nama}</div><div class="text-[10px] text-blue-500 font-medium mt-0.5">Kelas: ${s.kelas}</div>`;
                            opt.onclick = () => {
                                const finalName = `${s.nama} (${s.kelas})`;
                                if(!tagsArray.includes(finalName)) tagsArray.push(finalName); 
                                else showToast('Siswa sudah ada di grup!', 'error');
                                searchInput.value = ''; dropdown.classList.add('hidden'); renderTags(); searchInput.focus();
                            };
                            dropdown.appendChild(opt);
                        });
                        dropdown.classList.remove('hidden');
                    };
                    document.addEventListener('click', (e) => { if(!input.contains(e.target)) dropdown.classList.add('hidden'); });
                    renderTags();
                } else {
                    input = document.createElement('input'); 
                    input.type = f.type || 'text'; 
                    input.className = baseClass + (f.type === 'readonly' ? " bg-slate-100 dark:bg-slate-700/50 text-slate-500 cursor-not-allowed border-dashed" : ""); 
                    input.value = val; 
                    if(f.type === 'readonly') input.readOnly = true; 
                    input.placeholder = f.placeholder || `Masukkan ${f.label.toLowerCase()}...`;
                }
                
                input.name = f.key; input.id = `field-${f.key}`;
                div.appendChild(label); 
                div.appendChild(input); 
                
				//  AUTO-INJECT MIC (Hanya untuk tipe text dan textarea)
                if (f.type === 'text' || f.type === 'textarea' || f.type === 'number') {
                    const micBtn = document.createElement('button');
                    micBtn.type = "button";
                    micBtn.id = `btn-mic-${f.key}`;
                    // Posisi mic di kanan bawah isian agar estetik
                    micBtn.className = "absolute right-3 bottom-3 text-slate-400 hover:text-blue-500 transition-all z-20 p-1";
                    micBtn.innerHTML = '<i class="fa-solid fa-microphone"></i>';
                    micBtn.title = "Dikte Suara (Jarvis Mode)";
                    micBtn.onclick = () => startDictation(f.key);
                    div.appendChild(micBtn);
                    
                    // Beri padding kanan sedikit agar teks tidak tertabrak ikon mic
                    input.classList.add('pr-10');
                }
				
                //  TOMBOL AI MELAYANG ESTETIK
                const btnContainer = document.createElement('div');
                btnContainer.className = "flex gap-2 absolute right-2 -top-1 z-10"; 

                const aiTargets = ['Alternatif_Pemecahan', 'Hasil', 'Tindak_Lanjut', 'Hasil_Rujukan', 'Hasil_Kesepakatan', 'Bentuk_Advokasi', 'Hasil_Advokasi', 'Hasil_Konsultasi', 'Capaian_Layanan', 'Evaluasi_Tindak_Lanjut'];
                if(aiTargets.includes(f.key)) {
                    const aiBtn = document.createElement('button');
                    aiBtn.type = "button"; aiBtn.id = `btn-ai-${f.key}`;
                    aiBtn.className = "flex items-center gap-1.5 text-[10px] font-bold text-white bg-gradient-to-r from-purple-500 to-indigo-500 hover:from-purple-600 hover:to-indigo-600 px-2.5 py-1 rounded-lg shadow-md transition-all btn-press ring-4 ring-slate-50 dark:ring-slate-900";
                    aiBtn.innerHTML = `<i class="fa-solid fa-wand-magic-sparkles"></i> AI Asisten`;
                    aiBtn.onclick = () => generateAIDraft(f.key);
                    btnContainer.appendChild(aiBtn);
                }

                const aiRewriters = ['Identifikasi_Masalah', 'Penjelasan_Masalah', 'Penyebab_Masalah', 'Tujuan_Layanan', 'Eksperientasi_Awal', 'Identifikasi', 'Analisis', 'Generalisasi', 'Topik_Layanan', 'Uraian_Topik', 'Deskripsi_Kasus', 'Alasan_Rujukan', 'Pokok_Masalah', 'Kronologi_Masalah', 'Bentuk_Advokasi', 'Deskripsi_Kegiatan'];
                if(aiRewriters.includes(f.key)) {
                    const rewriteBtn = document.createElement('button');
                    rewriteBtn.type = "button"; rewriteBtn.id = `btn-rewrite-${f.key}`;
                    rewriteBtn.className = "flex items-center gap-1.5 text-[10px] font-bold text-slate-700 bg-gradient-to-r from-amber-300 to-yellow-400 hover:from-amber-400 hover:to-yellow-500 px-2.5 py-1 rounded-lg shadow-md transition-all btn-press ring-4 ring-slate-50 dark:ring-slate-900";
                    rewriteBtn.innerHTML = `<i class="fa-solid fa-pen-nib"></i> Rapihkan`;
                    rewriteBtn.onclick = () => rewriteTextAI(f.key);
                    btnContainer.appendChild(rewriteBtn);
                }

                if(btnContainer.children.length > 0) {
                    div.appendChild(btnContainer);
                    if(f.type === 'textarea') input.classList.add('pt-6');
                }
                
                form.appendChild(div);
            });
            
            // LOGIKA NAVIGASI HALAMAN PENUH
            // Sembunyikan halaman tabel layanan, tampilkan form
            document.getElementById('page-service').classList.add('hide');
            document.getElementById('page-form').classList.remove('hide');
        }

        function closeForm() { 
            // Sembunyikan form, kembalikan ke halaman tabel layanan
            document.getElementById('page-form').classList.add('hide'); 
            document.getElementById('page-service').classList.remove('hide');
        }
        // GANTI FUNCTION autoFillSiswa YANG LAMA DENGAN INI
		function autoFillSiswa(nama, fieldKey) {
			// 1. Cari data siswa di metadata
			const s = metaData.siswa.find(x => x.nama === nama);
			if(!s) return;

			// 2. Tentukan target kolom Kelas berdasarkan siapa yang dipilih
			let targetKelasId = 'field-Kelas'; // Default (untuk layanan individu dll)
			let targetNisnId = 'field-NISN';

			if (fieldKey === 'Nama_Siswa_1') {
				targetKelasId = 'field-Kelas_1'; // Target khusus Mediasi Pihak 1
			} else if (fieldKey === 'Nama_Siswa_2') {
				targetKelasId = 'field-Kelas_2'; // Target khusus Mediasi Pihak 2
			}

			// 3. Isi Nilainya jika elemennya ada di form
			const elKelas = document.getElementById(targetKelasId);
			if(elKelas) elKelas.value = s.kelas;

			const elNisn = document.getElementById(targetNisnId);
			if(elNisn) elNisn.value = s.nisn;
		}
		// --- FITUR PREMIUM: GENERATE AI DRAFT ---
        async function generateAIDraft(targetField) {
            // 1. Kumpulkan konteks masalah dari form yang sedang diisi
            let contextText = "";
            const formElements = document.getElementById('dynamic-form').elements;
            for(let el of formElements) {
                // Cari kolom yang mengandung kata kunci masalah/topik
                if((el.name.includes('Masalah') || el.name.includes('Topik') || el.name.includes('Alasan') || el.name.includes('Kronologi') || el.name.includes('Deskripsi')) && el.value.trim() !== "") {
                    contextText += `${el.name.replace(/_/g, ' ')}: ${el.value}\n`;
                }
            }

            if(!contextText) {
                Swal.fire("Tunggu Dulu", "Tuliskan dulu Identifikasi Masalah / Kronologi / Topiknya di atas, agar AI paham apa yang harus diselesaikan.", "warning");
                return;
            }

            const targetEl = document.getElementById(`field-${targetField}`);
            const btnEl = document.getElementById(`btn-ai-${targetField}`);
            
            // 2. Ubah UI tombol jadi status Loading
            const originalBtnText = btnEl.innerHTML;
            btnEl.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> AI Sedang Berpikir...`;
            btnEl.disabled = true;
            targetEl.value = "Meminta petunjuk AI...";

            try {
                // 3. Tembak ke Backend
                // note+++ PERBAIKAN: Tambahkan targetField ke dalam payload yang dikirim ke backend
                const payload = { action: 'askAI', prompt: contextText, targetField: targetField };
                const res = await apiCall(payload, 'POST', payload);
                
                if(res && res.status === 'success') {
                    // 4. Efek mengetik elegan (Typing effect)
                    targetEl.value = "";
                    let i = 0;
                    const txt = res.data;
                    const speed = 15; // Kecepatan ketik (ms)
                    
                    function typeWriter() {
                        if (i < txt.length) {
                            targetEl.value += txt.charAt(i);
                            i++;
                            targetEl.scrollTop = targetEl.scrollHeight; // Auto-scroll ke bawah saat ngetik
                            setTimeout(typeWriter, speed);
                        } else {
                            btnEl.innerHTML = `<i class="fa-solid fa-check"></i> Selesai`;
                            setTimeout(() => { btnEl.innerHTML = originalBtnText; btnEl.disabled = false; }, 2000);
                        }
                    }
                    typeWriter();
                } else {
                    targetEl.value = "";
                    Swal.fire("Gagal", res?.message || "AI sedang sibuk.", "error");
                    btnEl.innerHTML = originalBtnText;
                    btnEl.disabled = false;
                }
            } catch(e) {
                targetEl.value = "";
                Swal.fire("Error", "Koneksi ke AI gagal. Cek internet.", "error");
                btnEl.innerHTML = originalBtnText;
                btnEl.disabled = false;
            }
        }
		
		// --- FITUR BARU: AI PENYIHIR BAHASA (REWRITER) ---
        async function rewriteTextAI(targetField) {
            const targetEl = document.getElementById(`field-${targetField}`);
            const btnEl = document.getElementById(`btn-rewrite-${targetField}`);
            const rawText = targetEl.value.trim();

            // Cek apakah Bapak sudah mengetik sesuatu
            if(rawText.length < 5) {
                Swal.fire("Ketik Dulu", "Ketikkan dulu inti masalahnya (minimal beberapa kata), biar AI punya bahan untuk dirapihkan bahasanya.", "warning");
                return;
            }

            const originalBtnText = btnEl.innerHTML;
            btnEl.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Menyihir Bahasa...`;
            btnEl.disabled = true;

            try {
                // Kita "selipkan" instruksi tambahan di prompt agar backend Bapak paham ini tugas merapihkan teks
                const specialPrompt = `TOLONG PERBAIKI, RAPIHKAN, DAN FORMALKAN catatan mentah berikut menjadi kalimat baku laporan administrasi Bimbingan Konseling yang profesional, empatik, dan mudah dipahami. \n\nCatatan Mentah Guru BK: "${rawText}"`;
                
                const payload = { action: 'askAI', prompt: specialPrompt, targetField: targetField };
                const res = await apiCall(payload, 'POST', payload);
                
                if(res && res.status === 'success') {
                    targetEl.value = ""; // Kosongkan yang lama
                    let i = 0;
                    const txt = res.data;
                    const speed = 10; 
                    
                    // Efek mengetik otomatis
                    function typeWriter() {
                        if (i < txt.length) {
                            targetEl.value += txt.charAt(i);
                            i++;
                            targetEl.scrollTop = targetEl.scrollHeight;
                            setTimeout(typeWriter, speed);
                        } else {
                            btnEl.innerHTML = `<i class="fa-solid fa-check text-green-700"></i> Selesai`;
                            setTimeout(() => { btnEl.innerHTML = originalBtnText; btnEl.disabled = false; }, 2000);
                        }
                    }
                    typeWriter();
                } else {
                    Swal.fire("Gagal", res?.message || "AI sedang sibuk.", "error");
                    btnEl.innerHTML = originalBtnText;
                    btnEl.disabled = false;
                }
            } catch(e) {
                Swal.fire("Error", "Sirkuit AI terputus. Cek internet Anda.", "error");
                btnEl.innerHTML = originalBtnText;
                btnEl.disabled = false;
            }
        }
		
		// --- JARVIS MODE: SPEECH TO TEXT ENGINE ---
        function startDictation(fieldId) {
            const btn = document.getElementById(`btn-mic-${fieldId}`);
            const input = document.getElementById(`field-${fieldId}`);
            
            // Cek apakah browser mendukung Speech Recognition
            window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!window.SpeechRecognition) {
                showToast("Maaf, Browser Anda tidak mendukung perintah suara.", "error");
                return;
            }

            const recognition = new SpeechRecognition();
            recognition.lang = 'id-ID'; // Set Bahasa Indonesia
            recognition.interimResults = false;

            // Efek Visual saat merekam
            btn.classList.add('animate-pulse', 'text-red-500', 'scale-125');
            btn.innerHTML = '<i class="fa-solid fa-microphone-lines"></i>';
            showToast("Sistem Mendengarkan... Silakan bicara.", "info");

            recognition.start();

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                // Masukkan hasil suara ke input/textarea (ditambah spasi jika sudah ada teks)
                input.value = input.value ? input.value + " " + transcript : transcript;
                showToast("Suara berhasil direkam!", "success");
            };

            recognition.onerror = (event) => {
                console.error("Speech error:", event.error);
                showToast("Gagal merekam: " + event.error, "error");
            };

            recognition.onend = () => {
                btn.classList.remove('animate-pulse', 'text-red-500', 'scale-125');
                btn.innerHTML = '<i class="fa-solid fa-microphone"></i>';
            };
        }
		
        // --- LOGIKA SIMPAN DATA DENGAN LOADING ---
		async function handleSave(e) {
			e.preventDefault();

			// 1. TAMPILKAN LOADING SEBELUM PROSES MULAI
			document.getElementById('loading').classList.remove('hide');

			try {
				// Ambil Data dari Form
				const formData = new FormData(document.getElementById('dynamic-form'));
				const dataObj = {};
				
				formData.forEach((value, key) => dataObj[key] = value);
				dataObj['Created_By'] = currentUser.username;

				// Auto-Fill Tanggal jika kosong
				if(!dataObj['Tanggal_Layanan'] && !dataObj['Tanggal'] && !dataObj['Tanggal_Kegiatan']) {
					const d = new Date().toISOString().split('T')[0];
					if(currentSheet.includes('Klasikal')) dataObj['Tanggal'] = d; 
					else if(currentSheet.includes('Dukungan')) dataObj['Tanggal_Kegiatan'] = d; 
					else dataObj['Tanggal_Layanan'] = d;
				}

				// Siapkan Payload
				const payload = { 
					action: editMode ? 'updateData' : 'saveData', 
					sheetName: currentSheet, 
					values: dataObj, 
					id: editId 
				};

				// 2. KIRIM KE BACKEND (Proses Tunggu)
				const res = await apiCall(payload, 'POST', payload);

				// 3. CEK HASIL
                if(res && res.status === 'success') { 
                    //  Alert Mewah Simpan/Edit
                    Swal.fire({
                        icon: 'success',
                        iconColor: '#10b981',
                        title: `<span class="text-2xl font-bold dark:text-white text-slate-800">${editMode ? 'Pembaruan Berhasil!' : 'Tersimpan!'}</span>`,
                        html: `<p class="text-sm text-slate-500 dark:text-slate-400 mt-1">Data layanan <strong>${currentTitle}</strong> telah tercatat di server.</p>`,
                        showConfirmButton: false,
                        timer: 2500,
                        customClass: { popup: 'rounded-[2rem] border border-slate-200 dark:border-slate-700 bg-white/90 dark:bg-slate-900/90 backdrop-blur-xl shadow-2xl' }
                    });
                    
                    closeForm(); 
                    cachedAllServices = null; 
                    await openService(currentSheet, currentTitle); 
                } else { 
                    Swal.fire({
                        icon: 'error',
                        title: '<span class="text-xl font-bold dark:text-white text-slate-800">Oops! Gagal</span>',
                        html: `<p class="text-sm text-slate-500 dark:text-slate-400">${res?.message || "Terjadi kesalahan saat menyinkronkan data."}</p>`,
                        confirmButtonText: 'Tutup',
                        buttonsStyling: false,
                        customClass: { 
                            popup: 'rounded-[2rem] border border-slate-200 dark:border-slate-700 bg-white/90 dark:bg-slate-900/90 backdrop-blur-xl shadow-2xl',
                            confirmButton: 'px-8 py-2.5 bg-slate-800 dark:bg-slate-700 text-white font-bold rounded-xl shadow-md mt-4 btn-press'
                        }
                    }); 
                }

			} catch (error) {
				console.error(error);
				Swal.fire("Error", "Gagal menghubungi server.", "error");
			} finally {
				// 4. SEMBUNYIKAN LOADING (Wajib dijalankan, sukses ataupun gagal)
				document.getElementById('loading').classList.add('hide');
			}
		}
        async function deleteItem(id) {
            //  Alert Mewah Konfirmasi Hapus
            const confirm = await Swal.fire({ 
                title: '<span class="text-2xl font-bold dark:text-white text-slate-800">Hapus Riwayat?</span>', 
                html: '<div class="mt-2 text-sm text-slate-500 dark:text-slate-400"><p>Data yang dihapus akan musnah dari sistem.</p><p class="mt-1 font-semibold text-red-500">Tindakan ini tidak bisa dibatalkan!</p></div>', 
                icon: 'warning', 
                iconColor: '#ef4444',
                showCancelButton: true, 
                confirmButtonText: '<i class="fa-solid fa-trash-can mr-2"></i>Ya, Musnahkan', 
                cancelButtonText: 'Batal',
                buttonsStyling: false,
                customClass: {
                    popup: 'rounded-[2rem] border border-slate-200 dark:border-slate-700 bg-white/90 dark:bg-slate-900/90 backdrop-blur-xl shadow-2xl',
                    confirmButton: 'px-6 py-3 bg-gradient-to-r from-red-600 to-rose-600 text-white font-bold rounded-xl shadow-lg shadow-red-500/30 transition-all hover:-translate-y-1 mx-2 btn-press',
                    cancelButton: 'px-6 py-3 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 font-bold rounded-xl transition-all hover:bg-slate-200 dark:hover:bg-slate-700 border border-slate-200 dark:border-slate-700 mx-2 btn-press'
                }
            });
            
            if(confirm.isConfirmed) {
                // Tampilkan Loading Animasi
                Swal.fire({
                    title: '<span class="text-lg font-bold dark:text-white text-slate-800">Melenyapkan Data...</span>',
                    html: '<p class="text-sm text-slate-500">Menyinkronkan dengan database pusat.</p>',
                    allowOutsideClick: false,
                    didOpen: () => { Swal.showLoading(); },
                    customClass: { popup: 'rounded-[2rem] border border-slate-200 dark:border-slate-700 bg-white/90 dark:bg-slate-900/90 backdrop-blur-xl shadow-xl' }
                });

                const payload = { action: 'deleteData', sheetName: currentSheet, id: id, username: currentUser.username };
                const res = await apiCall(payload, 'POST', payload);
                
                if(res.status === 'success') { 
                    //  Alert Mewah Sukses Hapus
                    Swal.fire({
                        icon: 'success',
                        title: '<span class="text-xl font-bold dark:text-white text-slate-800">Dilenyapkan!</span>',
                        html: '<p class="text-sm text-slate-500 dark:text-slate-400">Data tersebut sudah tidak ada lagi di sistem.</p>',
                        showConfirmButton: false,
                        timer: 2000,
                        customClass: { popup: 'rounded-[2rem] border border-slate-200 dark:border-slate-700 bg-white/90 dark:bg-slate-900/90 backdrop-blur-xl shadow-2xl' }
                    });
                    
                    cachedAllServices = null;
                    openService(currentSheet, currentTitle); 
                } else { 
                    Swal.fire({
                        icon: 'error',
                        title: '<span class="text-xl font-bold dark:text-white text-slate-800">Gagal</span>',
                        text: res.message,
                        customClass: { popup: 'rounded-[2rem] border border-slate-200 dark:border-slate-700 bg-white/90 dark:bg-slate-900/90 backdrop-blur-xl shadow-2xl' }
                    }); 
                }
            }
        }
		
		// --- FITUR PREMIUM: GENERATE PDF PROFIL PSIKOLOGIS SISWA ---
        async function printStudentProfile(historyData, studentName) {
            showToast("Menyiapkan Dokumen Profil...", "info");
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: [215.9, 330.2] }); // F4
            
            // 1. BUAT KOP SURAT (Murni dari Backend)
            const s = metaData.sekolah || {};
            const pageWidth = doc.internal.pageSize.getWidth();
            const centerX = pageWidth / 2;
            doc.setFont("times", "normal");
            
            // Memanggil data logo yang sudah diperbaiki di backend
            const urlKiri = s.logo_kiri || s.logo_url || "https://drive.google.com/thumbnail?id=1Z6g-sCdw-k7W8dnw12NeagPkroLlmk-L"; 
            const urlKanan = s.logo_kanan || ""; 
            
            if (urlKiri) { 
                const imgData = await getBase64FromUrl(urlKiri); 
                if (imgData) doc.addImage(imgData, 'PNG', 10, 10, 25, 25); 
            }
            if (urlKanan) { 
                const imgData2 = await getBase64FromUrl(urlKanan); 
                if (imgData2) doc.addImage(imgData2, 'PNG', pageWidth - 35, 10, 25, 25); 
            }
            
            let currentY = 15;
            doc.setFontSize(12); doc.text((s.pemerintah || "PEMERINTAH KOTA").toUpperCase(), centerX, currentY, { align: 'center' });
            currentY += 5; doc.text((s.instansi || "DINAS PENDIDIKAN").toUpperCase(), centerX, currentY, { align: 'center' });
            currentY += 6; doc.setFont("times", "bold"); doc.setFontSize(14); doc.text((s.nama || "NAMA SEKOLAH").toUpperCase(), centerX, currentY, { align: 'center' });
            currentY += 5; doc.setFontSize(12); doc.text((s.judul_bk || "BIMBINGAN DAN KONSELING").toUpperCase(), centerX, currentY, { align: 'center' });
            currentY += 5; doc.setFont("times", "normal"); doc.setFontSize(10); doc.text(s.alamat || "Alamat Sekolah Lengkap", centerX, currentY, { align: 'center' });
            
            currentY += 4; doc.setLineWidth(0.8); doc.line(10, currentY, pageWidth - 10, currentY); 
            doc.setLineWidth(0.3); doc.line(10, currentY + 1.2, pageWidth - 10, currentY + 1.2); 
            
            // 2. JUDUL DOKUMEN & BIODATA SISWA (Semua Font Times & Model Kotak Simpel)
            currentY += 15;
            doc.setFont("times", "bold"); doc.setFontSize(14); // note+++ Ubah helvetica jadi times
            doc.text("LAPORAN PROFIL & RIWAYAT LAYANAN SISWA", centerX, currentY, { align: 'center' });
            
            currentY += 8; // Jarak dari judul ke kotak biodata
            
            // note+++ Membuat kotak biodata yang simpel dan elegan
            doc.autoTable({
                startY: currentY,
                body: [
                    ['Nama Siswa', studentName],
                    ['Tahun Ajaran', `${s.tahun_ajar || '-'} (Semester ${s.semester || '-'})`],
                    ['Total Kasus', `${historyData.length} Riwayat Layanan`],
                    ['Tanggal Cetak', new Date().toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'})]
                ],
                theme: 'grid',
                styles: { font: "times", fontSize: 11, cellPadding: 2.5, lineColor: 0, lineWidth: 0.1, textColor: 0 },
                columnStyles: { 
                    0: { cellWidth: 40, fontStyle: 'bold', fillColor: [245, 245, 245] }, // Latar abu-abu terang untuk label
                    1: { cellWidth: 'auto', fillColor: 255 } 
                },
                margin: { left: 15, right: 15 }
            });

            // 3. TABEL RIWAYAT
            currentY = doc.lastAutoTable.finalY + 10; // Mengatur posisi Y awal tabel riwayat agar pas di bawah kotak biodata
            const tableData = historyData.map((h, i) => {
                const tgl = new Date(h._date).toLocaleDateString('id-ID', {day: '2-digit', month: 'short', year: 'numeric'});
                const layanan = h._type.label;
                const detail = h['Identifikasi_Masalah'] || h['Topik_Layanan'] || h['Deskripsi_Kasus'] || h['Pokok_Masalah'] || '-';
                const hasil = h['Hasil'] || h['Hasil_Keputusan'] || h['Hasil_Kesepakatan'] || h['Tindak_Lanjut'] || '-';
                return [i+1, tgl, layanan, detail, hasil];
            });

            doc.autoTable({
                startY: currentY,
                head: [['No', 'Tanggal', 'Jenis Layanan', 'Deskripsi / Masalah', 'Hasil / Tindak Lanjut']],
                body: tableData,
                theme: 'grid',
                styles: { font: "times", fontSize: 10, cellPadding: 3, lineColor: 0, lineWidth: 0.1 },
                headStyles: { fillColor: [168, 85, 247], textColor: 255, fontStyle: 'bold', halign: 'center' },
                columnStyles: { 0: {cellWidth: 10, halign: 'center'}, 1: {cellWidth: 25}, 2: {cellWidth: 35}, 3: {cellWidth: 'auto'}, 4: {cellWidth: 'auto'} },
                margin: { left: 15, right: 15 }
            });

            // 4. TANDA TANGAN GURU BK
            let finalY = doc.lastAutoTable.finalY + 20;
            
            doc.setFont("times", "normal");
            doc.setFontSize(11); // Kunci ukuran 11 untuk tanggal dan jabatan
            doc.text(`Makassar, ${new Date().toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'})}`, doc.internal.pageSize.getWidth() - 60, finalY, { align: 'center' });
            doc.text("Guru Bimbingan Konseling", doc.internal.pageSize.getWidth() - 60, finalY + 5, { align: 'center' });
            
            finalY += 25;
            
            doc.setFont("times", "bold"); 
            doc.setFontSize(11); // note+++ KUNCI LAGI UKURAN 11 UNTUK NAMA (Agar tidak membengkak saat di-bold)
            doc.text(currentUser.nama, doc.internal.pageSize.getWidth() - 60, finalY, { align: 'center' });
            
            // Garis bawah nama
            const textWidth = doc.getTextWidth(currentUser.nama);
            doc.setLineWidth(0.2); 
            doc.line(doc.internal.pageSize.getWidth() - 60 - (textWidth / 2), finalY + 1, doc.internal.pageSize.getWidth() - 60 + (textWidth / 2), finalY + 1);
            
            doc.setFont("times", "normal"); 
            doc.setFontSize(11); // note+++ KUNCI LAGI UKURAN 11 UNTUK NIP
            doc.text(`NIP. ${currentUser.nip}`, doc.internal.pageSize.getWidth() - 60, finalY + 5, { align: 'center' });

            // OUTPUT PDF
            try { 
                const blob = doc.output('blob'); 
                const blobURL = URL.createObjectURL(blob); 
                window.open(blobURL, '_blank'); 
            } catch (e) { 
                doc.save(`Profil_${studentName}.pdf`); 
            }
        }
		
		// ---  FITUR DEWA: AI FORECASTER (PREDIKSI TREN MASALAH) ---
        async function runAiForecast() {
            if(!cachedAllServices) {
                Swal.fire("Tunggu", "Data sedang disinkronkan, silakan tunggu sebentar...", "info");
                return;
            }

            // 1. Kumpulkan data mentah untuk bahan ramalan AI
            let rawDataSummary = "";
            for (const [sheet, data] of Object.entries(cachedAllServices)) {
                if(data.length > 0) {
                    rawDataSummary += `--- Layanan ${sheet} ---\n`;
                    data.forEach(item => {
                        const txt = item['Identifikasi_Masalah'] || item['Deskripsi_Kasus'] || item['Pokok_Masalah'] || item['Uraian_Topik'] || "";
                        if(txt) rawDataSummary += `- ${txt}\n`;
                    });
                }
            }

            if(!rawDataSummary) {
                Swal.fire("Kosong", "Belum ada data layanan yang cukup untuk dianalisis AI.", "warning");
                return;
            }

            // 2. Tampilkan Loading Mewah
            Swal.fire({
                title: 'Membuka Mata Batin AI...',
                html: 'AI sedang menganalisis pola masalah siswa dan menyusun strategi pencegahan...',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });

            try {
                // 3. Siapkan Prompt "Peramal" yang sangat spesifik
                const forecastPrompt = `
                    TUGAS: Analisis Data Historis BK ini dan jadilah peramal preventif.
                    DATA: \n${rawDataSummary}\n
                    INSTRUKSI:
                    1. Identifikasi 3 Tren Masalah Tersembunyi (misal: "Bullying Verbal meningkat di kelas 8").
                    2. Prediksi apa yang akan terjadi bulan depan jika tidak diintervensi.
                    3. Berikan 2 Saran Tindakan Preventif (Bimbingan Klasikal/Sosialisasi).
                    
                    Gunakan gaya bahasa profesional, tajam, dan waspada. Jawab langsung ke poinnya tanpa salam.
                `;

                // 4. Tembak ke Backend Action 'askAI'
                const payload = { action: 'askAI', prompt: forecastPrompt, targetField: 'AI Forecaster Report' };
                const res = await apiCall(payload, 'POST', payload);

                if(res && res.status === 'success') {
                    Swal.close();
                    
                    // 5. Tampilkan hasil ramalan dalam modal yang sangat mewah
                    Swal.fire({
                        title: '<span class="text-indigo-600">Laporan Prediksi Tren BK</span>',
                        html: `
                            <div class="text-left text-sm leading-relaxed p-2 space-y-4 max-h-[60vh] overflow-y-auto custom-scroll">
                                ${res.data.replace(/\n/g, '<br>')}
                            </div>
                            <p class="mt-4 text-[10px] text-gray-400 italic font-light text-center border-t pt-2">Note: Analisis ini berdasarkan pola data historis yang tersimpan di sistem.</p>
                        `,
                        icon: 'info',
                        width: '600px',
                        confirmButtonText: 'Siap, Saya Akan Antisipasi!',
                        confirmButtonColor: '#4f46e5'
                    });
                } else {
                    throw new Error("Gagal mendapatkan respons AI.");
                }
            } catch (err) {
                Swal.fire("Error", "Sirkuit AI terputus. Cek internet Anda.", "error");
            }
        }
		
        function editItem(id) { showForm(true, id); }
        function showAbout() {
            Swal.fire({
                html: `
                    <div class="relative overflow-hidden p-2">
                        <div class="absolute -top-10 -left-10 w-32 h-32 bg-blue-500/10 rounded-full blur-2xl pointer-events-none"></div>
                        <div class="absolute -bottom-10 -right-10 w-32 h-32 bg-purple-500/10 rounded-full blur-2xl pointer-events-none"></div>
                        
                        <div class="relative z-10 flex flex-col items-center text-center">
                            <div class="w-20 h-20 bg-white dark:bg-slate-800 rounded-3xl shadow-xl flex items-center justify-center mb-5 border border-slate-100 dark:border-slate-700 p-2">
                                <img src="https://drive.google.com/thumbnail?id=1Z6g-sCdw-k7W8dnw12NeagPkroLlmk-L" class="w-full h-full object-contain drop-shadow-md" alt="Logo">
                            </div>
                            
                            <h2 class="text-3xl font-black tracking-tight dark:text-white text-slate-800 mb-1">
                                SIAP-BK <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-500 to-purple-600">PRO</span>
                            </h2>
                            <div class="inline-block px-4 py-1 bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 text-[10px] font-extrabold tracking-widest rounded-full mb-5 border border-blue-100 dark:border-blue-800">
                                MAPPAGURU ONLINE &bull; BUILD 2026
                            </div>
                            
                            <p class="text-sm text-slate-500 dark:text-slate-400 mb-6 px-2 leading-relaxed">
                                Sistem Informasi Administrasi & Pelayanan Bimbingan Konseling <strong class="text-slate-700 dark:text-slate-200">UPT SPF SMP Negeri 16 Makassar</strong>.
                            </p>

                            <div class="grid grid-cols-2 gap-3 w-full text-left mb-8">
                                <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm hover:-translate-y-1 transition-transform">
                                    <div class="w-8 h-8 rounded-full bg-purple-100 dark:bg-purple-900/40 flex items-center justify-center mb-3">
                                        <i class="fa-solid fa-wand-magic-sparkles text-purple-600 dark:text-purple-400 text-sm"></i>
                                    </div>
                                    <h4 class="text-xs font-bold dark:text-white text-slate-800">AI Analytics</h4>
                                    <p class="text-[10px] text-slate-500 mt-1 leading-tight">Prediksi Tren & Smart Insight</p>
                                </div>
                                <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm hover:-translate-y-1 transition-transform">
                                    <div class="w-8 h-8 rounded-full bg-red-100 dark:bg-red-900/40 flex items-center justify-center mb-3">
                                        <i class="fa-solid fa-file-pdf text-red-600 dark:text-red-400 text-sm"></i>
                                    </div>
                                    <h4 class="text-xs font-bold dark:text-white text-slate-800">Pro Reports</h4>
                                    <p class="text-[10px] text-slate-500 mt-1 leading-tight">Cetak PDF & Validasi QR</p>
                                </div>
                                <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm hover:-translate-y-1 transition-transform">
                                    <div class="w-8 h-8 rounded-full bg-green-100 dark:bg-green-900/40 flex items-center justify-center mb-3">
                                        <i class="fa-solid fa-cloud text-green-600 dark:text-green-400 text-sm"></i>
                                    </div>
                                    <h4 class="text-xs font-bold dark:text-white text-slate-800">Cloud Sync</h4>
                                    <p class="text-[10px] text-slate-500 mt-1 leading-tight">Google Sheets Database</p>
                                </div>
                                <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm hover:-translate-y-1 transition-transform">
                                    <div class="w-8 h-8 rounded-full bg-blue-100 dark:bg-blue-900/40 flex items-center justify-center mb-3">
                                        <i class="fa-solid fa-shield-halved text-blue-600 dark:text-blue-400 text-sm"></i>
                                    </div>
                                    <h4 class="text-xs font-bold dark:text-white text-slate-800">Secure Data</h4>
                                    <p class="text-[10px] text-slate-500 mt-1 leading-tight">Encrypted Traffic System</p>
                                </div>
                            </div>
                            
                            <div class="w-full pt-4">
                                <p class="text-xs text-slate-500 dark:text-slate-400 flex items-center justify-center gap-1.5">
                                    Developed with <i class="fa-solid fa-heart text-red-500 animate-pulse"></i> by 
                                    <span class="font-bold text-slate-800 dark:text-white">Muhammad Hasratul</span>
                                </p>
                            </div>
                        </div>
                    </div>
                `,
                showConfirmButton: true,
                confirmButtonText: '<i class="fa-solid fa-check mr-2"></i> Tutup',
                confirmButtonColor: '#4f46e5',
                customClass: {
                    popup: 'rounded-[2rem] border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900 shadow-2xl',
                    htmlContainer: 'p-2 m-0',
                    confirmButton: 'rounded-xl font-bold shadow-lg shadow-indigo-500/30 w-[80%] mx-auto mb-4 hover:scale-105 transition-transform'
                },
                width: '450px',
                padding: '1rem'
            });
        }
    </script>
</body>
</html>
